# 19 - 行政区域边界渲染与选区交互（Region Boundary）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 19  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

行政区域边界渲染与选区交互（Google Maps Data Layer + region_code 契约 + hover/click 边界）

---

## 目标 / 非目标

### 目标

- 使用 Google Maps Data Layer 渲染行政区域边界（GeoJSON），并支持：
  - hover 高亮（轻交互）
  - click lock（重交互：锁定选区）
  - 与热力/叠加层协同（边界样式不遮挡 overlays）
- 从“名称驱动”升级为“编码契约驱动”：
  - 交互回传必须产出 `region_code` + `region_scope`
  - `display_name` 仅用于 UI 展示
- 严格遵守 v2 性能红线：
  - hover 0 次 L1/L2 明细重请求
- 具备可观测性：
  - 记录映射命中策略与 region_dataset_version（避免映射漂移不可解释）

### 非目标

- 不在本细则实现 “GPS/反向地理编码 → region_code” 全链路（由 `RD-GPS定位与反向地理编码.md` 与后续步骤承接）。
- 不在本细则实现后端 Region Service（若需要查询/搜索 API，属于后端模块或 Shared Contract 扩展）。

---

## 关联的数据产品（Data Product）

边界交互是数据产品联动的核心入口：

- L0 Dashboard：Ranking click ↔ map lock
- L1 Region Intelligence：click lock 触发 L1 最小集刷新
- Map Overlays：选区变化驱动 overlays 过滤或视角定位

---

## 输入维度（最小集合）

- `region_scope`（province/city/district…）
- `region_code`（稳定编码，系统主键）
- `region_dataset_version`（边界/映射数据版本）
- `time_range`、`data_type`、`weather_type`、`product_id`、`access_mode`、`prediction_run_id`（用于联动请求与可观测）

---

## 输出形态

### 渲染输出

- 行政区域边界（Polygon/MultiPolygon）
- hover 高亮样式
- selected（锁定）样式

### 事件输出（给 UI Orchestration）

- `map_hover(region_code?)`
- `map_lock(region_code, region_scope)`

---

## Mode 规则（必须写）

边界渲染对 Mode 不敏感，但其触发的数据产品下钻必须由后端 Mode-aware 裁剪：

- Demo/Public：允许锁区与高亮，但 L2 明细默认不可用或仅摘要（后端强裁剪）
- Partner/Admin：按能力开放更细粒度

---

## predicted 规则（必须写）

边界渲染本身不区分 predicted，但边界交互触发的所有数据产品请求必须遵守：

- `data_type=predicted` 时，必须绑定 `prediction_run_id`（或使用 active_run 解析并回填）
- hover 不触发任何 predicted 的 L1/L2 明细请求（仍是 0 重请求）

---

## 性能与缓存策略

### hover 轻交互（强制）

hover 只允许：

- 边界高亮
- mini tooltip（≤3 指标，来自已加载数据或缓存命中）

禁止：

- hover 触发 L1/L2 明细请求
- hover 导致排行榜/时间轴重算风暴

### 边界数据加载（建议）

边界 GeoJSON 需要按国家/层级分片与缓存（见 `RD-行政区域数据管理与名称映射.md`），避免一次加载全量。

---

## 可观测性

必须记录（至少）：

- `region_boundary_loaded`（region_dataset_version、feature_count）
- `map_hover`（region_code?）
- `map_lock`（region_code、source=map_click|ranking_click|gps|search）
- `region_mapping_hit`（match_strategy=exact|mapping|semantic|nearest；若本模块不负责映射，可由上游注入）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `region_scope/region_code`
- `region_dataset_version`
- predicted：`prediction_run_id`

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-行政区域边界与选区交互.md`
- `docs/v2/v2复用逻辑摘录/RD-行政区域数据管理与名称映射.md`
- `docs/v2/v2复用逻辑摘录/RD-地图主舞台.md`

### 来自 v1 的可复用资产（R0/R1）

- 复用 Data Layer + GeoJSON 渲染边界的方式与“选中/未选中样式协同热力图”的设计思想，但 v2 强制升级为 region_code 契约。

### 不复用内容（R3）

- 不复用“用 province/district 自由文本作为状态主键/缓存 key”的做法。

---

## 验收用例（可勾选）

### 渲染与交互（必须）

- [ ] 边界可渲染；hover 高亮；click 可锁定选区。
- [ ] 锁定选区的回传包含 `region_code + region_scope`（非仅 display_name）。

### 性能红线（必须）

- [ ] hover 0 次 L1/L2 明细重请求。

### 样式协同（必须）

- [ ] 热力图可见时：边界填充透明、边框高亮；热力图不可见时：选中区域可有高亮填充（不遮挡关键信息）。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo 模式下依然能通过边界交互触发 L2 明细接口并拿到敏感字段。  
硬规则：后端必须 Mode-aware 强裁剪；前端仅负责“可见但不可用”的 UX。

### 失败模式 B：predicted 混批次

症状：锁区后 overlays/L1 使用了不同 prediction_run，导致解释断裂。  
硬规则：prediction_run_id 作为顶层状态域统一传递；缓存 key 必含批次；UI 不得混批次渲染。

---

## 风险与回滚策略

### 风险

- region_code 未固化：名称漂移导致“同一地区不同端解析不同”，联动不稳定（P0）。
- hover 触发请求风暴：地图掉帧、路演翻车（P0）。

### 回滚策略

- 若 region_code 体系未定：先限定国家集与 demo 区域，固化 mapping/version，再扩展。
- 若出现请求风暴：强制关闭 hover 下钻（只保留高亮与 tooltip），把请求权收敛到 click/CTA。

