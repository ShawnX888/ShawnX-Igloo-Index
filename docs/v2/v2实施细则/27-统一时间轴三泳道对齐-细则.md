# 27 - 统一时间轴（三泳道对齐）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 27  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

Timeline（统一时间轴三泳道）：Weather / Risk / Claims 对齐（同一 UTC 轴 + 统一刷选/高亮）

---

## 目标 / 非目标

### 目标

- 在 Region Intelligence Panel 中提供“同一时间轴三泳道对齐”的解释主通道：
  - Weather series（基础天气/单位）
  - Risk series（与产品 riskRules 对齐：rolling window 聚合结果 + thresholds/tiers）
  - Claims series（聚合点/柱状，明细属于 L2；Phase 2 允许 disabled/placeholder）
- 固化两个窗口概念，避免口径漂移（来自 `RD-图表可视化.md`）：
  - `time_range`：用户选择的显示区间（决定横轴范围）
  - `calculation_window`：产品 riskRules 决定的计算回溯窗口（决定纵轴值如何生成；由后端完成并在 meta 解释）
- 支持 brush（时间窗刷选）作为全局过滤入口：
  - 刷选后 L0/L1/Overlays 同步更新（节流）
  - brush 结束后统一 commit，避免每像素一次请求
- 与 Mode/predicted 红线对齐：
  - Demo/Public 下不暴露可逆推敏感明细
  - predicted 场景必须同一批次（prediction_run_id 一致）

### 非目标

- 不在本细则决定具体图表库（Recharts 等在 Step 28）。
- 不在本细则实现 L2 明细下钻（Step 35）。
 - 不在 Phase 2 用“推断/模拟”填充 claims：claims 事实域在 Phase 3（Step 30/31/32）。Phase 2 的 Timeline 只要求 Claims lane 可见但不可用且解释清晰。

---

## 关联的数据产品（Data Product）

直接消费：

- L1 Region Intelligence Data Product（Step 13）— Timeline 三泳道序列 + thresholds + meta

间接联动：

- Map Overlays（Step 12）：brush 触发 overlays 过滤/刷新（节流）
- L0 Dashboard（Step 11）：可选同步（以产品决定）

---

## 输入维度（最小集合）

- `region_code`（锁区后）
- `time_range`（UTC）
- `data_type`
- `weather_type`
- `product_id`（可选；Risk 泳道通常需要）
- `access_mode`
- predicted：`prediction_run_id`

交互状态（可观测）：

- `timeline_brush_range`（UTC；表示当前刷选范围）
- `view_mode`（hourly/daily；由产品/粒度能力决定）

---

## 输出形态

- 三泳道渲染（同一横轴）
- 统一的 hover cursor / crosshair（可选）
- brush 交互输出（给 Orchestration）：
  - `timeline_brush_start`
  - `timeline_brush_change`（节流；不必每次触发 dp）
  - `timeline_brush_commit(time_range)`
  - `timeline_brush_clear()`

---

## Mode 规则（必须写）

- Demo/Public：
  - Claims 泳道只展示聚合强弱/区间（后端裁剪为准）
  - 禁止通过 hover/tooltip 暗示可逆推出敏感明细
- Partner/Admin：可更细粒度（仍需脱敏/审计）

硬规则：
- Mode 裁剪由后端执行；前端不自行猜测“哪些字段该隐藏”。
 - **claims 可用性必须被显式尊重**：当 L1 meta 声明 `claims_available=false` 时，Claims lane 必须进入 disabled/placeholder（可见但不可用），并展示原因；不得触发 claims 请求或下钻意图。

---

## predicted 规则（必须写）

- `data_type=predicted`：
  - 三泳道必须同一 `prediction_run_id`
  - brush commit 后触发的 overlays/L1（以及 L2 按需）必须使用同一 run_id
- query key 必含 prediction_run_id（predicted）

---

## 性能与缓存策略

### Brush 节流（强制）

- brush change 仅更新本地 UI 状态（或节流更新）
- 只在 brush commit（鼠标释放/手势结束）时触发数据产品刷新

### 数据点多时的渲染降级（建议）

- 采样/稀疏化（由后端或前端渲染层实现，但必须可解释且不影响口径一致性）

---

## 可观测性

必须记录：

- `timeline_view_mode_change`（hourly/daily）
- `timeline_brush_commit`（range）
- `dp_l1_query` / `dp_overlays_query`（命中/耗时）
- `ui_render_done`（points_count 等摘要）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `region_code/time_range/data_type/weather_type/product_id`
- predicted：`prediction_run_id`

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-图表可视化.md`
- `docs/v2/v2复用逻辑摘录/RD-数据面板基础结构.md`
- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`
- `docs/v2/v2复用逻辑摘录/RD-共享类型与接口契约.md`

---

## 验收用例（可勾选）

### 对齐与解释（必须）

- [ ] Weather/Risk/Claims 三泳道同一 UTC 横轴对齐，legend/meta 可解释单位/阈值/窗口口径。
- [ ] 明确区分 time_range（显示）与 calculation_window（计算），且窗口起点不丢失（由后端保证）。
 - [ ] 当 `claims_available=false`：Claims lane 为 disabled/placeholder，但仍与同一 UTC 横轴对齐；UI 明确解释“为何不可用”且不误导。

### 交互治理（必须）

- [ ] hover 不触发 L1/L2 明细重请求；brush 不产生请求风暴（commit 才刷新）。

### Mode/批次（必须）

- [ ] Demo/Public 下不暴露敏感明细；predicted 不混批次（同 run_id）。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo 通过 tooltip/series 精确值可逆推敏感明细。  
硬规则：后端裁剪；前端避免“明细级” hover 输出；L2 必须按需并 Mode-aware。

### 失败模式 B：predicted 混批次

症状：三泳道或联动 overlays 使用不同 prediction_run，解释断裂。  
硬规则：prediction_run_id 顶层锁定；query key 含 run_id；响应 meta 显式回填。

---

## 风险与回滚策略

### 风险

- brush 未节流 → 请求风暴（P0）。
- time_range 与 calculation_window 混用 → 风险叠加曲线口径错误（P0）。

### 回滚策略

- 先回滚为“确认后提交”（brush end 才刷新），稳定后再增强实时预览。
- 若口径不稳：强制以 L1 Data Product 输出为准，前端只渲染并展示 meta。

