# 28 - 图表可视化（Weather/Risk/Claims）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 28  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

Charts（图表可视化）：Weather 趋势、Risk 叠加（thresholds/tiers）、Claims 序列（摘要）+ Events 时间线（摘要）

---

## 目标 / 非目标

### 目标

- 在 Region Intelligence Panel 的 Timeline/Overview 中提供“可解释”的图表呈现：
  - Weather：柱状/折线（按 hourly/daily）
  - Risk：叠加曲线 + thresholds（参考线）+ tier 高亮
  - Claims：柱状/点状序列（聚合摘要；明细属于 L2；Phase 2 允许 disabled/placeholder）
  - Events：风险事件摘要时间线（用于 highlight/定位）
- 强制后端作为事实源：
  - 图表序列来自 L1 Data Product（Step 13），前端**不做** rolling window 纵轴值重计算
  - 若后端返回“已计算序列”，必须在 meta 里说明 calculation_window（便于解释与审计）
- 交互治理：
  - hover 只做 tooltip（≤3 指标），不得触发 L1/L2 重请求
  - brush 按 Step 27 规则节流（commit 才刷新）
- Mode/predicted 一致性：
  - Demo/Public：不暴露可逆推敏感明细
  - predicted：prediction_run_id 全链路一致

### 非目标

- 不在本细则选定具体 UI 视觉设计（样式由 UI 方案逐步迭代）。
- 不在本细则实现 L2 Details（Step 35）。
 - 不在 Phase 2 用推断/模拟填充 claims：claims 事实域在 Phase 3（Step 30/31/32）。Phase 2 仅要求 Claims 图表占位/禁用态可解释且不误导。

---

## 关联的数据产品（Data Product）

直接消费：

- L1 Region Intelligence Data Product（Step 13）

按需消费（后续）：

- L2 Evidence Data Product（Step 33；用于 Details 下钻）

---

## 输入维度（最小集合）

- `region_code`
- `time_range`
- `data_type`
- `weather_type`
- `product_id`（可选；Risk 叠加与 events 通常需要）
- `access_mode`
- predicted：`prediction_run_id`
- `view_mode`（hourly/daily）

---

## 输出形态

- Weather chart
- Risk overlay chart（含 thresholds / tiers）
- Claims chart（摘要序列）
- Events timeline（摘要）
- 统一 legend/meta 展示：
  - unit、thresholds、tiers、window 口径、data_type、prediction_run_id

---

## Mode 规则（必须写）

- Demo/Public：
  - 金额/敏感口径区间化/隐藏（后端裁剪为准）
  - tooltip 不输出可逆推出敏感明细的精确值（尤其 claims）
  - L2 明细入口默认禁用或仅摘要（可见但不可用）
  - 当 `claims_available=false`（来自 L1 meta）：
    - Claims 图表必须显示为 disabled/placeholder，并解释原因
    - 禁止展示任何“看似精确的 claims 序列/金额”，避免误导
- Partner/Admin：可更细粒度（仍需脱敏/审计）

---

## predicted 规则（必须写）

- predicted 图表必须绑定 `prediction_run_id`（或 active_run 解析后回填）
- 切 active_run 后图表与 legend/meta 同步刷新，不混批次
- query key 必含 prediction_run_id（predicted）

---

## 性能与缓存策略

### 图表数据点多时的策略（建议）

- 由后端选择合适粒度（hourly/daily）并控制点数
- 前端渲染侧允许采样/虚拟化，但不得改变口径（采样必须可解释）

### 交互治理（强制）

- hover 不触发 dp 请求（红线）
- brush commit 才触发刷新（见 Step 27）

---

## 可观测性

必须记录：

- `chart_view_mode_change`（hourly/daily）
- `timeline_brush_commit`
- `dp_l1_query`（命中/耗时）
- `chart_render_done`（series_points_count 等摘要）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `region_code/time_range/data_type/weather_type/product_id`
- predicted：`prediction_run_id`

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-图表可视化.md`
- `docs/v2/v2复用逻辑摘录/RD-分析汇总卡片.md`
- `docs/v2/v2复用逻辑摘录/RD-数据面板基础结构.md`
- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`
- `docs/v2/v2复用逻辑摘录/RD-共享类型与接口契约.md`

---

## 验收用例（可勾选）

### 结构（必须）

- [ ] 图表具备三块：天气趋势、风险叠加、事件时间线（选产品后出现风险相关部分）；claims 泳道为摘要序列。

### 口径（必须）

- [ ] 正确区分 time_range（显示）与 calculation_window（计算），并在 legend/meta 中可解释。
- [ ] Risk 阈值/tiers/unit 与产品 riskRules 一致，且可追溯 product_version/rules_hash（至少在 meta 或日志中体现）。

### 红线（必须）

- [ ] hover 0 重请求；刷选/缩放无请求风暴（commit 才刷新）。
- [ ] predicted 不混批次（同 run_id）。
- [ ] Demo/Public 下不暴露敏感明细（后端裁剪可验证）。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo 图表 tooltip 仍可输出可逆推的敏感精确值。  
硬规则：后端裁剪 + 前端 tooltip 受 Mode 限制；L2 明细按需且 Mode-aware。

### 失败模式 B：predicted 混批次

症状：图表序列与 overlays/L1 其他部分不在同一 prediction_run。  
硬规则：prediction_run_id 顶层锁定；query key 含 run_id；响应 meta 显式回填。

---

## 风险与回滚策略

### 风险

- 前端自行计算 risk rolling window → 口径漂移/窗口起点错误（P0）。
- 数据点过多导致卡顿 → 面板拖慢地图主舞台（P0/P1）。

### 回滚策略

- 强制回滚为后端输出“已计算序列”+ 更粗粒度（daily），保证一致性与性能。
- 在 Demo/Public 默认关闭复杂图表细节，保留最小解释通道。

