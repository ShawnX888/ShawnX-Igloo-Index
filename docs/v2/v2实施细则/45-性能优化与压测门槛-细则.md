# 45 - 性能优化（缓存/预聚合/节流/压测门槛）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 45  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-19  
> 最后更新：2026-01-19

---

## 模块名称

性能优化与压测门槛：把 v2 的 Perf-SLO（p95/帧率/风暴红线）从“口头指标”落地为可执行的缓存 key 规则、预聚合策略、节流边界与压测/验收清单

---

## 目标 / 非目标

### 目标

- 固化 v2 的性能“硬门槛”（Go/No-Go）：
  - hover 0 明细重请求（红线）
  - L0/L1/Overlays 的 p95 目标可验证
  - Map Stage 交互优先（不掉帧/不卡顿）
- 把性能优化落到三层：
  - **后端**：Data Product 级缓存/预聚合、cache key 维度、失效策略
  - **前端**：Orchestration 节流/去抖、TanStack Query 并发取消/合并
  - **任务**：重计算异步化、缓存刷新节奏与幂等
- 把性能“可证明化”：
  - 统一埋点/日志字段（Step 43）
  - 能区分 cache_hit/miss、p95、风暴触发源

### 非目标

- 不绑定具体压测工具（k6/locust/jmeter 皆可），只定义“必须测什么/门槛是什么/如何判定 pass/fail”。
- 不在本细则决定数据库索引/分区的具体实现细节（由后端表/服务细则承接），这里只定义“哪些查询必须预聚合/缓存优先”。

---

## 关联的数据产品（Data Product）

性能优化主要覆盖：

- L0 Dashboard（Step 11）
- Map Overlays（Step 12）
- L1 Region Intelligence（Step 13）
- L2 Evidence（Step 33，重点是“按需加载 + 不预取 + Mode 裁剪”）
- AI Insights（Step 39/41，重点是“节流刷新 + 不滥用 L2”）

---

## 输入维度（最小集合）

性能治理必须以 Shared Contract 维度为索引（否则无法做正确缓存与排障）：

- `region_scope/region_code`
- `time_range`
- `data_type`
- `weather_type`
- `product_id`（如适用）
- `access_mode`
- predicted：`prediction_run_id`
- `trace_id/correlation_id`

---

## 输出形态

- **缓存策略与 key 维度规则**（强制）
- **预聚合/强缓存的对象清单**（强制）
- **交互节流边界**（强制）
- **压测用例与门槛**（强制）
- **可观测字段与事件字典**（复用 Step 43）

---

## Mode 规则（必须写）

- 所有缓存必须 **按 Mode 隔离**：
  - cache key 必含 `access_mode`（否则 Mode 串数据等价于权限事故）
- Demo/Public 性能目标更重要：
  - 默认更保守：更多聚合、更少明细、更少高成本 L2
  - 允许“可见但不可用”的降级提示，避免演示断流

---

## predicted 规则（必须写）

- predicted 场景缓存必须 **与批次绑定**：
  - cache key 必含 `prediction_run_id`（或 active_run 标识）
- active_run 切换必须触发失效/刷新并可观测：
  - `active_run_changed` → `dp_cache_invalidated` → `dp_*_query`

---

## 性能与缓存策略（落地规范）

### 1) 缓存 key 维度（强制）

> 与 Step 01/02/03 一致。本模块只重申“性能视角的必须性”。

缓存 key 至少包含：

- `region_scope`
- `region_code`（或 region_set/聚合域）
- `time_range`
- `data_type`
- `weather_type`
- `product_id`（一旦影响口径必须入 key）
- `access_mode`
- `prediction_run_id`（predicted 必须）

### 2) 缓存层级（建议）

- **L0 Dashboard**：强缓存优先（预聚合可选）
- **Overlays**：强缓存 + 按 zoom/region_scope 分层缓存（避免“一份数据打天下”）
- **L1**：缓存可复用（相同维度组合下支持复用/切窗）
- **L2**：默认不缓存或短 TTL（敏感+重查询；且必须 Mode-aware）

### 3) 预聚合优先级（强制清单）

必须优先预聚合/强缓存的场景（否则会被 OLTP 明细打爆）：

- L0 KPI/Top 导航（Pareto TopN，按省级/region_scope）
- Overlays（可直接渲染的区域级/网格/hex 级聚合）
- L1 的 Overview 聚合（用于 KPI 卡片与 AI Insight 证据点）

禁止项（红线对齐）：

- 前端对“海量明细 risk_events/claims”做二次聚合（必须由 DP 输出聚合）

---

## 交互节流边界（强制）

> 统一由 UI Orchestration 执行（Step 20），并通过埋点/日志验证（Step 43）。

### Hover（轻交互）

- **0 次 L1/L2 明细重请求**（硬红线）
- tooltip 只能使用“已加载的数据”或“轻量聚合（≤3 指标）”

### Brush（高频交互）

- `brush` 过程中只更新本地 UI（不打请求）
- 只在 `brush_commit`（松手/确认）触发 DP 请求
- 必须支持 in-flight cancel（TanStack Query）

### Toggle（图层/选项）

- 默认只改呈现
- 如必须触发 Overlays 请求：必须 debounce，并合并“最后一次 wins”
- 绝不触发 L2（避免 toggle→L2 风暴）

### 动画期间 gate（与地图动画系统对齐）

- `is_animating=true` 时，允许“后台预取”，但禁止 commit 到渲染（避免掉帧/竞态）
- 动画结束一次性 commit：`map_animation_end` → `dp_refresh_commit` → `ui_render_done`

---

## 压测与验收门槛（Go/No-Go）

> 下面门槛来自 `v2实现步骤总览.md` 的建议值；如后续调整，必须版本化并记录原因。

### 1) p95 延迟门槛（必须）

- L0 Dashboard：缓存命中 p95 < 500ms
- L1 Region Intelligence：p95 < 1.5s
- L2 Evidence：p95 < 2.5s（按需）
- Overlays：缓存命中 p95 < 800ms

### 2) 地图交互门槛（必须）

- pan/zoom/hover 不掉帧（必须提供可观测指标/替代指标：如 map_fps_drop 或交互卡顿率）
- Layer toggle 不导致明显卡顿（尤其移动端）

### 3) 风暴门槛（必须）

- hover 0 明细重请求（通过埋点/日志验证）
- brush/toggle 不产生请求风暴（单位时间 dp_query 次数有上限）

### 4) 任务门槛（必须）

- Celery 任务重试不重复写（幂等可验证）
- 任务触发的缓存刷新不导致“全站抖动”（建议分批/分片）

---

## 可观测性（必须）

必打点/日志：

- `dp_cache_hit/miss`
- `dp_latency_ms`
- `ui_render_done`
- `map_interaction`（hover/lock/pan/zoom）
- `timeline_brush_commit`
- `layer_toggle_commit`
- `map_animation_start/end`

必带字段：遵循 Step 43（trace_id/correlation_id + 关键维度 + prediction_run_id）。

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`
- `docs/v2/v2复用逻辑摘录/RD-地图模式与动画系统.md`
- `docs/v2/v2复用逻辑摘录/RD-分层职责与协作边界.md`

### 依赖实施细则（强制对齐）

- `docs/v2/v2实施细则/01-Shared-Contract基线-细则.md`（cache key 维度）
- `docs/v2/v2实施细则/20-UI-Orchestration状态机与联动矩阵-细则.md`（节流/门控）
- `docs/v2/v2实施细则/43-可观测性基础设施-细则.md`（指标与事件）

---

## 验收用例（可勾选）

### 性能（必须）

- [ ] L0/L1/Overlays/L2 p95 达标（记录测试环境与数据规模）。
- [ ] hover 0 明细重请求（日志/埋点可证明）。
- [ ] brush/toggle 有节流与 in-flight cancel，且不产生风暴。

### 一致性（必须）

- [ ] cache key 维度完整：至少 access_mode；predicted 额外包含 prediction_run_id。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：缓存未按 access_mode 隔离，Demo 命中 Partner/Admin 缓存导致敏感泄露。  
硬规则：cache key 必含 `access_mode`；发现即视为 P0，立即清缓存并回滚策略版本。

### 失败模式 B：predicted 混批次

症状：predicted 缓存未含 run_id，active_run 切换后仍命中旧批次结果。  
硬规则：cache key 必含 `prediction_run_id`；切换 active_run 必须触发失效与可观测事件。

---

## 风险与回滚策略

### 风险

- 过度依赖 OLTP 明细查询导致性能崩溃（P0/P1）。
- 前端节流缺失导致交互风暴（P0）。

### 回滚策略

- 先“收敛”再优化：降级为更强缓存/更粗聚合，禁用高成本路径（L2、复杂 overlays）。
- 若地图掉帧：先禁用动画/高密度 markers，切换到更轻的 overlays 表达。

