# 22 - 天气热力图图层（Weather Layer）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 22  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

Weather Heatmap Layer（地图热力表达：historical vs predicted 分层；数据产品驱动；deck.gl + Google Maps）

---

## 目标 / 非目标

### 目标

- 在 Map Stage 上提供天气热力可视化（以 rainfall 为例，可扩展到 wind/temperature…）：
  - historical 与 predicted 分层表达（颜色体系区分）
  - 由 `data_type` 驱动显示切换：historical 模式只显示历史层；predicted 模式只显示预测层
- 数据来源必须“数据产品化”：
  - 仅消费后端 `Map Overlays Data Product`（Step 12）的 weather overlays 输出
  - legend/meta 由后端提供并在前端呈现（单位、范围、色阶、data_type、prediction_run_id）
- 与边界层协同：
  - 热力层开启时，选中区域描边必须仍清晰可见（不遮挡）
- 性能治理：
  - 切换 data_type / time_range / weather_type 不造成请求风暴与掉帧（节流/缓存复用）

### 非目标

- 不在本细则实现 Weather Service/数据生成（后端已在 Step 07/12 定义）。
- 不在本细则实现“径向渐变”作为硬门槛（可作为后续体验增强）。

---

## 关联的数据产品（Data Product）

直接消费：

- Map Overlays Data Product（Step 12）— weather overlay + legend/meta

间接联动：

- 控制面板 / Top Bar（Step 24）切换 weather_type、time_range、data_type
- L1 Region Intelligence（Step 13）在 timeline 中同步 weather 泳道（同一 time_range/data_type 批次）

---

## 输入维度（最小集合）

> 维度命名必须与 Shared Contract 一致。

- `region_scope`（地图 overlays 的聚合层级）
- `time_range`
- `data_type`（historical/predicted）
- `weather_type`
- `access_mode`
- predicted：`prediction_run_id`（或 active_run 解析后回填并锁定）

---

## 输出形态

### 视觉输出

- Weather Heatmap（区域/网格/hex 等聚合形态，优先以 Overlays 输出为准）
- Legend/Meta：
  - unit、value range、color ramp、weather_type
  - data_type
  - predicted：prediction_run_id（或 active_run 标识）

### 交互输出

- hover：仅 tooltip（≤3 指标，来自 overlays 已加载数据），不得触发 L1/L2
- click：由 Map Stage/Orchestration 承接（本图层不新增下钻语义）

---

## Mode 规则（必须写）

- Demo/Public：可弱化数值精度（例如区间/强弱），避免暴露敏感口径（若与业务定义有关，以后端裁剪为准）
- Partner/Admin：允许更精细 legend 与数值区间

硬规则：
- Mode 裁剪必须由后端完成；前端仅按结果呈现与解释（lock + tooltip）。

---

## predicted 规则（必须写）

### 分层表达（强制）

- predicted 热力层必须绑定 `prediction_run_id`（或 active_run 解析后回填并锁定）
- 切换 active_run 后：热力结果与 legend/meta 必须同步刷新，不得混批次

### 缓存 key（强制）

- predicted overlays 的 query key 必含 `prediction_run_id`

---

## 性能与缓存策略

### 地图渲染策略（建议）

优先使用 deck.gl 与 Maps JS API 的 `GoogleMapsOverlay` 集成（官方提供 deck.gl overlay 支持与示例）：

- Google Maps 官方 deck.gl overlay 说明：`https://developers.google.com/maps/documentation/javascript/deckgl-overlay-view?utm_source=gmp-code-assist`
- deck.gl `GoogleMapsOverlay` 文档：`https://deck.gl/docs/api-reference/google-maps/google-maps-overlay`

说明（可在实现阶段择一）：

- interleaved（vector map + WebGL2）：与 3D buildings/标签层更好混合，性能更优
- overlaid：设备或渲染能力不足时的自动降级/兜底

### 请求治理（强制）

- weather layer 的数据刷新只允许由 Orchestration 触发（TanStack Query）
- 变更维度（time_range/weather_type/data_type）必须节流
- hover 不触发任何 dp 请求（红线）

---

## 可观测性

必须记录：

- `dp_overlays_query`（layer=weather，耗时/缓存命中）
- `weather_layer_render_done`（渲染完成时间）
- `weather_layer_toggle`（on/off）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `region_scope/time_range/data_type/weather_type`
- predicted：`prediction_run_id`

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-天气热力图图层.md`
- `docs/v2/v2复用逻辑摘录/RD-图层控制与联动边界.md`
- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`
- `docs/v2/v2复用逻辑摘录/RD-共享类型与接口契约.md`

### 来自 v1 的可复用资产（R0/R1）

- 复用“historical/predicted 分层表达”与“半透明不遮挡底图”的视觉原则，但 v2 必须由后端 overlays 输出驱动。

### 不复用内容（R3）

- 不复用“前端 mock 生成热力数据作为事实源”的模式。

---

## 验收用例（可勾选）

### 分层表达（必须）

- [ ] historical 模式只显示历史热力层；predicted 模式只显示预测热力层（颜色体系区分）。
- [ ] predicted 场景绑定 prediction_run_id；切换 active_run 后热力与 legend 同步刷新，不混批次。

### 性能（必须）

- [ ] 切换 time_range/weather_type/data_type 不产生请求风暴；地图交互不掉帧。
- [ ] hover 0 次 L1/L2 明细重请求。

### 协同（必须）

- [ ] 热力开启时，选中区域描边仍清晰；不遮挡 overlays 的 legend 与关键 UI。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo 模式下 overlays 返回了不该展示的精确数值，前端试图靠隐藏解决。  
硬规则：后端裁剪；前端按裁剪结果呈现（必要时范围化/弱化）。

### 失败模式 B：predicted 混批次

症状：热力层颜色/legend 对应 run A，但 L1/Overlays 其他字段来自 run B。  
硬规则：prediction_run_id 顶层锁定；query key 必含 run_id；legend/meta 必显式包含批次。

---

## 风险与回滚策略

### 风险

- 过度追求复杂渐变/动画 → 掉帧（P0/P1）。
- overlays 维度不全或 legend 缺失 → 前端无法解释口径（P0）。

### 回滚策略

- 优先回滚为“分级色阶 + 半透明”的稳定方案；减少动画与渲染负担。
- 若 legend 缺失：先阻断上线门槛（Overlays 必须输出 legend/meta），避免前端猜口径。

