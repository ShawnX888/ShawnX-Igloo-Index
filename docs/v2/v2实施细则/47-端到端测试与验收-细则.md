# 47 - 端到端测试与验收（Go/No-Go 门槛化）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 47  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-19  
> 最后更新：2026-01-19

---

## 模块名称

端到端测试与验收：把 v2 的功能闭环、三条红线（Mode/批次/风暴）、性能门槛、合规 gate、可观测闭环写成可执行的 E2E 验收矩阵

---

## 目标 / 非目标

### 目标

- 建立统一的 E2E 验收入口与清单：
  - “功能闭环”必过：L0 → 锁区 → L1 →（按 Mode）L2
  - “一致性闭环”必过：同条件下 L0/L1/L2 自洽；predicted 不混批次
  - “安全闭环”必过：Demo/Public 抓包拿不到敏感字段/明细
  - “性能闭环”必过：p95、hover 0 重请求、地图不掉帧
  - “合规闭环”必过：Maps 合规 Gate（Key/CSP/Attribution/预算/代理）
  - “可观测闭环”必过：trace_id/correlation_id 可串联
- 形成测试矩阵（覆盖 Mode × data_type × 关键交互路径）
- 产出可作为发布审批材料的“验收报告结构模板”

### 非目标

- 不规定具体测试框架（Playwright/Cypress/pytest/k6 等），只定义必须覆盖的用例与判定标准。
- 不在本细则补齐所有单元测试（各计算内核/服务已在各自细则定义测试方向）。

---

## 关联的数据产品（Data Product）

E2E 必须覆盖所有对用户可见的数据产品：

- L0 Dashboard
- Overlays
- L1 Region Intelligence
- L2 Evidence（按 Mode）
- AI Insights（卡片/聊天窗/intent）

---

## 输入维度（最小集合）

E2E 用例必须覆盖（至少）：

- `access_mode`：Demo/Public、Partner（若可）、Admin/Internal（若可）
- `data_type`：historical / predicted
- `region_scope/region_code`
- `time_range`
- `weather_type`
- `product_id`（选择/不选择两条路径）
- predicted：`prediction_run_id`

并且每条用例都要能拿到：

- `trace_id/correlation_id`

---

## 输出形态

- E2E 测试矩阵（Checklist）
- Go/No-Go 结论（pass/fail + failed list）
- 验收报告模板（建议）

---

## Mode 规则（必须写）

### Demo/Public（必须覆盖）

- 抓包验证：敏感字段/明细不可得（后端裁剪）
- UI 行为：不可用能力必须“可见但不可用”（解释原因 + 替代路径）
- AI 输出：不得泄露敏感口径，不得建议越权动作

### Partner/Admin（若环境允许，建议覆盖）

- Partner：字段脱敏策略生效
- Admin：审计事件齐全（尤其 Mode/policy_version/active_run）

---

## predicted 规则（必须写）

predicted E2E 必须验证：

- DP 响应显式携带 `prediction_run_id`
- 同一页面链路（L0/L1/Overlays/AI/L2）不混 run_id
- active_run 切换后：
  - 旧缓存不复用
  - 新请求命中新 run
  - 审计与可观测事件齐全

---

## E2E 验收矩阵（可执行 Checklist）

> 每条用例必须带测试记录（截图/日志/trace），且可复现。

### A. 功能闭环（必须）

- [ ] 首屏 10s 内看到 L0（Left HUD Rail：金额 KPI（2项）+ Pareto Top3 +（可选）sparkline + AI Insight）
- [ ] Pareto Click → Map fly-to + lock district（region_code 稳定；默认不自动打开面板）
- [ ] Map Click Lock → L1 最小集刷新（Overview + Timeline）
- [ ] Timeline 三泳道对齐可见（Weather/Risk/Claims）
- [ ] AI Insight Click / CTA → L2（按 Mode）加载并可回指到 Timeline/Map

### B. 三条红线（必须）

#### B1. 权限旁路（Mode）

- [ ] Demo/Public 抓包无法拿到敏感字段/明细（L2/claims/policies）
- [ ] 越权请求行为一致（裁剪返回或明确拒绝），且有审计/日志

#### B2. predicted 混批次

- [ ] predicted 下 L0/L1/Overlays/AI 使用同一 `prediction_run_id`
- [ ] 缓存 key 维度完整（至少 `access_mode` + `prediction_run_id`）

#### B3. 交互风暴

- [ ] hover 0 L1/L2 明细重请求（通过 network 日志/埋点证明）
- [ ] brush/toggle 有节流（单位时间 dp_query 次数不超上限）

### C. 性能门槛（必须）

> 门槛来自 Step 45（如有调整必须版本化）。

- [ ] L0 缓存命中 p95 < 500ms
- [ ] L1 p95 < 1.5s
- [ ] Overlays 缓存命中 p95 < 800ms
- [ ] L2 p95 < 2.5s（按需）
- [ ] 地图主舞台不掉帧（至少提供“卡顿率/掉帧事件”或等价指标）

### D. 合规 Gate（必须）

- [ ] Maps Browser key：Website restrictions + API restrictions 生效
- [ ] Web Service key 不在前端 bundle；所有 Web Service 调用走后端代理
- [ ] CSP 包含 `googleapis.com`，无 Maps CSP 违规
- [ ] Attribution 清晰可见且未被覆盖（截图）
- [ ] 预算告警与用量监控就绪；有异常用量止血预案（演练或记录）

### E. 可观测闭环（必须）

- [ ] 用 `correlation_id` 串起：ui_intent → dp_request → dp_response → ui_render_done
- [ ] AI 链路可追踪：chat_submit → tool_call → intent_proposed → intent_executed/blocked
- [ ] predicted 下每条关键事件都有 `prediction_run_id`
- [ ] Mode 变更/策略版本变更有审计事件（Step 44）

### F. 移动端/低性能降级（必须）

- [ ] reduced-motion 生效（动画默认关闭）
- [ ] 小屏默认至少 Level 1（Step 46），核心闭环仍可完成
- [ ] 触发掉帧后能进入 Level 2/3 并可观测（degrade_level_changed）

---

## 验收报告模板（建议）

- **测试环境**：数据规模、缓存开关、active_run、版本号
- **Mode 覆盖**：Demo/Public（必测）+ Partner/Admin（如可）
- **核心闭环视频/截图**：L0→锁区→L1→L2
- **红线证据**：
  - 抓包证明（Mode）
  - run_id 一致性证明（predicted）
  - hover 0 重请求证明（network/埋点）
- **性能报告**：p95 + cache hit ratio + 关键慢点位
- **合规 Gate 证明**：Key 限制/CSP/Attribution/预算告警截图或配置记录
- **可观测链路**：trace/correlation 示例链接（或日志片段）
- **结论**：pass/fail + failed list + 回滚策略

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`
- `docs/v2/v2复用逻辑摘录/RD-分层职责与协作边界.md`

### 依赖实施细则（强制对齐）

- `docs/v2/v2实施细则/42-Google-Maps-合规Gate落地-细则.md`（合规验收项）
- `docs/v2/v2实施细则/43-可观测性基础设施-细则.md`（观测验收项）
- `docs/v2/v2实施细则/45-性能优化与压测门槛-细则.md`（性能门槛）
- `docs/v2/v2实施细则/46-移动端与低性能降级策略-细则.md`（降级验收）
- `docs/v2/v2实施细则/02-Access-Mode裁剪基线-细则.md`（Mode 验收）
- `docs/v2/v2实施细则/03-Prediction-Run基线-细则.md`（predicted 验收）

---

## 验收用例（可勾选）

- [ ] 完成 A–F 全部 Checklist 且无阻塞项
- [ ] 失败项具备回滚策略并可在 1 天内止血（配置/策略回滚优先）

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo/Public 抓包仍能拿到敏感明细；或 UI 隐藏但接口可直调。  
硬规则：后端强裁剪 + 抓包验收；失败即 P0，禁止上线。

### 失败模式 B：predicted 混批次

症状：同屏出现不同 run_id 的数据；或 active_run 切换后仍命中旧缓存。  
硬规则：run_id 顶层锁定 + 缓存 key 含 run_id + 审计可追溯；失败即 P0。

---

## 风险与回滚策略

### 风险

- 测试只测“功能能跑”，不测红线与合规，导致上线后不可控（P0）。

### 回滚策略

- 任何 P0（权限旁路/混批次/风暴）：
  - 立即收敛能力（禁用 L2、禁用 predicted、强制 Demo 模式）
  - 回滚策略版本（mode_policy_version / capability flags / active_run）
  - 清理缓存并保留审计证据

