# 04 - 时间与时区口径统一 - v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 04  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

时间与时区口径统一（UTC 存储/传输 + region_timezone 业务边界 + local 展示）

---

## 目标 / 非目标

### 目标

- 固化 v2 的时间三层口径：
  - **存储/传输**：UTC（DB TIMESTAMPTZ）
  - **业务判断**：以 `region_timezone`（通常来自 policy 或 region 配置）确定“自然日/月”等边界
  - **前端展示**：用户本地时区（或明确选择的展示时区）
- 把“per day/per month once per policy”等业务规则的时间边界写死：**必须按风险发生地时区**，不能按 UTC。
- 固化 Data Product 的时间维度语义：`time_range` 是“展示窗”，计算可能需要 `calculation_range`（扩展窗口），但响应必须裁剪回展示窗。
- 防止 L0/L1/L2/Overlays/AI 在同一筛选条件下因时区/窗口不一致出现互相矛盾。

### 非目标

- 不在本细则中实现具体代码工具函数（time_utils）；只定义必须满足的口径与接口字段要求。
- 不处理“跨多个时区的单一保单覆盖范围”的复杂业务（如未来出现，需单独扩展规则与数据模型）。

---

## 关联的数据产品（Data Product）

所有数据产品都必须遵守：

- L0 Dashboard（统计口径按 time_range，且与 L1/L2 不矛盾）
- L1 Region Intelligence（Timeline 三泳道对齐）
- L2 Evidence（事件时间与理赔触发时间一致且可追溯）
- Map Overlays（聚合窗口与 legend 说明一致）
- AI Insights（口径说明必须包含时间窗与时区口径）

---

## 输入维度（最小集合）

在 Shared Contract（Step 01）基础上，本模块要求显式引入：

- `time_range`（UTC；展示窗）
- `region_timezone`（业务边界；可由 policy/region 推导，但必须在服务端确定）
- （可选）`calculation_range`（UTC；扩展计算窗，仅用于后端计算，不直接暴露给 UI 作为筛选条件）

---

## 输出形态

### 1) 响应中的时间字段要求（必须）

- 事件类字段统一为 UTC：
  - `event_time_utc` / `timestamp_utc`（命名以 Shared Contract 为准）
- 序列类字段统一为 UTC：
  - Series 的 x 轴时间戳必须是 UTC，前端负责按展示口径转换

### 2) Meta/Legend 必须包含时间口径说明（必须）

每个 Data Product 响应至少包含：

- `time_range`（UTC）
- `region_timezone`（例如 Asia/Shanghai）
- （如使用扩展窗口）`calculation_range`（UTC，仅用于审计/排障，可不展示在 UI，但必须可追溯）

---

## Mode 规则（必须写）

Mode 不改变时间口径，但会影响“能否展示更细时间粒度/明细字段”：

- Demo/Public：可对时间粒度做降级（例如只展示日级趋势），但不得改变时间边界口径。
- Partner/Admin：允许展示更细粒度（小时级/事件级），仍必须以统一 UTC/region_timezone 规则为准。

---

## predicted 规则（必须写）

predicted 不改变时间口径，但必须额外满足：

- predicted 时间轴仍使用 UTC 时间戳，且与 prediction_run_id 绑定（避免“同一未来时刻”在不同 run 的数据混用）。
- AI 在 predicted 下必须明确“预测时间窗”与“批次”，避免把未来预测当作历史事实。

---

## 性能与缓存策略

### 缓存 key 与时间维度（必须）

- `time_range` 必入缓存 key（否则会返回错窗口数据）。
- 对“扩展窗口计算”的场景：
  - 缓存可以以 calculation_range 为底层计算 key，但对外响应必须裁剪到 time_range，并保证相同 time_range 的返回稳定一致。

### L0/L1/L2 一致性红线（必须）

- 同一 `time_range` 下：
  - L0 聚合的时间口径必须与 L1 Timeline 聚合口径一致
  - L2 事件时间必须能回指到 L1 Timeline 的同一 UTC 时间轴位置

---

## 可观测性

每次请求/计算必须记录：

- `time_range`（UTC）
- （如使用）`calculation_range`（UTC）
- `region_timezone`
- `trace_id/correlation_id`
- （如适用）`policy_id`（或其摘要标识）与其 timezone 来源

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-时间与时区口径统一.md`
- `docs/v2/v2复用逻辑摘录/RD-计算窗口与扩展数据.md`（扩展窗口与输出裁剪）

### 来自 v1 的可复用资产（R0/R1）

- 复用“时间窗起点需要扩展数据以保证正确性”的思路；但 v2 必须把时区口径与扩展窗口字段固化为跨端契约。

### 来自 v1 的可复用逻辑（R2）

- 风险计算/理赔计算中的“同一天/同一月”判断逻辑思路可复用，但必须在后端以 region_timezone 为边界实现与测试。

### 不复用内容（R3）

- 任何把“per day”的 day 解释为 UTC day 的实现（会导致跨时区保单错误赔付/解释矛盾）。

---

## 验收用例（可勾选）

### 口径一致性（必须）

- [ ] 同一筛选条件下，L0 KPI、L1 时间轴汇总、L2 事件摘要不互相矛盾（时间边界一致）。
- [ ] Timeline 的三泳道（Weather/Risk/Claims）在同一 UTC 时间轴对齐。

### 时区边界（必须）

- [ ] “per day/per month”判断严格以 region_timezone 的自然日/月边界为准。
- [ ] 跨日/月边界的事件能正确归期，并且解释可追溯（Meta 中包含 region_timezone）。

---

## 风险与回滚策略

### 风险

- 时区口径漂移导致：同一天限制失效/重复理赔、L0/L1/L2 数字对不上、AI 解释断裂。

### 回滚策略

- 一旦发现时区口径错误：优先回滚到“更保守的粒度与更少的可见字段”（Demo 模式下更强摘要），并暂停相关“按天/月”强结论的 AI 输出。
- 对计算结果可回放：保留关键输入维度与 region_timezone，使得可在修复后重算并核对差异。

