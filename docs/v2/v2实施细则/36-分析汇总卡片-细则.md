# 36 - 分析汇总卡片（Overview KPI Cards）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 36  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

分析汇总卡片（Overview KPI Cards）：Region Intelligence Panel 的 Overview section（消费 L1 Region Intelligence Data Product 的 aggregations/meta，Mode-aware）

---

## 目标 / 非目标

### 目标

- 在区域情报面板（Step 26）中提供“少而强”的概览 KPI，支撑路演叙事：
  - 时间窗口（展示窗：UTC→本地显示）
  - 天气指标摘要（单位与口径清晰）
  - 风险摘要（仅选中产品时）
  - 理赔摘要（Mode-aware，敏感口径不泄露）
- 强制“数据产品化”：
  - KPI 必须来自 L1 Region Intelligence Data Product（Step 13）的 Aggregations/Meta
  - 前端禁止自行对明细做重计算/聚合（避免口径漂移）
- 与 v2 红线对齐：
  - Mode 裁剪由后端完成；前端仅负责呈现/禁用解释
  - predicted KPI 必须绑定 prediction_run_id（或 active_run 等价注入），不混批次

### 非目标

- 不在本细则定义 L0 Sidebar 的 KPI（L0 由 Step 21 + Step 11 承接）。
- 不在本细则实现图表与时间轴（由 Step 27/28 承接）。

---

## 关联的数据产品（Data Product）

- L1 Region Intelligence Data Product（Step 13）：Overview aggregations + meta（唯一事实源）
-（可选）Map Overlays（Step 12）：用于 hover mini tooltip 的轻量复用，但不影响 KPI 口径

---

## 输入维度（最小集合）

来自 UI Orchestration（Step 20）的状态域（命名必须与 Shared Contract 一致）：

- `region_scope` / `region_code`
- `time_range`
- `data_type`
- `weather_type`
- `product_id`（可选；风险 KPI 通常需要）
- `access_mode`
- predicted：`prediction_run_id`

---

## 输出形态（UI）

### 1) KPI 卡片集合（建议默认 4–6 张）

> 具体卡片集合可按 Mode 调整信息密度，但必须可解释且稳定。

基础卡（不依赖产品）：

- **Time Window**：展示窗长度（天/小时）+ 起止（本地显示；权威仍是 UTC）
- **Weather Average**：平均值（粒度随产品/口径；由后端给出，带 unit）
- **Weather Total / Peak**：总量或峰值（按 weather_type 决定；由后端给出）

产品相关卡（仅在 `product_id` 存在时启用；否则禁用态可见）：

- **Risk Events Count**：风险事件数量（按 tier 汇总可选）
- **Risk Severity**：最高 tier 或综合 severity（由后端给出，避免前端推断）

理赔相关卡（Mode-aware）：

- **Claims Count**：理赔件数
- **Claims Amount / Rate**：理赔金额合计/理赔率（Demo 可范围化/隐藏，后端裁剪）

### 2) 卡片交互（建议）

- hover：显示 ≤3 指标的轻 tooltip（不触发 L2）
- click（可选）：作为“软导航”滚动到 Timeline 或打开 Correlation（不触发 L2）

---

## Mode 规则（必须写）

### Demo/Public

- 金额类 KPI（coverage/payout）必须范围化/区间化或隐藏（以 L1 后端裁剪为准）
- 风险与理赔的“明细导向”默认关闭：
  - 卡片可点击但只能导航到 Timeline/Correlation（保持解释闭环），不直达 L2 全量明细

### Partner

- 可显示更细 KPI（仍需字段级脱敏与审计策略）。

### Admin/Internal

- 可显示更全 KPI（仍需审计）。

硬规则：
- 后端裁剪；前端隐藏不是权限。

---

## predicted 规则（必须写）

- predicted KPI 必须携带并展示（至少在 debug）：`prediction_run_id`
- KPI 的缓存/刷新必须与 prediction_run_id 绑定（不混批次）
- 与 Step 33 一致：predicted 下无正式 claims 事实时，claims 相关 KPI 必须有明确口径说明（例如只展示 historical claims 或明确显示 N/A；由后端策略决定并在 meta 中说明）

---

## 性能与缓存策略

- KPI 不单独触发额外请求：复用 L1 Data Product 的同一响应
- brush/切产品等高频交互触发 L1 刷新必须节流（由 Orchestration 承接）
- KPI 渲染需避免重渲染（React memo 化、派生状态最小化；不在卡片层做数据变形）

---

## 可观测性

必须记录：

- `kpi_render_done`（card_ids、counts 摘要）
- `dp_l1_region_intelligence_query`（命中/耗时）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `region_scope/region_code`
- `time_range`
- `data_type/weather_type/product_id`
- predicted：`prediction_run_id`

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-分析汇总卡片.md`
- `docs/v2/v2复用逻辑摘录/RD-共享类型与接口契约.md`
- `docs/v2/v2复用逻辑摘录/RD-时间与时区口径统一.md`
- `docs/v2/v2复用逻辑摘录/RD-产品库与规则契约.md`（产品相关 KPI 的启用条件）
- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`

---

## 验收用例（可勾选）

### 口径一致（必须）

- [ ] KPI 来自 L1 Data Product（无前端二次聚合）；与 Timeline/Overlays 的解释口径自洽。

### Mode（必须）

- [ ] Demo/Public 下敏感金额类 KPI 被范围化/隐藏（抓包可验证后端裁剪）。

### predicted（必须）

- [ ] predicted KPI 与页面批次一致（prediction_run_id 不混用），且口径说明清晰。

### 性能（必须）

- [ ] 高频交互下 KPI 不引发额外请求风暴，渲染稳定。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo/Public 仍能拿到精确金额/敏感 KPI，前端只是“没显示”。  
硬规则：后端强裁剪；前端只做降级呈现。

### 失败模式 B：predicted 混批次

症状：KPI 命中旧缓存或 run_id 缺失导致预测口径混乱。  
硬规则：query key 必含 prediction_run_id；响应 meta 显式回填 run_id；渲染层显示口径说明。

---

## 风险与回滚策略

### 风险

- KPI 前端推断口径 → L0/L1/L2 不一致（P0）
- Demo 口径泄露 → 合规/安全事故（P0）

### 回滚策略

- 收敛 KPI 集合到最小背书集（移除金额/明细导向），保证路演稳定
- 发现泄露：立即切换更保守的 mode_policy_version 并清理缓存

