# 23 - 风险事件标记图层（Risk Layer）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 23  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 模块名称

Risk Events Marker Layer（地图风险事件标记：AdvancedMarkerElement / 聚合点；historical vs predicted 分层；与产品规则绑定）

---

## 目标 / 非目标

### 目标

- 在 Map Stage 上以“标记/聚合点”的方式表达风险事件强弱：
  - historical 与 predicted 在视觉上明确区分（颜色系/legend）
  - 标记大小/透明度随“事件数量”变化
  - 选中区域可显示事件数量文本（可读性优先）
- 数据来源必须数据产品化：
  - **禁止**前端从 `risk_events` 明细实时过滤/计数
  - 必须消费后端 `Map Overlays Data Product`（Step 12）提供的 risk markers 聚合输出
- 与产品规则强绑定：
  - 未选中产品：风险标记禁用/不显示（v2 强制）
  - 换产品：口径/阈值/legend 必须同步刷新
- 性能与降级：
  - 动画只允许 transform/opacity，必须限制动画数量
  - 尊重 `prefers-reduced-motion`，弱机/移动端可降级（少标记/无动画）

### 非目标

- 不在本细则实现 L2 明细下钻（由 L2 Evidence/Details 承接）。
- 不在本细则实现后端风险聚合算法（由 Step 12/09/08 承接）。

---

## 关联的数据产品（Data Product）

直接消费：

- Map Overlays Data Product（Step 12）— risk markers 聚合 + legend/meta

间接联动：

- L1 Region Intelligence（Step 13）：锁区后时间轴解释应与 markers 口径一致
- Product Service（Step 05）：产品规则决定风险事件口径与 weather_type

---

## 输入维度（最小集合）

> 维度命名必须与 Shared Contract 一致。

- `region_scope`（overlays 聚合层级）
- `time_range`
- `data_type`（historical/predicted）
- `weather_type`（由产品规则驱动，或由全局选择决定，但必须一致）
- `product_id`（必填：未选中产品时禁用）
- `access_mode`
- predicted：`prediction_run_id`（或 active_run 解析后回填并锁定）

---

## 输出形态

### 视觉输出

- 风险标记（聚合点）：
  - count/maxCount → size/opacity 映射
  - historical vs predicted 配色区分
- Legend/Meta：
  - data_type、（predicted）prediction_run_id
  - product_id + product_version/rules_hash（至少可追溯）
  - weather_type、unit（如需要）

### 交互输出

- hover：tooltip（≤3 指标，来自已加载 overlays），不得触发 L1/L2 重请求
- click（可选）：只产出 UI intent（例如高亮或打开面板定位），不得直接请求 L2

---

## Mode 规则（必须写）

- Demo/Public：
  - 可弱化精度（例如只显示相对强弱/区间）
  - 动效可更强（路演表现），但必须可降级
- Partner/Admin：
  - 可展示更精细的 count/阈值解释（若后端允许）

硬规则：
- Mode 裁剪必须由后端执行；前端按裁剪结果呈现与解释（lock + tooltip）。

---

## predicted 规则（必须写）

- `data_type=predicted` 时：
  - risk markers 必须绑定 `prediction_run_id`（或 active_run 解析后回填）
  - 切换 active_run 后 markers 与 legend/meta 必须同步刷新，不得混批次
- predicted query key 必含 `prediction_run_id`（避免缓存串用）

---

## 性能与缓存策略

### 标记实现（建议）

优先采用 Advanced Markers（官方建议从 legacy Marker 迁移到 `google.maps.marker.AdvancedMarkerElement`，且 legacy `google.maps.Marker` 已在 v3.56（2024-02-21）起 deprecated）：

- Advanced Markers 迁移/加载说明：`https://developers.google.com/maps/documentation/javascript/advanced-markers/migration?utm_source=gmp-code-assist`
  - 动态加载 marker library：`const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");`
  - **Advanced Marker 需要 mapId**（文档要求）

大量标记场景的治理：

- 优先“后端聚合为少量 markers”（v2 推荐）
- 如仍有大量 markers：使用 marker clustering（Google 官方建议使用 `@googlemaps/markerclusterer`）并避免为每个 marker 创建复杂 DOM：
  - 参考优化建议（Markers/cluster）：`https://developers.google.com/maps/optimization-guide?utm_source=gmp-code-assist`

### 联动边界（强制）

- layer toggle 默认只改可见性；如触发 overlays 刷新必须节流
- hover 0 次 L1/L2 明细重请求（红线）

---

## 可观测性

必须记录：

- `dp_overlays_query`（layer=risk_markers，缓存命中/耗时）
- `risk_markers_render_done`（marker_count、anim_enabled、degraded）
- `layer_toggle`（risk_markers on/off）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `time_range/data_type/weather_type/product_id`
- predicted：`prediction_run_id`
- `product_version/rules_hash`（可在 meta 或日志中体现）

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-风险事件标记图层.md`
- `docs/v2/v2复用逻辑摘录/RD-图层控制与联动边界.md`
- `docs/v2/v2复用逻辑摘录/RD-产品库与规则契约.md`
- `docs/v2/v2复用逻辑摘录/RD-多天气类型扩展.md`
- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`

---

## 验收用例（可勾选）

### 功能（必须）

- [ ] 选中产品后显示风险标记；未选产品不显示或为禁用态（可见但不可用）。
- [ ] historical 与 predicted 标记在视觉上可区分；legend/meta 能解释口径与批次。

### 红线（必须）

- [ ] hover 0 次 L1/L2 明细重请求；toggle/刷时间无请求风暴（可观测可证明）。
- [ ] predicted 不混批次：切换 active_run 后同步刷新且 query key 含 run_id。

### 性能（必须）

- [ ] 标记动画有上限且可降级（prefers-reduced-motion/弱机）。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：Demo 模式通过接口拿到不该展示的精确 count/规则解释，前端靠隐藏糊弄。  
硬规则：后端裁剪；前端只按裁剪结果呈现（必要时范围化/弱化）。

### 失败模式 B：predicted 混批次

症状：markers 来自 run A，但 L1/Overlays 其他部分来自 run B。  
硬规则：prediction_run_id 顶层锁定；query key 必含 run_id；legend/meta 必显式包含批次。

---

## 风险与回滚策略

### 风险

- DOM 型 marker 数量过多 → 掉帧（P0/P1）。
- 换产品未同步刷新 → 口径错位（P0）。

### 回滚策略

- 优先回滚为更强聚合（减少 markers）+ 关闭动画；再逐步加回动效与细节。
- 若 markers 与规则错位：强制刷新 overlays 与 legend，并在 Orchestration 中串联 product_version/rules_hash 进行一致性校验。

