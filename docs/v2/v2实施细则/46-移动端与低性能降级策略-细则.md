# 46 - 移动端 / 低性能降级策略（地图主舞台优先）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 46  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-19  
> 最后更新：2026-01-19

---

## 模块名称

移动端/低性能降级：在不破坏 v2 信息架构（L0/L1/L2）的前提下，优先保障 Map Stage 可用与稳定演示，按设备能力/偏好（reduced-motion）/运行时性能指标做渐进降级

---

## 目标 / 非目标

### 目标

- 固化降级矩阵（可执行）：
  - 以“设备/运行态”选择渲染策略（2D/Vector、动画开关、图层密度）
  - 以“功能闭环不破坏”为第一原则：L0→锁区→L1→（按 Mode）L2
- 与 v2 红线对齐：
  - 交互风暴：移动端更严格节流（brush/toggle）
  - 地图主舞台优先：面板展开不得拖慢地图交互
- 可观测：
  - 记录 `degrade_level` 与触发原因（device/perf/reduced_motion）

### 非目标

- 不追求移动端“完全等价 PC 体验”；目标是“能稳定演示 + 核心闭环可用”。
- 不在本细则引入复杂设备指纹；仅用可解释信号（viewport、prefers-reduced-motion、运行时卡顿）与保守策略。

---

## 关联的数据产品（Data Product）

降级策略不改变数据产品契约，但会影响：

- Overlays 的呈现方式（聚合强弱/桶化）
- L1/L2 面板默认展开策略（更倾向摘要）

---

## 输入维度（最小集合）

### 设备/运行态输入（建议）

- `viewport`（宽高、devicePixelRatio）
- `prefers_reduced_motion`（CSS media）
- `network_quality`（可选：effectiveType）
- `runtime_perf`（可选：地图交互卡顿率/掉帧指标）
- `access_mode`
- `capability_flags`

---

## 输出形态

- `degrade_level`：`0`（无）| `1`（轻）| `2`（中）| `3`（重）
- `degrade_reasons[]`：`viewport_small` | `reduced_motion` | `fps_drop` | `high_density` | `memory_pressure`
- `feature_overrides`：对动画/图层/细节/面板默认值的覆盖

---

## Mode 规则（必须写）

- Demo/Public：
  - 默认更保守（更多聚合、更少明细、更少动效）
  - 避免“移动端掉帧导致路演翻车”
- Partner/Admin：
  - 可开放更多，但仍必须尊重 reduced-motion 与运行时降级信号

---

## predicted 规则（必须写）

- predicted 的批次一致性规则不因降级而改变：
  - 仍必须携带 `prediction_run_id`
  - 降级只能改变“怎么画/展示多少”，不能改变“取哪个批次”

---

## 降级矩阵（强制固化）

> 约束来源：`RD-性能优化.md`（动画降级/主舞台优先/reduced-motion）与 `RD-地图模式与动画系统.md`（动画 gate/可取消）。

### Level 0（默认：桌面/性能良好）

- Map：
  - 允许 Vector + 3D Buildings（如启用）
  - 动画开启（可取消）
- Layers：
  - Weather Heatmap / Risk Markers / Claims Overlay 按需启用
  - Markers 允许有限动画（数量上限）
- Panel：
  - 支持 Peek/Half/Full

### Level 1（轻降级：小屏或 reduced-motion）

- Map：
  - 禁用高频 camera 动画（改为快速过渡或减少插值帧）
  - reduced-motion：默认关闭所有装饰性动画
- Layers：
  - 降低 heatmap 点密度/采样
  - markers 关闭动画、降低数量（聚合点优先）
- Panel：
  - 默认 Peek/Half；Full 仅在显式 CTA / AI Insight 触发

### Level 2（中降级：运行时掉帧/设备较弱）

- Map：
  - 强制 2D（或 vector 俯视，tilt=0）
  - 禁止模式切换动画（只允许瞬切）
- Layers：
  - Weather Heatmap 改为更粗粒度（区域级桶化/强弱）
  - Risk/Claims 仅显示 TopN 聚合标记（非全量点）
  - 关闭阴影/高成本效果（如自定义 Canvas 特效）
- Panel：
  - 默认只展示 Overview + Timeline 摘要（减少渲染负担）

### Level 3（重降级：持续卡顿/低内存/网络差）

- Map：
  - 禁止所有非必要 overlay（只留边界高亮 + 基础底图）
  - 显示“性能降级提示”（可关闭）
- Layers：
  - 禁用 risk/claims 明细表现，仅保留 L0/L1 文本/图表
- Panel：
  - 保证 L0→锁区→L1 可用；L2 默认禁用或只摘要

---

## 触发与恢复策略（强制）

### 触发（建议组合）

- `prefers-reduced-motion=true` → 至少 Level 1
- 小屏（viewport 阈值）→ 至少 Level 1
- 连续 `fps_drop` 或交互卡顿率超阈值 → 升级到 Level 2/3

### 恢复

- 仅允许“逐级恢复”（防止抖动），并记录 `degrade_level_changed`

---

## 性能与交互治理（移动端更严格）

- Hover：仍 0 明细重请求
- Brush：移动端默认不开放连续 brush（或必须更强节流，commit 才请求）
- Toggle：默认只改呈现；触发请求必须 debounce 更久
- 动画 gate：移动端默认更保守，`is_animating=true` 期间严禁 commit 重绘

---

## 可观测性

必须记录：

- `degrade_level_changed`（from/to + reasons）
- `map_fps_drop`（可选）
- `ui_render_done`（含 degrade_level）

必带字段：

- `trace_id/correlation_id`
- `access_mode`
- `degrade_level`
- `reasons[]`
- predicted：`prediction_run_id`（如适用）

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`
- `docs/v2/v2复用逻辑摘录/RD-地图模式与动画系统.md`

### 依赖实施细则（强制对齐）

- `docs/v2/v2实施细则/18-Map-Stage基线-细则.md`（主舞台优先与交互边界）
- `docs/v2/v2实施细则/20-UI-Orchestration状态机与联动矩阵-细则.md`（节流与 gate）
- `docs/v2/v2实施细则/45-性能优化与压测门槛-细则.md`（门槛与验证）

---

## 验收用例（可勾选）

### 稳定演示（必须）

- [ ] 在小屏/移动端默认至少 Level 1，核心闭环可完成：L0→锁区→L1→（按 Mode）L2 摘要。
- [ ] reduced-motion 生效：装饰性动画默认关闭。

### 性能（必须）

- [ ] Level 2/3 下地图交互可用且不持续掉帧；切图层不导致明显卡顿。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：移动端用“降级”为由直接在前端拼装/隐藏字段，导致口径与权限混乱。  
硬规则：降级只影响呈现，不改变后端裁剪与契约；权限仍由后端 Mode 裁剪决定。

### 失败模式 B：predicted 混批次

症状：降级路径绕过了 run_id 传播，导致 predicted 下引用旧批次缓存。  
硬规则：降级仅影响渲染密度；请求维度仍必须包含 prediction_run_id。

---

## 风险与回滚策略

### 风险

- 降级策略不稳定（抖动）导致体验闪烁（P1）。
- 移动端掉帧导致路演失败（P0/P1）。

### 回滚策略

- 强制固定到 Level 2（最保守可用集），并提示用户可手动开启高级效果（如允许）。
- 快速关闭动画与高密度 markers（最容易触发掉帧的部分）。

