# 43 - 可观测性基础设施（Trace/Metrics/Logs/Audit）- v2 实施细则

> 对应 `docs/v2/v2实现步骤总览.md` Step 43  
> 状态：Draft（可开工）  
> 版本：v2.0  
> 创建日期：2026-01-19  
> 最后更新：2026-01-19

---

## 模块名称

可观测性基础设施：在 FE/BE/Celery/AI 全链路固化 trace_id/correlation_id 与统一事件命名、结构化日志、指标与审计，保证 v2 的三条红线（Mode/批次/风暴）可以被“证明”和“排障”

---

## 目标 / 非目标

### 目标

- 建立 v2 的可观测“底座契约”（与 Step 01 的字段规范一致）：
  - trace（链路追踪，W3C Trace Context）
  - metrics（核心 SLO：dp_latency/cache_hit/task_latency/地图加载）
  - logs（结构化 JSON logs，可与 trace/span 关联）
  - audit（关键治理动作：active_run 切换/敏感数据访问/导出等）
- 覆盖 v2 核心链路：
  - UI 交互 → UI Orchestration → Data Product 请求 → 返回/渲染完成
  - Celery 任务（风险/理赔/聚合刷新）从入队到写入/刷新缓存
  - AI（聊天窗/AI Insight/intent）从输入到工具调用到 intent 执行/阻断
- 让“最常见失败模式”可被快速定位：
  - Mode 串数据（cache key/裁剪不一致）
  - predicted 混批次（run_id 缺失或混用）
  - 交互风暴（hover/brush 触发重请求）

### 非目标

- 不绑定具体观测后端（Jaeger/Tempo/Datadog/New Relic 等）；只定义 OTLP 输出与字段规范。
- 不在本细则引入复杂 APM 采购/权限策略（可在后续治理文档细化）。

---

## 关联的数据产品（Data Product）

可观测性必须覆盖所有 Data Products 与其缓存/任务链路：

- L0 Dashboard / Overlays / L1 Region Intelligence / L2 Evidence
- AI Insights（由 Router Agent/AI Insight 驱动）

---

## 输入维度（最小集合）

> 维度命名必须与 Shared Contract 一致（Step 01），否则无法跨模块串联排障。

### 1) 统一 Trace/Correlation 字段（强制）

- `trace_id`（来自 tracing 系统）
- `correlation_id`（业务链路 id，建议由前端生成并贯穿：UI→API→Celery→DB）

### 2) 统一业务维度（强制）

- `access_mode`
- `region_scope/region_code`（如适用）
- `time_range`（如适用）
- `data_type`
- `weather_type`
- `product_id`（如适用）
- predicted：`prediction_run_id`（predicted 必须；historical 为空）

### 3) AI/会话维度（强制）

- `session_id`
- `channel`（text|voice）
- `intent_id/intent_type`（如适用）

---

## 输出形态

### 1) Traces（OTel）

- span 级别包含：
  - `name`（统一命名）
  - `attributes`（必带维度 + latency/cache_hit 等）
  - `status`（ok/error + error_code）

### 2) Metrics（最小集）

- `dp_request_count{dp_name,access_mode,data_type,weather_type,product_id}`
- `dp_latency_ms{dp_name}`（p50/p95/p99）
- `dp_cache_hit{dp_name}`（hit/miss）
- `task_latency_ms{task_name}`、`task_retry_count{task_name}`
- `maps_api_load_latency_ms`、`maps_webservice_proxy_latency_ms`（如适用）

### 3) Logs（结构化）

- JSON logs（禁止拼接长文本；字段化）
- 支持自动注入 `trace_id/span_id`，实现 logs ↔ traces 关联（OTel 文档示例强调）

### 4) Audit（关键动作清单）

至少审计：

- predicted：`active_run` 切换（Step 10）
- 敏感接口访问（L2 Evidence，Admin/Partner 深口径）
- 数据写入类动作（claims 写入、风险事件批量写入）
- AI intent 高风险动作（open_details/export 等）的执行/阻断

---

## Mode 规则（必须写）

### Demo/Public

- **日志脱敏更严格**：
  - 不记录用户输入原文（可记录 hash/长度/分类）
  - 不记录可识别明细字段（policy/claim id、精确金额、完整地址）
- **采样更激进**（建议）：
  - traces 采样率更低，但关键失败事件（4xx/5xx、gate fail）必须全量保留

### Partner/Admin

- 可记录更完整的调试字段，但仍需：
  - PII/敏感数据脱敏策略（不可因 Admin 放开而“无限记录”）
  - 审计事件全量（尤其 active_run、export）

---

## predicted 规则（必须写）

硬规则：

- predicted 的所有 dp_* 请求、AI 工具调用、任务写缓存、以及渲染完成事件，都必须带 `prediction_run_id`
- 任一链路事件缺 run_id 视为 P0（可直接阻断或告警）

---

## 事件命名与 Span 命名（统一规范）

> 参考 Step 01/37/40 的建议事件命名，本细则把它固化为“全局字典”。

### 前端（UI / Orchestration）

- `map_loaded`
- `map_hover`（必须轻量，不触发 dp）
- `map_lock`
- `pareto_click`
- `ai_insight_click`
- `time_range_change`
- `timeline_brush_start` / `timeline_brush_commit`
- `weather_type_toggle`
- `layer_toggle`
- `panel_snap_change`
- `ui_render_done`（每次 dp 响应导致的渲染完成都要发）

### 后端（Data Product / Services）

- `dp_l0_dashboard_query` / `dp_l0_dashboard_response`
- `dp_overlays_query` / `dp_overlays_response`
- `dp_l1_region_intelligence_query` / `dp_l1_region_intelligence_response`
- `dp_l2_evidence_query` / `dp_l2_evidence_response`
- `svc_product_list_query` / `svc_policy_query`（可选）

### 任务（Celery）

- `task_risk_event_calc_start/success/fail`
- `task_claim_calc_start/success/fail`
- `task_cache_refresh_start/success/fail`

### AI（Router/Chat/Intent）

- `chat_submit`
- `chat_stream_open/close`
- `ai_tool_call_start/finish`（含 tool_name）
- `ai_intent_proposed`
- `ai_intent_validated`
- `ai_intent_blocked_by_mode`
- `ai_intent_executed`

---

## 技术落地建议（OTel / 传播 / 导出）

官方依据（OpenTelemetry）：

- Python exporters（OTLP HTTP/gRPC）：`https://opentelemetry.io/docs/languages/python/exporters`
- Python propagation（TraceContext/Baggage）：`https://opentelemetry.io/docs/languages/python/propagation`

### 1) Trace Context 传播（强制）

- HTTP：使用 W3C Trace Context（`traceparent`/`tracestate`）
- 业务相关：额外显式传 `x-correlation-id`（或等价 header）
- Celery：任务入参/headers 必须携带 `correlation_id` 与关键维度（与 Step 14 对齐）

### 2) OTLP Export（建议）

- 统一用 OTLP exporter（HTTP 或 gRPC 其一），由 Collector 转发到后端（更换供应商不影响代码）
- service 识别：
  - `service.name` 至少区分：`igloo-api`、`igloo-worker`、`igloo-frontend`（前端可仅事件）

### 3) Logs ↔ Traces 关联（必须）

- 结构化日志必须包含 `trace_id/span_id`（OTel 文档示例强调可实现关联）
- 错误日志必须带：
  - error_code（自定义）
  - http_status（如适用）
  - failed_dimensions（缺失维度列表，尤其 prediction_run_id）

---

## 性能与采样策略

- traces 采样建议：
  - 正常请求采样（低）
  - 失败（4xx/5xx）、越权阻断、混批次、gate fail：全量
- metrics 全量（低成本）
- logs：
  - info 级别可采样（高频事件如 hover）
  - warn/error 全量

---

## 复用声明（必须写清楚）

### Reuse Digest（必填引用）

- `docs/v2/v2复用逻辑摘录/RD-共享类型与接口契约.md`
- `docs/v2/v2复用逻辑摘录/RD-分层职责与协作边界.md`
- `docs/v2/v2复用逻辑摘录/RD-性能优化.md`

### 与既有实施细则的依赖（强制对齐）

- `docs/v2/v2实施细则/01-Shared-Contract基线-细则.md`（字段与事件命名）
- `docs/v2/v2实施细则/14-Celery任务基础设施-细则.md`（任务可观测字段与幂等/锁日志）
- `docs/v2/v2实施细则/03-Prediction-Run基线-细则.md`（批次一致性）

---

## 验收用例（可勾选）

### 全链路（必须）

- [ ] 用 `correlation_id` 可串起：UI intent → dp_request → dp_response → ui_render_done。
- [ ] 用 `trace_id` 可定位：dp 缓存命中/未命中、耗时分布、错误点位。

### Mode（必须）

- [ ] Demo/Public 不记录敏感数据；Partner/Admin 也遵守脱敏策略；审计事件可查。

### predicted（必须）

- [ ] predicted 链路所有关键事件都带 `prediction_run_id`；缺失即告警/阻断。

### 任务（必须）

- [ ] Celery 任务从入队到完成可追踪（task_id + correlation_id），失败原因可复盘（含关键维度）。

---

## 两个“最常见失败模式”（必须写进每个模块）

### 失败模式 A：前端隐藏当权限

症状：日志/埋点记录了 Demo 本不该暴露的敏感明细；或审计缺失导致无法证明越权未发生。  
硬规则：Mode-aware 脱敏；敏感动作必须审计；前端隐藏不等于安全。

### 失败模式 B：predicted 混批次

症状：链路事件缺 `prediction_run_id` 或跨 run 混用，导致“解释断裂但无法定位”。  
硬规则：predicted 必带 run_id；日志/metrics/span attributes 都要带；缺失视为 P0。

---

## 风险与回滚策略

### 风险

- 字段/事件命名不统一导致无法串联排障（P0/P1）。
- 过度记录导致成本与合规风险（PII 泄露）（P0）。

### 回滚策略

- 先收敛：只保留必带字段 + 必要事件（dp_*、task_*、ai_intent_*），暂停非关键埋点。
- 出现敏感泄露：立即提高脱敏级别与采样，回滚日志字段白名单；审计并清理存储（按合规流程）。

