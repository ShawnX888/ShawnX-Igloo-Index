# 12-降雨量热力图图层

## 步骤概述

### 步骤编号和名称
**步骤12**：降雨量热力图图层

### 步骤目标
实现历史降雨量和预测降雨量的热力图图层，使用Data Layer和Polygon实现半透明纯色高亮效果，支持图层切换和动态更新。

### 预期成果
- 历史降雨量热力图图层可以正常显示
- 预测降雨量热力图图层可以正常显示
- 半透明纯色高亮效果正确实现（颜色深浅表示降雨量大小）
- 图层可以根据数据类型动态切换
- 图层可以根据降雨量数据动态更新

---

## 前置条件

### 依赖的步骤
- **步骤10**：地图容器替换（需要地图实例）
- **步骤04**：Mock数据生成器（需要降雨量数据）
- **步骤05**：行政区域数据管理（需要区域边界数据）

### 需要完成的前置工作
- 地图实例已创建
- 降雨量数据已生成
- 区域边界数据已准备

### 需要的数据/接口
- 地图实例：`google.maps.Map`类型
- 降雨量数据：`RegionData`类型（从Mock数据生成器获取）
- 区域边界数据：GeoJSON格式（从步骤05获取）

---

## 实现要点

### 核心功能点

1. **图层1：历史降雨量热力图**
   - 使用Data Layer加载行政区域边界数据
   - 为每个行政区域创建Polygon
   - 根据历史降雨量数据设置颜色和透明度
   - 实现径向渐变效果（从中心往边界逐渐变浅）

2. **图层2：预测降雨量热力图**
   - 使用相同的技术实现
   - 使用不同的颜色系（紫色系，区别于历史数据的蓝色系）
   - 根据预测降雨量数据设置颜色和透明度

3. **半透明纯色高亮效果**
   - 使用半透明纯色填充区域
   - 颜色深浅（透明度）表示降雨量大小
   - 使用半透明设计，不遮挡地图底图

4. **图层切换逻辑**
   - 根据`dataType`动态显示对应图层
   - 历史数据模式：仅显示历史降雨量图层
   - 预测数据模式：仅显示预测降雨量图层

5. **动态更新机制**
   - 当降雨量数据更新时，图层自动更新
   - 使用增量更新，只更新变更的区域
   - 优化性能，避免重复渲染

### 技术实现方案

#### 1. 使用Data Layer + Polygon
```typescript
// 伪代码示例
const dataLayer = new google.maps.Data();

// 加载区域边界数据
dataLayer.loadGeoJson(regionBoundaryData);

// 为每个区域设置样式
dataLayer.setStyle((feature) => {
  const district = feature.getProperty('district');
  const weatherValue = getWeatherData(district);
  
  return {
    fillColor: calculateColor(weatherValue),
    fillOpacity: calculateOpacity(weatherValue),
    strokeColor: '#4285F4',
    strokeWeight: 1,
  };
});
```

#### 2. 半透明纯色高亮效果
使用Google Maps Data Layer的fillOpacity属性实现：
- 根据降雨量数据计算透明度（0.2 ~ 0.8）
- 降雨量越大，透明度越高，颜色越深
- 历史数据使用蓝色系，预测数据使用紫色系

#### 3. 颜色计算
```typescript
// 伪代码示例
function calculateColor(weatherValue: number, type: DataType): string {
  const maxValue = 200; // 最大数值参考值
  const intensity = Math.min(weatherValue / maxValue, 1);
  
  if (type === 'historical') {
    // 蓝色系：从浅蓝到深蓝
    return `rgba(66, 133, 244, ${intensity})`;
  } else {
    // 紫色系：从浅紫到深紫
    return `rgba(147, 51, 234, ${intensity})`;
  }
}
```

### 关键代码结构

#### 热力图图层组件
```typescript
// 伪代码示例
function RainfallHeatmapLayer({
  map,
  regions,
  rainfallData,
  type,
  visible
}: HeatmapLayerProps) {
  const dataLayerRef = useRef<google.maps.Data | null>(null);

  useEffect(() => {
    if (!map) return;
    
    const dataLayer = new google.maps.Data();
    dataLayerRef.current = dataLayer;
    
    // 加载区域数据
    // 设置样式
    // 添加到地图
    
    return () => {
      dataLayer.setMap(null);
    };
  }, [map, regions, rainfallData, type, visible]);

  return null; // 无UI，直接操作地图
}
```

---

## 输入输出

### 输入
- **地图实例**：`google.maps.Map`类型
- **区域数据**：`AdministrativeRegion[]`类型
- **降雨量数据**：`RegionData`类型
- **数据类型**：`DataType`（"historical" | "predicted"）
- **可见性**：`boolean`（控制图层显示/隐藏）

### 输出
- **热力图图层**：显示在地图上的Polygon图层
- **图层实例**：`google.maps.Data`实例（用于后续控制）

---

## 验收标准

### 功能验收标准
- [ ] 历史降雨量热力图可以正常显示
- [ ] 预测降雨量热力图可以正常显示
- [ ] 图层可以根据数据类型正确切换
- [ ] 图层可以根据降雨量数据动态更新
- [ ] 半透明纯色高亮效果正确实现

### 视觉验收标准
- [ ] 颜色透明度正确表示降雨量大小
- [ ] 半透明设计不遮挡地图底图
- [ ] 历史数据使用蓝色系，预测数据使用紫色系

### 性能验收标准
- [ ] 图层渲染时间在1秒内
- [ ] 图层切换流畅，无明显卡顿
- [ ] 数据更新时，图层更新在500ms内完成

---

## 注意事项

### 常见问题
1. **透明度计算不准确**
   - 确保降雨量到透明度的映射逻辑正确
   - 建议使用线性映射或对数映射

2. **性能问题**
   - 大量区域可能导致性能问题
   - 使用图层可见性控制，只渲染可见区域
   - 考虑使用数据采样

3. **颜色计算不准确**
   - 确保颜色计算逻辑正确
   - 考虑使用颜色映射表

### 技术难点
- **透明度映射**：将降雨量数据准确映射到透明度值
- **性能优化**：大量Polygon的渲染和更新需要优化
- **动态更新**：数据更新时如何高效更新图层

### 扩展性考虑
- 图层实现可以提取为独立组件，便于复用
- 颜色计算逻辑可以配置化，便于调整
- 支持未来添加更多数据图层

---

## 下一步

### 后续步骤的准备工作
- 热力图图层已实现，可以在步骤14中使用图层控制功能
- 图层实例已创建，可以在步骤13中添加风险事件标记图层

### 数据/接口的传递
- 图层实例通过ref传递给图层控制组件
- 图层可见性通过props控制

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
