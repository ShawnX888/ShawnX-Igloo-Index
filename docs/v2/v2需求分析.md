# Index Insurance 门户网站 - v2 需求分析文档

> 本文档在 v1 `docs/v2/需求分析.md` 的结构基础上“复制后再修改”，并以 v2 的两份核心文档为准：  
> - `docs/v2/v2页面设计提案.md`（L0/L1/L2 信息架构、交互状态机、Access Mode、导演式联动）  
> - `docs/v2/v2架构升级-全栈方案.md`（全栈边界：products/policies/claims/risk_events/weather、AI Agent、预测批次）

---

## 1. 项目概述

### 1.1 项目背景
打造一个 Index Insurance 专属门户网站（v2），以“地图主舞台 + 态势感知大屏”的方式，直观呈现天气/风险/理赔的联动关系，并支撑多类受众（路演/合作伙伴/内部）在同一套信息架构下获得不同的信息密度与能力集。

### 1.2 项目目标
v2 的核心目标从“前端演示与教育”升级为“全栈可解释态势系统”：

- **态势感知（L0/L1/L2）**：省级态势（L0）→ 区域情报（L1）→ 证据链（L2）分层呈现，且同一条时间轴贯穿。
- **全栈闭环**：产品（products）、保单（policies）、风险事件（risk_events）、理赔（claims）、天气数据（weather）构成可审计的数据闭环。
- **可解释性强**：所有关键数字能回答“为什么”（阈值/事件/时间对齐/口径说明）。
- **多受众模式（Access Mode）**：Demo/Public、Partner、Admin/Internal 三档，影响信息密度与操作能力；**后端必须强制裁剪**避免敏感数据泄露。
- **智能交互升级**：AI 从“聊天回答”升级为“导演式联动”（AI Insight（ticker + pin） + CTA + UI Intent），推动用户进入正确的解释路径而非堆信息。
- **视觉体验与演示稳定性**：地图交互优先，动效有降级路径；路演场景下稳定、可控、可复现。

### 1.3 项目定位
- **产品形态**：Web Application（大屏/路演友好，兼顾桌面端）
- **核心价值**：可解释性（Explainable）+ 可追溯（Traceable）+ 可分级（Mode-aware）
- **阶段策略**：MVP 先跑通“口径一致性 + 预测批次一致性 + Mode 裁剪 + 联动闭环”，不追求预测准确性本身

### 1.4 保险产品的两层定义（v2 口径）
保险产品涵盖两层定义，两者分开、相对独立：

1. **产品级风险事件触发条件**（Product-Level Risk Event Trigger Conditions, `riskRules`）
   - 定义：什么情况触发风险事件，触发风险的级别是什么
   - 用途：用于风险事件计算与可视化（risk）
2. **保单级赔付规则**（Policy-Level Payout Rules, `payoutRules`）
   - 定义：赔付多少金额，赔付频率限制（如“once per day per policy / once per month per policy”）
   - 用途：用于 v2 理赔计算（claims）；同时可用于产品介绍与解释展示

**v2 范围说明**：
- ✅ 计算并可视化产品级风险事件（risk_events）
- ✅ 基于保单与风险事件，生成正式理赔记录（claims，基于历史数据）
- ⚠️ 预测数据可用于风险/叠加/洞察，但**不生成正式 claims**（避免财务事实随预测波动）

### 1.5 非目标（不在 v2 MVP 范围内，必须写清）
- **不承诺“秒级实时全量刷新”**：优先准实时（缓存 + 定时刷新 + 预测批次）。
- **不把 predicted 结果写入正式理赔**：predicted 只能用于解释/叠加/洞察或推演，不生成正式 claims。
- **不承诺“全球任意区域即时可用”**：先支持既有边界数据的可配置国家集，逐步扩展。
- **不以预测准确性为验收目标**：v2 验收重点是“口径一致性、批次一致性、Mode 裁剪、解释闭环与系统稳定性”。

---

## 2. 用户需求分析

### 2.1 目标用户（v2）
- **Demo/Public（路演受众）**：投资人/潜在客户/公众，目标是“10 秒看懂态势 + 1 分钟解释闭环”
- **Partner（合作伙伴）**：保司/渠道/再保/数据合作方，目标是“更深 KPI/Top 导航/对比，有限下钻”
- **Admin/Internal（内部）**：产品/运营/风控/研发，目标是“全量口径、明细追溯、回放与审计”

### 2.2 使用场景（v2）

#### 场景 1：路演态势播报（默认）
- 打开页面 10 秒内看到省级态势（L0：Left HUD Rail 的金额 KPI + Top 导航（Pareto））与地图主舞台的天气/风险动效
- 点击任意区县锁定 → 看到该区的“区域情报面板”入口与 AI Insight（导演提示）

#### 场景 2：区域下钻解释（L1）
- Map Click / Pareto Click 锁定区域
- 通过 “AI Insight Click / CTA” 打开区域情报面板到 Half
- 在统一时间轴上对齐 Weather / Risk / Claims，回答“什么时候开始异常？与风险是否相关？”

#### 场景 3：证据链追溯（L2）
- 在 Details 查看“风险事件 ↔ 理赔信息”的关联（Mode-aware）
- 点击明细回指时间轴，形成闭环解释

#### 场景 4：多口径受众切换（Access Mode）
- Demo/Public：强调解释与叙事，隐藏敏感明细与口径
- Partner：开放更多 KPI/Top 导航与对比能力，明细字段脱敏
- Admin/Internal：全量口径、导出/对比/回滚等能力（后续迭代）

#### 场景 5：预测态势与批次一致性（predicted）
- 切换到 predicted：看到未来一段时间的天气/风险态势
- 预测批次刷新时，前端/AI 不混用不同批次数据（prediction_run_id 一致）

#### 场景 6：AI 导演式联动（降低门槛）
- AI Insight（ticker）输出一句话结论 + CTA（Show on timeline / Overlay thresholds / Compare / Open details）
- 点击 CTA 触发 UI 编排层动作，定位到对应解释路径（而不是只给长文本）

### 2.3 核心价值主张（v2）
- **教育性**：把“指数触发”讲清楚（阈值、窗口、tier、触发）
- **透明性**：可解释、可追溯、口径一致
- **可控演示**：轻/重交互边界明确，避免联动风暴
- **分级输出**：同一 IA，多受众模式下的裁剪与能力矩阵

---

## 3. 功能需求（v2）

> v2 的功能需求以 L0/L1/L2 信息架构为骨架，并映射到页面组件与数据产品契约。

### 3.1 Top Bar（全局控制）
- **全局时间范围**：影响 L0/L1/Overlays；L2 按打开状态决定是否刷新
- **数据类型**：historical / predicted 切换
- **天气类型**：weather_type selector（Demo 模式可限制 1–2 种；其他模式扩展）
- **图层开关**：weather / risk / claims / thresholds（基础开关）
- **AI 状态**：展示 ready/thinking/calling_tool/generating/done，与 UI 同步

### 3.2 Left HUD Rail（L0：省级态势 HUD）
> 说明：L0 不再是“独立侧栏页面”，而是位于 Search Box 下方、左对齐的 HUD Rail（上宽下窄），以“最小背书 + 导航”为主，避免压制地图主舞台。

#### 3.2.1 AI Insight（导演提示，亮点）
- 形态：ticker / carousel（自动轮动；用户点击后 pin + highlight）
- 交互：**AI Insight Click / CTA → 打开 Region Panel 到 Half 并定位 section**（默认 Timeline）
- 原则：AI Insight 不可收起（保持路演叙事入口稳定可见）

#### 3.2.2 KPI Strip（省级背书，金额口径）
- 省级 KPI 固定为 2 个金额：**Total Premium / Total Claims Amount**

#### 3.2.3 Pareto Top3（省级 Top 导航）
- 双条并列展示：Claim Amount（排序主键） + Premium Amount
- 交互：**Pareto Click → Map fly-to + lock district**（作为导航）；默认不自动展开 Region Panel

#### 3.2.4 Claim Trend Sparkline（趋势提示）
- 仅保留 sparkline（轻量趋势提示 + delta），不在 L0 承载完整趋势阅读任务

#### 3.2.5 可收起（A/B 分组）
- Group A（可收起）：KPI Strip + Pareto Top3（可收起为小图标）
- Group B（可收起）：Claim Trend Sparkline（可收起为小图标）

### 3.3 Map Stage（地图主舞台）
#### 3.3.1 区域交互
- Hover（轻交互）：边界高亮 + mini tooltip（≤3 指标），**不得触发重请求**
- Click（锁定，重交互）：锁定选区、必要时 fly-to；Left HUD Rail 高亮选区；AI Insight 状态更新/轮动（节流）；默认不自动展开情报面板

#### 3.3.2 图层体系（Mode-aware）
- Weather Layer：historical 与 predicted 分层表达（颜色/透明度/图例区分）
- Risk Layer：historical 与 predicted 分层表达；与产品 `riskRules` 绑定（阈值/tiers/单位）
- Claims Overlay：Mode-aware（Demo 建议仅聚合弱化，Partner/Admin 可更细）
- Legend：必须清晰表达单位、阈值、tiers、data_type

#### 3.3.3 Product Selector（随 weather_type 过滤）
- 根据当前 weather_type 动态过滤可选产品（仅显示支持该天气类型的产品）
- 产品最多单选 1 个；切换产品会改变 Risk 口径与阈值说明
- 若当前产品不支持新 weather_type：清空选中并提示

### 3.4 Region Intelligence Panel（L1/L2：区域情报面板）
#### 3.4.1 Snap points
- Peek(20%) → Half(45%) → Full(80~90%)

#### 3.4.2 Sections
- Overview / Timeline / Correlation / Details 四个 section（可用 sticky nav）

#### 3.4.3 Timeline（三泳道对齐）
- Weather / Risk / Claims 三泳道在同一时间轴对齐
- 支持 brush；brush 会同步影响 L0/L1/Overlays（需节流）

#### 3.4.4 Details（证据链，Mode-aware）
- Demo/Public：默认隐藏或仅摘要（聚合/脱敏）
- Partner：字段级脱敏（可配置）
- Admin/Internal：全量明细（后续迭代）

### 3.5 Access Mode（模式矩阵：可见/可用/默认展开）
模式定义：
- Demo/Public（默认）
- Partner
- Admin/Internal

核心原则：
- **被禁用的能力“可见但不可用”**（lock + tooltip），避免路演断流
- **前端隐藏不是权限**：后端必须强制裁剪字段与口径，并对越权请求一致处理

---

## 4. 数据需求（v2）

### 4.1 数据对象（概念级，不展开细字段）
- **products**：`riskRules` + `payoutRules`（产品配置权威来源）
- **policies**：保单（覆盖区域、保额、timezone 等）
- **risk_events**：风险事件（historical/predicted；tier；触发值/阈值；predicted 绑定 prediction_run_id）
- **prediction_runs**：预测批次元信息（active/archived/failed；用于切换与回滚）
- **claims**：正式理赔记录（仅基于历史数据生成）
- **weather data**：历史/预测天气数据（按 weather_type 扩展）

### 4.2 数据产品（L0/L1/L2/Overlays）的输入维度（强制统一）
任何数据产品请求必须携带/推导以下维度（按场景取值）：
- `region_scope`（province/district）
- `region_code`（统一编码）
- `time_range`
- `data_type`（historical/predicted）
- `weather_type`
- `product_id`（可选）
- `access_mode`
- `prediction_run_id`（仅 predicted）

### 4.2.1 数据产品目录（用于后续接口与任务拆解）
> 目的：把 L0/L1/L2/Overlays 从“UI 组件”提升为“可交付的数据产品”，让后续拆解可以直接落到接口、缓存与验收。

| 数据产品 | 层级 | 目的 | 输出形态 | 必选输入维度（除 region_code/time_range 外） | Mode 影响 | predicted 约束 |
|---|---|---|---|---|---|---|
| L0 Dashboard（省级态势） | L0 | “10 秒内一眼看到态势”：金额 KPI + Top 导航（Pareto） | 聚合 + Top 导航 | region_scope=province、data_type、weather_type（可选）、access_mode | Demo 可范围化/隐藏敏感口径；Partner 更细；Admin 全量 | predicted 必须携带 prediction_run_id（或由 active_run 解析） |
| L1 Region Intelligence（区域情报） | L1 | “可解释”：概览 + 趋势 + 统一时间轴三泳道 | 时间序列 + 轻量聚合 | data_type、weather_type、product_id（可选）、access_mode | Demo 裁剪/摘要；Partner 脱敏；Admin 全量 | 同上（不得混批次） |
| L2 Evidence（证据链） | L2 | “可追溯”：风险事件 ↔ 理赔关联 | 明细/半明细 + 关联 | data_type、weather_type、product_id（可选）、access_mode | Demo 默认隐藏或仅摘要；Partner 脱敏；Admin 全量 | 若允许展示 predicted evidence，必须绑定 prediction_run_id（且默认不预取） |
| Map Overlays（地图叠加） | Map | 直接可渲染的聚合结果 + legend 元信息 | 渲染聚合（区域/网格/hex） | region_scope、data_type、weather_type、product_id（可选）、access_mode | Demo 避免暴露敏感金额粒度；必要时只出强弱 | predicted 与批次绑定失效；legend 必须体现批次/口径 |
| AI Insights（AI Insight） | AI | 一句话结论 + 可执行 CTA（导演式联动） | 文本 + UI Intent | 依赖 L0/L1（以及打开 L2 时） | Demo 避免敏感结论与越权 CTA | predicted 必须与页面批次一致（避免解释断裂） |

### 4.2.2 缓存与 SLO（需求级硬约束）
- **缓存 key 必须包含会改变口径/结果集的维度**：至少包含 `access_mode`；predicted 场景必须额外包含 `prediction_run_id`（或 active_run 标识）。
- **Hover 不触发重请求**：Hover 仅使用已加载的轻量数据或缓存命中数据，严禁直接打明细查询。
- **默认策略**：
  - L0 与 Overlays：强缓存优先（命中 p95 < 500ms / 800ms 量级）
  - L1：可缓存但需可复用（交互刷新稳定优先）
  - L2：默认不预取，按需加载（允许更高延迟但必须可解释且 Mode-aware）

### 4.3 预测数据版本化（predicted）
predicted 数据“会变”，必须区分批次并避免混用：
- 每次预测刷新生成新的 `prediction_run_id`
- 存在可切换的 `active_run`
- 缓存失效必须与 prediction_run 切换绑定
- 前端/AI 在同一请求链路中不得混用不同 prediction_run 的数据

---

## 5. 交互需求（v2）

### 5.1 状态机（S0-S3）
以 v2 页面设计的状态机为准：
- S0 初始（Left HUD Rail 可见；Region Panel Collapsed/Peek）
- S1 区域锁定（Map lock；HUD 高亮选区；AI Insight 状态更新/轮动（节流））
- S2 情报面板打开（Half，定位到目标 section）
- S3 分析模式（Full，sticky nav）

### 5.2 轻/重交互边界（避免请求风暴）
- Hover：只做高亮与轻量 tooltip，禁止触发 L1/L2 明细请求
- Click lock / Pareto click：允许触发 L1 最小集（但默认不打断打开面板）
- “AI Insight Click / CTA”：允许触发 L2（按需加载）

### 5.3 联动矩阵（摘要版）
必须支持以下关键联动：
- Pareto Click → Map fly-to + lock district
- AI Insight Click / CTA → 打开 Region Panel 到 Half 并定位到指定 section
- Timeline brush → L0/L1/Overlays 同步更新（节流）
- Weather Type Toggle → Map 图层、产品列表、Timeline 泳道同步更新

---

## 6. UI/UX 需求（v2）

### 6.1 视觉风格
- 深色大屏风格（指挥中心感）
- 地图主舞台优先，左侧为“态势播报台”，底部为“情报面板”

### 6.2 渐进披露与动效降级
- 默认简洁：L0 + Map + Panel Peek
- L2 明细按需加载
- 动效尊重 `prefers-reduced-motion`，移动端/低性能设备降级

---

## 7. 非功能需求（v2）

### 7.1 性能与稳定性（必须量化并验收）
- 地图交互优先：pan/zoom/hover 不掉帧
- 高频交互（切区域/刷时间/切天气/切产品）必须节流、防抖、可缓存
- **建议验收目标（可调整，但必须量化）**：
  - L0 数据（缓存命中）：p95 < 500ms
  - Overlays（缓存命中）：p95 < 800ms
  - L1（冷/热混合）：p95 < 1.5s（稳定优先）
  - L2（按需加载）：p95 < 2.5s（可接受但必须可追溯）
  - Hover：0 次“明细重请求”，且不得触发请求风暴

### 7.2 安全与合规
- Access Mode 后端强制裁剪（禁止仅靠前端隐藏）
- Google Maps：Key 限制、attribution、缓存限制、成本/配额监控（以 v2 方案落地）

### 7.3 可观测性
- 关键链路可追踪：用户动作 → 数据产品请求 → 缓存/DB → 渲染完成
- 预测批次切换可审计（active_run 变更原因/时间/操作者）

### 7.4 可靠性与幂等
- 风险/理赔等重计算不得阻塞 API event loop，需异步化
- 任务重试不产生重复 risk_events/claims（幂等写）

---

## 8. 约束条件（v2）
- **区域覆盖**：先支持既有边界数据的可配置国家集（逐步扩展），不承诺“全球任意区域”
- **产品选择**：单选 1 个产品叠加（MVP）
- **Mode 默认**：Demo/Public 默认；Mode 来源需可审计
- **预测 vs 正式理赔**：predicted 不生成正式 claims

---

## 9. 验收标准（v2）

### 9.1 功能验收
- [ ] L0（Left HUD Rail）：AI Insight（ticker + pin）可用；金额 KPI（Total Premium / Total Claims Amount）可用；Pareto Top3（dual bars，claim 排序）可用，且 Pareto Click 能驱动 Map 锁定（不自动开面板）
- [ ] Map：Weather/Risk/Claims 图层可控，Legend 清晰表达单位/阈值/tiers/data_type
- [ ] L1：Region Panel 的 Overview/Timeline 可用，三泳道对齐
- [ ] L2：Details 在不同 Mode 下按规则隐藏/脱敏/全量
- [ ] AI：AI Insight + CTA 能触发 UI 联动并定位到解释路径（点击后打开到 Half）

### 9.2 一致性与批次验收（predicted）
- [ ] predicted 场景：所有请求显式携带 prediction_run_id（或通过 active_run 解析），不混用不同批次
- [ ] active_run 切换后：缓存失效并刷新到新批次结果

### 9.3 权限与模式验收（Access Mode）
- [ ] Demo/Public 下：敏感字段与明细不可通过接口获取（后端强裁剪）
- [ ] Partner/Admin 下：能力与字段按矩阵开放，越权请求响应一致且可审计

### 9.4 性能与稳定性验收
- [ ] Hover 不触发重请求；刷时间/切产品无请求风暴
- [ ] 地图交互流畅；面板展开不影响主舞台可用性

### 9.5 可观测与合规验收（必须有“可证明”结果）
- [ ] 核心链路可追踪：用户动作 → 数据产品请求 → 缓存/DB 命中 → 渲染完成（具备 trace_id/correlation_id）
- [ ] predicted：active_run 切换有审计记录（何时/为何/谁），且切换后不会混批次
- [ ] Access Mode：Demo/Public 下敏感明细无法通过接口获取（后端强裁剪可验证）
- [ ] Google Maps：前端 Key 具备 referrer + API scope 限制，且具备用量/预算监控（验收提供截图或配置记录）

---

## 10. 附录

### 10.1 术语表（v2）
- **L0/L1/L2**：省级态势 / 区域情报 / 证据链
- **Access Mode**：Demo/Public、Partner、Admin/Internal
- **Data Product**：面向场景的数据输出形态（L0/L1/L2/Overlays）
- **prediction_run_id / active_run**：预测批次标识 / 当前对外展示批次
- **Director Cues**：AI Insight（ticker + pin） + CTA 驱动 UI 联动

---

**文档版本**：v2.0  
**创建日期**：2026-01-15  
**最后更新**：2026-01-15  

