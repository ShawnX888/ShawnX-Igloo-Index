# v2 实现步骤总览

> 状态：Verified  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 0. 前置与真源

- **真源**：`v2需求分析.md`、`v2页面设计提案.md`、`v2架构升级-全栈方案.md`、`v2技术方案.md`
- **迁移导航**：`v2迁移分层矩阵.md`
- **复用承接**：R0/R1 必须先有 `v2复用逻辑摘录/RD-*.md`，再写实施细则
- **复用索引**：`v2复用逻辑摘录/README.md`（包含全部 24 个 RD 文件的分类索引与推荐阅读顺序）
- **开发进度真源**：`v2项目开发进度.md`（跟踪“代码实现/联调/验收”；并记录每一步对应的实施细则路径）
- **实施细则真源**：`docs/v2/v2实施细则/`（47/47 已完成；执行期以此为每一步“怎么做/验收锚点/风险点”的主依据）

---

## 0.1 实施细则索引（47/47）

> 目的：让执行 agent 能从“步骤总览”直接跳到对应实施细则，避免信息丢失或口径漂移。  
> 说明：以下索引按 `v2项目开发进度.md` 的映射与 `docs/v2/v2实施细则/` 实际文件名对齐。

### Phase 0：契约基线 + 红线固化（01-04）

| 步骤编号 | 步骤名称 | 实施细则（真源） |
|---:|---|---|
| 01 | Shared Contract 基线（维度/DTO/口径） | `docs/v2/v2实施细则/01-Shared-Contract基线-细则.md` |
| 02 | Access Mode 裁剪基线（后端输出裁剪规则） | `docs/v2/v2实施细则/02-Access-Mode裁剪基线-细则.md` |
| 03 | Prediction Run 基线（active_run / run_id 传播） | `docs/v2/v2实施细则/03-Prediction-Run基线-细则.md` |
| 04 | 时间与时区口径统一 | `docs/v2/v2实施细则/04-时间与时区口径统一-细则.md` |

### Phase 1：后端数据产品最小可用（05-15）

| 步骤编号 | 步骤名称 | 实施细则（真源） |
|---:|---|---|
| 05 | 产品表 + Product Service | `docs/v2/v2实施细则/05-产品表与Product-Service-细则.md` |
| 06 | 保单表 + Policy Service | `docs/v2/v2实施细则/06-保单表与Policy-Service-细则.md` |
| 07 | 天气数据表 + Weather Service | `docs/v2/v2实施细则/07-天气数据表与Weather-Service-细则.md` |
| 08 | Risk Calculator（计算内核） | `docs/v2/v2实施细则/08-Risk-Calculator计算内核-细则.md` |
| 09 | 风险事件表 + Risk Service | `docs/v2/v2实施细则/09-风险事件表与Risk-Service-细则.md` |
| 10 | 预测批次表 + Prediction Run Service | `docs/v2/v2实施细则/10-预测批次表与Prediction-Run-Service-细则.md` |
| 11 | L0 Dashboard Data Product | `docs/v2/v2实施细则/11-L0-Dashboard数据产品-细则.md` |
| 12 | Map Overlays Data Product | `docs/v2/v2实施细则/12-Map-Overlays数据产品-细则.md` |
| 13 | L1 Region Intelligence Data Product | `docs/v2/v2实施细则/13-L1-Region-Intelligence数据产品-细则.md` |
| 14 | Celery 任务基础设施 | `docs/v2/v2实施细则/14-Celery任务基础设施-细则.md` |
| 15 | 风险事件计算任务 | `docs/v2/v2实施细则/15-风险事件计算任务-细则.md` |

### Phase 2：前端联动闭环（16-29）

| 步骤编号 | 步骤名称 | 实施细则（真源） |
|---:|---|---|
| 16 | 项目结构与类型定义（Next.js） | `docs/v2/v2实施细则/16-前端项目结构与类型定义-细则.md` |
| 17 | Google Maps API 配置与初始化 | `docs/v2/v2实施细则/17-Google-Maps-API配置与初始化-细则.md` |
| 18 | Map Stage 基线（加载/交互/图层框架） | `docs/v2/v2实施细则/18-Map-Stage基线-细则.md` |
| 19 | 行政区域边界渲染与选区交互 | `docs/v2/v2实施细则/19-行政区域边界渲染与选区交互-细则.md` |
| 20 | UI Orchestration（状态机 + 联动矩阵） | `docs/v2/v2实施细则/20-UI-Orchestration状态机与联动矩阵-细则.md` |
| 21 | L0（Left HUD Rail，省级态势 HUD） | `docs/v2/v2实施细则/21-L0-Sidebar省级态势抽屉-细则.md` |
| 22 | 天气热力图图层 | `docs/v2/v2实施细则/22-天气热力图图层-细则.md` |
| 23 | 风险事件标记图层 | `docs/v2/v2实施细则/23-风险事件标记图层-细则.md` |
| 24 | 控制面板（Top Bar） | `docs/v2/v2实施细则/24-控制面板Top-Bar-细则.md` |
| 25 | 产品选择器 | `docs/v2/v2实施细则/25-产品选择器Product-Selector-细则.md` |
| 26 | Region Intelligence Panel 基础结构 | `docs/v2/v2实施细则/26-Region-Intelligence-Panel基础结构-细则.md` |
| 27 | 统一时间轴（三泳道对齐） | `docs/v2/v2实施细则/27-统一时间轴三泳道对齐-细则.md` |
| 28 | 图表可视化（Weather/Risk/Claims） | `docs/v2/v2实施细则/28-图表可视化-细则.md` |
| 29 | GPS 定位与反向地理编码 | `docs/v2/v2实施细则/29-GPS定位与反向地理编码-细则.md` |

### Phase 3：L2 + Mode + AI 闭环（30-41）

| 步骤编号 | 步骤名称 | 实施细则（真源） |
|---:|---|---|
| 30 | 理赔表 + Claim Service | `docs/v2/v2实施细则/30-理赔表与Claim-Service-细则.md` |
| 31 | Claim Calculator（Tier 差额逻辑） | `docs/v2/v2实施细则/31-Claim-Calculator计算内核-细则.md` |
| 32 | 理赔计算任务 | `docs/v2/v2实施细则/32-理赔计算任务-细则.md` |
| 33 | L2 Evidence Data Product | `docs/v2/v2实施细则/33-L2-Evidence数据产品-细则.md` |
| 34 | Claims Overlay | `docs/v2/v2实施细则/34-Claims-Overlay图层-细则.md` |
| 35 | L2 Details 面板 | `docs/v2/v2实施细则/35-L2-Details面板-细则.md` |
| 36 | 分析汇总卡片（Overview） | `docs/v2/v2实施细则/36-分析汇总卡片-细则.md` |
| 37 | Router Agent（NLU + 路由 + 格式化） | `docs/v2/v2实施细则/37-Router-Agent-细则.md` |
| 38 | Expertise Agents（Product/Risk/Policy） | `docs/v2/v2实施细则/38-Expertise-Agents-细则.md` |
| 39 | AI Insight（ticker + pin） | `docs/v2/v2实施细则/39-AI-Insight-Cards-细则.md` |
| 40 | AI CTA → Orchestration 联动 | `docs/v2/v2实施细则/40-AI-CTA到Orchestration联动-细则.md` |
| 41 | AI 聊天窗（保留入口） | `docs/v2/v2实施细则/41-AI聊天窗（保留入口）-细则.md` |

### Phase 4：合规 + 观测 + 优化（42-47）

| 步骤编号 | 步骤名称 | 实施细则（真源） |
|---:|---|---|
| 42 | Google Maps 合规 Gate 落地 | `docs/v2/v2实施细则/42-Google-Maps-合规Gate落地-细则.md` |
| 43 | 可观测性基础设施 | `docs/v2/v2实施细则/43-可观测性基础设施-细则.md` |
| 44 | Mode 默认值/审计/回滚 | `docs/v2/v2实施细则/44-Mode默认值与审计回滚-细则.md` |
| 45 | 性能优化（缓存/预聚合/节流） | `docs/v2/v2实施细则/45-性能优化与压测门槛-细则.md` |
| 46 | 移动端/低性能降级 | `docs/v2/v2实施细则/46-移动端与低性能降级策略-细则.md` |
| 47 | 端到端测试与验收 | `docs/v2/v2实施细则/47-端到端测试与验收-细则.md` |

---

## 1. 实现策略

### 1.1 分阶段实现原则

1. **契约先行**：先立"Shared Contract + 数据产品边界"，再做 FE/BE 并行
2. **增量闭环**：任何阶段都必须可演示/可验收（End-to-End 增量闭环）
3. **高风险优先**：Mode 裁剪、predicted 批次一致性、hover 红线、CPU 隔离必须尽早纳入验收

### 1.2 End-to-End 增量闭环原则

每个里程碑至少跑通一次：
```
L0（省级态势） → 锁区（Map Click / Pareto Click） → L1（区域情报） →（按 Mode）L2（证据链）
```

### 1.3 原子化与可验收原则

每个步骤必须绑定验收锚点：
- **Data Product**：L0 / L1 / L2 / Overlays / AI Insights
- **Access Mode**：后端强裁剪可验证
- **Prediction Run**：批次一致性可追溯
- **Perf-SLO**：p95 目标 + hover 0 重请求
- **Compliance**：Google Maps 合规 Gate
- **Observability**：trace_id/correlation_id 全链路

---

## 2. 泳道与阶段划分

### 2.1 泳道定义

| 泳道 | 说明 | 主要产出 |
|---|---|---|
| **Lane A: Shared Contract** | 维度/枚举/DTO/缓存 key/Mode 裁剪规则 | 跨端契约文档 + 类型定义 |
| **Lane B: Backend** | products/policies/claims/risk_events/prediction_runs + Data Products + Tasks | API(读) + 服务 + 任务 |
| **Lane C: Frontend** | UI Orchestration + Map Stage + L0/L1/L2 UI | 前端组件 + 状态管理 |
| **Lane D: Governance** | 合规 gate、观测、发布治理 | 配置 + 监控 + 审计 |
| **Lane E: AI** | 聊天窗、AI Insight、Intent 执行链路 | Agent + Tool Calling + CTA 联动 |

### 2.2 阶段划分

| 阶段 | 目标 | 包含泳道 | 里程碑验收 |
|---|---|---|---|
| **Phase 0** | 契约基线 + 红线固化 | A + 部分 D | 契约可供 FE/BE 独立开发 |
| **Phase 1** | 后端数据产品最小可用 | B | L0/L1/Overlays API 可调用 |
| **Phase 2** | 前端联动闭环 | C | Map + L0 + 锁区 + L1 timeline |
| **Phase 3** | L2 + Mode + AI 闭环 | B + C + E | 全链路 Mode-aware + AI CTA |
| **Phase 4** | 合规 + 观测 + 优化 | D + 全部 | 生产就绪 |

---

## 3. 步骤列表（详细）

> 编号用于 `v2实施细则` 的文件编号：`docs/v2/v2实施细则/<编号>-<模块名>-细则.md`（见上文“实施细则索引（47/47）”）

### Phase 0：契约基线 + 红线固化

| 步骤编号 | 步骤名称 | 泳道 | 依赖 | Reuse Type | 交付对象 | 验收锚点 | 风险点/注意事项 |
|---:|---|---|---|---|---|---|---|
| 01 | Shared Contract 基线（维度/DTO/口径） | A | — | — | 类型定义文档 + TypeScript/Pydantic 类型 | Consistency / Observability | 必须包含所有数据产品的输入维度 |
| 02 | Access Mode 裁剪基线（后端输出裁剪规则） | A + B | 01 | — | 裁剪策略矩阵 + 接口设计 | Access Mode / Security | 字段级/粒度级/能力级裁剪 |
| 03 | Prediction Run 基线（active_run / run_id 传播） | A + B | 01 | — | 批次管理契约 + DB 设计 | Prediction Run / Consistency | 缓存 key 必含批次 |
| 04 | 时间与时区口径统一 | A | 01 | R1 | 时间处理规范 | Consistency | UTC 存储/region_tz 业务边界/local 展示 |

**复用逻辑摘录引用**（跨模块口径/系统红线）：
- `RD-分层职责与协作边界.md` — FE/BE/Shared Contract 职责边界
- `RD-共享类型与接口契约.md` — 输入维度/DTO/枚举定义
- `RD-时间与时区口径统一.md` — UTC 存储/region_tz 业务边界/local 展示
- `RD-计算窗口与扩展数据.md` — 扩展窗口计算规则
- `RD-多天气类型扩展.md` — weather_type 枚举与扩展策略
- `RD-性能优化.md` — 缓存策略/节流边界/预聚合

### Phase 1：后端数据产品最小可用

| 步骤编号 | 步骤名称 | 泳道 | 依赖 | Reuse Type | 交付对象 | 验收锚点 | 风险点/注意事项 |
|---:|---|---|---|---|---|---|---|
| 05 | 产品表 + Product Service | B | 01 | R2 | products 表 + API | Data Product | riskRules/payoutRules 分离 |
| 06 | 保单表 + Policy Service | B | 05 | R2 | policies 表 + API(读) | Data Product | 写入由内部任务/修复链路承接 |
| 07 | 天气数据表 + Weather Service | B | 01 | R2 | historical_weather_data 表 + API | Data Product | Mock 生成 + 未来真实接口 |
| 08 | Risk Calculator（计算内核） | B | 05, 07 | R2 | 纯计算模块 | CPU-Isolation | 不依赖 DB Session |
| 09 | 风险事件表 + Risk Service | B | 08 | R2 | risk_events 表 + API(读) | Data Product / Prediction Run | 写入由计算任务批量落库 |
| 10 | 预测批次表 + Prediction Run Service | B | 09 | R2 | prediction_runs 表 + active_run 切换 | Prediction Run | 支持回滚 |
| 11 | L0 Dashboard Data Product | B | 05, 06, 09 | R2 | L0 KPI/Pareto API | Perf-SLO | 强缓存/预聚合 |
| 12 | Map Overlays Data Product | B | 05, 07, 09 | R2 | Overlays API | Perf-SLO | 服务端聚合 |
| 13 | L1 Region Intelligence Data Product | B | 05, 07, 09 | R2 | L1 Timeline 三泳道 API | Data Product | 缓存可复用 |
| 14 | Celery 任务基础设施 | B | 07, 08 | R2 | Celery Worker/Beat 配置 | Reliability | 幂等 + 并发控制 |
| 15 | 风险事件计算任务 | B | 08, 09, 14 | R2 | 定时任务 | Reliability | predicted 在天气同步时触发 |

**复用逻辑摘录引用**（产品/规则/计算/数据源）：
- `RD-产品库与规则契约.md` — riskRules/payoutRules 分离、timeWindow 语义
- `RD-风险计算引擎核心与策略.md` — 计算内核职责、事件模型、CPU 隔离
- `RD-风险分析统一入口与聚合输出.md` — 后端唯一事实源、输出分层
- `RD-天气数据源与Mock生成.md` — Mock 生成规则、未来真实接口边界

### Phase 2：前端联动闭环

| 步骤编号 | 步骤名称 | 泳道 | 依赖 | Reuse Type | 交付对象 | 验收锚点 | 风险点/注意事项 |
|---:|---|---|---|---|---|---|---|
| 16 | 项目结构与类型定义（Next.js） | C | 01 | R1 | 前端项目骨架 | — | Zustand + TanStack Query |
| 17 | Google Maps API 配置与初始化 | C | 16 | R1 | 地图加载模块 | Compliance | Key 限制 + 版本策略 |
| 18 | Map Stage 基线（加载/交互/图层框架） | C | 17 | R1 | 地图主舞台组件 | Perf-SLO / Compliance | 地图优先 |
| 19 | 行政区域边界渲染 | C | 18, 12 | R1 | Region Boundary 图层 | Perf-SLO | hover 0 重请求 |
| 20 | UI Orchestration（状态机 + 联动矩阵） | C | 16 | R1 | 状态管理架构 | Perf-SLO / Observability | 唯一事实来源 |
| 21 | L0（Left HUD Rail，省级态势 HUD） | C | 11, 20 | R1 | L0 UI（HUD）组件 | Data Product | 金额 KPI（2项）+ Pareto Top3 +（可选）sparkline |
| 22 | 天气热力图图层 | C | 12, 18 | R1 | Weather Layer | Prediction Run | 历史/预测分层表达 |
| 23 | 风险事件标记图层 | C | 12, 18 | R1 | Risk Layer | Data Product | 与产品规则绑定 |
| 24 | 控制面板（Top Bar） | C | 20 | R1 | 全局控制组件 | — | 时间/天气类型/图层开关 |
| 25 | 产品选择器 | C | 05, 24 | R1 | Product Selector | Data Product | 随 weather_type 过滤 |
| 26 | Region Intelligence Panel 基础结构 | C | 13, 20 | R1 | L1/L2 Bottom Sheet | Data Product | Peek/Half/Full snap |
| 27 | 统一时间轴（三泳道对齐） | C | 13, 26 | R1 | Timeline 组件 | Data Product | Weather/Risk/Claims 对齐 |
| 28 | 图表可视化（Weather/Risk/Claims） | C | 13, 27 | R1 | 图表组件 | Data Product | Recharts |
| 29 | GPS 定位与反向地理编码 | C | 18, 20 | R1 | 定位模块 | Compliance | 节流/限流/降级 |

**复用逻辑摘录引用**（地图与区域体验编排 + 面板/可视化）：

*地图与区域体验编排（Map Stage / Region）*：
- `RD-地图主舞台.md` — Maps API 加载、图层框架、交互原则
- `RD-地图模式与动画系统.md` — 动画期间禁止重请求/重绘
- `RD-行政区域数据管理与名称映射.md` — region_code/region_scope 统一
- `RD-行政区域边界与选区交互.md` — hover/click 交互边界
- `RD-图层控制与联动边界.md` — 图层开关与联动矩阵
- `RD-天气热力图图层.md` — 历史/预测分层表达
- `RD-风险事件标记图层.md` — 与产品规则绑定
- `RD-GPS定位与反向地理编码.md` — 定位链路、合规与成本约束

*面板/可视化/页面联动（前端交互与呈现）*：
- `RD-控制面板.md` — Top Bar 全局控制
- `RD-数据面板基础结构.md` — Region Intelligence Panel 结构
- `RD-图表可视化.md` — Timeline 三泳道、图表组件
- `RD-页面间联动.md` — 联动矩阵、状态机

### Phase 3：L2 + Mode + AI 闭环

| 步骤编号 | 步骤名称 | 泳道 | 依赖 | Reuse Type | 交付对象 | 验收锚点 | 风险点/注意事项 |
|---:|---|---|---|---|---|---|---|
| 30 | 理赔表 + Claim Service | B | 06, 09 | R2 | claims 表 + API(读) | Data Product | 写入由理赔计算任务落库（仅 historical） |
| 31 | Claim Calculator（Tier 差额逻辑） | B | 05, 30 | R2 | 纯计算模块 | CPU-Isolation | 时区边界 + 幂等 |
| 32 | 理赔计算任务 | B | 31, 14 | R2 | 定时任务 | Reliability | Redis 锁 + DB 行锁 |
| 33 | L2 Evidence Data Product | B | 09, 30 | R2 | L2 明细 API | Access Mode | Mode-aware 裁剪 |
| 34 | Claims Overlay | C | 30, 18 | R1 | Claims Layer | Access Mode | Mode-aware 聚合 |
| 35 | L2 Details 面板 | C | 33, 26 | R1 | 证据链 UI | Access Mode | 回指时间轴/地图 |
| 36 | 分析汇总卡片（Overview） | C | 13, 26 | R1 | Overview 组件 | Data Product | 概览 KPI |
| 37 | Router Agent（NLU + 路由 + 格式化） | E | 11, 13, 33 | R2 | Agent 模块 | Observability | Mode-aware 输出 |
| 38 | Expertise Agents（Product/Risk/Policy） | E | 37 | R2 | 专业 Agent | Data Product | Function Calling |
| 39 | AI Insight（ticker + pin） | C + E | 37, 20 | R1 | AI Insight 组件 | Access Mode | 导演式联动 |
| 40 | AI CTA → Orchestration 联动 | C + E | 39, 20 | R1 | Intent 执行链路 | Access Mode | CTA 必须过 Mode 校验 |
| 41 | AI 聊天窗（保留入口） | C + E | 37 | R1 | 聊天组件 | — | SSE 流式输出 |

**复用逻辑摘录引用**（面板/可视化 + AI 交互）：

*面板/可视化（前端交互与呈现）*：
- `RD-分析汇总卡片.md` — Overview KPI、概览组件

*AI 交互（聊天窗 + 洞察联动）*：
- `RD-AI聊天窗与洞察联动.md` — 导演式联动、CTA→Orchestration、Mode-aware 输出

### Phase 4：合规 + 观测 + 优化

| 步骤编号 | 步骤名称 | 泳道 | 依赖 | Reuse Type | 交付对象 | 验收锚点 | 风险点/注意事项 |
|---:|---|---|---|---|---|---|---|
| 42 | Google Maps 合规 Gate 落地 | D | 17, 18 | — | Key 限制 + Attribution + 预算告警 | Compliance | 必须上线前完成 |
| 43 | 可观测性基础设施 | D | 全部 | — | trace_id/correlation_id + 日志 | Observability | 全链路追踪 |
| 44 | Mode 默认值/审计/回滚 | D | 02 | — | 配置中心 + 审计日志 | Security | 切换可追溯 |
| 45 | 性能优化（缓存/预聚合/节流） | B + C | 全部 | R1 | 性能调优 | Perf-SLO | 压测验证 |
| 46 | 移动端/低性能降级 | C | 18, 22, 23 | R1 | 降级策略 | Perf-SLO | prefers-reduced-motion |
| 47 | 端到端测试与验收 | 全部 | 全部 | — | 测试报告 | 全部 | Go/No-Go 门槛 |

**复用逻辑摘录引用**（跨模块口径/系统红线）：
- `RD-性能优化.md` — 缓存策略、节流边界、预聚合、移动端降级
- `RD-多天气类型扩展.md` — 天气类型枚举扩展策略

---

## 3.6 复用逻辑摘录完整索引

> 详见 `docs/v2/v2复用逻辑摘录/README.md`，以下按分类列出全部 24 个 RD 文件。

### 跨模块口径/系统红线（优先级最高，Phase 0/4 引用）
| RD 文件 | 核心约束 |
|---|---|
| `RD-分层职责与协作边界.md` | FE/BE 职责隔离、口径漂移/权限旁路/预测混算防控 |
| `RD-共享类型与接口契约.md` | 输入维度/DTO/枚举定义、缓存 key 维度 |
| `RD-时间与时区口径统一.md` | UTC 存储、region_tz 业务边界、local 展示 |
| `RD-计算窗口与扩展数据.md` | 扩展窗口计算规则、输出裁剪 |
| `RD-多天气类型扩展.md` | weather_type 枚举、扩展策略 |
| `RD-性能优化.md` | 缓存策略、节流边界、预聚合、移动端降级 |

### 产品/规则/计算/数据源（Phase 1 引用）
| RD 文件 | 核心约束 |
|---|---|
| `RD-产品库与规则契约.md` | riskRules/payoutRules 分离、timeWindow 语义 |
| `RD-风险计算引擎核心与策略.md` | 计算内核职责、事件模型、CPU 隔离 |
| `RD-风险分析统一入口与聚合输出.md` | 后端唯一事实源、输出分层 |
| `RD-天气数据源与Mock生成.md` | Mock 生成规则、未来真实接口边界 |

### 地图与区域体验编排（Phase 2 引用）
| RD 文件 | 核心约束 |
|---|---|
| `RD-地图主舞台.md` | Maps API 加载、图层框架、交互原则 |
| `RD-地图模式与动画系统.md` | 动画期间禁止重请求/重绘 |
| `RD-行政区域数据管理与名称映射.md` | region_code/region_scope 统一 |
| `RD-行政区域边界与选区交互.md` | hover/click 交互边界 |
| `RD-图层控制与联动边界.md` | 图层开关与联动矩阵 |
| `RD-天气热力图图层.md` | 历史/预测分层表达 |
| `RD-风险事件标记图层.md` | 与产品规则绑定 |
| `RD-GPS定位与反向地理编码.md` | 定位链路、合规与成本约束 |

### 面板/可视化/页面联动（Phase 2/3 引用）
| RD 文件 | 核心约束 |
|---|---|
| `RD-控制面板.md` | Top Bar 全局控制 |
| `RD-数据面板基础结构.md` | Region Intelligence Panel 结构 |
| `RD-分析汇总卡片.md` | Overview KPI、概览组件 |
| `RD-图表可视化.md` | Timeline 三泳道、图表组件 |
| `RD-页面间联动.md` | 联动矩阵、状态机 |

### AI 交互（Phase 3 引用）
| RD 文件 | 核心约束 |
|---|---|
| `RD-AI聊天窗与洞察联动.md` | 导演式联动、CTA→Orchestration、Mode-aware |

---

## 4. 依赖关系图

```
Phase 0: 契约基线
┌──────────────────────────────────────────────────────────────┐
│  [01] Shared Contract                                         │
│       ↓                                                       │
│  [02] Access Mode   [03] Prediction Run   [04] 时区口径        │
└──────────────────────────────────────────────────────────────┘
                          ↓
Phase 1: 后端数据产品
┌──────────────────────────────────────────────────────────────┐
│  [05] products ──────┬──→ [08] Risk Calculator                │
│  [06] policies ──────┤                                        │
│  [07] weather ───────┘       ↓                                │
│                         [09] risk_events                      │
│                              ↓                                │
│                         [10] prediction_runs                  │
│                              ↓                                │
│  [11] L0 Dashboard   [12] Overlays   [13] L1 Intelligence     │
│                                                               │
│  [14] Celery 基础 ──→ [15] 风险事件任务                         │
└──────────────────────────────────────────────────────────────┘
                          ↓
Phase 2: 前端联动
┌──────────────────────────────────────────────────────────────┐
│  [16] Next.js 骨架 ──→ [17] Maps 初始化 ──→ [18] Map Stage     │
│                              ↓                                │
│  [20] Orchestration ←───────┴───────────────→ [19] 边界渲染   │
│       ↓                                                       │
│  [21] L0 Left HUD Rail  [22] Weather Layer  [23] Risk Layer   │
│  [24] Control Panel  [25] Product Selector                    │
│  [26] Panel 结构 ──→ [27] Timeline ──→ [28] 图表               │
│  [29] GPS                                                     │
└──────────────────────────────────────────────────────────────┘
                          ↓
Phase 3: L2 + AI
┌──────────────────────────────────────────────────────────────┐
│  [30] claims ──→ [31] Claim Calculator ──→ [32] 理赔任务       │
│       ↓                                                       │
│  [33] L2 Evidence ──→ [35] L2 Details                         │
│  [34] Claims Overlay                                          │
│  [36] 分析卡片                                                 │
│                                                               │
│  [37] Router Agent ──→ [38] Expertise Agents                  │
│       ↓                                                       │
│  [39] AI Insight ──→ [40] CTA 联动                              │
│  [41] 聊天窗                                                   │
└──────────────────────────────────────────────────────────────┘
                          ↓
Phase 4: 合规 + 优化
┌──────────────────────────────────────────────────────────────┐
│  [42] Google Maps 合规   [43] 可观测性   [44] Mode 审计         │
│  [45] 性能优化   [46] 降级策略   [47] 端到端测试                 │
└──────────────────────────────────────────────────────────────┘
```

---

## 5. 每阶段/里程碑的交付物与验收

### 5.1 Phase 0：契约基线 + 红线固化

**目标**：固化跨端契约，使 FE/BE 可并行独立开发

**交付物**：
- 维度/DTO/枚举定义文档
- TypeScript 类型定义（`packages/shared/types/`）
- Pydantic Schema 定义（`backend/app/schemas/`）
- Mode 裁剪规则矩阵
- 预测批次传播规则
- 时间口径规范

**Go/No-Go 门槛**：
- [ ] 所有数据产品的输入维度已定义且 FE/BE 一致
- [ ] cache key 维度规则明确（必含 access_mode；predicted 必含 prediction_run_id）
- [ ] trace_id/correlation_id 字段规范已定义

### 5.2 Phase 1：后端数据产品最小可用

**目标**：L0/L1/Overlays API 可被前端调用，predicted 批次一致性可验证

**交付物**：
- products/policies/risk_events/prediction_runs 表
- Product/Policy/Risk/Weather Service
- Risk Calculator（纯计算模块）
- L0/L1/Overlays Data Product API
- Celery 任务基础设施

**可演示闭环**：
- API 调用返回 L0 KPI + TopN
- API 调用返回 Overlays 聚合数据
- predicted 请求显式携带 prediction_run_id

**Phase 1/2 关于 Claims 的临时策略（强制声明，避免口径漂移）**：
- 在 Phase 1/2：**claims 作为“历史事实域”尚未落地（Step 30/31/32 在 Phase 3）**，因此：
  - L0/L1/Overlays 中与 claims 相关的内容必须为 **“可见但不可用（disabled/placeholder）”**；
  - 后端必须在响应 `meta` 中显式返回 `claims_available=false`（字段名最终以 Shared Contract 为准）与不可用原因；
  - 前端不得用 `risk_events` 或任何前端 mock “伪造 claims”来填充（否则会污染“claims=历史事实”的系统定义）；
  - AI（Insight/Chat）不得输出 claims 结论或触发 claims 相关 CTA（除非 `claims_available=true`）。

**Go/No-Go 门槛**：
- [ ] Mode 裁剪可验证（Demo 模式下敏感字段已裁剪）
- [ ] predicted 不混批次（同一响应内无跨 run 数据）
- [ ] 计算逻辑不在 API 路由层（CPU 隔离）

### 5.3 Phase 2：前端联动闭环

**目标**：Map + L0 + 锁区 + L1 Timeline 可交互

**交付物**：
- 地图主舞台（Google Maps + 图层框架）
- 行政边界 + hover/click 交互
- L0 Left HUD Rail（省级态势 HUD：金额 KPI + Pareto Top3 +（可选）sparkline + AI Insight）
- Region Intelligence Panel（Peek/Half/Full）
- 统一时间轴（三泳道对齐）
- UI Orchestration 状态机

**可演示闭环**：
- 打开页面 10s 内看到 L0 态势
- 点击任意区域锁定 → HUD 高亮选区 → AI Insight 状态更新/轮动（节流）
- 点击 AI Insight / CTA → Panel Half → Timeline 展示
- Pareto Click → Map fly-to + lock（默认不自动打开面板）

**Go/No-Go 门槛**：
- [ ] hover 0 明细重请求
- [ ] 地图主舞台不掉帧
- [ ] 联动逻辑统一在 Orchestration 层
 - [ ] Claims 在 Phase 2 为“可见但不可用”且解释清晰：UI 不空白、不误导；网络侧不发生 claims 查询；AI 不输出 claims 结论/CTA

### 5.4 Phase 3：L2 + Mode + AI 闭环

**目标**：全链路 Mode-aware + AI 导演式联动

**交付物**：
- claims 表 + Claim Service
- Claim Calculator + 理赔计算任务
- L2 Evidence API + L2 Details 面板
- Claims Overlay
- Router Agent + Expertise Agents
- AI Insight（ticker + pin）+ CTA 联动
- AI 聊天窗

**可演示闭环**：
- L2 Details 在不同 Mode 下按规则隐藏/脱敏/全量
- AI Insight 输出结论 + CTA
- 点击 CTA → 驱动 UI 联动（打开面板/定位/叠加图层）
- 聊天窗可交互并返回流式响应

**Go/No-Go 门槛**：
- [ ] Demo/Public 抓包无法拿到敏感明细（后端裁剪）
- [ ] AI 只建议 Mode 可执行动作
- [ ] CTA 执行经过 Orchestration + Mode 校验

### 5.5 Phase 4：合规 + 观测 + 优化

**目标**：生产就绪

**交付物**：
- Google Maps Key 限制 + 预算告警
- trace_id/correlation_id 全链路
- Mode 审计日志
- 性能优化（缓存/预聚合/节流）
- 移动端降级策略
- 端到端测试报告

**Go/No-Go 门槛**：
- [ ] Google Maps 合规 Gate 全部通过
- [ ] 核心链路可追踪（用户动作 → 数据请求 → 缓存/DB → 渲染）
- [ ] L0 缓存命中 p95 < 500ms
- [ ] L1 p95 < 1.5s
- [ ] Overlays 地图切换不掉帧
- [ ] Celery 任务幂等可验证

---

## 6. 验收标准总览

### 6.1 功能闭环（必须）

- [ ] L0 → 锁区 → L1 →（按 Mode）L2 全链路可交互
- [ ] L0（Left HUD Rail）：金额 KPI（2项）+ Pareto Top3 可用（注：Phase 1/2 若 `claims_available=false`，claims 相关口径必须为禁用/占位且可解释；Phase 3 起可逐步恢复完整口径）
- [ ] Pareto Click 能驱动 Map 锁定（默认不自动打开面板）
- [ ] Timeline 三泳道对齐（Weather/Risk/Claims）（注：Phase 2 允许 Claims lane 为 disabled/placeholder；Phase 3 起必须可用）
- [ ] AI Insight（ticker + pin）+ CTA 能触发 UI 联动

### 6.2 一致性与批次（必须）

- [ ] 同一筛选条件下：L0 KPI、L1 汇总、L2 摘要自洽
- [ ] predicted 全链路绑定 prediction_run_id/active_run
- [ ] 缓存 key 维度完整（至少 access_mode；predicted 额外 prediction_run_id）
- [ ] active_run 切换后缓存失效并刷新到新批次

### 6.3 安全与模式（必须）

- [ ] Demo/Public 抓包无法拿到敏感字段/明细
- [ ] 越权请求响应一致且可审计
- [ ] Mode 切换有审计记录（何时/为何/谁）

### 6.4 性能与体验（必须）

- [ ] hover 0 明细重请求（埋点/日志验证）
- [ ] L0 缓存命中 p95 < 500ms
- [ ] L1 p95 < 1.5s
- [ ] L2 p95 < 2.5s
- [ ] Overlays 缓存命中 p95 < 800ms
- [ ] 地图主舞台不掉帧

### 6.5 可观测与合规（必须）

- [ ] trace_id/correlation_id 全链路可追踪
- [ ] predicted active_run 切换有审计记录
- [ ] Google Maps Key 限制 + 预算监控就绪
- [ ] Attribution 正确显示

---

## 7. 并行开发建议

### 7.1 可并行组合

| 组合 | 说明 | 前置条件 |
|---|---|---|
| **BE 基础 + FE 骨架** | Phase 1 步骤 05-10 与 Phase 2 步骤 16-17 | Phase 0 完成 |
| **L0/Overlays API + Map Stage** | 步骤 11-12 与步骤 18-20 | 契约已定义 |
| **L1 API + L0 Left HUD Rail** | 步骤 13 与步骤 21 | L0 API 可用 |
| **Claims BE + Risk Layer FE** | 步骤 30-32 与步骤 23 | 各自前置完成 |
| **AI Agent + L2 Details FE** | 步骤 37-38 与步骤 35 | 数据产品 API 可用 |

### 7.2 接口/契约冻结点

| 冻结点 | 内容 | 时机 |
|---|---|---|
| **F1** | 输入维度 + DTO 类型 | Phase 0 完成时 |
| **F2** | L0/L1/Overlays API 契约 | Phase 1 Step 13 完成时 |
| **F3** | L2 + Mode 裁剪契约 | Phase 3 Step 33 完成时 |
| **F4** | AI Intent 契约 | Phase 3 Step 40 完成时 |

---

## 8. 下一步行动

1. **按步骤编号产出 Reuse Digest**（R0/R1 模块必须）
2. **实施细则已完成（47/47）**：执行期直接查 `docs/v2/v2实施细则/`（并以 `v2项目开发进度.md` 跟踪实现/联调/验收进度）
3. **优先完成 Phase 0**：使 FE/BE 可并行开发
4. **每个里程碑结束进行 Go/No-Go 评审**

---

**文档版本**：v2.0  
**创建日期**：2026-01-16  
**最后更新**：2026-01-16
