# v2 项目总览

> 状态：Verified  
> 版本：v2.0  
> 创建日期：2026-01-16  
> 最后更新：2026-01-16

---

## 0. 文档定位与读者

- **定位**：把 v2 "是什么/为什么/边界/关键约束/能力地图/交付对象（数据产品）/迁移策略"说清楚。
- **读者**：架构/产品/研发/测试/其他 agent。
- **禁止**：任何 v1 假设与实现细节；任何"前端隐藏=权限"的表达。

---

## 1. 项目背景

### 1.1 项目概述

**v2 是一个全栈可解释态势系统**：以"地图主舞台 + L0/L1/L2 信息分层 + AI Director Cues"为核心，直观呈现天气/风险/理赔的联动关系，支撑多类受众（路演/合作伙伴/内部）在同一套信息架构下获得不同的信息密度与能力集。

**一句话架构**：前端以事件驱动编排（UI Orchestration）为核心，后端以场景化数据产品（L0/L1/L2 + Map Overlays）为核心，由 Access Mode 贯穿数据裁剪、能力开关与 AI 动作建议。

### 1.2 v1 到 v2 的核心演变

| 维度 | v1（纯前端演示） | v2（全栈可解释系统） |
|---|---|---|
| **架构形态** | 前端 Mock 驱动，无持久化 | 全栈：Next.js + FastAPI + PostgreSQL/PostGIS + Redis + Celery |
| **数据来源** | 前端 Mock 生成 | 后端权威数据源：products/policies/claims/risk_events/weather |
| **风险计算** | 前端实时计算 | 后端服务计算 + 异步任务（Celery），结果持久化 |
| **理赔生成** | 不支持 | 基于历史数据生成正式理赔（claims） |
| **预测数据** | 前端切换 | 预测批次版本化（prediction_run_id/active_run）+ 一致性保障 |
| **信息架构** | 单层展示 | L0/L1/L2 分层：省级态势 → 区域情报 → 证据链 |
| **权限模式** | 无 | Access Mode：Demo/Public、Partner、Admin/Internal |
| **AI 能力** | 聊天回答 | 导演式联动（Insight Cards + CTA + UI Intent）+ 聊天保留 |

### 1.3 目标（必须）

1. **L0/L1/L2 信息分层闭环**
   - L0：省级态势（KPI/TopN/洞察卡），"10 秒内一眼看到态势"
   - L1：区域情报（Overview/Timeline/Correlation），"可解释"
   - L2：证据链（Details），"可追溯"

2. **Access Mode 跨层契约**
   - Demo/Public、Partner、Admin/Internal 三档
   - 后端强制裁剪（禁止前端隐藏冒充权限）
   - 影响：数据输出、默认展开、可用动作、AI 可说内容

3. **predicted 批次一致性**
   - `prediction_run_id` / `active_run` 全链路绑定
   - 缓存 key 必含批次标识
   - 支持回滚（切换 active_run）

4. **数据产品化与 SLO**
   - L0/L1/L2/Overlays/AI Insights 作为可交付数据产品
   - 明确 p95 延迟目标与缓存策略

5. **可观测闭环**
   - trace_id/correlation_id 全链路追踪
   - active_run 切换可审计
   - 用户动作 → 数据请求 → 缓存/DB → 渲染可追溯

### 1.4 非目标（必须）

- **不承诺"秒级实时全量刷新"**：优先准实时（缓存 + 定时刷新 + 预测批次）
- **不把 predicted 结果写入正式理赔**：predicted 只能用于解释/叠加/洞察或推演
- **不承诺"全球任意区域即时可用"**：先支持既有边界数据的可配置国家集
- **不以预测准确性为验收目标**：v2 验收重点是"口径一致性、批次一致性、Mode 裁剪、解释闭环与系统稳定性"
- **不建设"通用 BI 自助分析平台"**
- **不一开始做重型 IAM/组织架构权限**

---

## 2. 范围与约束（v2 的硬边界）

### 2.1 统一语言（必须）

| 概念 | 定义 |
|---|---|
| **L0/L1/L2** | 省级态势 / 区域情报 / 证据链 |
| **Access Mode** | Demo/Public、Partner、Admin/Internal（跨层契约） |
| **Data Type** | historical / predicted |
| **Prediction Run** | prediction_run_id（批次标识） / active_run（当前对外展示批次） |
| **Data Product** | L0 Dashboard / L1 Region Intelligence / L2 Evidence / Map Overlays / AI Insights |

### 2.2 统一输入维度（必须）

所有数据产品请求必须携带/推导以下维度：

| 维度 | 说明 |
|---|---|
| `region_scope` | 省/市/区层级（province/district） |
| `region_code` | 统一区域编码 |
| `time_range` | 时间范围（UTC 存储/传输） |
| `data_type` | historical / predicted |
| `weather_type` | 天气类型（rainfall/wind/temperature...） |
| `product_id` | 产品 ID（可选） |
| `access_mode` | 受众模式 |
| `prediction_run_id` | 预测批次 ID（仅 predicted） |

### 2.3 三条"红线"（必须写在总览里）

#### 红线 A：权限旁路
- **规则**：Access Mode 必须由后端裁剪输出，前端隐藏不算权限
- **验证**：Demo/Public 模式下抓包无法获取敏感字段/明细

#### 红线 B：预测混批次
- **规则**：predicted 必须全链路绑定 `prediction_run_id` / `active_run`
- **规则**：缓存 key 必须包含批次标识
- **规则**：支持回滚（切换 active_run 而非覆盖数据）

#### 红线 C：交互风暴
- **规则**：hover 不触发重请求（0 次明细重请求）
- **规则**：重交互（lock/CTA）才允许触发 L1/L2
- **规则**：地图主舞台永远优先，任何面板展开不能让地图掉帧

---

## 3. 目标体验与信息架构（L0/L1/L2）

### 3.1 L0：省级态势（背书级）

**目的**：10 秒内一眼看到态势

**主要输出**：
- Combined / Policies / Claims 三 Tab
- 每 Tab：3–5 个 KPI + Top5 排名 +（可选）tiny trend
- AI Insight Cards（3 张洞察卡，节流刷新）

**SLO/缓存策略**：
- p95 < 500ms（缓存命中）
- 强缓存/预聚合优先
- 新鲜度可容忍分钟级

**交互**：
- Ranking Click → Map fly-to + lock region
- 洞察卡 CTA → 驱动 UI 联动

### 3.2 L1：区域情报（解释）

**目的**：可解释——什么时候开始异常？与风险是否相关？

**主要输出**：
- Overview：概览 KPI
- Timeline：同一时间轴三泳道对齐（Weather / Risk / Claims）
- Correlation：相关性分析（默认折叠）

**SLO**：
- p95 < 1.5s（交互刷新稳定优先）
- 缓存可复用（按维度）

**交互触发边界**：
- Map Click Lock / Ranking Click 触发
- Timeline Brush 节流同步

### 3.3 L2：证据链（追溯，Mode-aware）

**目的**：可追溯——给我证据：哪些理赔、对应哪些风险、触发了什么规则？

**主要输出**：
- Details：风险事件 ↔ 理赔信息关联
- 支持回指时间轴/地图定位

**默认策略**：
- Demo/Public：默认隐藏或仅聚合摘要
- Partner：字段级脱敏（可配置）
- Admin/Internal：全量明细

**下钻触发**：
- "See more" / AI Insight CTA
- 按需加载（默认不预取）

**SLO**：
- p95 < 2.5s（可接受，但必须可追溯）

---

## 4. 能力地图（Capability Map）

### 4.1 Shared Contract（跨端契约）

| 能力 | 说明 | 验收锚点 |
|---|---|---|
| 输入维度定义 | region_code/time_range/data_type/weather_type/product_id/access_mode/prediction_run_id | Consistency |
| 输出 DTO 分类 | Series（时间序列）/ Events（事件）/ Aggregations（聚合） | Consistency |
| 时间口径 | 存储传输 UTC，业务边界 region_tz，展示 local | Consistency |
| 缓存 key 维度 | 必含 access_mode；predicted 必含 prediction_run_id | Consistency / Prediction Run |
| Mode 裁剪规则 | 字段级/粒度级/能力级裁剪策略 | Access Mode / Security |

### 4.2 Backend（数据产品 + 计算 + 任务）

| 能力 | 说明 | Reuse Type | 验收锚点 |
|---|---|---|---|
| products 表 + Product Service | 产品配置权威源（riskRules + payoutRules） | R2 | Data Product |
| policies 表 + Policy Service | 保单管理 | R2 | Data Product |
| risk_events 表 + Risk Service | 风险事件持久化与查询 | R2 | Data Product / Prediction Run |
| claims 表 + Claim Service | 理赔记录（仅历史生成） | R2 | Access Mode |
| prediction_runs 表 | 预测批次元信息 + active_run 切换 | R2 | Prediction Run |
| L0 Dashboard Data Product | KPI + TopN 排名 | R2 | Perf-SLO |
| L1 Region Intelligence Data Product | Overview + 趋势 + Timeline 三泳道 | R2 | Data Product |
| L2 Evidence Data Product | 证据链明细（Mode-aware） | R2 | Access Mode |
| Map Overlays Data Product | 可直接渲染的聚合结果 | R2 | Perf-SLO |
| Risk Calculator | 风险事件计算（纯计算，不依赖 DB Session） | R2 | CPU-Isolation |
| Claim Calculator | 理赔计算（Tier 差额逻辑） | R2 | CPU-Isolation |
| Celery Tasks | 风险事件批量计算、理赔计算、天气同步 | R2 | Reliability |

### 4.3 Frontend（UI Orchestration + Map Stage）

| 能力 | 说明 | Reuse Type | 验收锚点 |
|---|---|---|---|
| UI Orchestration | 状态机 + 联动矩阵（Zustand） | R1 | Perf-SLO / Observability |
| Map Stage | 地图主舞台 + 图层体系（Google Maps + deck.gl） | R1 | Compliance / Perf-SLO |
| Region Boundary | 行政边界渲染 + hover/click lock | R1 | Perf-SLO |
| Weather Layer | 历史/预测分层表达 | R1 | Prediction Run |
| Risk Layer | 风险事件标记（与产品规则绑定） | R1 | Data Product |
| Claims Overlay | 理赔叠加（Mode-aware） | R1 | Access Mode |
| L0 Sidebar | 省级态势抽屉 | R1 | Data Product |
| Region Intelligence Panel | 区域情报面板（L1/L2 Bottom Sheet） | R1 | Data Product |
| TanStack Query + Zustand | 数据获取与状态管理职责分工 | R1 | Perf-SLO |

### 4.4 AI（聊天窗 + 洞察卡 + Intent）

| 能力 | 说明 | Reuse Type | 验收锚点 |
|---|---|---|---|
| AI 聊天窗 | 保留作为稳定交互入口 | R1 | — |
| AI Insight Cards | 导演式联动（结论 + CTA） | R1 | Access Mode |
| Router Agent | NLU + 意图识别 + 路由 + 响应格式化 | R2 | Observability |
| Expertise Agents | Product / Risk & Claim / Policy 专业 Agent | R2 | Data Product |
| Intent → Orchestration | CTA 必须过 Orchestration + Mode 校验 | R1 | Access Mode |
| Modality Adapter | 文本/语音模态解耦（语音可选） | R2 | — |

### 4.5 Governance（合规/观测/发布治理）

| 能力 | 说明 | 验收锚点 |
|---|---|---|
| Google Maps 合规 Gate | Key 限制、Attribution、缓存条款、成本监控 | Compliance |
| 预算/配额监控 | 用量突增告警 + 预算上限 | Compliance |
| Mode 默认值/来源/审计 | Mode 切换必须记录操作者/时间/原因 | Security / Observability |
| trace_id / correlation_id | 全链路追踪 | Observability |
| active_run 审计 | 预测批次切换可追溯 | Prediction Run |

---

## 5. 数据产品目录（Data Product Catalog）

| 数据产品 | 层级 | 目的 | 输入维度（除 region_code/time_range 外） | 输出形态 | Mode 影响 | predicted 约束 | 缓存与 SLO |
|---|---|---|---|---|---|---|---|
| **L0 Dashboard** | L0 | "10 秒内一眼看到态势"：KPI + TopN 排名 | region_scope=province、data_type、weather_type（可选）、access_mode | 聚合 + 排名 | Demo 范围化/隐藏敏感口径；Partner 更细；Admin 全量 | 必须携带 prediction_run_id（或由 active_run 解析） | p95 < 500ms（缓存命中）；强缓存优先 |
| **L1 Region Intelligence** | L1 | "可解释"：Overview + 趋势 + 统一时间轴三泳道 | data_type、weather_type、product_id（可选）、access_mode | 时间序列 + 轻量聚合 | Demo 裁剪/摘要；Partner 脱敏；Admin 全量 | 同上（不得混批次） | p95 < 1.5s；交互刷新稳定优先 |
| **L2 Evidence** | L2 | "可追溯"：风险事件 ↔ 理赔关联 | data_type、weather_type、product_id（可选）、access_mode | 明细/半明细 + 关联 | Demo 默认隐藏或仅摘要；Partner 脱敏；Admin 全量 | 若允许展示 predicted evidence，必须绑定 prediction_run_id（默认不预取） | p95 < 2.5s；按需加载 |
| **Map Overlays** | Map | 可视化友好：直接渲染的聚合结果 + legend 元信息 | region_scope、data_type、weather_type、product_id（可选）、access_mode | 渲染聚合（区域/网格/hex） | Demo 避免暴露敏感金额粒度 | 与批次绑定失效；legend 必须体现批次/口径 | p95 < 800ms（命中）；地图不掉帧优先 |
| **AI Insights** | AI | 一句话结论 + 可执行 CTA（导演式联动） | 依赖 L0/L1（以及打开 L2 时） | 文本 + UI Intent | Demo 避免敏感结论与越权 CTA | 必须与页面批次一致（避免解释断裂） | 节流刷新 |

---

## 6. 系统架构一览（顶层）

```
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Frontend)                        │
│  Next.js (App Router) + React 19 + TypeScript + Tailwind CSS│
│  - UI Orchestration (Zustand 状态机)                          │
│  - Data Fetching (TanStack Query)                            │
│  - 地图主舞台 (Google Maps + deck.gl)                         │
│  - AI 对话界面 (聊天窗 + Insight Cards)                        │
└─────────────────────────────────────────────────────────────┘
                          ↕ HTTP/SSE/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                      API 层 (FastAPI Router)                 │
│  - 参数校验、调用 Service、禁止重计算                           │
└─────────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────────┐
│                      服务层 (Service Layer)                   │
│  - Data Product 权威实现 (L0/L1/L2/Overlays)                  │
│  - Mode 裁剪、批次一致性、缓存、审计                            │
│  - 返回纯 JSON (Agent/前端负责格式化)                          │
└─────────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────────┐
│                      计算/任务层 (Compute/Tasks)              │
│  - Risk Calculator / Claim Calculator (纯计算)               │
│  - Celery 异步任务 (风险事件批量、理赔计算、天气同步)             │
│  - 幂等 + 并发控制 (Redis 锁 + DB 行锁)                        │
└─────────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                      │
│  - PostgreSQL 15+ / PostGIS 3.3+ (products/policies/claims/ │
│    risk_events/prediction_runs/weather)                      │
│  - Redis (缓存 + 分布式锁 + Celery Broker)                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 迁移策略摘要（R0/R1/R2/R3）

基于 `v2迁移分层矩阵.md` 的结论：

### R0：直接复用
- 几乎没有（v2 全栈化导致大部分模块需要重构）

### R1：复用但重构
- **地图集成**：API 加载方式/Map ID/图层选择需按 v2 合规与性能方案重整
- **行政边界渲染**：统一 region_code/region_scope 与后端一致
- **天气/风险图层**：由后端提供数据产品，前端只渲染
- **Product Selector**：产品来自后端产品表
- **中心化 Hook**：转为 Zustand + TanStack Query
- **DataDashboard**：数据来源改为数据产品 API
- **AI 对话面板**：保留聊天窗 + 新增导演式洞察卡
- **GPS 定位**：保留链路，遵守合规与成本约束

### R2：逻辑复用但后端重写
- **产品库**：落到 DB `products` 表 + Product Service
- **风险计算引擎**：后端计算 + Celery 任务 + 持久化
- **天气数据生成器**：后端 Mock/导入 + 未来真实数据接口
- **扩展数据获取**：后端计算输入准备
- **Claims/理赔**：后端正式记录 + Mode-aware

### R3：不复用（废弃/归档）
- **"全球任意区域"假设**：改为可配置国家集
- **"只做前端 Mock/不做 claims"假设**：v2 明确全栈闭环

---

## 8. 风险清单与 Go/No-Go 门槛

### 8.1 P0 风险（最高优先级）

| 风险 | 规避策略 |
|---|---|
| Mode 权限旁路（敏感数据泄露） | 后端输出裁剪强制执行；接口层统一鉴权与裁剪；日志审计越权请求 |
| CPU 计算阻塞 FastAPI event loop（雪崩） | 轻量线程池、重任务 Celery；计算逻辑与 DB 解耦；压测验证 |
| predicted 混批次（解释断裂） | 预测批次版本化；缓存与批次绑定；前端/AI 显式显示当前批次 |
| L0/Overlays 性能崩（OLTP 硬扛） | 场景化数据产品层 + 预聚合/强缓存；Overlays 服务端聚合 |

### 8.2 P1 风险（高优先级）

| 风险 | 规避策略 |
|---|---|
| 联动逻辑散落导致竞态/请求风暴 | 前端 Orchestration 统一入口；TanStack Query 统一 Server State；节流与去抖 |
| AI 动作建议越权或不可执行导致断流 | Intent 必须过 Mode/权限校验；AI 输出动作集合与 Mode 绑定 |
| 时区导致"per day/per month"判断错误 | UTC 存储；按风险地区时区判定"同一天/同一月"；增加边界测试 |

### 8.3 Go/No-Go 门槛

#### 功能闭环（必须）
- [ ] L0 → 选区锁定 → L1 Timeline →（按 Mode）L2
- [ ] AI Insight Cards 在各 Mode 下只输出该 Mode 可展示口径、只建议该 Mode 可执行动作

#### 口径一致性（必须）
- [ ] 同一筛选条件下：L0 KPI、L1 时间轴汇总、L2 证据链摘要自洽
- [ ] predicted 场景：active_run 一致；缓存与 AI 不得混用不同批次

#### 安全与模式（必须）
- [ ] Mode 裁剪不可绕过（抓包/接口直调无法拿到 Demo 禁止的字段/明细）
- [ ] Google Maps 合规 Gate 全部通过

#### 性能与体验（必须）
- [ ] L0 Dashboard：缓存命中 p95 < 500ms
- [ ] L1 Region Intelligence：p95 < 1.5s，不影响地图交互
- [ ] Overlays：地图切换图层/范围时不掉帧
- [ ] hover 0 明细重请求（可通过埋点/日志验证）

#### 可靠性（必须）
- [ ] Celery 关键任务具备幂等与并发控制验证（重复触发不产生重复写）
- [ ] 预测刷新链路闭环可被观测与回滚

---

## 9. 参考文档（v2 真源）

### 9.1 核心文档

| 文档 | 定位 |
|---|---|
| `docs/v2/v2需求分析.md` | 功能需求与验收标准 |
| `docs/v2/v2页面设计提案.md` | 体验/信息架构/联动状态机/Access Mode |
| `docs/v2/v2架构升级-全栈方案.md` | 全栈分层架构/数据库/服务/计算/AI Agent/部署 |
| `docs/v2/v2技术方案.md` | 实施指导/模块边界/风险规避/验收门槛 |
| `docs/v2/v2迁移分层矩阵.md` | v1 资产去向（R0/R1/R2/R3） |
| `docs/v2/v2文档治理与实施拆解方针.md` | 文档产出规范与模块细则模板 |

### 9.2 复用逻辑摘录（Reuse Digest）

> 详见 `docs/v2/v2复用逻辑摘录/README.md`，所有 R0/R1 模块的实施细则必须先引用对应的 RD 文件。

#### 跨模块口径/系统红线（优先级最高）
- `RD-分层职责与协作边界.md`
- `RD-共享类型与接口契约.md`
- `RD-时间与时区口径统一.md`
- `RD-计算窗口与扩展数据.md`
- `RD-多天气类型扩展.md`
- `RD-性能优化.md`

#### 产品/规则/计算/数据源（后端权威逻辑）
- `RD-产品库与规则契约.md`
- `RD-风险计算引擎核心与策略.md`
- `RD-风险分析统一入口与聚合输出.md`
- `RD-天气数据源与Mock生成.md`

#### 地图与区域体验编排（Map Stage / Region）
- `RD-地图主舞台.md`
- `RD-地图模式与动画系统.md`
- `RD-行政区域数据管理与名称映射.md`
- `RD-行政区域边界与选区交互.md`
- `RD-图层控制与联动边界.md`
- `RD-天气热力图图层.md`
- `RD-风险事件标记图层.md`
- `RD-GPS定位与反向地理编码.md`

#### 面板/可视化/页面联动（前端交互与呈现）
- `RD-控制面板.md`
- `RD-数据面板基础结构.md`
- `RD-分析汇总卡片.md`
- `RD-图表可视化.md`
- `RD-页面间联动.md`

#### AI 交互（聊天窗 + 洞察联动）
- `RD-AI聊天窗与洞察联动.md`

---

**文档版本**：v2.0  
**创建日期**：2026-01-16  
**最后更新**：2026-01-16
