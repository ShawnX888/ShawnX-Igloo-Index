# 05-行政区域数据管理

## 步骤概述

### 步骤编号和名称
**步骤05**：行政区域数据管理

### 步骤目标
准备行政区域边界数据（GADM格式），实现区域搜索和选择逻辑，支持模糊搜索、层级选择和GPS定位转换，为地图可视化提供区域数据支持。

### 预期成果
- 行政区域边界数据已准备（GADM GeoJSON格式）
- 区域搜索功能正常工作（模糊搜索）
- 层级选择功能正常工作（国家→省/州→市/区）
- GPS定位可以转换为行政区域
- 区域数据结构统一，便于后续使用
- Google 名称与 GADM 名称映射正常工作

---

## 前置条件

### 依赖的步骤
- 无（区域数据管理相对独立）

### 需要完成的前置工作
- 了解区域数据结构需求
- 准备或获取 GADM 行政区域边界数据
- 获取 Google Maps 官方区域名称

### 需要的数据/接口
- GADM 行政区域边界数据：`xxx_index.json`、`xxx_centers.json`、`xxx_hierarchy.json`
- Google 区域名称：`xxx_google_hierarchy.json`
- 名称映射：`xxx_mapping.json`
- GPS坐标（用于反向地理编码）

---

## 数据架构

### 双数据源设计

本项目采用双数据源架构，分离 UI 展示和 GIS 数据：

| 数据源 | 用途 | 文件位置 |
|--------|------|----------|
| **Google 名称** | UI 下拉选项、Weather API 调用、Geocoding API | `src/data/google/xxx_google_hierarchy.json` |
| **GADM 数据** | 边界渲染、中心点坐标、GPS 定位归属判断 | `src/data/gadm/xxx_index.json` 等 |
| **名称映射** | Google ↔ GADM 名称双向转换 | `src/data/google/xxx_mapping.json` |
| **合并数据** | 导出给其他模块使用 | `src/data/google/merged_*.json` |

### 数据文件结构

```
src/data/
├── gadm/
│   ├── idn_index.json       # 印尼边界数据（含 boundary、center）
│   ├── idn_centers.json     # 印尼中心点数据
│   ├── idn_hierarchy.json   # 印尼层级关系
│   ├── chn_index.json       # 中国边界数据
│   └── ...
├── google/
│   ├── idn_google_hierarchy.json   # 印尼 Google 名称层级
│   ├── idn_mapping.json            # 印尼名称映射
│   ├── chn_mapping.json            # 中国名称映射
│   ├── merged_google_hierarchy.json # 合并后的 Google 层级
│   └── merged_mapping.json          # 合并后的映射表
└── regions.ts                       # 数据导入和转换函数
```

### 名称转换函数

```typescript
// src/data/regions.ts 导出的转换函数
export function googleToGadmName(googleName: string): string;
export function gadmToGoogleName(gadmName: string): string;

// 使用示例
const gadmName = googleToGadmName("Jakarta");  // 返回 "JakartaRaya"
const googleName = gadmToGoogleName("JawaBarat");  // 返回 "West Java"
```

---

## 实现要点

### 核心功能点

1. **区域数据结构定义**
   - 定义 `AdministrativeRegion` 接口
   - 包含：国家、省/州、市/区、中心点坐标、边界坐标

2. **GADM 边界数据加载**
   - 使用 `gadmDataLoader.ts` 异步加载边界数据
   - 支持名称转换（Google → GADM）
   - 缓存已加载的数据

3. **区域搜索功能**
   - 实现模糊搜索算法
   - 支持按国家、省/州、市/区名称搜索
   - 同时支持 Google 名称和 GADM 名称

4. **层级选择功能**
   - 三级下拉选择器（国家→省/州→市/区）
   - 下拉选项使用 Google 名称（用户友好）
   - 内部查询使用 GADM 名称

5. **GPS定位转换（双重验证）**
   - 使用 Google Geocoding API 进行反向地理编码获取官方名称。
   - 引入“就近原则”：将 GPS 坐标与预存 GADM 中心点比对，筛选距离最近的候选区域。
   - 通过语义匹配（Google 名称对比）和距离优先级（最近原则）确定最终区域。
   - 确保返回结果与系统标准 `REGION_HIERARCHY` 一致。

### 技术实现方案

#### 1. 区域数据结构
```typescript
interface AdministrativeRegion {
  country: string;
  province: string;
  district: string;
  center: { lat: number; lng: number };
  boundary: LatLngLiteral[]; // 边界坐标数组
}
```

#### 2. GADM 数据加载器
```typescript
// src/lib/gadmDataLoader.ts
import { GOOGLE_TO_GADM } from '../data/regions';

function findRegionData(region: Region): ConvertedRegion | null {
  // 1. 直接查找
  let data = cachedIndex[region.country]?.[region.province]?.[region.district];
  if (data) return data;
  
  // 2. 转换 Google 名称为 GADM 名称再查找
  const gadmProvince = GOOGLE_TO_GADM[region.province] || region.province;
  const gadmDistrict = GOOGLE_TO_GADM[region.district] || region.district;
  
  return cachedIndex[region.country]?.[gadmProvince]?.[gadmDistrict] || null;
}

export async function getRegionBoundary(region: Region): Promise<LatLngLiteral[]>;
export async function getRegionCenter(region: Region): Promise<LatLngLiteral | null>;
export async function getAdministrativeRegion(region: Region): Promise<AdministrativeRegion | null>;
```

#### 3. 区域搜索
```typescript
export async function searchRegions(query: string): Promise<Region[]> {
  // 从 GADM hierarchy 中搜索匹配的区域
  // 支持 Google 名称和 GADM 名称
}
```

#### 4. GPS定位转换（双重验证逻辑）
```typescript
async function convertGPSToRegion(
  lat: number,
  lng: number
): Promise<Region | null> {
  // 1. 获取距离最近的 3-5 个候选区域
  const candidates = findNearestGadmRegions(lat, lng, 5);
  
  // 2. 调用 Google Geocoding 获取实时名称
  const googleNames = await fetchGoogleGeocodeNames(lat, lng);
  
  // 3. 语义匹配候选人名称（GADM 名或已映射的 Google 名）
  const matched = candidates.find(c => 
    isMatch(googleNames.district, c.name) || isMatch(googleNames.district, c.googleName)
  );
  
  // 4. 返回匹配项或距离最近的第 1 项
  return matched || candidates[0] || null;
}
```

---

## 输入输出

### 输入
- **搜索查询**：字符串（区域名称，支持 Google/GADM）
- **GPS坐标**：`{ lat: number; lng: number }`
- **层级选择**：国家、省/州、市/区的选择（Google 名称）

### 输出
- **区域信息**：`AdministrativeRegion` 类型
- **区域列表**：匹配的区域列表（用于搜索）
- **边界数据**：`LatLngLiteral[]`（用于地图绘制）
- **中心点**：`LatLngLiteral`（用于地图定位）

---

## 验收标准

### 功能验收标准
- [x] GADM 区域边界数据可以正常加载
- [x] 模糊搜索功能正常工作
- [x] 层级选择功能正常工作
- [x] GPS 定位可以正确转换为行政区域
- [x] Google ↔ GADM 名称转换正常工作
- [x] 区域数据结构统一

### 数据质量验收标准
- [x] GADM 边界数据格式正确
- [x] 区域中心点坐标准确
- [x] 区域层级关系正确
- [x] Google 名称映射覆盖主要区域

### 性能验收标准
- [x] 区域搜索响应时间在 500ms 内
- [x] 区域数据加载时间在 2 秒内
- [x] GPS 定位转换时间在 3 秒内

---

## 相关文件

| 文件路径 | 说明 |
|----------|------|
| `src/lib/gadmDataLoader.ts` | GADM 数据加载器 |
| `src/lib/regionData.ts` | 区域数据管理接口 |
| `src/data/regions.ts` | 数据导入和名称转换 |
| `src/data/gadm/*.json` | GADM 边界/中心点/层级数据 |
| `src/data/google/*.json` | Google 名称和映射数据 |
| `scripts/fetchGoogleRegionNames.mjs` | Google 名称获取脚本 |

---

## 注意事项

### 常见问题
1. **名称不匹配**
   - Google 名称与 GADM 名称不一致时，使用映射表转换
   - 如果映射表不包含某区域，回退到原始名称

2. **边界数据加载失败**
   - 检查 GADM 索引文件是否存在
   - 确认区域名称（GADM 格式）正确

3. **GPS定位转换失败**
   - 处理用户拒绝位置权限
   - 处理定位超时
   - 处理无法识别的区域

### 技术难点
- **双数据源管理**：UI 使用 Google 名称，GIS 使用 GADM 名称
- **名称映射维护**：需要脚本自动生成和更新映射表
- **大文件加载优化**：GADM 索引文件可能很大，需要异步加载

### 扩展性考虑
- 支持添加更多国家的 GADM 数据
- 支持更新 Google 名称映射
- 预留真实 API 接口，便于未来替换

---

## 下一步

### 后续步骤的准备工作
- 区域数据已准备，可以在步骤11中使用数据绘制行政区域边界
- 区域搜索功能已实现，可以在步骤15中使用

### 数据/接口的传递
- 区域信息通过 `Region` 类型传递给其他组件
- 边界数据通过 `getAdministrativeRegion()` 获取
- 名称转换通过 `googleToGadmName()`/`gadmToGoogleName()` 进行

---

**文档版本**：v2.0  
**创建日期**：2025-01-27  
**最后更新**：2025-12-18
