# 补充-时间处理统一化方案

## 文档信息
- **创建日期**：2025-12-18
- **状态**：实施中
- **版本**：v1.0

---

## 1. 问题背景

### 1.1 当前问题
项目中存在时间处理不一致的问题：
- **风险计算和过滤**：使用 UTC 时间
- **天气数据生成、加载、使用**：使用本地时间

这会导致以下异常：
1. 时间范围比较时出现偏差（跨时区场景）
2. 数据过滤不准确（UTC vs 本地时区）
3. 与其他系统交互时时间不一致
4. 夏令时切换时可能出现数据丢失或重复

### 1.2 影响范围
- 数据生成层：`weatherDataGenerator.ts`
- 扩展数据计算：`useExtendedWeatherData.ts`
- 风险计算引擎：`riskCalculationEngine.ts`
- UI 显示层：`ControlPanel.tsx`、`DataDashboard.tsx`、`Dashboard.tsx`
- 图表可视化：日期格式化函数

---

## 2. 解决方案

### 2.1 核心原则
**统一使用 UTC 时间作为内部标准，仅在 UI 显示时转换为本地时区**

### 2.2 为什么选择 UTC？

1. **系统间交互**：API、数据库、日志通常使用 UTC
2. **避免夏令时问题**：UTC 无夏令时，避免时间跳跃
3. **跨时区一致性**：不同时区用户计算结果一致
4. **标准化**：ISO 8601、Unix 时间戳等基于 UTC
5. **调试友好**：UTC 时间便于追踪和日志分析

### 2.3 实施策略

#### 数据流转换点
```
用户输入（本地时间）
    ↓
转换为 UTC（存储）
    ↓
内部计算（UTC）
    ↓
转换为本地时间（显示）
```

---

## 3. 实施计划

### 3.1 阶段一：创建时间工具函数

**目标**：创建统一的时间转换工具函数

**文件**：`src/lib/timeUtils.ts`

**功能**：
- `getUserTimezone()`: 获取用户时区
- `localToUTC(localDate: Date): Date`: 本地时间转 UTC
- `utcToLocal(utcDate: Date): Date`: UTC 转本地时间
- `formatUTCDate(utcDate: Date, formatStr: string): string`: 格式化 UTC 日期为本地显示

**验收标准**：
- ✅ 工具函数通过单元测试
- ✅ 支持所有常见时区
- ✅ 正确处理夏令时转换

---

### 3.2 阶段二：统一数据生成层

**目标**：将天气数据生成器改为使用 UTC 时间

**文件**：`src/lib/weatherDataGenerator.ts`

**修改点**：
1. `generateHourlyWeatherData` 函数：
   - `setHours()` → `setUTCHours()`
   - `getHours()` → `getUTCHours()`
   - `addHours()` → 使用 UTC 时间计算

2. `generateDailyWeatherData` 函数：
   - 日期分组使用 UTC 日期键
   - 日期比较使用 UTC 时间戳

**验收标准**：
- ✅ 生成的数据时间戳为 UTC
- ✅ 数据生成逻辑与修改前一致
- ✅ 不影响现有数据格式

---

### 3.3 阶段三：统一扩展数据计算

**目标**：将扩展数据计算改为使用 UTC 时间

**文件**：`src/hooks/useExtendedWeatherData.ts`

**修改点**：
1. 时间扩展计算：
   - `startOfDay()` → UTC 版本的日期对齐
   - `subDays()`、`subHours()` → UTC 时间计算

2. 扩展时间范围：
   - `extendedFrom` 和 `extendedTo` 使用 UTC

**验收标准**：
- ✅ 扩展时间范围计算正确
- ✅ 与数据生成器时间一致
- ✅ 不影响风险计算逻辑

---

### 3.4 阶段四：统一风险计算引擎

**目标**：确保风险计算引擎完全使用 UTC 时间

**文件**：`src/lib/riskCalculationEngine.ts`

**修改点**：
1. `filterAndSortWeatherData`：
   - 确保时间比较使用 UTC 时间戳
   - `toISOString()` 已返回 UTC，无需修改

2. `groupByHour`、`groupByDay`、`groupByMonth`：
   - 使用 UTC 小时/日期/月份进行分组

**验收标准**：
- ✅ 时间过滤准确
- ✅ 分组逻辑正确
- ✅ 风险事件时间戳为 UTC

---

### 3.5 阶段五：UI 层时间显示

**目标**：UI 层接收 UTC 时间，显示时转换为本地时间

#### 5.1 Map Settings (ControlPanel.tsx)

**修改点**：
1. **用户输入处理**：
   - Calendar 选择日期（本地时间）→ 转换为 UTC 存储
   - 小时选择（本地时间）→ 转换为 UTC 存储

2. **时间显示**：
   - `dateRange.from/to` (UTC) → 转换为本地时间显示
   - 使用 `utcToLocal()` 转换

3. **快速预设按钮**：
   - 计算本地时间 → 转换为 UTC 存储

**代码示例**：
```typescript
// 用户选择日期后
onSelect={(range) => {
  if (range?.from) {
    const fromUTC = localToUTC(range.from);
    const toUTC = range.to ? localToUTC(range.to) : fromUTC;
    setDateRange({ 
      ...dateRange, 
      from: fromUTC, 
      to: toUTC 
    });
  }
}}

// 显示时间
const displayFrom = utcToLocal(dateRange.from);
{format(displayFrom, "MMM dd")} {String(displayFrom.getHours()).padStart(2, '0')}:00
```

**验收标准**：
- ✅ 用户选择的时间正确转换为 UTC
- ✅ 显示的时间为用户本地时间
- ✅ 快速预设按钮工作正常

---

#### 5.2 Dashboard 初始化 (Dashboard.tsx)

**修改点**：
1. **初始时间范围**：
   - 计算本地时间 → 转换为 UTC 存储
   - `getHours()` → 使用本地小时（用于显示）

2. **数据类型切换**：
   - 历史/预测切换时，时间计算使用 UTC

**验收标准**：
- ✅ 初始时间范围正确
- ✅ 数据类型切换时时间计算正确

---

#### 5.3 分析汇总卡片 (DataDashboard.tsx)

**修改点**：
1. **时间范围显示**：
   - `dateRange.from/to` (UTC) → 转换为本地时间显示

2. **风险事件时间显示**：
   - `event.timestamp` (UTC) → 转换为本地时间显示

**代码示例**：
```typescript
const displayFrom = utcToLocal(dateRange.from);
const displayTo = utcToLocal(dateRange.to);

{format(displayFrom, "MMM dd, yyyy")} {String(displayFrom.getHours()).padStart(2, '0')}:00
{' — '}
{format(displayTo, "MMM dd, yyyy")} {String(displayTo.getHours()).padStart(2, '0')}:00
```

**验收标准**：
- ✅ 时间范围显示正确
- ✅ 风险事件时间显示正确

---

#### 5.4 图表可视化 (DataDashboard.tsx)

**修改点**：
1. **日期格式化函数**：
   - `formatDateAxis` 函数：UTC 时间 → 转换为本地时间显示

2. **图表数据**：
   - 图表数据中的日期字符串（ISO，UTC）→ 显示时转换为本地时间

**代码示例**：
```typescript
const formatDateAxis = (val: string | number | Date) => {
  try {
    if (!val) return "";
    const dateUTC = new Date(val);  // ISO字符串解析为UTC
    if (isNaN(dateUTC.getTime())) return String(val);

    // 转换为用户本地时区
    const dateLocal = utcToLocal(dateUTC);

    if (viewMode === 'daily') {
      return format(dateLocal, "dd MMM"); 
    }
    return format(dateLocal, "dd/MM HH:mm");
  } catch (e) {
    return String(val);
  }
};
```

**验收标准**：
- ✅ 图表 X 轴日期显示正确
- ✅ Tooltip 日期显示正确
- ✅ 风险事件时间线显示正确

---

## 4. 技术实现细节

### 4.1 依赖库
- `date-fns`: 基础日期处理
- `date-fns-tz`: 时区转换（需要新增依赖）

### 4.2 安装依赖
```bash
npm install date-fns-tz
```

### 4.3 时间工具函数实现

```typescript
// src/lib/timeUtils.ts
import { zonedTimeToUtc, utcToZonedTime, format } from 'date-fns-tz';

/**
 * 获取用户时区
 */
export function getUserTimezone(): string {
  return Intl.DateTimeFormat().resolvedOptions().timeZone;
}

/**
 * 将本地时间转换为 UTC
 * @param localDate 本地时间
 * @returns UTC 时间
 */
export function localToUTC(localDate: Date): Date {
  const tz = getUserTimezone();
  return zonedTimeToUtc(localDate, tz);
}

/**
 * 将 UTC 时间转换为本地时间
 * @param utcDate UTC 时间
 * @returns 本地时间
 */
export function utcToLocal(utcDate: Date): Date {
  const tz = getUserTimezone();
  return utcToZonedTime(utcDate, tz);
}

/**
 * 格式化 UTC 日期为本地时间显示
 * @param utcDate UTC 时间
 * @param formatStr 格式化字符串
 * @returns 格式化后的本地时间字符串
 */
export function formatUTCDate(utcDate: Date, formatStr: string): string {
  const localDate = utcToLocal(utcDate);
  return format(localDate, formatStr);
}
```

---

## 5. 测试计划

### 5.1 单元测试
- ✅ 时间工具函数测试
- ✅ 数据生成器 UTC 时间测试
- ✅ 扩展数据计算 UTC 时间测试

### 5.2 集成测试
- ✅ 跨时区场景测试
- ✅ 夏令时切换测试
- ✅ UI 显示时间正确性测试

### 5.3 用户验收测试
- ✅ 不同时区用户测试
- ✅ 时间选择功能测试
- ✅ 图表显示时间测试

---

## 6. 迁移注意事项

### 6.1 向后兼容
- 如果已有数据使用本地时间，需要迁移或兼容处理
- 建议在迁移期间同时支持两种格式，逐步迁移

### 6.2 数据迁移
- 检查现有缓存数据的时间格式
- 如有必要，提供数据迁移脚本

### 6.3 性能考虑
- 时区转换有性能开销，但影响很小
- 考虑在必要时缓存时区信息

---

## 7. 验收标准

### 7.1 功能验收
- ✅ 所有时间相关功能正常工作
- ✅ 跨时区场景下数据一致
- ✅ UI 显示时间为用户本地时间
- ✅ 内部计算使用 UTC 时间

### 7.2 性能验收
- ✅ 时区转换不影响性能
- ✅ 数据生成速度不变

### 7.3 兼容性验收
- ✅ 支持所有常见时区
- ✅ 正确处理夏令时
- ✅ 向后兼容现有数据格式

---

## 8. 后续优化

### 8.1 可选优化
- 时区信息缓存
- 批量时间转换优化
- 时区选择器（允许用户手动选择时区）

### 8.2 监控指标
- 时区转换性能
- 时间相关错误日志
- 用户时区分布统计

---

## 9. 相关文档

- **04-Mock数据生成器.md**: 数据生成器实现细节
- **07-风险计算引擎核心.md**: 风险计算引擎实现细节
- **15-控制面板实现.md**: 控制面板实现细节
- **20-图表可视化.md**: 图表可视化实现细节

---

**文档版本**：v1.0  
**创建日期**：2025-12-18  
**最后更新**：2025-12-18

