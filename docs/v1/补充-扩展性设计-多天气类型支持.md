# æ‰©å±•æ€§è®¾è®¡ï¼šå¤šå¤©æ°”ç±»å‹æ”¯æŒ

## æ¦‚è¿°

ä¸ºäº†æ”¯æŒæœªæ¥æ‰©å±•å¤šç§å¤©æ°”ç±»å‹ï¼ˆä¸ä»…ä»…æ˜¯é™é›¨é‡ï¼‰å’Œç›¸åº”çš„ä¿é™©äº§å“ï¼Œæˆ‘ä»¬å¯¹ç³»ç»Ÿè¿›è¡Œäº†æ‰©å±•æ€§æ”¹é€ ã€‚æœ¬æ–‡æ¡£è¯´æ˜æ”¹é€ å†…å®¹å’Œä½¿ç”¨æ–¹æ³•ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-27  
**æœ€åæ›´æ–°**ï¼š2025-01-27

---

## è®¾è®¡ç›®æ ‡

1. **æ”¯æŒå¤šç§å¤©æ°”ç±»å‹**ï¼šé™é›¨é‡ã€æ¸©åº¦ã€é£é€Ÿã€æ¹¿åº¦ã€æ°”å‹ã€é™é›ªç­‰
2. **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç ï¼ˆåŸºäºé™é›¨é‡ï¼‰æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œ
3. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript ç±»å‹ç³»ç»Ÿç¡®ä¿ç±»å‹ä¸€è‡´æ€§
4. **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°çš„å¤©æ°”ç±»å‹åªéœ€é…ç½®ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘

---

## ç±»å‹ç³»ç»Ÿæ‰©å±•

### 1. å¤©æ°”ç±»å‹å®šä¹‰

```typescript
// src/types/data.ts
export type WeatherType = 'rainfall' | 'temperature' | 'wind' | 'humidity' | 'pressure' | 'snowfall';
export type DataType = 'historical' | 'predicted';

// å‘åå…¼å®¹
export type RainfallType = DataType; // 'historical' | 'predicted'
```

### 2. é€šç”¨å¤©æ°”æ•°æ®æ¥å£

```typescript
// é€šç”¨å¤©æ°”æ•°æ®æ¥å£ï¼ˆæ¨èä½¿ç”¨ï¼‰
export interface WeatherData {
  date: string; // ISOæ ¼å¼
  value: number; // æ•°å€¼ï¼ˆæ ¹æ®å¤©æ°”ç±»å‹æœ‰ä¸åŒçš„å•ä½å’Œå«ä¹‰ï¼‰
  risk?: 'low' | 'medium' | 'high';
  weatherType?: WeatherType; // å¤©æ°”ç±»å‹æ ‡è¯†
}

// åŒºåŸŸå¤©æ°”æ•°æ®é›†åˆ
export interface RegionWeatherData {
  [districtName: string]: WeatherData[];
}

// å‘åå…¼å®¹ï¼šé™é›¨é‡æ•°æ®æ¥å£
export interface RainfallData {
  date: string;
  amount: number; // é™é›¨é‡ (mm)
  risk?: 'low' | 'medium' | 'high';
}

export interface RegionData {
  [districtName: string]: RainfallData[];
}
```

### 3. äº§å“ç±»å‹æ‰©å±•

```typescript
// src/types/product.ts
export interface Product {
  id: string;
  name: string;
  type: ProductType; // æ—¶é—´ç»´åº¦ï¼š'daily' | 'weekly' | 'monthly'
  weatherType: WeatherType; // æ•°æ®ç»´åº¦ï¼š'rainfall' | 'temperature' | ...
  description: string;
  icon: string;
  riskRules: RiskRule; // äº§å“çº§çš„é£é™©äº‹ä»¶è§¦å‘æ¡ä»¶ï¼ˆç”¨äºè®¡ç®—ï¼‰
  payoutRules?: PayoutRule; // ä¿å•çº§çš„èµ”ä»˜åŸåˆ™ï¼ˆå¯é€‰ï¼Œä»…ç”¨äºæ•™è‚²å±•ç¤ºï¼Œä¸å‚ä¸è®¡ç®—ï¼‰
}

export interface RiskRule {
  triggerType: ProductType; // æ—¶é—´ç»´åº¦
  weatherType: WeatherType; // æ•°æ®ç»´åº¦ï¼Œå¿…é¡»ä¸ Product.weatherType ä¸€è‡´
  timeWindow: TimeWindowConfig;
  thresholds: Threshold[];
  calculation: CalculationConfig;
}

export interface CalculationConfig {
  aggregation: 'sum' | 'average' | 'max' | 'min';
  operator: '>' | '<' | '>=' | '<=' | '==';
  unit: 'mm' | 'inch' | 'celsius' | 'fahrenheit' | 'kmh' | 'mph' | 'percent' | 'hpa' | 'psi';
}

export interface PayoutRule {
  // èµ”ä»˜é¢‘ç‡é™åˆ¶ï¼ˆä»…ç”¨äºæ•™è‚²å±•ç¤ºï¼‰
  frequencyLimit?: string; // å¦‚ "once per day per policy", "once per month per policy"
  
  // ç†èµ”é¢åº¦ç™¾åˆ†æ¯”ï¼ˆä»…ç”¨äºæ•™è‚²å±•ç¤ºï¼Œå‰ç«¯å±•ç¤ºç™¾åˆ†æ¯”æ•°å€¼ï¼‰
  // tier 1: 20%, tier 2: 50%, tier 3: 100%
  payoutPercentages: {
    tier1: number; // 20
    tier2: number; // 50
    tier3: number; // 100
  };
}
```

---

## æ•°æ®ç”Ÿæˆå™¨æ‰©å±•

### 1. é€šç”¨å¤©æ°”æ•°æ®ç”Ÿæˆå™¨

**æ–‡ä»¶**ï¼š`src/lib/weatherDataGenerator.ts`

```typescript
export interface WeatherDataGenerator {
  generate(
    region: Region,
    dateRange: DateRange,
    dataType: DataType,
    weatherType: WeatherType
  ): RegionWeatherData;
  
  hasData(...): boolean;
  supplement(...): RegionWeatherData;
  getDailyData(...): WeatherData[];
}

export class MockWeatherDataGenerator implements WeatherDataGenerator {
  // å®ç°æ”¯æŒæ‰€æœ‰å¤©æ°”ç±»å‹çš„æ•°æ®ç”Ÿæˆ
}
```

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒæ‰€æœ‰å¤©æ°”ç±»å‹ï¼ˆé€šè¿‡ `WEATHER_CONFIGS` é…ç½®ï¼‰
- æ¯ç§å¤©æ°”ç±»å‹æœ‰ç‹¬ç«‹çš„ç”Ÿæˆå‚æ•°ï¼ˆåŸºç¡€å€¼èŒƒå›´ã€æ—¶é—´å› å­ã€å­£èŠ‚æ€§å› å­ç­‰ï¼‰
- è‡ªåŠ¨è®¡ç®—é£é™©çº§åˆ«ï¼ˆæ ¹æ®å¤©æ°”ç±»å‹å’Œæ•°å€¼ï¼‰

### 2. å‘åå…¼å®¹çš„é™é›¨é‡ç”Ÿæˆå™¨

**æ–‡ä»¶**ï¼š`src/lib/rainfallDataGenerator.ts`

```typescript
// å‘åå…¼å®¹ï¼šå†…éƒ¨ä½¿ç”¨ WeatherDataGenerator
export class MockRainfallDataGenerator implements RainfallDataGenerator {
  generate(region: Region, dateRange: DateRange, type: DataType): RegionData {
    // å†…éƒ¨è°ƒç”¨ weatherDataGenerator.generate(..., 'rainfall')
    // å¹¶è½¬æ¢ä¸º RainfallData æ ¼å¼
  }
}
```

**ç‰¹ç‚¹**ï¼š
- ä¿æŒç°æœ‰æ¥å£ä¸å˜
- å†…éƒ¨ä½¿ç”¨é€šç”¨ç”Ÿæˆå™¨
- è‡ªåŠ¨è½¬æ¢æ•°æ®æ ¼å¼

---

## äº§å“åº“æ‰©å±•

### 1. äº§å“é…ç½®

**æ–‡ä»¶**ï¼š`src/data/products.ts`

æ‰€æœ‰äº§å“ç°åœ¨å¿…é¡»åŒ…å« `weatherType` å­—æ®µï¼š

```typescript
{
  id: 'daily',
  name: 'Daily Heavy Rain',
  type: 'daily',
  weatherType: 'rainfall', // æ–°å¢å­—æ®µ
  description: '...',
  icon: 'ğŸŒ§ï¸',
  riskRules: {
    triggerType: 'daily',
    weatherType: 'rainfall', // å¿…é¡»ä¸ Product.weatherType ä¸€è‡´
    // ...
  }
}
```

### 2. äº§å“æŸ¥è¯¢æ‰©å±•

æœªæ¥å¯ä»¥æ‰©å±• `ProductLibrary` æ”¯æŒæŒ‰å¤©æ°”ç±»å‹æŸ¥è¯¢ï¼š

```typescript
class ProductLibrary {
  // ç°æœ‰æ–¹æ³•
  getProduct(id: string): Product | null;
  getProductsByType(type: ProductType): Product[];
  
  // æ–°å¢æ–¹æ³•ï¼ˆæœªæ¥å®ç°ï¼‰
  getProductsByWeatherType(weatherType: WeatherType): Product[];
  getProductsByTypeAndWeather(type: ProductType, weatherType: WeatherType): Product[];
  getSupportedWeatherTypes(): WeatherType[];
}
```

---

## ä½¿ç”¨æŒ‡å—

### 1. ç”Ÿæˆé€šç”¨å¤©æ°”æ•°æ®

```typescript
import { weatherDataGenerator } from '@/lib/weatherDataGenerator';

// ç”Ÿæˆé™é›¨é‡æ•°æ®
const rainfallData = weatherDataGenerator.generate(
  region,
  dateRange,
  'historical',
  'rainfall'
);

// ç”Ÿæˆæ¸©åº¦æ•°æ®
const temperatureData = weatherDataGenerator.generate(
  region,
  dateRange,
  'historical',
  'temperature'
);
```

### 2. ä½¿ç”¨å‘åå…¼å®¹çš„é™é›¨é‡ç”Ÿæˆå™¨

```typescript
import { rainfallDataGenerator } from '@/lib/rainfallDataGenerator';

// ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
const rainfallData = rainfallDataGenerator.generate(
  region,
  dateRange,
  'historical'
);
```

### 3. å®šä¹‰æ–°äº§å“

åœ¨ `src/data/products.ts` ä¸­æ·»åŠ æ–°äº§å“ï¼š

```typescript
{
  id: 'temperature-daily',
  name: 'Daily High Temperature',
  type: 'daily',
  weatherType: 'temperature', // æŒ‡å®šå¤©æ°”ç±»å‹
  description: 'Daily maximum temperature > threshold',
  icon: 'ğŸŒ¡ï¸',
  riskRules: {
    triggerType: 'daily',
    weatherType: 'temperature', // å¿…é¡»ä¸€è‡´
    timeWindow: { type: 'hourly', size: 24, step: 1 },
    thresholds: [
      { value: 35, level: 'high', label: '35Â°C' },
      { value: 30, level: 'medium', label: '30Â°C' },
      { value: 25, level: 'low', label: '25Â°C' }
    ],
    calculation: {
      aggregation: 'max',
      operator: '>',
      unit: 'celsius'
    }
  }
}
```

---

## æ‰©å±•æ–°å¤©æ°”ç±»å‹

### 1. æ·»åŠ å¤©æ°”ç±»å‹å®šä¹‰

åœ¨ `src/types/data.ts` ä¸­æ‰©å±• `WeatherType`ï¼š

```typescript
export type WeatherType = 
  | 'rainfall' 
  | 'temperature' 
  | 'wind' 
  | 'humidity' 
  | 'pressure' 
  | 'snowfall'
  | 'newType'; // æ–°å¢ç±»å‹
```

### 2. æ·»åŠ ç”Ÿæˆé…ç½®

åœ¨ `src/lib/weatherDataGenerator.ts` çš„ `WEATHER_CONFIGS` ä¸­æ·»åŠ é…ç½®ï¼š

```typescript
const WEATHER_CONFIGS: Record<WeatherType, WeatherGenerationConfig> = {
  // ... ç°æœ‰é…ç½®
  newType: {
    baseRange: { min: 0, max: 100 },
    historicalFactor: 1.0,
    predictedFactor: 0.9,
    timeFactors: [/* ... */],
    seasonalStrength: 0.3
  }
};
```

### 3. æ·»åŠ é£é™©çº§åˆ«è®¡ç®—é€»è¾‘

åœ¨ `calculateRiskLevel` å‡½æ•°ä¸­æ·»åŠ æ–°ç±»å‹çš„é£é™©è®¡ç®—ï¼š

```typescript
function calculateRiskLevel(weatherType: WeatherType, value: number): ... {
  switch (weatherType) {
    // ... ç°æœ‰case
    case 'newType':
      // å®šä¹‰é£é™©çº§åˆ«è®¡ç®—é€»è¾‘
      if (value >= threshold) return 'high';
      // ...
      return undefined;
  }
}
```

### 4. æ·»åŠ å•ä½æ”¯æŒ

åœ¨ `src/types/product.ts` çš„ `CalculationConfig.unit` ä¸­æ·»åŠ æ–°å•ä½ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š

```typescript
unit: 'mm' | 'inch' | 'celsius' | 'fahrenheit' | ... | 'newUnit';
```

---

## å‘åå…¼å®¹æ€§

### å·²ä¿æŒå…¼å®¹çš„éƒ¨åˆ†

1. **ç±»å‹åˆ«å**ï¼š`RainfallType = DataType`ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
2. **æ¥å£ä¿ç•™**ï¼š`RainfallData` å’Œ `RegionData` æ¥å£ä¿ç•™ï¼Œç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ
3. **ç”Ÿæˆå™¨æ¥å£**ï¼š`RainfallDataGenerator` æ¥å£ä¿ç•™ï¼Œå†…éƒ¨ä½¿ç”¨é€šç”¨ç”Ÿæˆå™¨
4. **ç»„ä»¶ä½¿ç”¨**ï¼šç°æœ‰ç»„ä»¶ï¼ˆå¦‚ `ControlPanel`ã€`Dashboard`ï¼‰æ— éœ€ä¿®æ”¹

### éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ï¼ˆå¯é€‰ï¼‰

å¦‚æœå¸Œæœ›ä½¿ç”¨æ–°çš„é€šç”¨æ¥å£ï¼Œå¯ä»¥é€æ­¥è¿ç§»ï¼š

1. å°† `RainfallType` æ›¿æ¢ä¸º `DataType`
2. å°† `RainfallData` æ›¿æ¢ä¸º `WeatherData`
3. å°† `RegionData` æ›¿æ¢ä¸º `RegionWeatherData`
4. ä½¿ç”¨ `WeatherDataGenerator` æ›¿ä»£ `RainfallDataGenerator`

---

## ç›¸å…³æ–‡æ¡£

- `doc/04-Mockæ•°æ®ç”Ÿæˆå™¨.md` - æ•°æ®ç”Ÿæˆå™¨è¯¦ç»†è¯´æ˜ï¼ˆå·²æ›´æ–°ï¼‰
- `doc/06-äº§å“åº“åŸºç¡€ç»“æ„.md` - äº§å“åº“è¯¦ç»†è¯´æ˜ï¼ˆå·²æ›´æ–°ï¼‰
- `src/types/data.ts` - ç±»å‹å®šä¹‰
- `src/lib/weatherDataGenerator.ts` - é€šç”¨å¤©æ°”æ•°æ®ç”Ÿæˆå™¨å®ç°
- `src/data/products.ts` - äº§å“é…ç½®ç¤ºä¾‹

---

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡æ‰©å±•æ€§æ”¹é€ ï¼š

1. âœ… **ç±»å‹ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šç§å¤©æ°”ç±»å‹ï¼Œç±»å‹å®‰å…¨
2. âœ… **æ•°æ®ç”Ÿæˆå™¨**ï¼šé€šç”¨ç”Ÿæˆå™¨æ”¯æŒæ‰€æœ‰å¤©æ°”ç±»å‹ï¼Œå‘åå…¼å®¹
3. âœ… **äº§å“åº“**ï¼šäº§å“æ”¯æŒå¤©æ°”ç±»å‹å­—æ®µï¼Œæ˜“äºæ‰©å±•
4. âœ… **æ–‡æ¡£**ï¼šæ›´æ–°äº†ç›¸å…³æ–‡æ¡£ï¼Œè¯´æ˜æ‰©å±•æ€§è®¾è®¡
5. âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œ

æœªæ¥æ·»åŠ æ–°çš„å¤©æ°”ç±»å‹å’Œäº§å“æ—¶ï¼Œåªéœ€ï¼š
1. åœ¨ `WeatherType` ä¸­æ·»åŠ æ–°ç±»å‹
2. åœ¨ `WEATHER_CONFIGS` ä¸­æ·»åŠ é…ç½®
3. åœ¨ `calculateRiskLevel` ä¸­æ·»åŠ é£é™©è®¡ç®—é€»è¾‘
4. åœ¨ `products.ts` ä¸­æ·»åŠ æ–°äº§å“å®šä¹‰

å³å¯å®Œæˆæ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘ã€‚

