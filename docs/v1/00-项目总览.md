# 00-项目总览

## 1. 项目背景

### 1.1 项目概述
本项目旨在构建一个**Index Insurance 门户网站**，通过直观的可视化演示，帮助用户理解天气数据、风险事件和保险产品的运行机制。

### 1.2 项目目标
- **产品展示与教育**：通过差异化比较介绍 index insurance，集合多种创新的 index 保险产品
- **数据集成**：集成历史、当前和预测的天气数据，提供全面的天气信息视图
- **可视化演示**：建立自定义地图和配套的数据面板，将 Index 产品叠加至天气数据，可视化风险评估原理以及风险事件的触发机制
- **智能交互**：引入情景式 AI 聊天窗口，降低用户使用门槛，提升交互体验
- **视觉体验**：UI 风格参考 Google Maps Platform 和 Apple App Store，打造现代、简洁、直观的用户界面

### 1.3 项目定位
- **目标市场**：全球范围（不限制特定地区）
- **核心价值**：教育性、透明性、交互性
- **产品类型**：门户网站（Web Application）

---

## 2. 技术栈

### 2.1 前端框架和工具
- **React 19**：用于构建用户界面
- **TypeScript**：提供类型安全
- **Vite**：构建工具和开发服务器
- **Tailwind CSS**：样式框架
- **Framer Motion**：动画库

### 2.2 地图和AI集成（需新增）
- **Google Maps JavaScript API**：地图渲染和交互
- **Google Contextual View AI kit**：AI 对话界面
- **Grounding Lite MCP**：自然语言理解和参数提取

### 2.3 数据可视化
- **Recharts**：数据可视化图表库
- **自定义地图图层**：基于 Google Maps Data Layer 和 Polygon

### 2.4 其他依赖
- **date-fns**：日期处理
- **lucide-react**：图标库
- **radix-ui**：UI 组件库

---

## 3. 项目结构

### 3.1 目录结构
```
Next-gen-index/
├── src/
│   ├── App.tsx                    # 主应用组件
│   ├── main.tsx                   # 应用入口
│   ├── components/
│   │   ├── home/                  # 首页相关组件
│   │   │   ├── Dashboard.tsx     # 首页主组件（中心化状态管理）
│   │   │   ├── MapWorkspace.tsx  # 地图工作区（Google Maps）
│   │   │   ├── ControlPanel.tsx   # 手动选择面板
│   │   │   ├── ContextualAssistant.tsx  # AI对话面板
│   │   │   ├── ProductSelector.tsx      # 产品选择器
│   │   │   ├── DataDashboard.tsx       # 数据面板
│   │   │   └── types.ts                # 类型定义
│   │   ├── product/               # 产品介绍页相关组件
│   │   │   └── ProductIntro.tsx
│   │   ├── figma/                 # Figma 相关组件
│   │   │   └── ImageWithFallback.tsx
│   │   ├── layout/                # 布局组件
│   │   │   └── Header.tsx
│   │   └── ui/                    # UI基础组件（shadcn/ui）
│   ├── hooks/                     # 自定义 Hooks
│   │   ├── useRiskAnalysis.ts    # 中心化风险分析 Hook
│   │   ├── useWeatherData.ts      # 天气数据获取 Hook（包含 useWeatherStatistics, useDailyWeatherData）
│   │   ├── useExtendedWeatherData.ts # 扩展数据获取 Hook（通用）
│   │   ├── useRainfallData.ts     # 降雨量数据 Hook（向后兼容）
│   │   ├── useRainfallHeatmapLayer.ts # 降雨量热力图图层 Hook
│   │   ├── useRegionBoundaryLayer.ts  # 行政区域边界图层 Hook
│   │   ├── useRiskEventMarkersLayer.ts # 风险事件标记图层 Hook
│   │   └── useRegionData.ts       # 区域数据管理 Hook
│   ├── lib/                       # 工具库
│   │   ├── weatherDataGenerator.ts # 通用天气数据生成器
│   │   ├── rainfallDataGenerator.ts # 降雨量数据生成器
│   │   ├── productLibrary.ts      # 产品库
│   │   ├── riskCalculationEngine.ts # 风险计算引擎
│   │   ├── riskCalculationService.ts # 风险计算服务
│   │   ├── gadmDataLoader.ts      # GADM 数据加载器
│   │   ├── dataAdapters.ts        # 数据格式转换适配器
│   │   ├── geocoding.ts           # 地理编码服务
│   │   ├── googleMaps.ts          # Google Maps 初始化
│   │   ├── gpsLocation.ts         # GPS 定位功能
│   │   ├── mockData.ts            # Mock 数据定义
│   │   ├── regionData.ts          # 区域数据管理
│   │   ├── weatherStatistics.ts   # 天气统计计算工具
│   │   └── utils.ts              # 工具函数
│   ├── types/                     # 类型定义
│   │   ├── region.ts             # 区域相关类型
│   │   ├── data.ts               # 数据相关类型
│   │   ├── product.ts            # 产品相关类型
│   │   ├── risk.ts               # 风险相关类型
│   │   ├── map.ts                # 地图相关类型
│   │   ├── common.ts             # 通用类型
│   │   ├── google.maps.d.ts      # Google Maps 类型扩展
│   │   └── index.ts              # 类型导出
│   ├── interfaces/                # 接口定义（实现契约）
│   │   ├── dataGenerator.ts      # 数据生成器接口
│   │   ├── mapService.ts         # 地图服务接口
│   │   ├── productLibrary.ts     # 产品库接口
│   │   ├── riskCalculation.ts    # 风险计算引擎接口
│   │   ├── riskCalculationService.ts # 风险计算服务接口
│   │   ├── index.ts              # 接口导出
│   │   └── README.md             # 接口说明文档
│   ├── data/                      # 数据文件
│   │   ├── gadm/                 # GADM 行政区域数据
│   │   ├── google/                # Google 名称和映射数据
│   │   ├── products.ts           # 产品配置文件
│   │   ├── regions.ts            # 区域数据导入和名称转换
│   │   └── README.md             # 数据目录说明
│   └── styles/                    # 样式文件
│       └── globals.css            # 全局样式
└── doc/                           # 项目文档
```

**目录说明**：
- **`types/` 目录**：包含 TypeScript 类型定义，用于类型检查和代码提示
- **`interfaces/` 目录**：包含接口定义，用于实现契约和依赖注入，便于测试和扩展
- **`hooks/` 目录**：包含自定义 React Hooks，实现业务逻辑的复用和状态管理
- **`lib/` 目录**：包含工具函数和服务实现，提供核心业务功能
- **`data/` 目录**：包含静态数据文件（JSON、TypeScript 配置文件等）

### 3.2 主要组件说明

#### 3.2.1 首页（Dashboard）
- **Dashboard**：首页主组件，实现中心化状态管理，统一持有所有计算状态
- **MapWorkspace**：地图工作区，使用 Google Maps 渲染地图和数据图层
- **ControlPanel**：手动选择面板，包含区域选择、数据类型切换、时间范围选择、产品选择
- **ContextualAssistant**：AI对话面板，使用Google Contextual View AI kit
- **ProductSelector**：产品选择器，显示可选的保险产品
- **DataDashboard**：数据面板，展示分析汇总、图表和风险事件时间线

#### 3.2.2 产品介绍页（ProductIntro）
- 图文并茂介绍index insurance和不同保险产品
- 支持从首页跳转并传递产品参数

---

## 4. 核心功能模块

### 4.1 地图可视化模块
- **Google Maps集成**：替换现有的SVG模拟地图
- **地图动画系统**：实现平滑的地图视图切换动画（参考 [25-矢量地图动画切换.md](./25-矢量地图动画切换.md)）
  - 页面初始化动画：高空伪飞入效果
  - 远距离地址切换：抛物线 Fly-To 动画
  - 2D/3D 模式切换：平滑过渡动画
- **数据图层**：
  - 图层1：历史天气数据热力图
  - 图层2：预测天气数据热力图
  - 图层3：历史风险事件标记
  - 图层4：预测风险事件标记
- **图层控制**：支持开启/关闭图层
- **行政区域边界**：基于GeoJSON数据绘制Polygon

### 4.2 数据计算模块
- **Mock数据生成器**：根据区域、天气类型和时间范围生成天气数据（支持多种天气类型）
- **保险产品库**：管理产品定义和产品级的风险事件触发条件，支持多天气类型产品
- **风险计算引擎**：基于产品规则计算风险事件，支持产品级风险事件触发条件计算
- **中心化 Hooks**：
  - `useRiskAnalysis`：风险分析唯一入口，生成风险事件和统计信息
  - `useWeatherStatistics`：天气基础统计（时间窗口、均值、总量），位于 `useWeatherData.ts`
  - `useWeatherData`：天气数据获取和缓存，包含 `useDailyWeatherData` 和 `useWeatherStatistics`
  - `useExtendedWeatherData`：扩展数据获取（通用，用于风险叠加示意图和风险事件计算）
- **地图图层 Hooks**：
  - `useRainfallHeatmapLayer`：降雨量热力图图层管理
  - `useRegionBoundaryLayer`：行政区域边界图层管理
  - `useRiskEventMarkersLayer`：风险事件标记图层管理
- **数据管理 Hooks**：
  - `useRegionData`：区域数据管理
  - `useRainfallData`：降雨量数据获取（向后兼容）
- **数据缓存**：使用useMemo优化性能，支持历史数据持久化

### 4.3 用户交互模块
- **手动选择**：区域选择、数据类型切换、时间范围选择、产品选择
- **GPS定位**：获取用户位置并转换为行政区域
- **AI对话**：使用Contextual View和Grounding Lite实现自然语言交互
- **地图交互**：点击区域切换、图层控制

### 4.4 数据展示模块
- **分析汇总**：
  - 时间窗口（天数 + 小时数）
  - 平均天气数值（根据产品类型显示 hourly/daily）
  - 总天气数值
  - 风险事件数量（仅在选中产品时显示）
  - 风险严重程度（仅在选中产品时显示）
- **图表可视化**：
  - 天气数值柱状图（按天/按小时，支持视图切换）
  - 天气数据和风险叠加示意图（三种产品类型，支持扩展数据回溯）
  - 风险事件触发时间线（显示详细风险事件信息）

---

## 5. 技术架构

### 5.1 组件架构
```
App
├── Header
└── Main
    ├── Dashboard (首页)
    │   ├── MapWorkspace (地图工作区)
    │   │   ├── Google Maps Container
    │   │   ├── Layer Controls (图层控制)
    │   │   └── Overlays (数据图层)
    │   ├── ControlPanel (手动选择面板)
    │   ├── ContextualAssistant (AI 对话面板)
    │   ├── ProductSelector (产品选择器)
    │   └── DataDashboard (数据面板)
    └── ProductIntro (产品介绍页)
```

### 5.2 数据流架构（中心化 Hook 架构）

```
用户操作 (手动/AI)
    ↓
参数变更 (selectedRegion, dataType, dateRange, selectedProduct, weatherType)
    ↓
Dashboard.tsx (中心化状态管理)
    ├── useWeatherData (天气数据获取，useMemo 缓存)
    ├── useWeatherStatistics (天气基础统计：时间窗口、均值、总量)
    └── useRiskAnalysis (风险分析，唯一事实来源)
        ├── 监听参数变更，自动触发计算
        ├── 调用 RiskCalculationService
        ├── 生成 riskEvents (原始风险事件列表)
        ├── 生成 mapMarkersData (地图标记聚合数据)
        └── 生成 statistics (风险分级统计)
    ↓
数据分发 (单向数据流)
    ├── MapWorkspace (地图图层)
    │   ├── 使用 mapMarkersData 渲染风险标记
    │   └── 使用 weatherData 渲染热力图
    └── DataDashboard (数据面板)
        ├── 使用 statistics 显示分析汇总
        ├── 使用 riskEvents 渲染图表和时间线
        └── 使用 weatherStatistics 显示天气统计
```

**架构特点**：
- **中心化状态管理**：`Dashboard.tsx` 统一持有所有计算状态
- **唯一事实来源**：`useRiskAnalysis` 作为风险计算的唯一入口
- **职责分离**：天气统计与风险计算解耦，通过独立 Hook 管理
- **单向数据流**：数据从 Dashboard 向下分发，保证一致性

**重要说明**：当前仅计算并可视化产品级的风险事件触发条件，不涉及保单级的赔付计算。

### 5.3 核心模块架构

```
中心化 Hooks 层
    ├── useRiskAnalysis (风险分析 Hook)
    │   ├── 输入：selectedRegion, dateRange, selectedProduct, weatherType, dataType, weatherData
    │   ├── 内部：调用 RiskCalculationService
    │   └── 输出：riskEvents, mapMarkersData, statistics, isCalculated
    │
    ├── useWeatherStatistics (天气统计 Hook)
    │   ├── 输入：weatherData, dateRange
    │   └── 输出：timeWindow, metrics (total, avgDaily, avgHourly, max, min)
    │
    └── useWeatherData (天气数据获取 Hook)
        ├── 输入：selectedRegion, dateRange, dataType, weatherType
        └── 输出：hourlyData, dailyData (useMemo 缓存)

业务逻辑层
    ├── 保险产品库 (Product Library)
    │   ├── 产品定义 (产品级的风险事件触发条件)
    │   │   ├── riskRules (触发条件、阈值配置、风险级别定义)
    │   │   └── payoutRules (保单级的赔付原则，仅用于教育展示)
    │   └── 产品查询接口
    │
    ├── 风险计算引擎 (Risk Calculation Engine)
    │   ├── 产品规则解析器 (解析产品级的风险事件触发条件)
    │   ├── 风险事件计算器 (基于产品级的风险事件触发条件)
    │   └── 结果格式化器
    │
    └── RiskCalculationService (风险计算服务)
        ├── 协调产品库和计算引擎
        ├── 数据聚合（全域统计、选中城市统计）
        └── 错误处理

数据层
    ├── Mock 数据生成器 (weatherDataGenerator, rainfallDataGenerator)
    ├── 区域数据管理 (GADM + Google 名称双数据源)
    └── 扩展数据获取 (useExtendedWeatherData，通用，用于风险叠加示意图和风险事件计算)
```

**重要说明**：
- **产品级的风险事件触发条件**（当前实现）：定义什么情况触发风险事件，触发风险的级别（tier 1, tier 2, tier 3）
- **保单级的赔付原则**（可选，仅用于教育展示）：定义赔付多少金额，赔付几次（如"once per day per policy"、"对应不同理赔额度"）
- **当前网站范围**：目前该网站仅计算并可视化产品级的风险事件触发条件，不涉及保单级的赔付计算
- **架构升级**：采用中心化 Hook 架构，实现"唯一事实来源"原则，提升系统一致性和可维护性

---

## 6. 关键设计决策

### 6.1 地图图层实现方案
**决策**：使用 Data Layer + Polygon + 自定义渐变

**理由**：
- 可以精确控制行政区域边界
- 可以实现"从中心往边界逐渐变浅"的渐变效果
- 性能可接受，实现复杂度适中
- 未来可以升级到 WebGL Overlay View + deck.gl

### 6.2 AI对话集成方案
**决策**：使用 Google Contextual View AI kit + Grounding Lite MCP

**理由**：
- 符合需求文档要求
- 官方支持，文档完善
- 与 Google Maps 深度集成
- 支持自然语言理解和参数提取

### 6.3 产品库与计算引擎分离
**决策**：设立独立的保险产品库和风险计算引擎，两者协同工作

**理由**：
- **可扩展性**：支持未来添加更多不同类型的产品，无需修改核心计算逻辑
- **可维护性**：产品配置与业务逻辑分离，便于产品管理和规则更新
- **可测试性**：产品库和计算引擎独立，便于单元测试和集成测试
- **灵活性**：支持产品级和保单级两层定义，当前实现产品级，未来可扩展保单级

### 6.4 状态管理方案
**决策**：使用 React useState + useMemo + 中心化 Hooks，不引入 Redux

**理由**：
- 状态结构相对简单，不需要复杂的状态管理
- 减少依赖，保持项目轻量
- 使用 `useMemo` 可以满足性能需求
- 中心化 Hooks（`useRiskAnalysis`, `useWeatherStatistics`）实现"唯一事实来源"原则

### 6.5 中心化 Hook 架构
**决策**：采用中心化的 `useRiskAnalysis` Hook 作为风险计算的唯一入口

**理由**：
- **唯一事实来源**：解决风险计算逻辑分散的问题，确保数据一致性
- **职责分离**：天气统计（`useWeatherStatistics`）与风险计算解耦，保持单一职责
- **数据聚合**：统一处理全域统计（地图标记）和选中城市统计（数据面板）
- **易于维护**：计算逻辑集中管理，便于测试和扩展
- **性能优化**：通过 `useMemo` 缓存计算结果，避免重复计算

### 6.6 扩展数据获取方案
**决策**：建立通用的扩展数据获取方案，既用于风险叠加示意图，又用于风险事件计算

**理由**：
- **计算准确性**：确保图表起始位置的数据点能正确回溯计算纵轴值，同时确保风险事件计算在时间窗口起始位置的准确性
- **通用性**：扩展数据既用于风险叠加示意图的纵轴值计算，也用于风险事件计算
- **隔离性**：扩展数据不影响其他模块（风险展示、天气统计仍使用原始数据）
- **动态性**：根据产品 `riskRules.timeWindow` 动态计算扩展范围，支持所有产品类型
- **性能优化**：仅在需要时获取扩展数据，利用现有缓存机制

### 6.7 数据存储方案
**决策**：客户端实时生成 Mock 数据，使用 useMemo 缓存

**理由**：
- 符合当前需求（仅使用 Mock 数据）
- 无需后端服务，简化架构
- 未来可以轻松替换为真实 API 调用

### 6.8 双数据源架构（区域数据）
**决策**：采用 Google 名称和 GADM 数据双数据源设计

**理由**：
- **UI 友好性**：使用 Google 官方名称作为 UI 展示，提升用户体验
- **GIS 准确性**：使用 GADM 数据作为边界渲染和 GPS 定位的数据源
- **API 兼容性**：Google 名称与 Weather API 和 Geocoding API 兼容
- **名称映射**：通过映射表实现双向转换，保证数据一致性

---

## 7. 开发环境

### 7.1 环境要求
- **Node.js**：版本 18 或更高
- **npm**：随 Node.js 安装
- **现代浏览器**：Chrome, Firefox, Safari, Edge

### 7.2 API Key配置
- **Google Cloud Project**：`axinan-dev`
- **API Key配置**：通过环境变量 `VITE_GOOGLE_MAPS_API_KEY` 配置
- **已开启的 API**：
  - Maps JavaScript API
  - Geocoding API（用于反向地理编码）
  - Weather API

**配置步骤**：
1. 复制 `.env.example` 文件为 `.env`
2. 在 `.env` 文件中设置 `VITE_GOOGLE_MAPS_API_KEY=your_actual_api_key`
3. 重启开发服务器使环境变量生效

**注意**：
- 请勿将 `.env` 文件提交到版本控制系统
- 生产环境应使用环境变量或安全的密钥管理服务
- API Key 应限制使用范围，仅允许必要的域名和API

### 7.3 依赖安装
```bash
cd Next-gen-index
npm install
```

### 7.4 开发服务器
```bash
npm run dev
```

应用将在 `http://localhost:5173` 启动（或另一个可用端口）。

---

## 8. 项目约束

### 8.1 技术约束
- 前端代码已存在，需直接使用 `Next-gen-index/src` 下的代码
- 必须使用 Google Maps JavaScript API 构建地图
- AI 咨询窗口必须使用 Google Contextual View AI kit 和 Grounding Lite MCP
- 目前仅使用 Mock weather data，不接入真实天气 API

### 8.2 业务约束
- 历史数据最多选择 40 天内
- 预测数据默认未来 10 天
- 时间窗口需要明确起止日期和时刻（整数小时，24 小时制）
- 只能选择一个保险产品进行叠加
- **产品级 vs 保单级**：
  - **产品级的风险事件触发条件**（当前实现）：定义什么情况触发风险事件，触发风险的级别（tier 1, tier 2, tier 3）
  - **保单级的赔付原则**（未来扩展）：定义赔付多少金额，赔付几次（如"once per day per policy"、"对应不同理赔额度"）
- **当前网站范围**：目前仅计算并可视化产品级的风险事件触发条件，不涉及保单级的赔付计算

### 8.3 数据约束
- Mock weather data 在用户选择"市/区"后实时生成
- 时间范围：过去 40 天至未来 10 天
- 空间范围：选择的"市/区"所属的"省/州"下所有的"市/区"

---

## 9. 参考文档

### 9.1 项目文档
- **需求分析文档**：`doc/需求分析.md`
- **技术方案文档**：`doc/技术方案.md`
- **Figma详细设计**：`doc/figma-make详细设计.md`
- **实现步骤总览**：`doc/01-实现步骤总览.md`
- **补充文档**：
  - `doc/补充-风险计算架构升级方案.md`：中心化 Hook 架构设计
  - `doc/补充-扩展数据的获取和使用.md`：扩展数据获取通用方案
  - `doc/补充-扩展性设计-多天气类型支持.md`：多天气类型产品支持

### 9.2 Google Maps Platform 文档
- Maps JavaScript API 文档
- Advanced Markers 文档
- Data Layer 文档
- Geocoding API 文档
- Grounding with Google Maps 文档
- Contextual View Widget 文档

（通过 MCP google-maps-platform-code-assist 获取最新文档）

---

**文档版本**：v2.1  
**创建日期**：2025-01-27  
**最后更新**：2025-12-18

**更新说明**：
- v2.1 (2025-12-18)：
  - 更新目录结构，补充所有实际存在的文件和目录
  - 修正 `useWeatherStatistics` 的位置说明（位于 `useWeatherData.ts` 中，非独立文件）
  - 添加 `interfaces/` 目录说明（接口定义，用于实现契约）
  - 补充所有 Hooks 文件列表（包括地图图层 Hooks 和数据管理 Hooks）
  - 补充 `lib/` 目录中的所有工具文件
  - 补充 `data/` 目录中的 `regions.ts` 和 `README.md`
  - 补充 `components/figma/` 目录
  - 添加目录说明，区分 `types/` 和 `interfaces/` 的用途
  - 更新数据计算模块，添加地图图层 Hooks 和数据管理 Hooks 说明
- v2.0 (2025-12-18)：
  - 更新项目结构，反映实际的目录组织（types/, hooks/, data/ 等）
  - 更新数据流架构，反映中心化 Hook 架构（useRiskAnalysis, useWeatherStatistics）
  - 更新核心模块架构，添加中心化 Hooks 层和 RiskCalculationService
  - 添加关键设计决策：中心化 Hook 架构、扩展数据获取方案、双数据源架构
  - 更新数据计算模块和数据展示模块的描述
  - 添加补充文档到参考文档列表
