# 24-3D地图

## 步骤概述

### 步骤编号和名称
**步骤24**：3D地图功能实现

### 步骤目标
实现 Google Maps 的 2D/3D 模式切换功能，支持用户在地图的 2D 和 3D 视角之间自由切换，通过统一的样式配置管理不同模式下的图层显示效果，提供流畅的切换动画和一致的用户体验。

### 预期成果
- 2D/3D 切换按钮已添加到地图控制区域
- 地图支持 3D 倾斜视角（tilt）和旋转（heading）
- 所有图层（边界、热力图、标记）在 3D 模式下正常显示
- 统一的样式配置文件，便于管理和调优
- 流畅的切换动画和过渡效果
- 切换过程流畅，用户体验良好

---

## 前置条件

### 依赖的步骤
- **步骤03**：Google Maps API配置与初始化（必须）
- **步骤11**：行政区域边界绘制（必须）
- **步骤12**：降雨量热力图图层（必须）
- **步骤13**：风险事件标记图层（必须）

### 需要完成的前置工作
- Google Maps JavaScript API 已正确配置和加载
- 地图容器和基础地图功能已实现
- 所有图层（边界、热力图、标记）已实现并正常工作
- Map ID 已配置（需要支持 3D Buildings 的 Map ID）

### 需要的数据/接口
- **Google Maps API**：Maps JavaScript API（已配置）
- **Map ID**：支持 3D Buildings 的自定义 Map ID（需要在 Google Cloud Console 创建）
- **API Key**：已配置的 Google Maps API Key

**Map ID 配置说明**：
1. 在 Google Cloud Console 中创建自定义 Map ID
2. 启用 "3D Buildings" 样式选项
3. 将 Map ID 配置到 `getDefaultMapConfig()` 函数中

---

## 核心设计

### 1. 样式配置统一管理

**设计目标**：通过统一的配置文件管理不同 `mapMode` 下的样式，便于后续调优和维护。

**实现方案**：
- 创建 `mapModeStyles.ts` 配置文件
- 定义 2D 和 3D 模式下的样式配置对象
- 各图层 Hook 从配置文件读取样式
- 支持后续扩展和调优

**配置文件结构**：
```typescript
// 伪代码示例
export const mapModeStyles = {
  '2d': {
    boundary: { strokeWeight: 1, strokeOpacity: 0.4, ... },
    heatmap: { fillOpacity: { min: 0.15, max: 0.7 }, ... },
    markers: { size: 1.0, shadow: 'light' },
    map: { zoom: 11, tilt: 0, rotateControl: false }
  },
  '3d': {
    boundary: { strokeWeight: 3, strokeOpacity: 0.8, ... },
    heatmap: { fillOpacity: { min: 0.2, max: 0.8 }, ... },
    markers: { size: 1.2, shadow: 'enhanced' },
    map: { zoom: 15, tilt: 45, rotateControl: true }
  }
};
```

### 2. 切换动画和过渡效果

**设计目标**：提供流畅的视角切换体验，避免突兀的视角变化。

**实现方案**：
- 使用 Google Maps 的 `setTilt()` 和 `setZoom()` 方法（支持平滑过渡）
- 添加过渡状态管理（`isTransitioning`）
- 在切换过程中禁用用户交互
- 设置合理的过渡时长（建议 500-800ms）

**动画流程**：
1. 用户点击切换按钮
2. 设置 `isTransitioning = true`，禁用交互
3. 平滑过渡到目标模式（tilt、zoom、heading）
4. 过渡完成后，设置 `isTransitioning = false`
5. 更新图层样式（从配置文件读取）

### 3. 图层兼容性

**所有图层完全兼容**：
- ✅ 区域边界图层（Data Layer）：自动适配 3D 视角
- ✅ 降雨量热力图图层（Data Layer）：正常显示
- ✅ 风险事件标记图层（Advanced Markers）：自动调整位置

---

## 样式配置方案

### 配置文件结构

创建 `Next-gen-index/src/config/mapModeStyles.ts`：

```typescript
// 伪代码：样式配置结构
export interface MapModeStyles {
  boundary: BoundaryLayerStyles;
  heatmap: HeatmapLayerStyles;
  markers: MarkerLayerStyles;
  map: MapConfigStyles;
}

export const mapModeStyles: Record<'2d' | '3d', MapModeStyles> = {
  '2d': {
    // 2D 模式样式配置
  },
  '3d': {
    // 3D 模式样式配置
  }
};
```

### 样式参数对照表

| 图层类型 | 样式属性 | 2D 模式 | 3D 模式 | 说明 |
|---------|---------|---------|---------|------|
| **边界图层** |
| | `strokeWeight` | 1-2px | 2-3px | 3D 视角下需要更粗的线条 |
| | `strokeOpacity` | 0.4-0.6 | 0.6-0.9 | 3D 模式下增强描边可见性 |
| | `fillOpacity` | 0.6 | 0.6-0.7 | 基本保持不变 |
| **热力图图层** |
| | `fillOpacity` | 0.15-0.7 | 0.2-0.8 | 3D 模式下略微提高 |
| | `strokeWeight` | 0.5px | 1px | 3D 模式下增强边界 |
| **标记图层** |
| | `sizeMultiplier` | 1.0 | 1.2 | 3D 模式下标记稍大 |
| | `shadow` | 'light' | 'enhanced' | 3D 模式下增强立体感 |
| **地图配置** |
| | `zoom` | 11-13 | 15-18 | 3D 模式需要更高缩放 |
| | `tilt` | 0 | 45 | 3D 模式倾斜角度 |
| | `rotateControl` | false | true | 3D 模式启用旋转控制 |

---

## 实施步骤

### 步骤 1：创建样式配置文件

**文件**：`Next-gen-index/src/config/mapModeStyles.ts`

**任务**：
1. 创建样式配置接口定义
2. 定义 2D 和 3D 模式的样式配置对象
3. 导出配置供各图层使用

**关键点**：
- 使用 TypeScript 接口确保类型安全
- 配置项要覆盖所有图层的样式需求
- 预留扩展空间，便于后续调优

---

### 步骤 2：更新地图配置函数

**文件**：`Next-gen-index/src/lib/googleMaps.ts`

**任务**：
1. 修改 `getDefaultMapConfig()` 函数签名，添加 `mapMode` 参数
2. 从样式配置读取地图配置参数
3. 添加 3D 模式特定配置（`tilt`、`heading`、`rotateControl`）

**关键点**：
- 从 `mapModeStyles` 读取地图配置
- 确保 Map ID 支持 3D Buildings
- 保持向后兼容（默认 2D 模式）

---

### 步骤 3：实现模式切换逻辑

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 添加 `mapMode` 状态管理（已添加）
2. 添加 `isTransitioning` 状态管理
3. 实现 `useEffect` 监听器，监听 `mapMode` 变化
4. 实现平滑切换动画：
   - 设置过渡状态，禁用交互
   - 平滑更新 `tilt`、`heading`、`zoom`
   - 更新旋转控制显示
   - 过渡完成后恢复交互

**关键点**：
- 使用 Google Maps 原生过渡效果（`setTilt()` 等支持平滑过渡）
- 过渡时长建议 500-800ms
- 在过渡期间禁用用户操作，避免冲突
- 自动调整缩放级别（3D 模式需要更高缩放）

---

### 步骤 4：更新图层 Hook 使用样式配置

**文件**：
- `Next-gen-index/src/hooks/useRegionBoundaryLayer.ts`
- `Next-gen-index/src/hooks/useRainfallHeatmapLayer.ts`
- `Next-gen-index/src/hooks/useRiskEventMarkersLayer.ts`

**任务**：
1. 在各 Hook 的配置接口中添加 `mapMode` 参数
2. 从 `mapModeStyles` 读取对应模式的样式配置
3. 在样式设置时应用配置的样式值
4. 监听 `mapMode` 变化，动态更新样式

**关键点**：
- 从统一配置读取样式，而非硬编码
- 样式更新要平滑，避免闪烁
- 保持现有功能逻辑不变

---

### 步骤 5：优化切换按钮交互

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 切换按钮已添加（定位按钮上方）
2. 添加过渡状态下的视觉反馈：
   - 切换时显示加载状态
   - 禁用按钮点击（避免重复切换）
   - 过渡完成后恢复按钮状态

**关键点**：
- 按钮状态要与 `isTransitioning` 同步
- 提供清晰的视觉反馈
- 保持按钮位置和样式一致性

---

## 代码修改清单

### 新增文件

1. **Next-gen-index/src/config/mapModeStyles.ts**（新建）
   - 定义样式配置接口
   - 导出 2D/3D 模式样式配置对象

### 必须修改的文件

2. **Next-gen-index/src/lib/googleMaps.ts**
   - 修改 `getDefaultMapConfig()` 函数，添加 `mapMode` 参数
   - 从样式配置读取地图参数

3. **Next-gen-index/src/components/home/MapWorkspace.tsx**
   - 添加 `isTransitioning` 状态
   - 实现模式切换逻辑和动画
   - 优化切换按钮交互

4. **Next-gen-index/src/hooks/useRegionBoundaryLayer.ts**
   - 添加 `mapMode` 参数
   - 从样式配置读取边界图层样式

5. **Next-gen-index/src/hooks/useRainfallHeatmapLayer.ts**
   - 添加 `mapMode` 参数
   - 从样式配置读取热力图图层样式

6. **Next-gen-index/src/hooks/useRiskEventMarkersLayer.ts**
   - 添加 `mapMode` 参数
   - 从样式配置读取标记图层样式

---

## 实施细节

### 1. 样式配置文件结构

```typescript
// 伪代码：完整配置结构示例
export interface BoundaryLayerStyles {
  strokeWeight: number;
  strokeOpacity: number;
  fillOpacity: number;
  strokeColor: string;
}

export interface HeatmapLayerStyles {
  fillOpacity: { min: number; max: number };
  strokeWeight: number;
  strokeOpacity: number;
}

export interface MarkerLayerStyles {
  sizeMultiplier: number;
  shadow: 'light' | 'enhanced';
  opacity: { min: number; max: number };
}

export interface MapConfigStyles {
  zoom: number;
  tilt: number;
  heading: number;
  rotateControl: boolean;
}

export const mapModeStyles: Record<'2d' | '3d', MapModeStyles> = {
  '2d': { /* 2D 配置 */ },
  '3d': { /* 3D 配置 */ }
};
```

### 2. 模式切换动画实现

```typescript
// 伪代码：切换逻辑
useEffect(() => {
  if (!mapInstanceRef.current || !mapsLoaded) return;
  
  const map = mapInstanceRef.current;
  const targetMode = mapMode;
  const styles = mapModeStyles[targetMode];
  
  // 1. 设置过渡状态
  setIsTransitioning(true);
  
  // 2. 平滑过渡地图参数
  map.setTilt(styles.map.tilt);
  map.setHeading(styles.map.heading);
  if (map.getZoom() < styles.map.zoom) {
    map.setZoom(styles.map.zoom);
  }
  map.setOptions({ rotateControl: styles.map.rotateControl });
  
  // 3. 等待过渡完成（Google Maps 自动处理）
  setTimeout(() => {
    setIsTransitioning(false);
  }, 800); // 过渡时长
}, [mapMode, mapsLoaded]);
```

### 3. 图层样式应用

```typescript
// 伪代码：图层样式应用
const styles = mapModeStyles[mapMode];

// 边界图层
dataLayer.setStyle((feature) => ({
  strokeWeight: styles.boundary.strokeWeight,
  strokeOpacity: styles.boundary.strokeOpacity,
  // ...
}));

// 热力图图层
dataLayer.setStyle((feature) => {
  const opacity = calculateOpacity(rainfall, maxRainfall, styles.heatmap.fillOpacity);
  return { fillOpacity: opacity, ... };
});

// 标记图层
const markerSize = baseSize * styles.markers.sizeMultiplier;
```

---

## 注意事项

### 1. Map ID 配置

- **必须**：使用支持 3D Buildings 的自定义 Map ID
- **当前状态**：代码中使用 `DEMO_MAP_ID`，这是演示 ID，不支持 3D
- **解决方案**：在 Google Cloud Console 创建新的 Map ID，启用 3D Buildings 样式

### 2. 性能考虑

- 3D 模式渲染开销更高，注意低端设备性能
- 切换动画时长建议 500-800ms，避免过长影响体验
- 考虑在低性能设备上禁用 3D 模式或降低倾斜角度

### 3. 用户体验

- 切换时自动调整缩放级别，确保 3D 效果可见
- 过渡期间禁用用户交互，避免操作冲突
- 在 3D 模式下启用旋转控制，允许用户自由调整视角
- 提供清晰的视觉反馈（按钮状态、加载提示）

### 4. 样式调优

- 所有样式参数集中在配置文件中，便于后续调优
- 建议先使用默认配置，根据实际效果逐步调整
- 保持 2D 和 3D 模式的视觉一致性

### 5. 兼容性

- 所有图层（Data Layer、Advanced Markers）在 3D 模式下完全兼容
- 样式配置系统支持后续扩展（如添加新的模式或图层类型）
- 保持向后兼容，默认使用 2D 模式

---

## 参考资源

### Google Maps API 文档

- [Maps JavaScript API - Map Options](https://developers.google.com/maps/documentation/javascript/reference/map#MapOptions)
- [3D Maps API 文档](https://developers.google.com/maps/documentation/javascript/reference/3.60/3d-map)
- [Map ID 配置指南](https://developers.google.com/maps/documentation/javascript/maptypes#map_id)

### 相关步骤文档

- **步骤03**：Google Maps API配置与初始化
- **步骤11**：行政区域边界绘制
- **步骤12**：降雨量热力图图层
- **步骤13**：风险事件标记图层

---

## 完成标准

### 功能完整性

- ✅ 2D/3D 切换按钮已添加并正常工作
- ✅ 地图支持 3D 倾斜和旋转视角
- ✅ 所有图层在 3D 模式下正常显示
- ✅ 样式配置统一管理，便于调优
- ✅ 模式切换过程流畅，带有平滑动画

### 代码质量

- ✅ 样式配置集中管理，代码结构清晰
- ✅ 类型定义完整，类型安全
- ✅ 错误处理完善
- ✅ 注释清晰，便于维护

### 用户体验

- ✅ 切换按钮位置合理，易于发现
- ✅ 视觉反馈明确（高亮、图标变化、加载状态）
- ✅ 切换动画流畅自然（500-800ms 过渡）
- ✅ 3D 模式下各图层清晰可见
- ✅ 过渡期间交互禁用，避免操作冲突

### 性能表现

- ✅ 切换响应时间 < 200ms
- ✅ 3D 模式渲染流畅（60fps）
- ✅ 无明显性能问题
- ✅ 过渡动画不影响地图交互

---

## 后续优化建议

1. **高级 3D 功能**
   - 支持自定义倾斜角度（滑块控制）
   - 支持自定义旋转角度
   - 保存用户偏好的视角设置

2. **样式调优**
   - 根据实际使用反馈调整样式参数
   - 支持主题切换（浅色/深色模式）
   - 支持自定义样式配置

3. **性能优化**
   - 实现 3D 模式的延迟加载
   - 优化低端设备的 3D 渲染
   - 添加性能监控和降级策略

4. **用户体验增强**
   - 添加 3D 模式引导提示
   - 支持手势控制（触摸设备）
   - 添加视角重置按钮
