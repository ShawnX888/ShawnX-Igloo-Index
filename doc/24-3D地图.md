# 24-3D地图

## 步骤概述

### 步骤编号和名称
**步骤24**：3D地图功能实现

### 步骤目标

**最终目标**：实现三种地图模式的切换功能
- **2D 模式**：传统平面地图视图
- **Vector Map + 3D Buildings**：矢量地图 3D 建筑（白模风格）
- **Photorealistic 3D Maps**：照片级 3D 地图（Google Earth 风格）

支持用户在地图的三种模式之间自由切换，通过统一的样式配置管理不同模式下的图层显示效果，提供流畅的切换动画和一致的用户体验。

### 分阶段实施计划

#### 第一阶段：2D ↔ Vector Map + 3D Buildings 切换

**目标**：实现 2D 和 Vector Map + 3D Buildings 两种模式的切换

**技术方案**：
- 使用标准 `maps` 库和 `Map` 类
- 通过 `tilt` 和 `heading` 参数实现 3D 视角
- 适合数据可视化、风险分析等场景

**预期成果**：
- 2D/3D 切换按钮已添加到地图控制区域（已有基础实现）
- 地图支持 3D 倾斜视角（tilt）和旋转（heading）
- 所有图层（边界、热力图、标记）在 3D 模式下正常显示
- 统一的样式配置文件，便于管理和调优
- 流畅的切换动画和过渡效果
- 切换过程流畅，用户体验良好

#### 第二阶段：添加 Photorealistic 3D Maps 模式

**目标**：在现有基础上添加 Photorealistic 3D Maps 模式，实现三种模式的切换

**技术方案**：
- 使用 `maps3d` 库和 `Map3DElement` 类
- 真实世界的 3D 网格模型，带照片纹理
- 适合沉浸式展示、旅游导览等场景

**预期成果**：
- 地图模式切换按钮支持三种模式（2D、Vector 3D、Photorealistic 3D）
- Photorealistic 3D Maps 模式正常工作
- 所有图层在 Photorealistic 3D 模式下正常显示
- 模式切换流畅，支持平滑过渡
- 性能优化，支持低端设备降级策略

---

## 前置条件

### 依赖的步骤
- **步骤03**：Google Maps API配置与初始化（必须）
- **步骤11**：行政区域边界绘制（必须）
- **步骤12**：降雨量热力图图层（必须）
- **步骤13**：风险事件标记图层（必须）

### 需要完成的前置工作
- Google Maps JavaScript API 已正确配置和加载
- 地图容器和基础地图功能已实现
- 所有图层（边界、热力图、标记）已实现并正常工作
- Map ID 已配置（需要支持 3D Buildings 的 Map ID）

### 需要的数据/接口
- **Google Maps API**：Maps JavaScript API（已配置）
- **Map ID**：支持 3D Buildings 的自定义 Map ID（需要在 Google Cloud Console 创建）
- **API Key**：已配置的 Google Maps API Key

**重要说明**：
- 使用 Google 官方的 `maps3d` 库时，**不需要启用 Map Tiles API**
- Map Tiles API 仅在集成 Cesium/deck.gl 等第三方引擎时需要

**Map ID 配置说明（Vector Map + 3D Buildings - 第一阶段）**：
1. 在 Google Cloud Console 中创建自定义 Map ID
2. **Map type 必须选择 "JavaScript - Vector"（矢量）**
3. 在 Map Styles 编辑器中，找到 **Buildings (建筑)** 图层
4. 确保 Buildings 图层的 **"3D"** 选项被选中（默认 Zoom 17+ 开启）
5. 将样式关联到 Map ID
6. 将 Map ID 配置到 `getDefaultMapConfig()` 函数中

**Photorealistic 3D Maps API 配置说明（第二阶段）**：
1. 创建 Map ID，类型选择 **"JavaScript"**（推荐）
2. (可选) 关联样式通常无效，因为它不渲染矢量图层
3. **注意**：Photorealistic 3D Maps 不支持常规样式编辑，只能通过叠加 Marker 或多边形来改变视觉
4. **重要**：使用 Google 官方的 `maps3d` 库时，**不需要启用 Map Tiles API**。Map Tiles API 仅在集成 Cesium/deck.gl 等第三方引擎时需要

---

## 3D 地图模式说明

### 两种 3D 模式对比

Google Maps Platform 提供两种不同的 3D 地图功能，底层技术、配置方式和应用场景完全不同：

| 特性 | Photorealistic 3D Maps (照片级 3D 地图) | Vector Map + 3D Buildings (矢量地图 3D 建筑) |
| :---- | :---- | :---- |
| **视觉效果** | **Google Earth 风格**。真实的卫星/航拍贴图，树木、地标、建筑都是实景网格模型。 | **"白模"风格**。抽象的矢量方块，侧重于展示建筑轮廓和高度，表面无纹理。 |
| **底层技术** | 全新的 `maps3d` 库 (WebGL) | 标准 `maps` 库 (WebGL Vector Renderer) |
| **代码类** | `google.maps.maps3d.Map3DElement` | `google.maps.Map` |
| **主要用途** | 沉浸式展示、旅游导览、房产周边环境查看 | 导航、LBS 游戏、数据可视化、城市规划 |
| **第二阶段** | 第一阶段 | ✅ **第一阶段** |

### 配置要求对比

| 配置项 | Photorealistic 3D Maps | Vector Map + 3D Buildings |
| :---- | :---- | :---- |
| **1. Map ID (Cloud Console)** | **推荐配置** 虽然技术上不绑定 Map ID 有时也能加载，但在生产环境中**必须配置 Map ID** 以确保配额和计费正常。<br>• **类型**：建议选择 **"JavaScript"** (通常兼容，不需要强制选 Vector，因为它是独立的渲染器，但选 Vector 也没问题)。 | **强制要求** 若无 Map ID，API 会自动回退到 2D Raster 模式。<br>• **类型**：必须显式选择 **"JavaScript - Vector"** (矢量)。 |
| **2. Map Style (Cloud Console)** | **不支持常规样式** 由于它是基于照片纹理的，你**无法**通过样式编辑器修改"草地颜色"或"道路宽度"。<br>• **配置**：无。通常不需要关联 Style JSON。<br>• **自定义能力**：只能通过叠加 3D Marker 或多边形来改变视觉。 | **高度支持**<br>• **配置**：需要在样式编辑器中关联 Style。<br>• **关键操作**：在 Style Editor 中，必须确保 **"Buildings"** 图层的 **"3D"** 选项被选中 (默认 Zoom 17+ 开启)。<br>• **自定义能力**：可修改建筑颜色(Fill/Stroke)、隐藏特定类型POI。 |
| **3. 代码参数差异** | **必须移除 zoom** 使用摄像机参数代替：<br>• `center` (含 `altitude` 高度)<br>• `range` (摄像机距离)<br>• `tilt` (0-90度)<br>• `heading` | **依赖 zoom**<br>• `zoom`: **必须 >= 17** (否则建筑不显示)<br>• `tilt`: **必须设置** (如 45 或 67.5)<br>• `heading`: 建议设置<br>• `mapId`: 代码中必须传入字符串 |
| **4. 库引入** | `libraries=maps3d` | `libraries=maps` (标准库) |
| **5. 计费 SKU (重要)** | **高阶计费** 通常归类为 *"High Volume 3D Maps"* 或类似的高级 SKU，单次加载费用远高于普通地图。 | **标准计费** 归类为 *"Dynamic Maps"*，使用 Vector 模式不会产生额外费用 (除非使用了高级数据图层)。 |

### 详细配置步骤

#### 第一阶段 - 启用 Vector Map + 3D Buildings (白模)

1. **Console 设置 (最关键一步)**：
   - 进入 **Map Management**。
   - 创建/编辑 Map ID，Map type **必须** 选 **Vector (矢量)**。
   - 进入 **Map Styles**，创建一个样式。
   - 在左侧菜单找到 **Buildings (建筑)**，确保可见性开启，并检查是否有 "3D" 开关（通常是自动的，但可以调整颜色）。
   - 将该样式 **关联** 到你的 Map ID。

2. **代码设置**：
   - **库引入**：`libraries=maps` (标准库)。
   - **初始化**：`new google.maps.Map()`。
   - **关键点**：
     ```javascript
     mapId: "YOUR_VECTOR_MAP_ID", // 必须对应
     zoom: 18,                    // 必须大于17
     tilt: 45,                    // 必须有倾斜角
     heading: 30                  // 建议有旋转角
     ```

#### 第二阶段 - 启用 Photorealistic 3D Maps (实景)

1. **Console 设置**：
   - 创建 Map ID，类型选 **JavaScript**（推荐）
   - (可选) 关联样式通常无效，因为它不渲染矢量图层
   - **重要**：不需要启用 Map Tiles API（仅在使用 Cesium/deck.gl 等第三方引擎时需要）

2. **代码设置**：
   - **库引入**：`libraries=maps3d`
   - **初始化**：使用 `<gmp-map-3d>` 标签或 `new Map3DElement()`
   - **关键点**：不要设置 `zoom`，要设置 `range` (距离) 和 `altitude` (高度)

### 实施方案说明

**第一阶段采用 Vector Map + 3D Buildings**，原因：
1. 实现简单，符合当前项目需求（数据可视化、风险分析）
2. 性能开销小，适合低端设备
3. 与现有图层（Data Layer、Advanced Markers）兼容性好
4. 标准计费，成本可控
5. 支持样式自定义，便于后续调优

**第二阶段将升级到 Photorealistic 3D Maps**，需要：
1. 修改代码使用 `maps3d` 库和 `Map3DElement`
2. 调整参数配置（使用 `range`/`altitude` 替代 `zoom`）
3. 处理与现有图层的集成（可能需要适配）
4. 注意高阶计费影响

**重要说明**：使用 Google 官方的 `maps3d` 库时，**不需要启用 Map Tiles API**。
Map Tiles API 仅在集成 Cesium/deck.gl 等第三方引擎时需要。

---

## 核心设计

### 1. 样式配置统一管理

**设计目标**：通过统一的配置文件管理不同 `mapMode` 下的样式，便于后续调优和维护。

**实现方案**：
- 创建 `mapModeStyles.ts` 配置文件
- 第一阶段：定义 2D 和 Vector Map + 3D Buildings 模式下的样式配置对象
- 第二阶段：添加 Photorealistic 3D Maps 模式的样式配置
- 各图层 Hook 从配置文件读取样式
- 支持后续扩展和调优

**配置文件结构（分阶段）**：

**第一阶段配置**：
```typescript
// 第一阶段：2D 和 Vector Map + 3D Buildings
export const mapModeStyles = {
  '2d': {
    boundary: { strokeWeight: 1, strokeOpacity: 0.4, ... },
    heatmap: { fillOpacity: { min: 0.15, max: 0.7 }, ... },
    markers: { size: 1.0, shadow: 'light' },
    map: { zoom: 11, tilt: 0, rotateControl: false }
  },
  '3d': {
    // Vector Map + 3D Buildings
    boundary: { strokeWeight: 3, strokeOpacity: 0.8, ... },
    heatmap: { fillOpacity: { min: 0.2, max: 0.8 }, ... },
    markers: { size: 1.2, shadow: 'enhanced' },
    map: { zoom: 18, tilt: 45, heading: 0, rotateControl: true }
  }
};
```

**第二阶段扩展**：
```typescript
// 第二阶段：添加 Photorealistic 3D Maps
export const mapModeStyles = {
  '2d': { /* ... */ },
  '3d': { /* ... */ },
  '3d-photorealistic': {
    // Photorealistic 3D Maps
    boundary: { strokeWeight: 3, strokeOpacity: 0.9, ... },
    heatmap: { fillOpacity: { min: 0.25, max: 0.75 }, ... },
    markers: { size: 1.4, shadow: 'strong' },
    map: { 
      range: 1000,      // 替代 zoom
      altitude: 300,    // 摄像机高度
      tilt: 60, 
      heading: 0, 
      rotateControl: true 
    }
  }
};
```

### 2. 切换动画和过渡效果

**设计目标**：提供流畅的视角切换体验，避免突兀的视角变化。

**实现方案（分阶段）**：

**第一阶段**：
- 使用 Google Maps 的 `setTilt()` 和 `setZoom()` 方法（支持平滑过渡）
- 添加过渡状态管理（`isTransitioning`）
- 在切换过程中禁用用户交互
- 设置合理的过渡时长（建议 500-800ms）

**第二阶段**：
- 扩展切换逻辑，支持三种模式之间的切换
- Photorealistic 3D Maps 使用 `setRange()` 和 `setAltitude()` 方法
- 处理不同地图实例之间的切换（Map vs Map3DElement）

**动画流程**：
1. 用户点击切换按钮
2. 设置 `isTransitioning = true`，禁用交互
3. 根据目标模式选择相应的过渡方法：
   - 2D ↔ Vector 3D：使用 `setTilt()`、`setZoom()`、`setHeading()`
   - 切换到 Photorealistic 3D：使用 `setRange()`、`setAltitude()`、`setTilt()`、`setHeading()`
4. 过渡完成后，设置 `isTransitioning = false`
5. 更新图层样式（从配置文件读取）

### 3. 图层兼容性

**所有图层完全兼容**：
- ✅ 区域边界图层（Data Layer）：自动适配 3D 视角
- ✅ 降雨量热力图图层（Data Layer）：正常显示
- ✅ 风险事件标记图层（Advanced Markers）：自动调整位置

---

## 样式配置方案

### 配置文件结构

创建 `Next-gen-index/src/config/mapModeStyles.ts`：

```typescript
// 伪代码：样式配置结构
export interface MapModeStyles {
  boundary: BoundaryLayerStyles;
  heatmap: HeatmapLayerStyles;
  markers: MarkerLayerStyles;
  map: MapConfigStyles;
}

// Vector Map + 3D Buildings 配置
export interface Vector3DMapConfigStyles {
  zoom: number;        // 必须 >= 17
  tilt: number;        // 必须设置 (45-67.5)
  heading: number;      // 0-360
  rotateControl: boolean;
}

// Photorealistic 3D Maps 配置
export interface Photorealistic3DMapConfigStyles {
  range: number;       // 摄像机距离 (替代 zoom)
  altitude: number;    // 摄像机高度
  tilt: number;        // 0-90
  heading: number;     // 0-360
  rotateControl: boolean;
}

export const mapModeStyles: Record<'2d' | '3d' | '3d-photorealistic', MapModeStyles> = {
  '2d': {
    // 2D 模式样式配置
  },
  '3d': {
    // Vector Map + 3D Buildings 样式配置（第一阶段）
  },
  '3d-photorealistic': {
    // Photorealistic 3D Maps 样式配置（第二阶段）
  }
};
```

### 样式参数对照表

| 图层类型 | 样式属性 | 2D 模式 | 3D 模式<br>(Vector + 3D Buildings) | Photorealistic 3D 模式 | 说明 |
|---------|---------|---------|---------|---------|------|
| **边界图层** |
| | `strokeWeight` | 1-2px | 2-3px | 2-3px | 3D 视角下需要更粗的线条 |
| | `strokeOpacity` | 0.4-0.6 | 0.6-0.9 | 0.7-0.95 | Photorealistic 模式下需要更高可见性 |
| | `fillOpacity` | 0.6 | 0.6-0.7 | 0.5-0.6 | Photorealistic 模式下降低填充以避免遮挡实景 |
| **热力图图层** |
| | `fillOpacity` | 0.15-0.7 | 0.2-0.8 | 0.25-0.75 | Photorealistic 模式下需要平衡可见性和实景展示 |
| | `strokeWeight` | 0.5px | 1px | 1-1.5px | Photorealistic 模式下增强边界以突出数据 |
| **标记图层** |
| | `sizeMultiplier` | 1.0 | 1.2 | 1.3-1.5 | Photorealistic 模式下标记需要更大以在实景中可见 |
| | `shadow` | 'light' | 'enhanced' | 'strong' | Photorealistic 模式下需要更强的阴影效果 |
| **地图配置** |
| | `zoom` | 11-13 | 17-18<br>(必须 >= 17) | N/A<br>(使用 `range`) | Photorealistic 模式不使用 zoom，改用 range/altitude |
| | `range` | N/A | N/A | 500-2000m | Photorealistic 模式摄像机距离（替代 zoom） |
| | `altitude` | N/A | N/A | 100-500m | Photorealistic 模式摄像机高度 |
| | `tilt` | 0 | 45-67.5 | 0-90 | Photorealistic 模式支持更大倾斜角度 |
| | `heading` | 0 | 0-360 | 0-360 | 两种 3D 模式都支持旋转 |
| | `rotateControl` | false | true | true | 3D 模式启用旋转控制 |
| | **库引入** | `maps` | `maps` | `maps3d` | Photorealistic 模式需要不同的库 |
| | **地图类** | `Map` | `Map` | `Map3DElement` | Photorealistic 模式使用不同的类 |

---

## 分阶段实施步骤

### 第一阶段：2D ↔ Vector Map + 3D Buildings 切换

#### 阶段目标
实现 2D 和 Vector Map + 3D Buildings 两种模式的切换功能。

#### 实施步骤

**步骤 1.1：创建样式配置文件（第一阶段）**

**文件**：`Next-gen-index/src/config/mapModeStyles.ts`

**任务**：
1. 创建样式配置接口定义
2. 定义 2D 和 Vector Map + 3D Buildings 模式的样式配置对象
3. 导出配置供各图层使用

**关键点**：
- 使用 TypeScript 接口确保类型安全
- 配置项要覆盖所有图层的样式需求
- 预留扩展空间，便于第二阶段添加 Photorealistic 3D Maps

---

**步骤 1.2：更新地图配置函数**

**文件**：`Next-gen-index/src/lib/googleMaps.ts`

**任务**：
1. 修改 `getDefaultMapConfig()` 函数签名，添加 `mapMode` 参数
2. 从样式配置读取地图配置参数
3. 添加 Vector Map + 3D Buildings 模式特定配置（`tilt`、`heading`、`rotateControl`）
4. 确保 Map ID 支持 3D Buildings（Vector 类型）

**关键点**：
- 从 `mapModeStyles` 读取地图配置
- 确保 Map ID 类型为 Vector，支持 3D Buildings
- 保持向后兼容（默认 2D 模式）

---

**步骤 1.3：实现模式切换逻辑**

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 利用已有的 `mapMode` 状态管理（'2d' | '3d'）
2. 添加 `isTransitioning` 状态管理
3. 实现 `useEffect` 监听器，监听 `mapMode` 变化
4. 实现平滑切换动画：
   - 设置过渡状态，禁用交互
   - 平滑更新 `tilt`、`heading`、`zoom`
   - 更新旋转控制显示
   - 过渡完成后恢复交互

**关键点**：
- 使用 Google Maps 原生过渡效果（`setTilt()` 等支持平滑过渡）
- 过渡时长建议 500-800ms
- 在过渡期间禁用用户操作，避免冲突
- 自动调整缩放级别（Vector 3D 模式需要 zoom >= 17）

---

**步骤 1.4：更新图层 Hook 使用样式配置**

**文件**：
- `Next-gen-index/src/hooks/useRegionBoundaryLayer.ts`
- `Next-gen-index/src/hooks/useRainfallHeatmapLayer.ts`
- `Next-gen-index/src/hooks/useRiskEventMarkersLayer.ts`

**任务**：
1. 在各 Hook 的配置接口中添加 `mapMode` 参数
2. 从 `mapModeStyles` 读取对应模式的样式配置
3. 在样式设置时应用配置的样式值
4. 监听 `mapMode` 变化，动态更新样式

**关键点**：
- 从统一配置读取样式，而非硬编码
- 样式更新要平滑，避免闪烁
- 保持现有功能逻辑不变

---

**步骤 1.5：优化切换按钮交互**

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 优化已有的切换按钮（定位按钮上方）
2. 添加过渡状态下的视觉反馈：
   - 切换时显示加载状态
   - 禁用按钮点击（避免重复切换）
   - 过渡完成后恢复按钮状态

**关键点**：
- 按钮状态要与 `isTransitioning` 同步
- 提供清晰的视觉反馈
- 保持按钮位置和样式一致性

---

### 第二阶段：添加 Photorealistic 3D Maps 模式

#### 阶段目标
在现有基础上添加 Photorealistic 3D Maps 模式，实现三种模式（2D、Vector 3D、Photorealistic 3D）的切换功能。

#### 前置条件
- 第一阶段已完成并测试通过
- 已创建支持 Photorealistic 3D 的 Map ID（类型：JavaScript）

**注意**：使用 Google 官方的 `maps3d` 库时，不需要启用 Map Tiles API。
Map Tiles API 仅在集成 Cesium/deck.gl 等第三方引擎时需要。

#### 实施步骤

**步骤 2.1：扩展样式配置文件**

**文件**：`Next-gen-index/src/config/mapModeStyles.ts`

**任务**：
1. 添加 Photorealistic 3D Maps 模式的样式配置接口
2. 定义 Photorealistic 3D Maps 模式的样式配置对象
3. 更新类型定义，支持三种模式

**关键点**：
- 使用 `range` 和 `altitude` 替代 `zoom`
- 样式参数需要针对 Photorealistic 3D 进行优化
- 保持与现有配置的兼容性

---

**步骤 2.2：添加 maps3d 库加载逻辑**

**文件**：`Next-gen-index/src/lib/googleMaps.ts`

**任务**：
1. 添加 `maps3d` 库的加载逻辑
2. 创建 `Map3DElement` 实例的辅助函数
3. 实现 Photorealistic 3D Maps 的配置函数

**关键点**：
- 动态加载 `maps3d` 库（按需加载，降低初始加载时间）
- 处理库加载失败的情况
- 保持与现有代码的兼容性

---

**步骤 2.3：扩展地图实例管理**

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 添加 `Map3DElement` 实例的 ref 管理
2. 扩展 `mapMode` 类型，支持 '2d' | '3d' | '3d-photorealistic'
3. 实现三种模式之间的切换逻辑
4. 处理不同地图实例之间的切换（Map vs Map3DElement）

**关键点**：
- 根据模式选择使用 `Map` 或 `Map3DElement`
- 处理实例切换时的状态同步
- 确保图层在不同实例间正确迁移

---

**步骤 2.4：更新切换按钮支持三种模式**

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 将切换按钮改为循环切换（2D → Vector 3D → Photorealistic 3D → 2D）
2. 或改为下拉菜单/分段控件，支持直接选择模式
3. 更新按钮图标和提示文字

**关键点**：
- 提供清晰的模式标识
- 支持快速切换
- 保持 UI 一致性

---

**步骤 2.5：适配图层 Hook 支持 Photorealistic 3D**

**文件**：
- `Next-gen-index/src/hooks/useRegionBoundaryLayer.ts`
- `Next-gen-index/src/hooks/useRainfallHeatmapLayer.ts`
- `Next-gen-index/src/hooks/useRiskEventMarkersLayer.ts`

**任务**：
1. 更新各 Hook 以支持 `Map3DElement` 实例
2. 从样式配置读取 Photorealistic 3D 模式的样式
3. 确保图层在 Photorealistic 3D 模式下正常显示

**关键点**：
- 处理 `Map` 和 `Map3DElement` 的类型差异
- 样式参数需要针对 Photorealistic 3D 进行优化
- 保持向后兼容

---

**步骤 2.6：性能优化和降级策略**

**文件**：`Next-gen-index/src/components/home/MapWorkspace.tsx`

**任务**：
1. 实现 Photorealistic 3D Maps 的延迟加载
2. 添加性能检测，在低端设备上禁用或降级
3. 优化切换动画，确保流畅性

**关键点**：
- 检测设备性能，自动降级
- 提供用户选项，允许手动禁用 Photorealistic 3D
- 监控性能指标，记录问题

---

## 代码修改清单

### 第一阶段：2D ↔ Vector Map + 3D Buildings 切换

#### 新增文件

1. **Next-gen-index/src/config/mapModeStyles.ts**（新建）
   - 定义样式配置接口
   - 导出 2D 和 Vector Map + 3D Buildings 模式样式配置对象

#### 必须修改的文件

2. **Next-gen-index/src/lib/googleMaps.ts**
   - 修改 `getDefaultMapConfig()` 函数，添加 `mapMode` 参数
   - 从样式配置读取地图参数
   - 添加 Vector Map + 3D Buildings 模式特定配置

3. **Next-gen-index/src/components/home/MapWorkspace.tsx**
   - 添加 `isTransitioning` 状态
   - 实现 2D ↔ Vector 3D 模式切换逻辑和动画
   - 优化切换按钮交互（利用已有的切换按钮）

4. **Next-gen-index/src/hooks/useRegionBoundaryLayer.ts**
   - 添加 `mapMode` 参数
   - 从样式配置读取边界图层样式

5. **Next-gen-index/src/hooks/useRainfallHeatmapLayer.ts**
   - 添加 `mapMode` 参数
   - 从样式配置读取热力图图层样式

6. **Next-gen-index/src/hooks/useRiskEventMarkersLayer.ts**
   - 添加 `mapMode` 参数
   - 从样式配置读取标记图层样式

---

### 第二阶段：添加 Photorealistic 3D Maps 模式

#### 修改文件

1. **Next-gen-index/src/config/mapModeStyles.ts**
   - 添加 Photorealistic 3D Maps 模式的样式配置接口
   - 扩展配置对象，支持三种模式

2. **Next-gen-index/src/lib/googleMaps.ts**
   - 添加 `maps3d` 库的加载逻辑
   - 创建 `Map3DElement` 实例的辅助函数
   - 实现 Photorealistic 3D Maps 的配置函数

3. **Next-gen-index/src/components/home/MapWorkspace.tsx**
   - 扩展 `mapMode` 类型，支持三种模式
   - 添加 `Map3DElement` 实例的 ref 管理
   - 实现三种模式之间的切换逻辑
   - 更新切换按钮，支持三种模式选择

4. **Next-gen-index/src/hooks/useRegionBoundaryLayer.ts**
   - 支持 `Map3DElement` 实例
   - 适配 Photorealistic 3D 模式的样式

5. **Next-gen-index/src/hooks/useRainfallHeatmapLayer.ts**
   - 支持 `Map3DElement` 实例
   - 适配 Photorealistic 3D 模式的样式

6. **Next-gen-index/src/hooks/useRiskEventMarkersLayer.ts**
   - 支持 `Map3DElement` 实例
   - 适配 Photorealistic 3D 模式的样式

#### 新增功能

7. **性能优化模块**（可选）
   - 设备性能检测
   - Photorealistic 3D Maps 延迟加载
   - 降级策略实现

---

## 实施细节

### 1. 样式配置文件结构

```typescript
// 伪代码：完整配置结构示例
export interface BoundaryLayerStyles {
  strokeWeight: number;
  strokeOpacity: number;
  fillOpacity: number;
  strokeColor: string;
}

export interface HeatmapLayerStyles {
  fillOpacity: { min: number; max: number };
  strokeWeight: number;
  strokeOpacity: number;
}

export interface MarkerLayerStyles {
  sizeMultiplier: number;
  shadow: 'light' | 'enhanced';
  opacity: { min: number; max: number };
}

// Vector Map + 3D Buildings 配置（第一阶段）
export interface Vector3DMapConfigStyles {
  zoom: number;        // 必须 >= 17
  tilt: number;        // 必须设置 (45-67.5)
  heading: number;     // 0-360
  rotateControl: boolean;
}

// Photorealistic 3D Maps 配置（第二阶段）
export interface Photorealistic3DMapConfigStyles {
  range: number;       // 摄像机距离 (替代 zoom)
  altitude: number;    // 摄像机高度
  tilt: number;        // 0-90
  heading: number;     // 0-360
  rotateControl: boolean;
}

// 联合类型
export type MapConfigStyles = Vector3DMapConfigStyles | Photorealistic3DMapConfigStyles;

export const mapModeStyles: Record<'2d' | '3d' | '3d-photorealistic', MapModeStyles> = {
  '2d': { 
    /* 2D 配置 */
    map: { zoom: 11, tilt: 0, heading: 0, rotateControl: false }
  },
  '3d': { 
    /* Vector Map + 3D Buildings 配置（第一阶段）*/
    map: { zoom: 18, tilt: 45, heading: 0, rotateControl: true }
  },
  '3d-photorealistic': {
    /* Photorealistic 3D Maps 配置（第二阶段）*/
    map: { range: 1000, altitude: 300, tilt: 60, heading: 0, rotateControl: true }
  }
};
```

### 2. 模式切换动画实现

#### Vector Map + 3D Buildings（第一阶段）

```typescript
// 伪代码：切换逻辑（Vector Map + 3D Buildings）
useEffect(() => {
  if (!mapInstanceRef.current || !mapsLoaded) return;
  
  const map = mapInstanceRef.current;
  const targetMode = mapMode;
  const styles = mapModeStyles[targetMode];
  
  // 1. 设置过渡状态
  setIsTransitioning(true);
  
  // 2. 平滑过渡地图参数
  if (targetMode === '2d' || targetMode === '3d') {
    const mapConfig = styles.map as Vector3DMapConfigStyles;
    map.setTilt(mapConfig.tilt);
    map.setHeading(mapConfig.heading);
    if (map.getZoom() < mapConfig.zoom) {
      map.setZoom(mapConfig.zoom);
    }
    map.setOptions({ rotateControl: mapConfig.rotateControl });
  }
  
  // 3. 等待过渡完成（Google Maps 自动处理）
  setTimeout(() => {
    setIsTransitioning(false);
  }, 800); // 过渡时长
}, [mapMode, mapsLoaded]);
```

#### Photorealistic 3D Maps（第二阶段）

```typescript
// 伪代码：切换逻辑（Photorealistic 3D Maps）
useEffect(() => {
  if (!map3DInstanceRef.current || !maps3DLoaded) return;
  
  const map3D = map3DInstanceRef.current; // Map3DElement 实例
  const targetMode = mapMode;
  const styles = mapModeStyles[targetMode];
  
  // 1. 设置过渡状态
  setIsTransitioning(true);
  
  // 2. 平滑过渡地图参数
  if (targetMode === '3d-photorealistic') {
    const mapConfig = styles.map as Photorealistic3DMapConfigStyles;
    // Photorealistic 3D 使用不同的参数
    map3D.setRange(mapConfig.range);
    map3D.setAltitude(mapConfig.altitude);
    map3D.setTilt(mapConfig.tilt);
    map3D.setHeading(mapConfig.heading);
    map3D.setOptions({ rotateControl: mapConfig.rotateControl });
  }
  
  // 3. 等待过渡完成
  setTimeout(() => {
    setIsTransitioning(false);
  }, 800);
}, [mapMode, maps3DLoaded]);
```

### 3. 图层样式应用

```typescript
// 伪代码：图层样式应用
const styles = mapModeStyles[mapMode];

// 边界图层
dataLayer.setStyle((feature) => ({
  strokeWeight: styles.boundary.strokeWeight,
  strokeOpacity: styles.boundary.strokeOpacity,
  // ...
}));

// 热力图图层
dataLayer.setStyle((feature) => {
  const opacity = calculateOpacity(rainfall, maxRainfall, styles.heatmap.fillOpacity);
  return { fillOpacity: opacity, ... };
});

// 标记图层
const markerSize = baseSize * styles.markers.sizeMultiplier;
```

---

## 注意事项

### 1. Map ID 配置

#### Vector Map + 3D Buildings（第一阶段）
- **必须**：使用支持 3D Buildings 的自定义 Map ID
- **Map type**：必须选择 **"JavaScript - Vector"**（矢量）
- **当前状态**：代码中使用 `DEMO_MAP_ID`，这是演示 ID，不支持 3D
- **解决方案**：
  1. 在 Google Cloud Console 创建新的 Map ID，类型选择 **Vector**
  2. 在 Map Styles 编辑器中，确保 **Buildings** 图层的 **"3D"** 选项被选中
  3. 将样式关联到 Map ID
  4. 将 Map ID 配置到 `getDefaultMapConfig()` 函数中

#### Photorealistic 3D Maps（第二阶段）
- **Map type**：建议选择 **"JavaScript"**（不需要强制选 Vector）
- **Map Style**：不支持常规样式编辑（基于照片纹理，无法修改颜色等）
- **需要额外配置**：
  1. 修改代码使用 `maps3d` 库和 `Map3DElement` 类
  2. 调整参数配置（使用 `range`/`altitude` 替代 `zoom`）
  3. **注意计费**：高阶计费，费用远高于普通地图
- **重要说明**：使用 Google 官方的 `maps3d` 库时，**不需要启用 Map Tiles API**。
  Map Tiles API 仅在集成 Cesium/deck.gl 等第三方引擎时需要。

### 2. 性能考虑

- 3D 模式渲染开销更高，注意低端设备性能
- 切换动画时长建议 500-800ms，避免过长影响体验
- 考虑在低性能设备上禁用 3D 模式或降低倾斜角度

### 3. 用户体验

- 切换时自动调整缩放级别，确保 3D 效果可见
- 过渡期间禁用用户交互，避免操作冲突
- 在 3D 模式下启用旋转控制，允许用户自由调整视角
- 提供清晰的视觉反馈（按钮状态、加载提示）

### 4. 样式调优

- 所有样式参数集中在配置文件中，便于后续调优
- 建议先使用默认配置，根据实际效果逐步调整
- 保持 2D 和 3D 模式的视觉一致性

### 5. 兼容性

- 所有图层（Data Layer、Advanced Markers）在 3D 模式下完全兼容
- 样式配置系统支持后续扩展（如添加新的模式或图层类型）
- 保持向后兼容，默认使用 2D 模式

---

## 参考资源

### Google Maps API 文档

#### Vector Map + 3D Buildings（第一阶段）
- [Maps JavaScript API - Map Options](https://developers.google.com/maps/documentation/javascript/reference/map#MapOptions?utm_source=gmp-code-assist)
- [3D Maps API 文档](https://developers.google.com/maps/documentation/javascript/reference/3.60/3d-map?utm_source=gmp-code-assist)
- [Map ID 配置指南](https://developers.google.com/maps/documentation/javascript/maptypes#map_id?utm_source=gmp-code-assist)

#### Photorealistic 3D Maps（第二阶段）
- [3D Maps 产品页面](https://mapsplatform.google.com/intl/zh-CN_cn/maps-products/3d-maps/?utm_source=gmp-code-assist)
- [WebGL Overlay View](https://developers.google.com/maps/documentation/javascript/webgl?utm_source=gmp-code-assist)

#### 第三方渲染库（可选，仅在特定场景需要）
- [Map Tiles API 文档](https://developers.google.com/maps/documentation/tiles?utm_source=gmp-code-assist) - 仅在集成 Cesium/deck.gl 等第三方引擎时需要
- [Photorealistic 3D Tiles 概述](https://mapsplatform.google.com/intl/zh-CN_cn/maps-products/map-tiles/?utm_source=gmp-code-assist) - 仅在集成第三方引擎时需要
- [CesiumJS](https://cesium.com/learn/cesiumjs/) - 第三方 3D 渲染引擎
- [deck.gl](https://deck.gl/) - 第三方数据可视化库

### 相关步骤文档

- **步骤03**：Google Maps API配置与初始化
- **步骤11**：行政区域边界绘制
- **步骤12**：降雨量热力图图层
- **步骤13**：风险事件标记图层

---

## 完成标准

### 第一阶段完成标准：2D ↔ Vector Map + 3D Buildings 切换

#### 功能完整性

- ✅ 2D/Vector 3D 切换按钮已添加并正常工作
- ✅ 地图支持 Vector 3D 倾斜和旋转视角
- ✅ 所有图层在 Vector 3D 模式下正常显示
- ✅ 样式配置统一管理，便于调优
- ✅ 模式切换过程流畅，带有平滑动画

#### 代码质量

- ✅ 样式配置集中管理，代码结构清晰
- ✅ 类型定义完整，类型安全
- ✅ 错误处理完善
- ✅ 注释清晰，便于维护

#### 用户体验

- ✅ 切换按钮位置合理，易于发现
- ✅ 视觉反馈明确（高亮、图标变化、加载状态）
- ✅ 切换动画流畅自然（500-800ms 过渡）
- ✅ Vector 3D 模式下各图层清晰可见
- ✅ 过渡期间交互禁用，避免操作冲突

#### 性能表现

- ✅ 切换响应时间 < 200ms
- ✅ Vector 3D 模式渲染流畅（60fps）
- ✅ 无明显性能问题
- ✅ 过渡动画不影响地图交互

---

### 第二阶段完成标准：添加 Photorealistic 3D Maps 模式

#### 功能完整性

- ✅ 三种模式切换功能正常工作（2D、Vector 3D、Photorealistic 3D）
- ✅ Photorealistic 3D Maps 模式正常加载和渲染
- ✅ 所有图层在 Photorealistic 3D 模式下正常显示
- ✅ 三种模式之间的切换流畅，支持平滑过渡
- ✅ 样式配置支持三种模式

#### 代码质量

- ✅ 代码结构清晰，支持多种地图实例类型
- ✅ 类型定义完整，区分 Map 和 Map3DElement
- ✅ 错误处理完善，包括库加载失败的情况
- ✅ 注释清晰，说明不同模式的实现差异

#### 用户体验

- ✅ 切换按钮支持三种模式选择（循环切换或下拉菜单）
- ✅ 模式标识清晰，用户易于理解
- ✅ 切换动画流畅，无明显卡顿
- ✅ Photorealistic 3D 模式下各图层清晰可见
- ✅ 提供性能降级选项（低端设备）

#### 性能表现

- ✅ Photorealistic 3D Maps 加载时间合理（< 3s）
- ✅ 三种模式切换响应时间 < 300ms
- ✅ Photorealistic 3D 模式渲染流畅（30fps+）
- ✅ 低端设备自动降级或提供禁用选项
- ✅ 无明显内存泄漏或性能问题

---

## 后续优化建议

### 第一阶段完成后可进行的优化

1. **高级 3D 功能**
   - 支持自定义倾斜角度（滑块控制）
   - 支持自定义旋转角度
   - 保存用户偏好的视角设置

2. **样式调优**
   - 根据实际使用反馈调整样式参数
   - 支持主题切换（浅色/深色模式）
   - 支持自定义样式配置

3. **性能优化**
   - 实现 Vector 3D 模式的延迟加载
   - 优化低端设备的 3D 渲染
   - 添加性能监控和降级策略

4. **用户体验增强**
   - 添加 3D 模式引导提示
   - 支持手势控制（触摸设备）
   - 添加视角重置按钮

### 第二阶段完成后可进行的优化

5. **Photorealistic 3D Maps 高级功能**
   - 优化 Photorealistic 3D Tiles 加载策略
   - 实现更精细的视角控制
   - 支持 Photorealistic 3D 模式下的自定义标记样式

6. **跨模式功能增强**
   - 实现模式间的视角记忆（切换回原模式时恢复之前的视角）
   - 支持模式快速切换快捷键
   - 添加模式预览功能

7. **性能与成本优化**
   - 实现 Photorealistic 3D Maps 的智能加载（按需加载）
   - 优化 Photorealistic 3D 模式的渲染性能
   - 监控和优化 API 调用成本
   - 实现更智能的降级策略

8. **用户体验增强**
   - 添加模式切换动画效果
   - 支持模式切换时的数据图层过渡动画
   - 提供模式对比功能（并排显示）
