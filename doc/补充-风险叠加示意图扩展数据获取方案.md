# 风险叠加示意图扩展数据获取方案

## 1. 问题背景

### 1.1 问题描述
风险叠加示意图的纵轴值计算需要回溯数据计算窗口内的天气数据。当用户选择的时间窗口（Map Settings 中的 `dateRange`）为 `[t0, t1]` 时：
- 对于图表上的第一个数据点 `t0`，需要回溯 `[t0 - timeWindow.size, ..., t0]` 的数据
- 但 `t0 - timeWindow.size` 不在用户选择的时间窗口内
- 导致 `t0` 时刻的纵轴值计算不准确（可能只计算了部分数据或只有 `t0` 本身）

### 1.2 影响范围
- **仅影响**：风险叠加示意图的纵轴值计算不准确
- **不影响**：其他模块（风险计算、风险展示、天气统计仍使用原始时间窗口）

## 2. 解决方案概述

### 2.1 核心思路
为风险叠加示意图单独获取扩展的时间范围数据，确保每个数据点都能正确回溯计算纵轴值。

### 2.2 设计原则
1. **隔离性**：扩展数据仅用于风险叠加示意图的计算，不影响其他模块
2. **动态性**：根据产品 `riskRules.timeWindow` 动态计算扩展范围，支持所有产品类型
3. **性能优化**：仅在需要时获取扩展数据，利用现有缓存机制

## 3. 扩展时间范围计算逻辑

### 3.1 计算依据
根据产品 `riskRules.timeWindow` 配置判断时间单位：
- `timeWindow.type`：'hourly' | 'daily' | 'weekly' | 'monthly'
- `timeWindow.size`：窗口大小（单位由 `type` 决定）

**重要**：使用 `riskRules.timeWindow.type` 判断时间单位，**不使用** `product.type`。

### 3.2 扩展规则

#### 3.2.1 小时级窗口（`timeWindow.type === 'hourly'`）
- **扩展起始时间** = `dateRange.from - timeWindow.size 小时`
- **扩展结束时间** = `dateRange.to`（保持不变）
- **示例**：
  - 产品配置：`timeWindow.type = 'hourly'`, `timeWindow.size = 4`
  - 用户选择：`[2025-01-15 10:00, 2025-01-20 10:00]`
  - 扩展范围：`[2025-01-15 06:00, 2025-01-20 10:00]`

#### 3.2.2 天级窗口（`timeWindow.type === 'daily'`）
- **扩展起始时间** = `dateRange.from - timeWindow.size 天`
- **扩展结束时间** = `dateRange.to`（保持不变）
- **示例**：
  - 产品配置：`timeWindow.type = 'daily'`, `timeWindow.size = 7`
  - 用户选择：`[2025-01-15, 2025-01-20]`
  - 扩展范围：`[2025-01-08, 2025-01-20]`

#### 3.2.3 周级窗口（`timeWindow.type === 'weekly'`）
- **扩展起始时间** = `dateRange.from - timeWindow.size 周`
- **扩展结束时间** = `dateRange.to`（保持不变）
- **示例**：
  - 产品配置：`timeWindow.type = 'weekly'`, `timeWindow.size = 2`
  - 用户选择：`[2025-01-15, 2025-01-20]`
  - 扩展范围：`[2025-01-01, 2025-01-20]`（约14天前）

#### 3.2.4 月级窗口（`timeWindow.type === 'monthly'`）
- **扩展起始时间** = `dateRange.from` 所在月份的第一天（1号 00:00:00）
- **扩展结束时间** = `dateRange.to`（保持不变）
- **示例**：
  - 产品配置：`timeWindow.type = 'monthly'`, `timeWindow.size = 1`
  - 用户选择：`[2025-01-15, 2025-01-20]`
  - 扩展范围：`[2025-01-01 00:00:00, 2025-01-20]`

### 3.3 特殊情况处理
1. **无产品选择**：不扩展，使用原始 `dateRange`
2. **无 `riskRules` 或 `timeWindow`**：不扩展，使用原始 `dateRange`
3. **历史数据边界**：如果扩展范围超出可用历史数据，使用实际可用数据范围

## 4. 数据流设计

### 4.1 数据流图
```
用户选择产品（selectedProduct）
    ↓
Map Settings 时间窗口 [t0, t1]（一直存在）
    ↓
根据 selectedProduct.riskRules.timeWindow 计算扩展范围
    ↓
扩展时间窗口 [t0 - windowSize, t1]
    ↓
获取扩展天气数据（包含回溯所需的数据）
    ↓
计算风险叠加示意图的纵轴值（使用扩展数据）
    ↓
过滤：只保留 [t0, t1] 内的数据用于图表显示
    ↓
渲染图表（只显示用户选择的时间窗口）
```

### 4.2 数据隔离
- **扩展数据获取**：仅在 `DataDashboard` 组件内部或通过专用 Hook 获取
- **数据使用范围**：
  - ✅ **风险叠加示意图**：使用扩展数据计算纵轴值
  - ❌ **其他图表（Rainfall Trends）**：使用原始数据
  - ❌ **风险计算（`useRiskAnalysis`）**：使用原始数据
  - ❌ **风险展示（地图标记、统计信息）**：使用原始数据
  - ❌ **天气统计（`useWeatherStatistics`）**：使用原始数据

## 5. 关键设计点

### 5.1 时间单位判断
- **使用 `riskRules.timeWindow.type` 判断时间单位**，不使用 `product.type`
- 支持 'hourly' | 'daily' | 'weekly' | 'monthly' 四种类型
- **通用化**：通过解析产品规则动态适配新产品类型

### 5.2 扩展范围计算
- 根据 `timeWindow.type` 和 `timeWindow.size` 动态计算
- 扩展起始时间 = 用户选择起始时间 - 数据计算窗口大小
- 扩展结束时间 = 用户选择结束时间（保持不变）

### 5.3 数据过滤
- **计算纵轴值时**：使用扩展数据（确保回溯完整）
- **图表显示时**：过滤到用户选择的时间窗口（只显示 `[t0, t1]` 内的数据点）

### 5.4 性能考虑
- 仅在选中产品时获取扩展数据
- 利用 `useWeatherData` 的缓存机制
- 使用 `useMemo` 避免重复计算

## 6. 实现要点

### 6.1 Hook 设计
创建专用 Hook：`useExtendedWeatherDataForOverlayChart`
- **输入参数**：
  - `selectedRegion`: 选中区域
  - `dateRange`: 用户选择的时间窗口（Map Settings）
  - `dataType`: 数据类型（历史/预测）
  - `weatherType`: 天气类型
  - `selectedProduct`: 选中的产品（用于获取 `riskRules`）
- **输出**：
  - `extendedHourlyData`: 扩展的小时级数据
  - `extendedDailyData`: 扩展的日级数据
  - `extendedDateRange`: 扩展的时间范围（用于调试和验证）

### 6.2 组件集成
在 `DataDashboard` 组件中：
- 调用 `useExtendedWeatherDataForOverlayChart` 获取扩展数据
- 修改 `analysisData` 计算逻辑：
  - 使用扩展数据计算纵轴值（确保回溯完整）
  - 过滤结果，只保留用户选择时间窗口内的数据点用于显示

### 6.3 边界处理
- **数据不足**：如果扩展范围超出可用数据，使用实际可用范围
- **跨月/跨年**：正确处理时间计算，避免日期错误
- **时区处理**：确保时间计算的一致性

## 7. 验证要点

### 7.1 功能验证
- [ ] 扩展时间范围计算正确（根据 `riskRules.timeWindow.type` 和 `size`）
- [ ] 纵轴值计算准确（图表起始位置的数据点也能正确计算）
- [ ] 图表显示正确（只显示用户选择的时间窗口）
- [ ] 不影响其他模块（风险计算、风险展示、天气统计）

### 7.2 性能验证
- [ ] 扩展数据获取不影响页面加载性能
- [ ] 缓存机制正常工作
- [ ] 数据计算不重复执行

### 7.3 通用化验证
- [ ] 支持所有产品类型（daily/weekly/monthly）
- [ ] 支持不同的 `timeWindow.type` 配置（hourly/daily/weekly/monthly）
- [ ] 支持新产品类型（无需修改代码）

## 8. 实际产品配置示例

根据 `src/data/products.ts` 中的实际配置：

### 8.1 降雨量日内产品（Daily Heavy Rain）
```typescript
riskRules: {
  timeWindow: {
    type: 'hourly',  // 时间单位：小时
    size: 4,         // 窗口大小：4小时
    step: 1
  }
}
```
- **扩展规则**：扩展 4 小时
- **示例**：用户选择 `[2025-01-15 10:00, 2025-01-20 10:00]`
  - 扩展范围：`[2025-01-15 06:00, 2025-01-20 10:00]`

### 8.2 降雨量周度产品（Weekly Accumulation Rainfall）
```typescript
riskRules: {
  timeWindow: {
    type: 'daily',   // 时间单位：天
    size: 7,         // 窗口大小：7天
    step: 1
  }
}
```
- **扩展规则**：扩展 7 天
- **示例**：用户选择 `[2025-01-15, 2025-01-20]`
  - 扩展范围：`[2025-01-08, 2025-01-20]`

### 8.3 降雨量月度产品（Drought Defense）
```typescript
riskRules: {
  timeWindow: {
    type: 'monthly', // 时间单位：月
    size: 1,         // 窗口大小：1个月
    step: 1
  }
}
```
- **扩展规则**：扩展到当月1号
- **示例**：用户选择 `[2025-01-15, 2025-01-20]`
  - 扩展范围：`[2025-01-01 00:00:00, 2025-01-20]`

## 9. 注意事项

### 9.1 时间单位判断
- **必须使用** `riskRules.timeWindow.type` 判断时间单位
- **不能使用** `product.type` 判断时间单位
- 原因：`product.type` 是产品的时间维度分类（daily/weekly/monthly），而 `timeWindow.type` 是实际的数据计算窗口类型（hourly/daily/weekly/monthly）

### 9.2 触发条件
- 扩展数据获取的**触发条件**：用户选择了产品（`selectedProduct !== null`）
- Map Settings 的时间窗口（`dateRange`）一直存在，不是触发条件

### 9.3 数据隔离
- 扩展数据**仅用于**风险叠加示意图的纵轴值计算
- **不影响**其他任何模块的数据获取和计算

---

**方案版本**：v1.0  
**创建日期**：2025-12-18  
**适用范围**：风险叠加示意图的纵轴值计算

