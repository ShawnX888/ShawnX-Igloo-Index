# 18-数据面板基础结构

## 步骤概述

### 步骤编号和名称
**步骤18**：数据面板基础结构

### 步骤目标
实现数据面板的基础结构，包括面板布局、数据获取逻辑、与地图和控制面板的数据联动，为后续的分析汇总和图表可视化提供基础框架。

### 预期成果
- 数据面板可以正常显示
- 面板布局清晰，符合设计要求
- 数据获取逻辑正常工作
- 与地图和控制面板的数据联动正常
- 为后续步骤提供可用的数据面板框架

---

## 前置条件

### 依赖的步骤
- **步骤04**：Mock数据生成器（需要降雨量数据）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- Mock数据生成器已实现
- 风险计算引擎可以正确计算风险事件
- 数据格式已统一

### 需要的数据/接口
- 降雨量数据：`RainfallData[]`类型
- 风险事件数据：`RiskEvent[]`类型
- 当前参数：`selectedRegion`、`rainfallType`、`dateRange`、`selectedProduct`

---

## 实现要点

### 核心功能点

1. **面板布局**
   - 面板位置：首页下方，流式布局
   - 面板结构：分析汇总区域、图表区域、风险事件时间线区域
   - 响应式设计：支持不同屏幕尺寸

2. **数据获取逻辑**
   - 从Dashboard组件获取当前参数
   - 根据参数获取对应的降雨量数据
   - 根据参数和产品获取风险事件数据
   - 使用useMemo缓存计算结果

3. **数据联动机制**
   - 参数变更时自动重新获取数据
   - 数据更新时自动更新面板显示
   - 与地图和控制面板保持数据同步

4. **数据格式化**
   - 格式化降雨量数据用于图表显示
   - 格式化风险事件数据用于时间线显示
   - 计算统计数据用于分析汇总

### 技术实现方案

#### 1. 数据面板组件结构
```typescript
// 伪代码示例
export function DataDashboard({
  selectedRegion,
  rainfallType,
  dateRange,
  selectedProduct,
  dailyData,
  onProductSelect
}: DataDashboardProps) {
  // 获取风险事件数据
  const riskEvents = useMemo(() => {
    if (!selectedProduct) return [];
    return calculateRiskEvents(
      selectedProduct,
      selectedRegion,
      dateRange,
      dailyData
    );
  }, [selectedProduct, selectedRegion, dateRange, dailyData]);

  // 计算统计数据
  const statistics = useMemo(() => {
    return calculateStatistics(dailyData, riskEvents, selectedProduct);
  }, [dailyData, riskEvents, selectedProduct]);

  return (
    <div className="data-dashboard">
      {/* 分析汇总区域 */}
      <AnalysisSummary statistics={statistics} />
      
      {/* 图表区域 */}
      <ChartsSection
        dailyData={dailyData}
        riskEvents={riskEvents}
        selectedProduct={selectedProduct}
      />
      
      {/* 风险事件时间线 */}
      <RiskEventsTimeline
        riskEvents={riskEvents}
        selectedProduct={selectedProduct}
      />
    </div>
  );
}
```

#### 2. 数据获取Hook
```typescript
// 伪代码示例
function useDashboardData(
  selectedRegion: Region,
  rainfallType: RainfallType,
  dateRange: DateRange,
  selectedProduct: Product | null,
  allRegionsData: RegionData
) {
  // 获取当前区域的降雨量数据
  const rainfallData = useMemo(() => {
    return allRegionsData[selectedRegion.district] || [];
  }, [allRegionsData, selectedRegion]);

  // 获取风险事件数据
  const riskEvents = useMemo(() => {
    if (!selectedProduct) return [];
    return calculateRiskEvents(
      selectedProduct,
      selectedRegion,
      dateRange,
      rainfallData
    );
  }, [selectedProduct, selectedRegion, dateRange, rainfallData]);

  // 计算统计数据
  const statistics = useMemo(() => {
    return calculateStatistics(rainfallData, riskEvents, selectedProduct);
  }, [rainfallData, riskEvents, selectedProduct]);

  return {
    rainfallData,
    riskEvents,
    statistics
  };
}
```

#### 3. 数据联动机制
```typescript
// 伪代码示例
useEffect(() => {
  // 参数变更时，自动重新获取数据
  // 数据更新时，自动更新面板显示
}, [selectedRegion, rainfallType, dateRange, selectedProduct]);
```

### 关键代码结构

#### 数据面板组件
```typescript
// 伪代码示例
export function DataDashboard({
  selectedRegion,
  rainfallType,
  dateRange,
  selectedProduct,
  dailyData,
  onProductSelect
}: DataDashboardProps) {
  // 数据获取逻辑
  // 数据格式化
  // 面板布局
}
```

---

## 输入输出

### 输入
- **当前参数**：`selectedRegion`、`rainfallType`、`dateRange`、`selectedProduct`
- **降雨量数据**：`RainfallData[]`类型（从Mock数据生成器获取）
- **区域数据**：`RegionData`类型（所有区域的数据）

### 输出
- **格式化数据**：用于图表显示的数据
- **统计数据**：用于分析汇总的数据
- **风险事件数据**：用于时间线显示的数据

---

## 验收标准

### 功能验收标准
- [ ] 数据面板可以正常显示
- [ ] 面板布局清晰，符合设计要求
- [ ] 数据获取逻辑正常工作
- [ ] 与地图和控制面板的数据联动正常
- [ ] 参数变更时，数据自动更新

### 性能验收标准
- [ ] 数据获取时间在1秒内
- [ ] 数据更新流畅，无明显卡顿
- [ ] 内存使用合理，不会导致内存泄漏

### 数据质量验收标准
- [ ] 数据格式统一，符合接口定义
- [ ] 数据计算准确，符合业务逻辑
- [ ] 数据与地图显示一致

---

## 注意事项

### 常见问题
1. **数据获取失败**
   - 确保参数正确传递
   - 确保数据生成器正常工作
   - 处理数据缺失的情况

2. **数据不同步**
   - 确保数据联动机制正确
   - 确保参数变更时正确触发数据更新

3. **性能问题**
   - 使用useMemo缓存计算结果
   - 避免不必要的重复计算

### 技术难点
- **数据联动**：需要正确管理数据流和状态同步
- **数据格式化**：需要将原始数据转换为图表所需格式
- **性能优化**：需要优化数据计算和渲染性能

### 扩展性考虑
- 数据面板结构可以扩展，支持更多数据展示
- 数据获取逻辑可以扩展，支持更多数据源
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 数据面板基础结构已实现，可以在步骤19中实现分析汇总卡片
- 数据获取逻辑已实现，可以在步骤20中使用进行图表可视化

### 数据/接口的传递
- 格式化数据通过props传递给图表组件
- 统计数据通过props传递给分析汇总组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
