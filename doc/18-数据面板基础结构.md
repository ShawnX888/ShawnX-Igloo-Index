# 18-数据面板基础结构

## 步骤概述

### 步骤编号和名称
**步骤18**：数据面板基础结构

### 步骤目标
实现数据面板的基础结构，包括面板布局、数据获取逻辑、与地图和控制面板的数据联动，为后续的分析汇总和图表可视化提供基础框架。

### 预期成果
- 数据面板可以正常显示
- 面板布局清晰，符合设计要求
- 数据获取逻辑正常工作
- 与地图和控制面板的数据联动正常
- 为后续步骤提供可用的数据面板框架

---

## 前置条件

### 依赖的步骤
- **步骤04**：Mock数据生成器（需要降雨量数据）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- Mock数据生成器已实现
- 风险计算引擎可以正确计算风险事件
- 数据格式已统一

### 需要的数据/接口
- 天气数据：`WeatherData[]` 类型
- 风险事件数据：`RiskEvent[]` 类型
- 当前参数：`selectedRegion`、`dataType`、`dateRange`、`selectedProduct`

---

## 实现要点

### 核心功能点

1. **面板布局**
   - 面板位置：首页下方，流式布局
   - 面板结构：分析汇总区域、图表区域、风险事件时间线区域
   - 响应式设计：支持不同屏幕尺寸

2. **数据集成逻辑**
   - 从 Dashboard 组件接收通过 `useRiskAnalysis` 计算好的 `riskEvents` 和 `statistics`
   - 气象原始数据 `dailyData` 同样通过 Props 传入
   - 组件内部仅处理与视图展示相关的逻辑

3. **数据联动机制**
   - 核心参数（区域、产品等）变更触发顶层 Hook 重新计算
   - 数据通过 Props 自动下发，实现数据面板的实时响应
   - 与地图图层共用同一套计算出的风险数据源

4. **数据格式化**
   - 气象原始数据用于渲染基础趋势图
   - `riskEvents` 用于在图表上叠加风险标识和渲染时间线
   - `statistics` 直接用于渲染顶层的分析汇总卡片

### 技术实现方案

有关中心化风险计算架构及数据流向的详细方案，请参阅：[风险计算架构升级方案](./补充-风险计算架构升级方案.md)

#### 1. 数据面板组件结构
```typescript
// 核心逻辑已上移至 Dashboard.tsx 的 useRiskAnalysis Hook
export function DataDashboard({
  selectedRegion,
  weatherDataType,
  dateRange,
  selectedProduct,
  dailyData,        // 气象原始数据
  riskEvents,       // 由中心化 Hook 计算后的风险事件列表
  statistics,       // 由中心化 Hook 计算后的风险统计信息
  onProductSelect
}: DataDashboardProps) {
  // 组件内不再执行核心风险计算，仅负责视图渲染和局部交互状态
  return (
    <div className="data-dashboard">
      {/* 分析汇总区域 */}
      <AnalysisSummary 
        statistics={statistics} 
        selectedProduct={selectedProduct} 
      />
      
      {/* 图表区域 */}
      <ChartsSection
        dailyData={dailyData}
        riskEvents={riskEvents}
        selectedProduct={selectedProduct}
      />
      
      {/* 风险事件时间线 */}
      <RiskEventsTimeline
        riskEvents={riskEvents}
        selectedProduct={selectedProduct}
      />
    </div>
  );
}
```

#### 2. 数据联动机制
数据面板通过 Props 响应 `Dashboard.tsx` 中 `useRiskAnalysis` 返回的最新状态。当用户切换区域、产品或数据类型时，中心化 Hook 重新计算，数据面板通过 React 的声明式渲染自动更新。

### 关键代码结构

#### 数据面板组件
```typescript
// 伪代码示例
export function DataDashboard({
  selectedRegion,
  dataType,
  dateRange,
  selectedProduct,
  dailyData,
  onProductSelect
}: DataDashboardProps) {
  // 数据获取逻辑
  // 数据格式化
  // 面板布局
}
```

---

## 输入输出

### 输入
- **核心参数**：`selectedRegion`、`weatherDataType`、`dateRange`、`selectedProduct`
- **计算结果 (来自中心化 Hook)**：
  - `riskEvents`: `RiskEvent[]` (详细风险事件列表)
  - `statistics`: `RiskStatistics` (聚合后的统计指标)
- **原始气象数据**：`dailyData`: `WeatherData[]`

### 输出
- **可视化视图**：天气趋势图、风险分布示意图
- **量化指标**：分析汇总卡片
- **事件追溯**：风险事件触发时间线

---

## 验收标准

### 功能验收标准
- [ ] 数据面板可以正常显示
- [ ] 面板布局清晰，符合设计要求
- [ ] 数据获取逻辑正常工作
- [ ] 与地图和控制面板的数据联动正常
- [ ] 参数变更时，数据自动更新

### 性能验收标准
- [ ] 数据获取时间在1秒内
- [ ] 数据更新流畅，无明显卡顿
- [ ] 内存使用合理，不会导致内存泄漏

### 数据质量验收标准
- [ ] 数据格式统一，符合接口定义
- [ ] 数据计算准确，符合业务逻辑
- [ ] 数据与地图显示一致

---

## 注意事项

### 常见问题
1. **数据获取失败**
   - 确保参数正确传递
   - 确保数据生成器正常工作
   - 处理数据缺失的情况

2. **数据不同步**
   - 确保数据联动机制正确
   - 确保参数变更时正确触发数据更新

3. **性能问题**
   - 使用useMemo缓存计算结果
   - 避免不必要的重复计算

### 技术难点
- **数据联动**：需要正确管理数据流和状态同步
- **数据格式化**：需要将原始数据转换为图表所需格式
- **性能优化**：需要优化数据计算和渲染性能

### 扩展性考虑
- 数据面板结构可以扩展，支持更多数据展示
- 数据获取逻辑可以扩展，支持更多数据源
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 数据面板基础结构已实现，可以在步骤19中实现分析汇总卡片
- 数据获取逻辑已实现，可以在步骤20中使用进行图表可视化

### 数据/接口的传递
- 格式化数据通过props传递给图表组件
- 统计数据通过props传递给分析汇总组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
