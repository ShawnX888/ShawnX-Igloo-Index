# 20-图表可视化

## 步骤概述

### 步骤编号和名称
**步骤20**：图表可视化

### 步骤目标
实现数据面板中的图表可视化功能，包括天气数值柱状图、天气数据和风险叠加示意图、风险事件触发时间线，支持按小时/按天切换视图，根据产品类型自动切换视图。

### 预期成果
- 天气数值柱状图可以正常显示（按天/按小时）
- 天气数据和风险叠加示意图可以正常显示（不同产品RiskRule的thresholds）
- 风险事件触发时间线可以正常显示
- 视图切换功能正常工作（hourly/daily）
- 根据产品类型自动切换视图
- 图表交互功能正常工作（缩放、悬停查看详情）

---

## 前置条件

### 依赖的步骤
- **步骤18**：数据面板基础结构（需要数据获取逻辑）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- 数据面板基础结构已实现
- 风险计算引擎可以正确计算风险事件
- 数据格式已统一

### 需要的数据/接口
- 天气数据：`WeatherData[]`类型
- 风险事件数据：`RiskEvent[]`类型
- 选中产品：`Product | null`类型
- 时间范围：`DateRange`类型

---

## 实现要点

### 核心功能点

> **通用化设计说明**：
> - **基础天气数据**：所有图表的基础天气数据（`WeatherData[]`）全部源自通用的数据接口，不依赖特定产品类型。
> - **风险叠加示意图**：作为一类特殊的图表类别，其下属图表是为每种产品定制的。通过解析 `Product` 对象的 `riskRules` 动态生成计算逻辑和可视化样式，不硬编码特定产品逻辑。系统的可视化框架不仅限于服务当前的降雨量日内/周度/月度产品，而是支持产品库中定义的任何符合规则配置的新产品类型。

1. **天气数值柱状图**
   - 默认按天展示，可手动切换为按小时展示
   - 使用Recharts库实现
   - 支持缩放和悬停查看详情
   - 根据产品类型自动切换视图：
     - 日内产品：自动切换到hourly view
     - 周度或月度产品：自动切换到daily view

2. **天气数据和风险叠加示意图（产品定制图表）**
   
   > **重要概念区分**：
   > - **时间窗口（Time Range）**：指 Map Settings 中用户指定的时间范围（`dateRange`），用于确定图表显示哪些时间段的数据。这是用户选择的分析时间范围。
   > - **数据计算窗口（Calculation Window）**：指根据产品 `riskRules.timeWindow.size` 配置的数据回溯窗口，用于计算每个数据点的纵轴值。这是产品规则定义的计算逻辑。
   
   > **纵轴值计算逻辑**：风险叠加示意图的纵轴值计算需要参考产品 `riskRules` 中的时间窗口配置，**对于图表上的每个数据点，回溯获取该点之前的数据计算窗口内的天气数据进行加工计算**。具体逻辑如下：
   
   - **降雨量日内产品示例**：
     - 图表类型：柱状图，hourly view
     - 数据计算窗口：对于任意时刻 `t`，回溯获取该时刻之前连续 `timeWindow.size` 小时的基础天气数据
     - 纵轴值计算：`t` 时刻的纵轴值 = `[t - timeWindow.size, ..., t-1, t]` 这 `(timeWindow.size + 1)` 小时的累计值
     - 例如：`timeWindow.size = 3` 时，时刻 `t` 的纵轴值 = `[t-3, t-2, t-1, t]` 这4小时的累计值
     - 主图上叠加阈值阶梯线（从 `riskRules.thresholds` 获取）
     - 若某根柱的值超过阈值线，则特殊显示（高亮、不同颜色）
   
   - **降雨量周度产品示例**：
     - 图表类型：柱状图，daily view
     - 数据计算窗口：对于任意日期 `d`，回溯获取该日期之前连续 `timeWindow.size` 天的基础天气数据
     - 纵轴值计算：`d` 日期的纵轴值 = `[d - timeWindow.size, ..., d-1, d]` 这 `(timeWindow.size + 1)` 天的累计值
     - 例如：`timeWindow.size = 6` 时，日期 `d` 的纵轴值 = `[d-6, d-5, ..., d-1, d]` 这7天的累计值
     - 主图上叠加阈值阶梯线（从 `riskRules.thresholds` 获取）
     - 若某根柱的值超过阈值线，则特殊显示（高亮、不同颜色）
   
   - **降雨量月度产品示例**：
     - 图表类型：累积折线图，daily view
     - 数据计算窗口：对于任意日期 `d`，回溯获取该日期所在月份从1号到当天的基础天气数据
     - 纵轴值计算：`d` 日期的纵轴值 = 该日期所在月份从1号到当天的累计值
     - 例如：日期 `d = 2025-01-15` 的纵轴值 = `[2025-01-01, ..., 2025-01-15]` 这15天的累计值
     - 主图上叠加阈值阶梯线（从 `riskRules.thresholds` 获取）
     - 若某月的累计值超过阈值，则特殊显示（高亮、不同颜色）
   
   - **通用化支持**：通过解析 `Product.riskRules.timeWindow` 和 `Product.riskRules.calculation`，系统可以动态适配任何新产品类型的计算逻辑，无需修改图表组件代码。

3. **风险事件触发时间线**
   - 仅在指定了保险产品后显示
   - 按时间线呈现：哪一月/哪一天/哪一小时，什么级别，触发类型等，按时间倒序排序
   - 展示风险事件的核心信息：时间戳、事件类型、事件描述
   - **注意**：产品、区域、天气类型等元数据已在分析汇总卡片中展示，时间线无需重复展示

### 技术实现方案

有关图表与中心化风险事件数据联动的详细方案，请参阅：[风险计算架构升级方案](./补充-风险计算架构升级方案.md)

#### 1. 风险叠加示意图逻辑
图表组件通过 Props 接收扩展天气数据（通过 `useExtendedWeatherData` 获取）、`riskEvents` 和 `selectedProduct`，根据产品规则动态计算纵轴值和生成阈值线。

- **扩展数据获取**：
  - 使用 `useExtendedWeatherData` Hook 获取扩展时间范围的天气数据
  - 扩展时间范围根据 `selectedProduct.riskRules.timeWindow` 动态计算
  - 确保时间窗口起始位置的数据点也能正确回溯计算纵轴值

- **纵轴值计算**：
  - 从 `selectedProduct.riskRules.timeWindow` 获取数据计算窗口配置（`size`、`type` 等）
  - 对于图表上的每个数据点（时刻 `t` 或日期 `d`），根据数据计算窗口回溯获取该点之前的天气数据（使用扩展数据）
    - 日内产品：回溯 `t - timeWindow.size` 到 `t` 的连续小时数据
    - 周度产品：回溯 `d - timeWindow.size` 到 `d` 的连续天数据
    - 月度产品：回溯该日期所在月份从1号到当天的数据
  - 根据 `riskRules.calculation.aggregation`（如 `sum`、`avg`）对回溯的天气数据进行累计计算
  - 计算得到的累计值作为该数据点的纵轴值
  - **数据过滤**：计算完成后，过滤到用户选择的时间窗口（`dateRange`），只显示用户选择时间范围内的数据点
  
- **阈值线来源**：从 `selectedProduct.riskRules.thresholds` 中获取阈值配置，在图表上叠加显示为参考线（ReferenceLine）。

- **触发标识**：直接标记 `riskEvents` 中存在的点，根据事件的 `level` (Tier 1/2/3) 进行分级着色。

- **分级着色**：根据 `RiskEvent` 中的 `level` 自动匹配不同的预警颜色（如 Tier 1/2/3 对应不同颜色）。

- **气象统计用途**：`weatherStatistics` 主要用于 Rainfall Trends 图表的均值参考线（可选），不用于 RiskOverlayChart 的阈值判断和纵轴值计算。

#### 2. 风险事件触发时间线
```typescript
// 伪代码示例
function RiskEventsTimeline({
  riskEvents,
  selectedProduct
}: RiskEventsTimelineProps) {
  return (
    <div className="risk-events-timeline">
      <h3>Risk Events</h3>
      <Timeline>
        {riskEvents.map((event) => (
          <TimelineItem key={event.id}>
            <TimelineContent>
              <div className="event-time">
                {formatEventTime(event.timestamp)}
              </div>
              <div className="event-level level-{event.level}">
                {event.level.toUpperCase()} (Tier {event.level.replace('tier', '')})
              </div>
              <div className="event-details">
                {/* 核心信息：类型和描述 */}
                <div className="event-type">{event.type}</div>
                <div className="event-description">{event.description}</div>
                {/* 注意：产品、区域、天气类型等元数据已在分析汇总卡片中展示 */}
              </div>
            </TimelineContent>
          </TimelineItem>
        ))}
      </Timeline>
    </div>
  );
}
```

### 关键代码结构

#### 图表可视化组件
```typescript
// 伪代码示例
export function ChartsSection({
  dailyData,
  hourlyData,          // 基础天气数据（通用接口）
  riskEvents,
  weatherStatistics,   // 解耦后的气象统计信息
  selectedProduct
}: ChartsSectionProps) {
  const [viewMode, setViewMode] = useState<'hourly' | 'daily'>('daily');

  // 根据产品类型自动切换视图
  useEffect(() => {
    if (selectedProduct?.type === 'daily') {
      setViewMode('hourly');
    } else {
      setViewMode('daily');
    }
  }, [selectedProduct]);

  return (
    <div className="charts-section">
      {/* 降雨量柱状图 */}
      <RainfallChart
        data={viewMode === 'hourly' ? hourlyData : dailyData}
        statistics={weatherStatistics} // 传递统计基准（均值、峰值等）
        viewMode={viewMode}
        onViewModeChange={setViewMode}
        selectedProduct={selectedProduct}
      />
      
      {/* 风险叠加示意图（仅在选中产品时显示） */}
      {selectedProduct && (
        <RiskOverlayChart
          data={viewMode === 'hourly' ? hourlyData : dailyData}  // 基础天气数据（通用接口）
          riskEvents={riskEvents}
          selectedProduct={selectedProduct}  // 用于获取 riskRules（timeWindow, thresholds, calculation）
          viewMode={viewMode}
        />
      )}
      
      {/* 风险事件触发时间线（仅在选中产品时显示） */}
      {selectedProduct && (
        <RiskEventsTimeline
          riskEvents={riskEvents}
          selectedProduct={selectedProduct}
        />
      )}
    </div>
  );
}
```

#### 风险叠加示意图纵轴值计算逻辑
```typescript
// 伪代码示例：根据产品 riskRules 动态计算纵轴值
// 注意：extendedData 是通过 useExtendedWeatherData 获取的扩展时间范围数据
function calculateOverlayChartData(
  extendedData: WeatherData[],  // 扩展天气数据（通过 useExtendedWeatherData 获取）
  product: Product,
  dateRange: DateRange  // 用户选择的时间窗口，用于过滤显示
): AnalysisItem[] {
  const { riskRules } = product;
  const { timeWindow, calculation } = riskRules;
  const calculationWindowSize = timeWindow.size;  // 数据计算窗口大小
  const aggregation = calculation.aggregation; // 'sum', 'avg', etc.

  // 先过滤到用户选择的时间窗口，只处理该范围内的数据点
  const userRangeData = extendedData.filter(item => {
    const itemDate = new Date(item.date);
    return itemDate >= dateRange.from && itemDate <= dateRange.to;
  });

  return userRangeData.map((item, index) => {
    // 在扩展数据中找到该数据点的位置
    const itemIndexInExtended = extendedData.findIndex(d => d.date === item.date);
    
    // 根据数据计算窗口回溯获取该数据点之前的天气数据（从扩展数据中回溯）
    // 例如：对于时刻 t，回溯获取 [t - calculationWindowSize, ..., t-1, t] 的数据
    const calculationWindowStartIndex = Math.max(0, itemIndexInExtended - calculationWindowSize);
    const calculationWindowData = extendedData.slice(calculationWindowStartIndex, itemIndexInExtended + 1);
    
    // 根据 aggregation 配置对数据计算窗口内的数据进行累计计算
    let calculatedValue = 0;
    if (aggregation === 'sum') {
      calculatedValue = calculationWindowData.reduce((sum, d) => sum + d.value, 0);
    } else if (aggregation === 'avg') {
      calculatedValue = calculationWindowData.reduce((sum, d) => sum + d.value, 0) / calculationWindowData.length;
    }
    // ... 支持其他聚合方式

    // 检查是否触发阈值（从 riskEvents 中查找）
    const isTriggered = riskEvents.some(
      event => event.timestamp.getTime() === new Date(item.date).getTime()
    );

    return {
      ...item,
      rollingSum: calculatedValue,  // 纵轴值（基于数据计算窗口的累计值）
      isTriggered,
      threshold: riskRules.thresholds[0]?.value  // 从产品规则获取阈值
    };
  });
}
```

---

## 输入输出

### 输入
- **扩展天气数据（通过 useExtendedWeatherData 获取）**：`WeatherData[]` 类型
  - `extendedHourlyData`: 扩展的小时级天气数据（用于 hourly view）
  - `extendedDailyData`: 扩展的日级天气数据（用于 daily view）
  - 扩展数据确保时间窗口起始位置的数据点也能正确回溯计算纵轴值
  - 计算完成后，过滤到用户选择的时间窗口（`dateRange`）用于显示
- **风险数据 (来自中心化 Hook)**：`riskEvents`: `RiskEvent[]` (用于图表打点和分级着色)
- **产品定义**：`selectedProduct`: `InsuranceProduct | null`
  - 用于获取 `riskRules.timeWindow`（时间窗口配置，用于回溯计算纵轴值）
  - 用于获取 `riskRules.thresholds`（阈值配置，生成阈值参考线）
  - 用于获取 `riskRules.calculation`（计算配置，如聚合方式）
- **气象统计 (来自中心化 Hook)**：`weatherStatistics`: `WeatherStatistics` (可选，用于 Rainfall Trends 图表的均值参考线)
- **交互参数**：`viewMode` (hourly/daily)

### 输出
- **趋势图表**：天气数值柱状图
- **叠加示意图**：在天气背景下叠加 `RiskEvent` 标识及 Tier 预警色
- **事件追溯**：风险事件时间轴

---

## 验收标准

### 功能验收标准
- [x] 降雨量柱状图可以正常显示（按天/按小时）
- [x] 降雨量和风险叠加示意图可以正常显示（三种产品类型）
- [x] 风险事件触发时间线可以正常显示
- [x] 视图切换功能正常工作（hourly/daily）
- [x] 根据产品类型自动切换视图
- [x] 图表交互功能正常工作（缩放、悬停查看详情）

### 数据质量验收标准
- [x] 图表数据计算准确，符合业务逻辑
- [x] 阈值线显示正确
- [x] 超过阈值的数据点特殊显示正确
- [x] 时间线数据格式正确

### 视觉验收标准
- [x] 图表清晰直观，易于理解
- [x] 颜色使用合理，符合设计规范
- [x] 阈值线明显，易于识别
- [x] 超过阈值的数据点有明显的视觉区分

---

## 注意事项

### 常见问题
1. **图表数据计算不准确**
   - **概念区分**：明确区分 Map Settings 中的时间窗口（`dateRange`，用户选择的分析时间范围）和产品规则中的数据计算窗口（`riskRules.timeWindow.size`，用于回溯计算纵轴值）
   - **扩展数据获取**：使用 `useExtendedWeatherData` 获取扩展时间范围的天气数据，确保时间窗口起始位置的数据点也能正确回溯计算
   - 确保根据产品 `riskRules.timeWindow.size` 正确回溯获取数据计算窗口内的天气数据（对于时刻 `t`，回溯 `[t - timeWindow.size, ..., t]` 的数据）
   - 确保累计值计算逻辑符合产品 `riskRules.calculation.aggregation` 配置
   - 确保阈值判断正确（从 `riskRules.thresholds` 获取）
   - 确保计算完成后正确过滤到用户选择的时间窗口用于显示

2. **视图切换不响应**
   - 确保视图状态管理正确
   - 确保产品类型判断正确

3. **图表性能问题**
   - 使用数据采样，避免渲染过多数据点
   - 使用虚拟滚动，处理大量数据
   - 优化数据计算窗口的回溯计算逻辑，避免重复计算

### 技术难点
- **概念区分**：需要明确区分两个"窗口"概念：
  - **时间窗口（Time Range）**：Map Settings 中用户指定的 `dateRange`，确定图表显示的时间范围
  - **数据计算窗口（Calculation Window）**：产品 `riskRules.timeWindow.size` 定义的回溯窗口，用于计算每个数据点的纵轴值
- **扩展数据获取**：使用 `useExtendedWeatherData` 获取扩展时间范围的天气数据，确保时间窗口起始位置的数据点也能正确回溯计算
- **回溯数据获取**：需要根据产品 `riskRules.timeWindow.size` 正确回溯获取数据计算窗口内的天气数据，处理边界情况（如数据不足、跨月等）
- **累计值计算**：需要根据产品 `riskRules.calculation` 动态计算累计值，支持不同的聚合方式（sum、avg等）
- **阈值叠加**：需要从产品规则中提取 `thresholds` 并在图表上叠加显示为参考线
- **多产品类型支持**：通过解析 `Product.riskRules` 动态生成图表计算逻辑和可视化样式，支持产品库中定义的所有产品类型

### 扩展性考虑
- 图表组件可以扩展，支持更多图表类型
- 图表样式可以配置化，便于调整
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 图表可视化已实现，数据展示功能基本完成
- 图表数据已格式化，可以在后续步骤中使用

### 数据/接口的传递
- 图表数据通过props传递给图表组件
- 交互事件通过回调函数传递给父组件

---

**文档版本**：v1.4  
**创建日期**：2025-01-27  
**最后更新**：2025-12-18
