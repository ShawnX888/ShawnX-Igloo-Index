# 20-图表可视化

## 步骤概述

### 步骤编号和名称
**步骤20**：图表可视化

### 步骤目标
实现数据面板中的图表可视化功能，包括天气数值柱状图、天气数据和风险叠加示意图、风险事件触发时间线，支持按小时/按天切换视图，根据产品类型自动切换视图。

### 预期成果
- 天气数值柱状图可以正常显示（按天/按小时）
- 天气数据和风险叠加示意图可以正常显示（三种产品类型）
- 风险事件触发时间线可以正常显示
- 视图切换功能正常工作（hourly/daily）
- 根据产品类型自动切换视图
- 图表交互功能正常工作（缩放、悬停查看详情）

---

## 前置条件

### 依赖的步骤
- **步骤18**：数据面板基础结构（需要数据获取逻辑）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- 数据面板基础结构已实现
- 风险计算引擎可以正确计算风险事件
- 数据格式已统一

### 需要的数据/接口
- 天气数据：`WeatherData[]`类型
- 风险事件数据：`RiskEvent[]`类型
- 选中产品：`Product | null`类型
- 时间范围：`DateRange`类型

---

## 实现要点

### 核心功能点

1. **天气数值柱状图**
   - 默认按天展示，可手动切换为按小时展示
   - 使用Recharts库实现
   - 支持缩放和悬停查看详情
   - 根据产品类型自动切换视图：
     - 日内产品：自动切换到hourly view
     - 周度或月度产品：自动切换到daily view

2. **天气数据和风险叠加示意图（日内产品）**
   - 以hourly view的柱状图为底
   - 每根柱的值为"包含当前小时和此前连续3小时的天气数据累计值"
   - 主图上叠加阈值线
   - 若某根柱的值超过阈值线，则特殊显示（高亮、不同颜色）

3. **天气数据和风险叠加示意图（周度产品）**
   - 以daily view的柱状图为底
   - 每根柱的值为"包含当天和此前连续6天的天气数据累计值"
   - 主图上叠加阈值线
   - 若某根柱的值超过阈值线，则特殊显示

4. **天气数据和风险叠加示意图（月度产品）**
   - 以daily view的面积图为底
   - 以每日天气数值为上沿线
   - 以一个完整自然月的天气数据累计值计算和显示面积
   - 若某月的累计值超过阈值，则特殊显示

5. **风险事件触发时间线**
   - 仅在指定了保险产品后显示
   - 按时间线呈现：那一月/哪一天/哪一小时，什么级别，触发类型等
   - 展示风险事件的详细信息：所属的产品、区域、时间、级别
   - 支持点击查看详情

### 技术实现方案

有关图表与中心化风险事件数据联动的详细方案，请参阅：[风险计算架构升级方案](./补充-风险计算架构升级方案.md)

#### 1. 风险叠加示意图逻辑
图表组件通过 Props 接收 `riskEvents`，并根据事件的 `timestamp` 和 `value` 在图表轴上叠加显示。

- **触发标识**：不再在组件内重复计算阈值触发，而是直接标记 `riskEvents` 中存在的点。
- **分级着色**：根据 `RiskEvent` 中的 `level` (Tier 1/2/3) 自动匹配不同的预警颜色。

#### 3. 风险事件触发时间线
```typescript
// 伪代码示例
function RiskEventsTimeline({
  riskEvents,
  selectedProduct
}: RiskEventsTimelineProps) {
  return (
    <div className="risk-events-timeline">
      <h3>Risk Events</h3>
      <Timeline>
        {riskEvents.map((event) => (
          <TimelineItem key={event.id}>
            <TimelineContent>
              <div className="event-time">
                {formatEventTime(event.timestamp)}
              </div>
              <div className="event-level level-{event.level}">
                {event.level.toUpperCase()} (Tier {event.level.replace('tier', '')})
              </div>
              <div className="event-details">
                Product: {selectedProduct.name}
                Region: {event.region.district}
                Data Type: {event.dataType}
                Weather Type: {event.weatherType}
                Value: {event.value} mm
              </div>
            </TimelineContent>
          </TimelineItem>
        ))}
      </Timeline>
    </div>
  );
}
```

### 关键代码结构

#### 图表可视化组件
```typescript
// 伪代码示例
export function ChartsSection({
  dailyData,
  riskEvents,
  selectedProduct
}: ChartsSectionProps) {
  const [viewMode, setViewMode] = useState<'hourly' | 'daily'>('daily');

  // 根据产品类型自动切换视图
  useEffect(() => {
    if (selectedProduct?.type === 'daily') {
      setViewMode('hourly');
    } else {
      setViewMode('daily');
    }
  }, [selectedProduct]);

  return (
    <div className="charts-section">
      {/* 降雨量柱状图 */}
      <RainfallChart
        data={dailyData}
        viewMode={viewMode}
        onViewModeChange={setViewMode}
        selectedProduct={selectedProduct}
      />
      
      {/* 降雨量和风险叠加示意图（仅在选中产品时显示） */}
      {selectedProduct && (
        <RiskOverlayChart
          data={dailyData}
          riskEvents={riskEvents}
          selectedProduct={selectedProduct}
          viewMode={viewMode}
        />
      )}
      
      {/* 风险事件触发时间线（仅在选中产品时显示） */}
      {selectedProduct && (
        <RiskEventsTimeline
          riskEvents={riskEvents}
          selectedProduct={selectedProduct}
        />
      )}
    </div>
  );
}
```

---

## 输入输出

### 输入
- **天气数据**：`WeatherData[]` 类型 (原始趋势显示)
- **风险数据 (来自中心化 Hook)**：`riskEvents`: `RiskEvent[]` (用于图表打点和分级)
- **产品定义**：`selectedProduct`: `InsuranceProduct | null`
- **交互参数**：`viewMode` (hourly/daily)

### 输出
- **趋势图表**：天气数值柱状图
- **叠加示意图**：在天气背景下叠加 `RiskEvent` 标识及 Tier 预警色
- **事件追溯**：风险事件时间轴

---

## 验收标准

### 功能验收标准
- [ ] 降雨量柱状图可以正常显示（按天/按小时）
- [ ] 降雨量和风险叠加示意图可以正常显示（三种产品类型）
- [ ] 风险事件触发时间线可以正常显示
- [ ] 视图切换功能正常工作（hourly/daily）
- [ ] 根据产品类型自动切换视图
- [ ] 图表交互功能正常工作（缩放、悬停查看详情）

### 数据质量验收标准
- [ ] 图表数据计算准确，符合业务逻辑
- [ ] 阈值线显示正确
- [ ] 超过阈值的数据点特殊显示正确
- [ ] 时间线数据格式正确

### 视觉验收标准
- [ ] 图表清晰直观，易于理解
- [ ] 颜色使用合理，符合设计规范
- [ ] 阈值线明显，易于识别
- [ ] 超过阈值的数据点有明显的视觉区分

---

## 注意事项

### 常见问题
1. **图表数据计算不准确**
   - 确保累计值计算正确（4小时、7天、1个月）
   - 确保阈值判断正确

2. **视图切换不响应**
   - 确保视图状态管理正确
   - 确保产品类型判断正确

3. **图表性能问题**
   - 使用数据采样，避免渲染过多数据点
   - 使用虚拟滚动，处理大量数据

### 技术难点
- **累计值计算**：需要正确处理时间窗口滑动计算
- **阈值叠加**：需要正确在图表上叠加阈值线
- **多产品类型支持**：需要支持三种不同的图表类型

### 扩展性考虑
- 图表组件可以扩展，支持更多图表类型
- 图表样式可以配置化，便于调整
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 图表可视化已实现，数据展示功能基本完成
- 图表数据已格式化，可以在后续步骤中使用

### 数据/接口的传递
- 图表数据通过props传递给图表组件
- 交互事件通过回调函数传递给父组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
