# 20-图表可视化

## 步骤概述

### 步骤编号和名称
**步骤20**：图表可视化

### 步骤目标
实现数据面板中的图表可视化功能，包括降雨量柱状图、降雨量和风险叠加示意图、风险事件触发时间线，支持按小时/按天切换视图，根据产品类型自动切换视图。

### 预期成果
- 降雨量柱状图可以正常显示（按天/按小时）
- 降雨量和风险叠加示意图可以正常显示（三种产品类型）
- 风险事件触发时间线可以正常显示
- 视图切换功能正常工作（hourly/daily）
- 根据产品类型自动切换视图
- 图表交互功能正常工作（缩放、悬停查看详情）

---

## 前置条件

### 依赖的步骤
- **步骤18**：数据面板基础结构（需要数据获取逻辑）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- 数据面板基础结构已实现
- 风险计算引擎可以正确计算风险事件
- 数据格式已统一

### 需要的数据/接口
- 降雨量数据：`RainfallData[]`类型
- 风险事件数据：`RiskEvent[]`类型
- 选中产品：`Product | null`类型
- 时间范围：`DateRange`类型

---

## 实现要点

### 核心功能点

1. **降雨量柱状图**
   - 默认按天展示，可手动切换为按小时展示
   - 使用Recharts库实现
   - 支持缩放和悬停查看详情
   - 根据产品类型自动切换视图：
     - 日内产品：自动切换到hourly view
     - 周度或月度产品：自动切换到daily view

2. **降雨量和风险叠加示意图（日内产品）**
   - 以hourly view的柱状图为底
   - 每根柱的值为"包含当前小时和此前连续3小时的降雨量累计值"
   - 主图上叠加阈值线
   - 若某根柱的值超过阈值线，则特殊显示（高亮、不同颜色）

3. **降雨量和风险叠加示意图（周度产品）**
   - 以daily view的柱状图为底
   - 每根柱的值为"包含当天和此前连续6天的降雨量累计值"
   - 主图上叠加阈值线
   - 若某根柱的值超过阈值线，则特殊显示

4. **降雨量和风险叠加示意图（月度产品）**
   - 以daily view的面积图为底
   - 以每日降雨量为上沿线
   - 以一个完整自然月的降雨量累计值计算和显示面积
   - 若某月的累计值超过阈值，则特殊显示

5. **风险事件触发时间线**
   - 仅在指定了保险产品后显示
   - 按时间线呈现：那一月/哪一天/哪一小时，什么级别，触发类型等
   - 展示风险事件的详细信息：所属的产品、区域、时间、级别
   - 支持点击查看详情

### 技术实现方案

#### 1. 降雨量柱状图
```typescript
// 伪代码示例
function RainfallChart({
  data,
  viewMode,
  onViewModeChange,
  selectedProduct
}: RainfallChartProps) {
  // 根据viewMode格式化数据
  const chartData = useMemo(() => {
    return formatChartData(data, viewMode);
  }, [data, viewMode]);

  return (
    <div className="rainfall-chart">
      <div className="chart-controls">
        <button
          onClick={() => onViewModeChange('hourly')}
          className={viewMode === 'hourly' ? 'active' : ''}
        >
          Hourly
        </button>
        <button
          onClick={() => onViewModeChange('daily')}
          className={viewMode === 'daily' ? 'active' : ''}
        >
          Daily
        </button>
      </div>
      
      <ResponsiveContainer width="100%" height={400}>
        <BarChart data={chartData}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="time" />
          <YAxis />
          <Tooltip />
          <Bar dataKey="rainfall" fill="#4285F4" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
}
```

#### 2. 降雨量和风险叠加示意图（日内产品）
```typescript
// 伪代码示例
function DailyProductChart({
  hourlyData,
  selectedProduct
}: DailyProductChartProps) {
  // 计算4小时累计值
  const chartData = useMemo(() => {
    return hourlyData.map((item, index) => {
      let sum = item.amount;
      for (let j = 1; j < 4; j++) {
        if (index - j >= 0) {
          sum += hourlyData[index - j].amount;
        }
      }
      return {
        time: item.date,
        cumulative: sum,
        exceedsThreshold: sum > selectedProduct.riskRules.thresholds[0].value
      };
    });
  }, [hourlyData, selectedProduct]);

  const threshold = selectedProduct.riskRules.thresholds[0].value;

  return (
    <ResponsiveContainer width="100%" height={400}>
      <BarChart data={chartData}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="time" />
        <YAxis />
        <Tooltip />
        <Bar 
          dataKey="cumulative" 
          fill={(entry) => entry.exceedsThreshold ? '#ef4444' : '#4285F4'} 
        />
        <ReferenceLine 
          y={threshold} 
          stroke="#ef4444" 
          strokeDasharray="5 5" 
          label="Threshold"
        />
      </BarChart>
    </ResponsiveContainer>
  );
}
```

#### 3. 风险事件触发时间线
```typescript
// 伪代码示例
function RiskEventsTimeline({
  riskEvents,
  selectedProduct
}: RiskEventsTimelineProps) {
  return (
    <div className="risk-events-timeline">
      <h3>Risk Events</h3>
      <Timeline>
        {riskEvents.map((event) => (
          <TimelineItem key={event.id}>
            <TimelineContent>
              <div className="event-time">
                {formatEventTime(event.timestamp)}
              </div>
              <div className="event-level level-{event.level}">
                {event.level.toUpperCase()}
              </div>
              <div className="event-details">
                Product: {selectedProduct.name}
                Region: {event.region.district}
                Value: {event.value} mm
              </div>
            </TimelineContent>
          </TimelineItem>
        ))}
      </Timeline>
    </div>
  );
}
```

### 关键代码结构

#### 图表可视化组件
```typescript
// 伪代码示例
export function ChartsSection({
  dailyData,
  riskEvents,
  selectedProduct
}: ChartsSectionProps) {
  const [viewMode, setViewMode] = useState<'hourly' | 'daily'>('daily');

  // 根据产品类型自动切换视图
  useEffect(() => {
    if (selectedProduct?.type === 'daily') {
      setViewMode('hourly');
    } else {
      setViewMode('daily');
    }
  }, [selectedProduct]);

  return (
    <div className="charts-section">
      {/* 降雨量柱状图 */}
      <RainfallChart
        data={dailyData}
        viewMode={viewMode}
        onViewModeChange={setViewMode}
        selectedProduct={selectedProduct}
      />
      
      {/* 降雨量和风险叠加示意图（仅在选中产品时显示） */}
      {selectedProduct && (
        <RiskOverlayChart
          data={dailyData}
          riskEvents={riskEvents}
          selectedProduct={selectedProduct}
          viewMode={viewMode}
        />
      )}
      
      {/* 风险事件触发时间线（仅在选中产品时显示） */}
      {selectedProduct && (
        <RiskEventsTimeline
          riskEvents={riskEvents}
          selectedProduct={selectedProduct}
        />
      )}
    </div>
  );
}
```

---

## 输入输出

### 输入
- **降雨量数据**：`RainfallData[]`类型
- **风险事件数据**：`RiskEvent[]`类型
- **选中产品**：`Product | null`类型
- **时间范围**：`DateRange`类型

### 输出
- **图表组件**：显示在数据面板上的图表
- **交互事件**：视图切换、图表缩放、悬停查看详情

---

## 验收标准

### 功能验收标准
- [ ] 降雨量柱状图可以正常显示（按天/按小时）
- [ ] 降雨量和风险叠加示意图可以正常显示（三种产品类型）
- [ ] 风险事件触发时间线可以正常显示
- [ ] 视图切换功能正常工作（hourly/daily）
- [ ] 根据产品类型自动切换视图
- [ ] 图表交互功能正常工作（缩放、悬停查看详情）

### 数据质量验收标准
- [ ] 图表数据计算准确，符合业务逻辑
- [ ] 阈值线显示正确
- [ ] 超过阈值的数据点特殊显示正确
- [ ] 时间线数据格式正确

### 视觉验收标准
- [ ] 图表清晰直观，易于理解
- [ ] 颜色使用合理，符合设计规范
- [ ] 阈值线明显，易于识别
- [ ] 超过阈值的数据点有明显的视觉区分

---

## 注意事项

### 常见问题
1. **图表数据计算不准确**
   - 确保累计值计算正确（4小时、7天、1个月）
   - 确保阈值判断正确

2. **视图切换不响应**
   - 确保视图状态管理正确
   - 确保产品类型判断正确

3. **图表性能问题**
   - 使用数据采样，避免渲染过多数据点
   - 使用虚拟滚动，处理大量数据

### 技术难点
- **累计值计算**：需要正确处理时间窗口滑动计算
- **阈值叠加**：需要正确在图表上叠加阈值线
- **多产品类型支持**：需要支持三种不同的图表类型

### 扩展性考虑
- 图表组件可以扩展，支持更多图表类型
- 图表样式可以配置化，便于调整
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 图表可视化已实现，数据展示功能基本完成
- 图表数据已格式化，可以在后续步骤中使用

### 数据/接口的传递
- 图表数据通过props传递给图表组件
- 交互事件通过回调函数传递给父组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
