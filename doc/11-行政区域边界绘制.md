# 11-行政区域边界绘制

## 步骤概述

### 步骤编号和名称
**步骤11**：行政区域边界绘制

### 步骤目标
使用Google Maps Data Layer加载GeoJSON格式的行政区域边界数据，绘制Polygon图层显示行政区域边界，支持区域选择和交互。

### 预期成果
- 行政区域边界可以正确绘制在地图上
- 区域边界使用Polygon显示
- 点击区域可以切换选中区域
- 选中区域有明显的视觉区分
- 边界数据可以正确加载和渲染

---

## 前置条件

### 依赖的步骤
- **步骤10**：地图容器替换（需要地图实例）
- **步骤05**：行政区域数据管理（需要区域边界数据）

### 需要完成的前置工作
- 地图实例已创建
- 区域边界数据已准备（GeoJSON格式）
- 区域数据结构已定义

### 需要的数据/接口
- 地图实例：`google.maps.Map`类型
- 区域边界数据：GeoJSON格式（从步骤05获取）
- 区域信息：`AdministrativeRegion[]`类型

---

## 实现要点

### 核心功能点

1. **GeoJSON数据加载**
   - 使用`google.maps.Data`加载GeoJSON数据
   - 支持从文件或API加载数据
   - 处理数据加载错误

2. **Polygon图层绘制**
   - 为每个行政区域创建Polygon
   - 设置Polygon的样式（填充色、边框、透明度）
   - 根据选中状态设置不同的样式

3. **区域选择交互**
   - 点击Polygon可以切换选中区域
   - 选中区域有明显的视觉区分（边框、高亮）
   - 支持从控制面板选择区域后地图自动定位

4. **边界样式设计**
   - 未选中区域：浅灰色填充，透明边框
   - 选中区域：高亮填充，蓝色边框，加粗
   - 样式参考Google Maps的设计

### 技术实现方案

#### 1. Data Layer加载
```typescript
// 伪代码示例
const dataLayer = new google.maps.Data();

// 加载GeoJSON数据
dataLayer.loadGeoJson(regionBoundaryData, {
  idPropertyName: 'district'
});

// 设置样式
dataLayer.setStyle((feature) => {
  const district = feature.getProperty('district');
  const isSelected = selectedRegion.district === district;
  
  return {
    fillColor: isSelected ? '#E3F2FD' : '#F5F5F5',
    fillOpacity: isSelected ? 0.6 : 0.3,
    strokeColor: isSelected ? '#4285F4' : 'transparent',
    strokeWeight: isSelected ? 3 : 0,
  };
});

// 添加到地图
dataLayer.setMap(map);
```

#### 2. 区域选择交互
```typescript
// 伪代码示例
dataLayer.addListener('click', (event) => {
  const district = event.feature.getProperty('district');
  const region = findRegionByDistrict(district);
  if (region) {
    setSelectedRegion(region);
    // 可选：自动缩放到该区域
    map.fitBounds(event.feature.getGeometry().getBounds());
  }
});
```

#### 3. 动态样式更新
```typescript
// 伪代码示例
useEffect(() => {
  if (!dataLayer) return;
  
  dataLayer.forEach((feature) => {
    const district = feature.getProperty('district');
    const isSelected = selectedRegion.district === district;
    
    dataLayer.overrideStyle(feature, {
      fillColor: isSelected ? '#E3F2FD' : '#F5F5F5',
      fillOpacity: isSelected ? 0.6 : 0.3,
      strokeColor: isSelected ? '#4285F4' : 'transparent',
      strokeWeight: isSelected ? 3 : 0,
    });
  });
}, [selectedRegion]);
```

### 关键代码结构

#### 区域边界图层组件
```typescript
// 伪代码示例
function RegionBoundaryLayer({
  map,
  regions,
  selectedRegion,
  setSelectedRegion
}: BoundaryLayerProps) {
  const dataLayerRef = useRef<google.maps.Data | null>(null);

  useEffect(() => {
    if (!map) return;
    
    const dataLayer = new google.maps.Data();
    dataLayerRef.current = dataLayer;
    
    // 加载GeoJSON数据
    // 设置样式
    // 添加点击事件
    // 添加到地图
    
    return () => {
      dataLayer.setMap(null);
    };
  }, [map, regions, selectedRegion]);

  return null; // 无UI，直接操作地图
}
```

---

## 输入输出

### 输入
- **地图实例**：`google.maps.Map`类型
- **区域边界数据**：GeoJSON格式
- **区域信息**：`AdministrativeRegion[]`类型
- **选中区域**：`Region`类型

### 输出
- **区域边界图层**：显示在地图上的Polygon图层
- **图层实例**：`google.maps.Data`实例（用于后续控制）
- **区域选择事件**：通过回调函数传递

---

## 验收标准

### 功能验收标准
- [ ] 行政区域边界可以正确绘制在地图上
- [ ] 区域边界使用Polygon显示
- [ ] 点击区域可以切换选中区域
- [ ] 选中区域有明显的视觉区分
- [ ] 边界数据可以正确加载和渲染
- [ ] 从控制面板选择区域后，地图自动定位到该区域

### 视觉验收标准
- [ ] 未选中区域样式清晰，不遮挡地图
- [ ] 选中区域样式明显，易于识别
- [ ] 边界样式符合Google Maps设计风格
- [ ] 区域标签（如果需要）清晰可读

### 性能验收标准
- [ ] 边界数据加载时间在2秒内
- [ ] 区域选择响应时间在100ms内
- [ ] 样式更新流畅，无明显卡顿

---

## 注意事项

### 常见问题
1. **GeoJSON数据格式错误**
   - 确保GeoJSON格式正确
   - 确保坐标系统正确（WGS84）

2. **边界数据加载失败**
   - 处理网络错误
   - 处理数据格式错误
   - 提供错误提示

3. **区域选择不响应**
   - 确保点击事件正确绑定
   - 确保区域ID匹配正确

### 技术难点
- **GeoJSON数据处理**：需要正确处理GeoJSON格式的数据
- **区域匹配**：需要正确匹配区域ID和区域信息
- **性能优化**：大量区域的渲染需要优化

### 扩展性考虑
- 边界图层实现可以提取为独立组件，便于复用
- 样式配置可以提取为常量，便于调整
- 支持未来添加更多区域数据

---

## 下一步

### 后续步骤的准备工作
- 区域边界已绘制，可以在步骤12中添加热力图图层
- 区域选择功能已实现，可以在步骤15中使用

### 数据/接口的传递
- 区域选择事件通过回调函数传递给Dashboard组件
- 选中区域通过props传递给其他组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
