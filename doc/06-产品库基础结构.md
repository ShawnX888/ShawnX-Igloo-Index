# 06-产品库基础结构

## 步骤概述

### 步骤编号和名称
**步骤06**：产品库基础结构

### 步骤目标
定义保险产品库的数据模型和接口规范，创建产品配置文件结构，为产品库完整实现和风险计算引擎提供基础架构。

### 预期成果
- 产品数据模型已定义（TypeScript接口）
- 产品配置文件结构已创建
- 产品查询接口已定义
- 为后续步骤提供统一的产品数据格式

---

## 前置条件

### 依赖的步骤
- 无（产品库基础结构相对独立）

### 需要完成的前置工作
- 了解产品需求（三种产品类型：降雨量日内产品、降雨量周度产品、降雨量月度产品）
- 了解产品级规则的定义方式

### 需要的数据/接口
- 产品基本信息：ID、名称、描述、图标
- 产品级规则：触发条件、阈值配置、风险级别定义

---

## 实现要点

### 核心功能点

1. **产品数据模型定义**
   - 定义`Product`接口（产品基本信息）
   - 定义`RiskRule`接口（风险事件触发规则）
   - 定义`Threshold`接口（阈值配置）
   - 定义产品类型枚举（daily/weekly/monthly）

2. **产品配置文件结构**
   - 创建产品配置文件（JSON格式）
   - 定义产品定义的存储方式
   - 支持产品版本管理（如果需要）

3. **产品查询接口**
   - 定义产品查询函数
   - 支持按ID查询产品
   - 支持按类型查询产品列表
   - 支持获取所有产品

4. **产品注册机制**
   - 定义产品注册接口
   - 支持动态添加产品（未来扩展）
   - 支持产品定义验证

### 技术实现方案

#### 1. 产品数据模型
```typescript
// 伪代码示例
interface Product {
  id: string;
  name: string;
  type: 'daily' | 'weekly' | 'monthly'; // 时间维度
  weatherType: WeatherType; // 数据维度：'rainfall' | 'temperature' | 'wind' | ...
  description: string;
  icon: string;
  riskRules: RiskRule;
}

interface RiskRule {
  triggerType: 'daily' | 'weekly' | 'monthly'; // 时间维度
  weatherType: WeatherType; // 数据维度，必须与 Product.weatherType 一致
  timeWindow: TimeWindowConfig;
  thresholds: Threshold[];
  calculation: CalculationConfig;
}

interface Threshold {
  value: number;
  level: 'low' | 'medium' | 'high';
  label: string;
}

interface TimeWindowConfig {
  type: 'sliding' | 'fixed';
  duration: number; // 小时数或天数
  unit: 'hour' | 'day';
}

interface CalculationConfig {
  aggregation: 'sum' | 'avg' | 'max' | 'min';
  operator: '>' | '<' | '>=' | '<=';
  unit: 'mm' | 'inch' | 'celsius' | 'fahrenheit' | 'kmh' | 'mph' | 'percent' | 'hpa' | 'psi';
}
```

#### 2. 产品配置文件结构
```json
// 伪代码示例
{
  "products": [
    {
      "id": "daily",
      "name": "日内产品",
      "type": "daily",
      "description": "...",
      "icon": "...",
      "weatherType": "rainfall",
      "riskRules": {
        "triggerType": "daily",
        "weatherType": "rainfall",
        "timeWindow": {
          "type": "sliding",
          "duration": 4,
          "unit": "hour"
        },
        "thresholds": [
          { "value": 100, "level": "low", "label": "100mm" },
          { "value": 120, "level": "medium", "label": "120mm" },
          { "value": 140, "level": "high", "label": "140mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": ">",
          "unit": "mm"
        }
      }
    }
  ]
}
```

#### 3. 产品查询接口
```typescript
// 伪代码示例
class ProductLibrary {
  getProduct(id: string): Product | null;
  getProductsByType(type: ProductType): Product[];
  getProductsByWeatherType(weatherType: WeatherType): Product[];
  getProductsByTypeAndWeather(type: ProductType, weatherType: WeatherType): Product[];
  getAllProducts(): Product[];
  getSupportedWeatherTypes(): WeatherType[];
  registerProduct(product: Product): void;
}
```

### 关键代码结构

#### 产品库模块
```typescript
// 伪代码示例
// lib/productLibrary.ts
export interface Product { ... }
export interface RiskRule { ... }

export class ProductLibrary {
  private products: Map<string, Product>;
  
  constructor() {
    // 加载产品配置
  }
  
  getProduct(id: string): Product | null { ... }
  getProductsByType(type: string): Product[] { ... }
}
```

---

## 输入输出

### 输入
- **产品配置文件**：JSON格式的产品定义
- **产品ID**：用于查询特定产品
- **产品类型**：用于查询特定类型的产品

### 输出
- **产品对象**：`Product`类型，包含完整的产品定义
- **产品列表**：`Product[]`类型，包含多个产品
- **产品查询接口**：提供统一的产品访问方式

---

## 验收标准

### 功能验收标准
- [ ] 产品数据模型定义完整，包含所有必要字段
- [ ] 产品配置文件结构清晰，易于维护
- [ ] 产品查询接口正常工作，可以按ID和类型查询
- [ ] 产品定义验证机制正常工作（如果实现）
- [ ] 产品数据结构与需求文档一致

### 数据质量验收标准
- [ ] 产品数据格式统一，符合接口定义
- [ ] 产品配置包含所有必要信息
- [ ] 产品类型定义正确（daily/weekly/monthly）

### 扩展性验收标准
- [ ] 支持未来添加新产品类型
- [ ] 支持未来扩展产品定义字段
- [ ] 产品查询接口易于扩展

---

## 注意事项

### 常见问题
1. **产品数据模型不完整**
   - 确保包含所有需求文档中提到的字段
   - 预留扩展字段，便于未来添加

2. **产品配置文件格式错误**
   - 使用TypeScript类型定义确保格式正确
   - 提供配置文件验证机制

3. **产品查询性能问题**
   - 使用Map或索引优化查询性能
   - 考虑缓存产品数据

### 技术难点
- **产品数据模型设计**：需要平衡完整性和灵活性
- **产品配置验证**：确保产品定义的正确性
- **产品类型扩展**：支持未来添加新的产品类型

### 扩展性考虑

#### 1. 多天气类型产品支持
- **设计目标**：支持基于不同天气类型（降雨量、温度、风速、湿度、气压、降雪等）的保险产品
- **实现方式**：
  - `Product` 接口新增 `weatherType: WeatherType` 字段，标识产品基于的天气类型
  - `RiskRule` 接口新增 `weatherType: WeatherType` 字段，确保风险规则与天气类型一致
  - `CalculationConfig` 的 `unit` 字段扩展支持多种单位：
    - 降雨量/降雪：`'mm' | 'inch'`
    - 温度：`'celsius' | 'fahrenheit'`
    - 风速：`'kmh' | 'mph'`
    - 湿度：`'percent'`
    - 气压：`'hpa' | 'psi'`

#### 2. 产品类型维度
- **时间维度**：`ProductType`（'daily' | 'weekly' | 'monthly'）- 产品的时间触发周期
- **数据维度**：`WeatherType`（'rainfall' | 'temperature' | 'wind' | ...）- 产品基于的天气数据类型
- **组合支持**：同一时间维度可以支持多种天气类型的产品（如：日内降雨量产品、日内温度产品）

#### 3. 产品数据模型扩展
- **向后兼容**：保留现有产品定义，通过添加 `weatherType` 字段扩展
- **类型安全**：使用 TypeScript 类型系统确保 `weatherType` 与 `RiskRule.weatherType` 一致
- **配置验证**：产品库加载时验证 `weatherType` 字段的有效性

#### 4. 产品查询扩展
- 支持按 `weatherType` 查询产品：`getProductsByWeatherType(weatherType: WeatherType)`
- 支持按 `type` 和 `weatherType` 组合查询：`getProductsByTypeAndWeather(type: ProductType, weatherType: WeatherType)`
- 支持获取所有支持的天气类型：`getSupportedWeatherTypes()`

#### 5. 未来扩展方向
- 产品数据模型可以扩展，支持未来添加新字段
- 产品查询接口可以扩展，支持更复杂的查询
- 支持产品版本管理（如果需要）
- 支持多天气类型组合产品（如：降雨量+温度组合触发）
- 支持自定义天气类型和单位

---

## 下一步

### 后续步骤的准备工作
- 产品数据模型已定义，可以在步骤08中实现具体产品配置
- 产品查询接口已定义，可以在步骤07中使用

### 数据/接口的传递
- 产品数据通过`Product`类型传递给风险计算引擎
- 产品查询接口通过`ProductLibrary`类提供给其他模块

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
