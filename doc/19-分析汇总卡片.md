# 19-分析汇总卡片

## 步骤概述

### 步骤编号和名称
**步骤19**：分析汇总卡片

### 步骤目标
实现分析汇总卡片，以卡片形式展示量化指标，包括时间窗口、平均降雨量、总降雨量、风险事件数量、风险严重程度等，根据产品类型动态调整显示内容。

### 预期成果
- 分析汇总卡片可以正常显示
- 时间窗口显示正确（天数 + 小时）
- 平均降雨量统计正确（按产品类型显示hourly或daily）
- 总降雨量统计正确
- 风险事件数量统计正确（仅在选中产品时显示）
- 风险严重程度显示正确（仅在选中产品时显示）

---

## 前置条件

### 依赖的步骤
- **步骤18**：数据面板基础结构（需要数据获取逻辑）

### 需要完成的前置工作
- 数据面板基础结构已实现
- 统计数据计算逻辑已实现

### 需要的数据/接口
- 统计数据：`Statistics`类型（从数据面板获取）
- 降雨量数据：`RainfallData[]`类型
- 风险事件数据：`RiskEvent[]`类型
- 选中产品：`Product | null`类型

---

## 实现要点

### 核心功能点

1. **时间窗口显示**
   - 显示时间窗口的天数和小时数
   - 格式：`X天 Y小时`
   - 根据起止日期和时刻计算

2. **平均降雨量统计**
   - 根据产品类型显示不同的统计方式：
     - 日内产品：显示avg. hourly rainfall
     - 周度或月度产品：显示avg. daily rainfall
   - 计算逻辑：总降雨量 / 时间窗口内的数据点数

3. **总降雨量统计**
   - 显示时间窗口内的总降雨量
   - 单位：mm
   - 计算逻辑：所有数据点的降雨量累计

4. **风险事件数量统计**
   - 仅在指定了保险产品后显示
   - 显示时间窗口内的风险事件总数
   - 可以按级别分类显示（low/medium/high）

5. **风险严重程度**
   - 仅在指定了保险产品后显示
   - 根据风险事件数量和级别计算
   - 显示为文本或颜色标识

### 技术实现方案

#### 1. 统计数据计算
```typescript
// 伪代码示例
interface Statistics {
  timeWindow: {
    days: number;
    hours: number;
  };
  avgRainfall: {
    hourly?: number;
    daily?: number;
  };
  totalRainfall: number;
  riskEvents: {
    total: number;
    byLevel: {
      low: number;
      medium: number;
      high: number;
    };
  };
  riskSeverity: 'low' | 'medium' | 'high' | 'none';
}

function calculateStatistics(
  rainfallData: RainfallData[],
  riskEvents: RiskEvent[],
  selectedProduct: Product | null
): Statistics {
  // 计算时间窗口
  const timeWindow = calculateTimeWindow(dateRange);
  
  // 计算平均降雨量
  const avgRainfall = calculateAvgRainfall(
    rainfallData,
    selectedProduct
  );
  
  // 计算总降雨量
  const totalRainfall = calculateTotalRainfall(rainfallData);
  
  // 计算风险事件统计
  const riskEventsStats = calculateRiskEventsStats(riskEvents);
  
  // 计算风险严重程度
  const riskSeverity = calculateRiskSeverity(riskEvents);
  
  return {
    timeWindow,
    avgRainfall,
    totalRainfall,
    riskEvents: riskEventsStats,
    riskSeverity
  };
}
```

#### 2. 分析汇总卡片组件
```typescript
// 伪代码示例
function AnalysisSummary({
  statistics,
  selectedProduct
}: AnalysisSummaryProps) {
  return (
    <div className="analysis-summary grid grid-cols-2 md:grid-cols-4 gap-4">
      {/* 时间窗口卡片 */}
      <SummaryCard
        title="Time Window"
        value={`${statistics.timeWindow.days}天 ${statistics.timeWindow.hours}小时`}
        icon={<Clock />}
      />
      
      {/* 平均降雨量卡片 */}
      <SummaryCard
        title={selectedProduct?.type === 'daily' ? 'Avg. Hourly Rainfall' : 'Avg. Daily Rainfall'}
        value={`${selectedProduct?.type === 'daily' 
          ? statistics.avgRainfall.hourly 
          : statistics.avgRainfall.daily} mm`}
        icon={<CloudRain />}
      />
      
      {/* 总降雨量卡片 */}
      <SummaryCard
        title="Total Rainfall"
        value={`${statistics.totalRainfall} mm`}
        icon={<Droplet />}
      />
      
      {/* 风险事件数量卡片（仅在选中产品时显示） */}
      {selectedProduct && (
        <SummaryCard
          title="Risk Events"
          value={statistics.riskEvents.total.toString()}
          icon={<AlertTriangle />}
          severity={statistics.riskSeverity}
        />
      )}
    </div>
  );
}
```

#### 3. 汇总卡片组件
```typescript
// 伪代码示例
function SummaryCard({
  title,
  value,
  icon,
  severity
}: SummaryCardProps) {
  return (
    <div className={cn(
      "summary-card",
      severity && `severity-${severity}`
    )}>
      <div className="card-icon">{icon}</div>
      <div className="card-content">
        <div className="card-title">{title}</div>
        <div className="card-value">{value}</div>
      </div>
    </div>
  );
}
```

### 关键代码结构

#### 分析汇总组件
```typescript
// 伪代码示例
export function AnalysisSummary({
  statistics,
  selectedProduct
}: AnalysisSummaryProps) {
  // 统计数据展示
  // 卡片布局
  // 条件渲染（根据产品类型）
}
```

---

## 输入输出

### 输入
- **统计数据**：`Statistics`类型
- **选中产品**：`Product | null`类型
- **时间范围**：`DateRange`类型

### 输出
- **分析汇总卡片**：显示在地图面板上的卡片组件
- **统计数据展示**：格式化的统计数据

---

## 验收标准

### 功能验收标准
- [ ] 分析汇总卡片可以正常显示
- [ ] 时间窗口显示正确（天数 + 小时）
- [ ] 平均降雨量统计正确（按产品类型显示hourly或daily）
- [ ] 总降雨量统计正确
- [ ] 风险事件数量统计正确（仅在选中产品时显示）
- [ ] 风险严重程度显示正确（仅在选中产品时显示）

### 数据质量验收标准
- [ ] 统计数据计算准确，符合业务逻辑
- [ ] 数据格式统一，易于理解
- [ ] 单位显示正确（mm、天、小时）

### 视觉验收标准
- [ ] 卡片布局清晰，信息层次分明
- [ ] 图标和数值清晰可读
- [ ] 风险严重程度有清晰的视觉区分（颜色、样式）

---

## 注意事项

### 常见问题
1. **统计数据计算不准确**
   - 确保计算逻辑正确
   - 确保数据格式正确
   - 验证计算结果

2. **产品类型判断错误**
   - 确保产品类型正确传递
   - 确保条件判断逻辑正确

3. **时间窗口计算错误**
   - 确保日期和时刻计算正确
   - 处理时区问题（如果需要）

### 技术难点
- **统计数据计算**：需要正确计算各种统计指标
- **条件渲染**：需要根据产品类型动态调整显示内容
- **数据格式化**：需要将数值格式化为易读的格式

### 扩展性考虑
- 分析汇总卡片可以扩展，支持更多统计指标
- 卡片样式可以配置化，便于调整
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 分析汇总卡片已实现，数据面板的基础功能基本完成
- 统计数据已计算，可以在步骤20中使用进行图表可视化

### 数据/接口的传递
- 统计数据通过props传递给分析汇总组件
- 格式化数据可以在图表组件中复用

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
