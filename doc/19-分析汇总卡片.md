# 19-分析汇总卡片

## 步骤概述

### 步骤编号和名称
**步骤19**：分析汇总卡片

### 步骤目标
实现分析汇总卡片，以卡片形式展示量化指标，包括时间窗口、平均天气数值、总天气数值、风险事件数量、风险严重程度等，根据产品类型动态调整显示内容。

### 预期成果
- 分析汇总卡片可以正常显示
- 时间窗口显示正确（天数 + 小时）
- 平均天气数值统计正确（按产品类型显示hourly或daily）
- 总天气数值统计正确
- 风险事件数量统计正确（仅在选中产品时显示）
- 风险严重程度显示正确（仅在选中产品时显示）

---

## 前置条件

### 依赖的步骤
- **步骤18**：数据面板基础结构（需要数据获取逻辑）

### 需要完成的前置工作
- 数据面板基础结构已实现
- 统计数据计算逻辑已实现

### 需要的数据/接口
- 统计数据：`Statistics`类型（从数据面板获取）
- 天气数据：`WeatherData[]`类型
- 风险事件数据：`RiskEvent[]`类型
- 选中产品：`Product | null`类型

---

## 实现要点

### 核心功能点

1. **时间窗口显示**
   - 显示时间窗口的天数和小时数
   - 格式：`X天 Y小时`
   - 根据起止日期和时刻计算

2. **平均天气数值统计**
   - 根据产品类型显示不同的统计方式：
     - 日内产品：显示avg. hourly value
     - 周度或月度产品：显示avg. daily value
   - 计算逻辑：总数值 / 时间窗口内的数据点数

3. **总天气数值统计**
   - 显示时间窗口内的总数值
   - 计算逻辑：所有数据点的数值累计

4. **风险事件数量统计**
   - 仅在指定了保险产品后显示
   - 显示时间窗口内的风险事件总数
   - 可以按级别分类显示（tier 1, tier 2, tier 3）

5. **风险严重程度**
   - 仅在指定了保险产品后显示
   - 根据风险事件的最高级别计算：
     - 若没有风险事件，为无 "-"
     - 若最高级别的风险事件为 tier 1，为低
     - 若最高级别的风险事件为 tier 2，为中
     - 若最高级别的风险事件为 tier 3，为高
   - 显示为文本或颜色标识

### 技术实现方案

有关中心化风险计算及分级统计的详细方案，请参阅：[风险计算架构升级方案](./补充-风险计算架构升级方案.md)

#### 1. 统计数据聚合
统计数据由 `useRiskAnalysis` Hook 统一产出并传递。组件内部不再负责 `calculateStatistics`，而是直接渲染传入的 `statistics` 对象。

```typescript
// statistics 对象由中心化 Hook 预先计算，包含分级统计信息
interface Statistics {
  timeWindow: { days: number; hours: number; };
  avgValue: { hourly?: number; daily?: number; };
  totalValue: number;
  riskEvents: {
    total: number;
    byLevel: { tier1: number; tier2: number; tier3: number; }; // 分级统计
  };
  riskSeverity: 'low' | 'medium' | 'high' | 'none' | '-';
}
```

#### 2. 分析汇总卡片组件
```typescript
// 伪代码示例
function AnalysisSummary({
  statistics,
  selectedProduct
}: AnalysisSummaryProps) {
  return (
    <div className="analysis-summary grid grid-cols-2 md:grid-cols-4 gap-4">
      {/* 时间窗口卡片 */}
      <SummaryCard
        title="Time Window"
        value={`${statistics.timeWindow.days}天 ${statistics.timeWindow.hours}小时`}
        icon={<Clock />}
      />
      
      {/* 平均天气数值卡片 */}
      <SummaryCard
        title={selectedProduct?.type === 'daily' ? 'Avg. Hourly Value' : 'Avg. Daily Value'}
        value={`${selectedProduct?.type === 'daily' 
          ? statistics.avgValue.hourly 
          : statistics.avgValue.daily} units`}
        icon={<Thermometer />}
      />
      
      {/* 总天气数值卡片 */}
      <SummaryCard
        title="Total Value"
        value={`${statistics.totalValue} units`}
        icon={<Activity />}
      />
      
      {/* 风险事件数量卡片（仅在选中产品时显示） */}
      {selectedProduct && (
        <SummaryCard
          title="Risk Events"
          value={statistics.riskEvents.total.toString()}
          icon={<AlertTriangle />}
          severity={statistics.riskSeverity}
        />
      )}
    </div>
  );
}
```

#### 3. 汇总卡片组件
```typescript
// 伪代码示例
function SummaryCard({
  title,
  value,
  icon,
  severity
}: SummaryCardProps) {
  return (
    <div className={cn(
      "summary-card",
      severity && `severity-${severity}`
    )}>
      <div className="card-icon">{icon}</div>
      <div className="card-content">
        <div className="card-title">{title}</div>
        <div className="card-value">{value}</div>
      </div>
    </div>
  );
}
```

### 关键代码结构

#### 分析汇总组件
```typescript
// 伪代码示例
export function AnalysisSummary({
  statistics,
  selectedProduct
}: AnalysisSummaryProps) {
  // 统计数据展示
  // 卡片布局
  // 条件渲染（根据产品类型）
}
```

---

## 输入输出

### 输入
- **核心输入 (来自中心化 Hook)**：`statistics`: `RiskStatistics` 类型
- **当前产品**：`selectedProduct`: `InsuranceProduct | null` 类型
- **辅助参数**：`dateRange` (用于校验或二次格式化)

### 输出
- **量化指标卡片**：包含时间窗口、均值/总量、风险事件数、严重程度的视觉卡片

---

## 验收标准

### 功能验收标准
- [ ] 分析汇总卡片可以正常显示
- [ ] 时间窗口显示正确（天数 + 小时）
- [ ] 平均天气数值统计正确（按产品类型显示hourly或daily）
- [ ] 总天气数值统计正确
- [ ] 风险事件数量统计正确（仅在选中产品时显示）
- [ ] 风险严重程度显示正确（仅在选中产品时显示）

### 数据质量验收标准
- [ ] 统计数据计算准确，符合业务逻辑
- [ ] 数据格式统一，易于理解
- [ ] 单位显示正确（units、天、小时）

### 视觉验收标准
- [ ] 卡片布局清晰，信息层次分明
- [ ] 图标和数值清晰可读
- [ ] 风险严重程度有清晰的视觉区分（颜色、样式）

---

## 注意事项

### 常见问题
1. **统计数据计算不准确**
   - 确保计算逻辑正确
   - 确保数据格式正确
   - 验证计算结果

2. **产品类型判断错误**
   - 确保产品类型正确传递
   - 确保条件判断逻辑正确

3. **时间窗口计算错误**
   - 确保日期和时刻计算正确
   - 处理时区问题（如果需要）

### 技术难点
- **统计数据计算**：需要正确计算各种统计指标
- **条件渲染**：需要根据产品类型动态调整显示内容
- **数据格式化**：需要将数值格式化为易读的格式

### 扩展性考虑
- 分析汇总卡片可以扩展，支持更多统计指标
- 卡片样式可以配置化，便于调整
- 支持未来添加更多数据可视化方式

---

## 下一步

### 后续步骤的准备工作
- 分析汇总卡片已实现，数据面板的基础功能基本完成
- 统计数据已计算，可以在步骤20中使用进行图表可视化

### 数据/接口的传递
- 统计数据通过props传递给分析汇总组件
- 格式化数据可以在图表组件中复用

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
