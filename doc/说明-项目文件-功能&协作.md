# 项目文件功能与协作说明

## 文档概述

本文档详细说明项目中各层文件的作用、设计理念以及它们之间的协作关系，帮助开发者理解项目的整体架构和工作原理。

**文档版本**：v1.1  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27  
**适用范围**：项目架构理解、新成员 onboarding、代码维护

---

## 目录

1. [项目文件结构说明](#一项目文件结构说明)
2. [各层之间的协作关系](#二各层之间的协作关系)

---

## 一、项目文件结构说明

### 1.1 入口与配置层

#### 作用
- 应用入口：初始化 React 应用，挂载根组件
- 路由管理：管理页面切换（首页/产品介绍页）
- 全局配置：管理环境变量、构建配置、样式入口
- 缓存管理：应用启动时清理缓存，提供调试工具

#### 设计优势
- **单一入口**：`main.tsx` 作为唯一入口，便于控制应用初始化流程
- **集中管理**：`App.tsx` 统一管理路由和全局状态，保持一致性
- **环境隔离**：通过 `.env` 文件管理敏感信息，不提交到仓库

#### 文件说明

**应用入口**
- **`main.tsx`** - React 应用入口，挂载根组件
- **`App.tsx`** - 根组件，管理页面路由（首页/产品介绍页）和全局缓存清理
- **`vite.config.ts`** - Vite 构建配置
- **`package.json`** - 依赖和脚本配置

**样式与配置**
- **`index.css`** - 全局样式入口
- **`styles/globals.css`** - 全局样式定义
- **`.env`** - 环境变量（Google Maps API Key 等，不提交到仓库）

---

### 1.2 核心业务组件层 (`components/`)

#### 作用
- UI 渲染：负责用户界面的展示和交互
- 状态管理：`Dashboard.tsx` 作为中心化状态管理器，统一管理所有业务状态
- 用户交互：处理用户操作（区域选择、产品选择、时间范围选择等）
- 数据展示：将计算后的数据以图表、卡片、时间线等形式展示给用户

#### 设计优势
- **中心化状态管理**：`Dashboard.tsx` 统一持有所有计算状态，确保数据一致性
- **组件职责单一**：每个组件专注于特定功能（地图、控制面板、数据展示等）
- **单向数据流**：数据从 Dashboard 向下分发，避免数据混乱
- **可复用性**：UI 基础组件库提供一致的组件，减少重复代码

#### 文件说明

**首页组件 (`components/home/`)**
- **`Dashboard.tsx`** - 中心化状态管理，协调各子组件
  - 管理：区域选择、时间范围、产品选择、数据类型
  - 调用中心化 Hooks 获取数据
  - 向下分发数据给子组件

- **`MapWorkspace.tsx`** - Google Maps 地图工作区
  - 渲染地图容器
  - 管理图层（边界、热力图、风险标记）
  - 处理地图交互（点击区域切换）

- **`ControlPanel.tsx`** - 手动选择面板
  - 区域选择器（国家/省/市）
  - 数据类型切换（历史/预测）
  - 时间范围选择器
  - GPS 定位按钮

- **`ContextualAssistant.tsx`** - AI 对话面板
  - 集成 Google Contextual View AI kit
  - 自然语言交互，解析用户意图并更新参数

- **`ProductSelector.tsx`** - 产品选择器
  - 展示可选保险产品
  - 产品选择与切换

- **`DataDashboard.tsx`** - 数据面板
  - 分析汇总卡片（时间窗口、均值、总量、风险统计）
  - 图表可视化（天气趋势、风险叠加示意图）
  - 风险事件时间线

- **`types.ts`** - 首页组件共享类型定义

**产品介绍页 (`components/product/`)**
- **`ProductIntro.tsx`** - 产品介绍页，展示产品详情和教育内容

**布局组件 (`components/layout/`)**
- **`Header.tsx`** - 顶部导航栏，页面切换

**UI 基础组件 (`components/ui/`)**
- 基于 shadcn/ui 的组件库（按钮、卡片、对话框、表格等）
- 提供一致的 UI 风格

---

### 1.3 数据层 (`data/`)

#### 作用
- 静态数据存储：存储产品配置、区域数据等静态资源
- 数据源管理：管理 GADM 和 Google 双数据源，提供区域数据查询
- 配置管理：产品配置集中管理，便于维护和扩展

#### 设计优势
- **双数据源设计**：GADM 数据用于 GIS 准确性，Google 名称用于 UI 友好性
- **集中配置**：产品配置集中管理，新增产品只需修改配置文件
- **数据分离**：静态数据与业务逻辑分离，便于数据更新和维护

#### 文件说明

**区域数据 (`data/gadm/` 和 `data/google/`)**
- **`gadm/`** - GADM 行政区域数据（GeoJSON）
  - `*_regions.json` - 区域边界数据
  - `*_hierarchy.json` - 区域层级关系
  - `*_centers.json` - 区域中心点坐标
  - `*_index.json` - 区域索引

- **`google/`** - Google 官方区域名称数据
  - `*_google_hierarchy.json` - Google 层级结构
  - `*_mapping.json` - GADM 与 Google 名称映射表

- **`regions.ts`** - 区域数据加载和查询工具

**产品配置 (`data/products.ts`)**
- 产品库配置文件
- 定义三种产品：Daily Heavy Rain、Weekly Accumulation Rainfall、Drought Defense
- 包含 `riskRules`（风险触发条件）和 `payoutRules`（赔付原则，仅展示）

---

### 1.4 类型定义层 (`types/`)

#### 作用
- 类型系统：定义项目中所有数据结构、接口和类型别名
- 类型安全：提供编译时类型检查，减少运行时错误
- 代码文档：类型定义即文档，清晰表达数据结构

#### 设计优势
- **类型安全**：编译时检查，减少运行时错误
- **代码提示**：IDE 自动补全和类型提示，提升开发效率
- **文档作用**：类型定义即文档，无需额外维护文档
- **重构友好**：类型变更时自动发现影响范围，降低重构风险
- **独立层**：不依赖其他层，可被所有层使用

#### 文件说明

- **`common.ts`** - 通用类型（时间范围、坐标等）
- **`region.ts`** - 区域相关类型（国家、省、市）
- **`data.ts`** - 数据相关类型（天气数据、统计数据）
- **`product.ts`** - 产品相关类型（产品配置、风险规则）
- **`risk.ts`** - 风险相关类型（风险事件、风险级别）
- **`map.ts`** - 地图相关类型（图层、标记）
- **`index.ts`** - 类型导出入口

---

### 1.5 业务逻辑层 (`lib/`)

#### 作用
- 核心算法：实现数据生成、风险计算等核心业务逻辑
- 业务规则：实现产品规则解析、风险事件计算等业务规则
- 服务封装：封装数据生成器、产品库、计算引擎等服务
- 工具函数：提供通用工具函数和数据适配器

#### 设计优势
- **职责分离**：数据生成、产品管理、风险计算等职责分离，便于维护
- **接口实现**：实现 `interfaces/` 定义的接口，支持依赖注入和测试
- **可扩展性**：新增产品类型或计算规则无需修改核心逻辑
- **缓存机制**：内置缓存机制，提升性能

#### 文件说明

**数据生成器**
- **`weatherDataGenerator.ts`** - 通用天气数据生成器（Mock）
  - 根据区域、时间范围生成小时级/日级数据
  - 支持多种天气类型（降雨量、温度等）
  - 带缓存机制

- **`rainfallDataGenerator.ts`** - 降雨量数据生成器（已整合到通用生成器）
- **`mockData.ts`** - Mock 数据初始化和工具函数

**产品与风险计算**
- **`productLibrary.ts`** - 产品库管理器
  - 加载产品配置
  - 产品查询接口
  - 产品规则解析

- **`riskCalculationEngine.ts`** - 风险计算引擎
  - 解析产品风险规则
  - 计算风险事件（基于时间窗口和阈值）
  - 生成风险级别（tier1/tier2/tier3）

- **`riskCalculationService.ts`** - 风险计算服务
  - 协调产品库和计算引擎
  - 数据聚合（全域统计、选中城市统计）
  - 错误处理

**区域与地图服务**
- **`gadmDataLoader.ts`** - GADM 数据加载器
  - 加载 GeoJSON 数据
  - 区域查询和过滤

- **`regionData.ts`** - 区域数据管理工具
- **`googleMaps.ts`** - Google Maps 初始化与工具函数
- **`geocoding.ts`** - 地理编码服务（地址 ↔ 坐标）
- **`gpsLocation.ts`** - GPS 定位服务

**工具函数**
- **`utils.ts`** - 通用工具函数（类名合并、格式化等）
- **`dataAdapters.ts`** - 数据格式转换适配器
- **`weatherStatistics.ts`** - 天气统计计算工具

---

### 1.6 Hooks 层 (`hooks/`)

#### 作用
- 数据获取封装：封装数据获取逻辑，统一管理缓存
- 计算逻辑封装：将复杂计算封装为可复用的 Hook
- 响应式更新：通过 `useMemo` 实现响应式计算和缓存
- 唯一事实来源：确保数据计算的一致性，避免重复计算

#### 设计优势
- **唯一事实来源**：`useRiskAnalysis` 是风险计算的唯一入口，避免多处重复计算
- **响应式更新**：使用 `useMemo` 自动响应依赖变化，依赖未变化时复用缓存结果
- **职责分离**：天气统计与风险计算解耦，各 Hook 职责单一
- **可扩展性**：新增产品类型无需修改 Hook，通过产品配置动态适配
- **性能优化**：多层缓存（Hook 层 `useMemo` + 业务逻辑层缓存），避免不必要的重复计算

#### 文件说明

**数据获取 Hooks**
- **`useWeatherData.ts`** - 天气数据获取 Hook
  - 输入：区域、时间范围、数据类型、天气类型
  - 输出：小时级/日级天气数据（带缓存）
  - 自动处理数据生成和缓存

- **`useExtendedWeatherDataForOverlayChart.ts`** - 扩展数据获取 Hook
  - 为风险叠加示意图获取扩展时间范围数据
  - 根据产品 `riskRules.timeWindow` 动态计算扩展范围
  - 确保图表起始位置能正确回溯计算

**分析计算 Hooks**
- **`useRiskAnalysis.ts`** - 中心化风险分析 Hook（唯一事实来源）
  - 输入：区域、时间范围、产品、天气数据
  - 输出：风险事件列表、地图标记数据、统计信息
  - 自动触发计算，带缓存机制

- **`useWeatherStatistics.ts`** - 天气统计 Hook
  - 计算时间窗口、均值、总量、最值等基础统计
  - 与风险计算解耦

**地图图层 Hooks**
- **`useRegionBoundaryLayer.ts`** - 行政区域边界图层
- **`useRainfallHeatmapLayer.ts`** - 降雨量热力图图层
- **`useRiskEventMarkersLayer.ts`** - 风险事件标记图层
- **`useRegionData.ts`** - 区域数据获取 Hook
- **`useRainfallData.ts`** - 降雨量数据获取 Hook（可能已废弃）

---

### 1.7 接口定义层 (`interfaces/`)

#### 作用
- 接口契约：定义业务逻辑的接口（契约），明确服务职责
- 依赖注入：解耦实现与接口，支持依赖注入
- 可测试性：便于 Mock 接口进行单元测试
- 可扩展性：支持多种实现（如不同数据源）

#### 设计优势
- **解耦**：实现与接口分离，便于替换实现
- **可测试**：易于 Mock 接口进行单元测试
- **可扩展**：支持多种实现（如不同数据源）
- **契约明确**：接口即契约，职责清晰

#### 文件说明

- **`dataGenerator.ts`** - 数据生成器接口
- **`productLibrary.ts`** - 产品库接口
- **`riskCalculation.ts`** - 风险计算接口
- **`riskCalculationService.ts`** - 风险计算服务接口
- **`mapService.ts`** - 地图服务接口
- **`index.ts`** - 接口导出入口

---

### 1.8 样式定义层 (`styles/`)

#### 作用
- 全局样式：定义全局样式、基础样式、重置样式
- 主题配置：通过 CSS 变量实现主题切换（亮色/暗色模式）
- 设计系统：统一的设计规范，保持视觉一致性

#### 设计优势
- **主题统一**：CSS 变量实现主题切换，支持运行时切换
- **设计系统**：统一的设计规范，保持视觉一致性
- **维护性**：集中管理样式，易于修改和维护
- **性能**：CSS 变量支持运行时主题切换，无需重新加载

#### 文件说明

- **`globals.css`** - 全局样式和 CSS 变量
  - 定义 CSS 变量（颜色、间距、字体等）
  - 支持亮色/暗色模式
  - 基础样式和重置样式

---

## 二、各层之间的协作关系

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    组件层 (Components)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Dashboard   │  │ MapWorkspace │  │ DataDashboard│      │
│  │ (状态管理)    │  │  (地图渲染)   │  │  (数据展示)   │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼──────────────────┼──────────────────┼──────────┘
          │                    │                    │
          │ 调用 Hooks         │ 接收数据            │ 接收数据
          ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                      Hook 层 (Hooks)                          │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ useWeatherData   │  │ useRiskAnalysis │                  │
│  │ (数据获取)       │  │ (风险计算)       │                  │
│  └────────┬─────────┘  └────────┬─────────┘                  │
│           │                      │                             │
│           │                      │ 调用                        │
│           ▼                      ▼                             │
│  ┌─────────────────────────────────────────┐                 │
│  │ useWeatherStatistics (天气统计)          │                 │
│  └─────────────────────────────────────────┘                 │
└─────────┼─────────────────────────────────────────────────────┘
          │
          │ 调用业务逻辑层
          ▼
┌─────────────────────────────────────────────────────────────┐
│                  业务逻辑层 (lib/)                            │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ weatherDataGen   │  │ riskCalcService  │                  │
│  │ (数据生成器)     │  │ (风险计算服务)    │                  │
│  └────────┬────────┘  └────────┬─────────┘                  │
│           │                     │                             │
│           │                     │ 调用                        │
│           │                     ▼                             │
│           │            ┌──────────────────┐                  │
│           │            │ riskCalcEngine   │                  │
│           │            │ (风险计算引擎)    │                  │
│           │            └────────┬─────────┘                  │
│           │                     │                             │
│           │                     │ 调用                        │
│           │                     ▼                             │
│           │            ┌──────────────────┐                  │
│           │            │ productLibrary   │                  │
│           │            │ (产品库)          │                  │
│           │            └───────────────────┘                  │
└───────────┼──────────────────────┼────────────────────────────┘
            │                      │
            │ 读取                  │ 读取
            ▼                      ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (data/)                            │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ products.ts     │  │ gadm/ + google/ │                  │
│  │ (产品配置)       │  │ (区域数据)       │                  │
│  └─────────────────┘  └──────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流协作流程

#### 场景：用户选择产品并查看风险

```
步骤 1: 用户操作
  └─> Dashboard.tsx 更新状态
      ├─> selectedProduct 改变
      ├─> selectedRegion 改变
      └─> dateRange 改变

步骤 2: Hook 层响应式计算
  └─> Dashboard.tsx 调用 Hooks
      ├─> useWeatherData()
      │   └─> 调用 weatherDataGenerator.generate()
      │       └─> 生成 Mock 天气数据（带缓存）
      │
      ├─> useRiskAnalysis()
      │   ├─> 创建 riskCalculationService
      │   ├─> 调用 riskService.calculateRiskEvents()
      │   │   ├─> 从 productLibrary 获取产品规则
      │   │   ├─> 调用 riskCalculationEngine 计算风险
      │   │   └─> 返回风险事件列表
      │   ├─> 生成 mapMarkersData（地图标记）
      │   └─> 生成 detailedStatistics（统计信息）
      │
      └─> useWeatherStatistics()
          └─> 调用 calculateWeatherStatistics()
              └─> 计算天气基础统计

步骤 3: 数据分发（单向数据流）
  └─> Dashboard.tsx 向下分发数据
      ├─> MapWorkspace
      │   ├─> 接收 mapMarkersData → 渲染风险标记
      │   └─> 接收 allRegionsWeatherData → 渲染热力图
      │
      └─> DataDashboard
          ├─> 接收 detailedStatistics → 显示分析汇总
          ├─> 接收 riskEvents → 渲染图表和时间线
          └─> 接收 weatherStatistics → 显示天气统计
```

### 2.3 关键协作点详解

#### 协作点 1: Dashboard → Hooks → 业务逻辑层

```typescript
// Dashboard.tsx
const allRegionsHourlyWeatherData = useWeatherData(
  selectedRegion, 
  dateRange, 
  weatherDataType, 
  'rainfall'
);

// useWeatherData.ts (Hook 层)
export function useWeatherData(...) {
  return useMemo(() => {
    // 调用业务逻辑层
    return weatherDataGenerator.generate(
      selectedRegion, 
      dateRange, 
      dataType, 
      weatherType, 
      cacheContext
    );
  }, [selectedRegion, dateRange, dataType, weatherType, cacheContext]);
}

// weatherDataGenerator.ts (业务逻辑层)
export function generate(...) {
  // 实际的数据生成逻辑
  // 带缓存机制
}
```

#### 协作点 2: 风险计算链路

```typescript
// Dashboard.tsx
const { riskEvents, mapMarkersData, detailedStatistics } = useRiskAnalysis(
  selectedRegion,
  dateRange,
  selectedProduct,
  'rainfall',
  weatherDataType,
  allRegionsHourlyWeatherData
);

// useRiskAnalysis.ts (Hook 层)
const riskService = useMemo(() => 
  createRiskCalculationService(productLibrary), 
  []
);

const riskEvents = useMemo(() => {
  // 调用业务逻辑层
  return riskService.calculateRiskEvents(
    selectedProduct.id,
    region,
    dateRange,
    data
  );
}, [selectedProduct, selectedRegion, dateRange, ...]);

// riskCalculationService.ts (业务逻辑层)
calculateRiskEvents(...) {
  // 1. 从产品库获取产品定义
  const product = this.productLibrary.getProduct(productId);
  
  // 2. 调用计算引擎
  const events = this.calculationEngine.calculateRiskEvents(
    product, region, dateRange, weatherData
  );
  
  return events;
}

// riskCalculationEngine.ts (业务逻辑层)
calculateRiskEvents(...) {
  // 1. 解析产品规则
  const config = this.parseRiskRule(product);
  
  // 2. 执行计算逻辑
  return this.calculateEvents(config, weatherData, dateRange);
}
```

#### 协作点 3: 扩展数据获取（特殊场景）

```typescript
// DataDashboard.tsx (在风险叠加示意图组件中)
const { extendedHourlyData, extendedDailyData } = 
  useExtendedWeatherDataForOverlayChart(
    selectedRegion,
    dateRange,
    dataType,
    weatherType,
    selectedProduct
  );

// useExtendedWeatherDataForOverlayChart.ts (Hook 层)
export function useExtendedWeatherDataForOverlayChart(...) {
  // 1. 计算扩展时间范围
  const extendedDateRange = useMemo(() => {
    const product = productLibrary.getProduct(selectedProduct.id);
    const { timeWindow } = product.riskRules;
    
    // 根据 timeWindow.type 计算扩展范围
    if (timeWindow.type === 'hourly') {
      return { from: subHours(dateRange.from, timeWindow.size), ... };
    }
    // ...
  }, [selectedProduct, dateRange]);
  
  // 2. 获取扩展数据（复用 useWeatherData）
  const extendedData = useWeatherData(
    selectedRegion,
    extendedDateRange,
    dataType,
    weatherType,
    `extended-${selectedProduct.id}` // 缓存上下文
  );
  
  return { extendedHourlyData, extendedDailyData };
}
```

### 2.4 缓存机制协作

```
用户操作 → Dashboard 状态更新
    ↓
Hook 层检查缓存 (useMemo 依赖项)
    ↓
┌─────────────────┬─────────────────┐
│  缓存命中        │   缓存未命中      │
└────────┬────────┘ └────────┬───────┘
         │                    │
         │                    ▼
   直接返回缓存数据     调用业务逻辑层生成数据
         │                    │
         │                    ▼
         │              存入缓存（历史数据）
         │                    │
         └──────────┬──────────┘
                    ▼
            返回数据给组件
```

### 2.5 职责分离原则

| 层级 | 职责 | 示例 |
|------|------|------|
| **组件层** | UI 渲染、用户交互、状态管理 | `Dashboard.tsx` 管理所有状态 |
| **Hook 层** | 数据获取、计算封装、缓存管理 | `useRiskAnalysis` 封装风险计算 |
| **业务逻辑层** | 核心算法、业务规则、数据处理 | `riskCalculationEngine` 执行计算 |
| **数据层** | 静态配置、原始数据 | `products.ts` 产品配置 |

### 2.6 各层之间的依赖关系

#### 依赖关系架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    组件层 (Components)                        │
│  使用 types 定义 Props 和 State                               │
│  使用 styles 的 CSS 变量和类名                                │
└─────────┬───────────────────────────────────────────────────┘
          │
          │ 导入 types
          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Hook 层 (Hooks)                            │
│  使用 types 定义参数和返回值                                   │
│  调用业务逻辑层（通过 interfaces）                             │
└─────────┬───────────────────────────────────────────────────┘
          │
          │ 导入 types 和 interfaces
          ▼
┌─────────────────────────────────────────────────────────────┐
│                  业务逻辑层 (lib/)                            │
│  实现 interfaces 定义的接口                                   │
│  使用 types 定义内部数据结构                                   │
│  ┌────────────────────────────────────────────┐             │
│  │ productLibrary.ts                          │             │
│  │ implements ProductLibrary (interface)     │             │
│  │ uses Product (type)                        │             │
│  └────────────────────────────────────────────┘             │
│  ┌────────────────────────────────────────────┐             │
│  │ riskCalculationEngine.ts                   │             │
│  │ implements RiskCalculationEngine (interface)│             │
│  │ uses RiskEvent, Product (types)            │             │
│  └────────────────────────────────────────────┘             │
└─────────┬───────────────────────────────────────────────────┘
          │
          │ 依赖关系
          ▼
┌─────────────────────────────────────────────────────────────┐
│              Interfaces 层 (interfaces/)                      │
│  定义接口契约（使用 types）                                   │
│  ┌────────────────────────────────────────────┐             │
│  │ ProductLibrary interface                    │             │
│  │ uses Product, ProductType (types)          │             │
│  └────────────────────────────────────────────┘             │
└─────────┬───────────────────────────────────────────────────┘
          │
          │ 依赖关系
          ▼
┌─────────────────────────────────────────────────────────────┐
│                 Types 层 (types/)                             │
│  定义所有数据结构（独立层，不依赖其他层）                       │
│  ┌────────────────────────────────────────────┐             │
│  │ Product, Region, WeatherData, RiskEvent    │             │
│  │ ProductType, WeatherType, DataType          │             │
│  └────────────────────────────────────────────┘             │
└───────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Styles 层 (styles/)                              │
│  独立层，通过 CSS 变量和类名被组件层使用                       │
│  ┌────────────────────────────────────────────┐             │
│  │ CSS Variables, Global Styles, Theme        │             │
│  └────────────────────────────────────────────┘             │
└───────────────────────────────────────────────────────────────┘
```

#### 依赖关系总结

| 层级 | 依赖关系 | 说明 |
|------|---------|------|
| **Types 层** | 无依赖 | 独立层，定义所有数据结构 |
| **Interfaces 层** | 依赖 Types | 接口定义使用 Types 中的类型 |
| **Styles 层** | 无依赖 | 独立层，定义 CSS 变量和样式 |
| **业务逻辑层 (lib/)** | 依赖 Types + Interfaces | 实现 Interfaces，使用 Types |
| **Hook 层** | 依赖 Types + Interfaces | 使用 Types 定义参数，调用实现 Interfaces 的服务 |
| **组件层** | 依赖 Types + Styles | 使用 Types 定义 Props/State，使用 Styles 的 CSS 变量 |

### 2.7 设计优势

1. **唯一事实来源**：`useRiskAnalysis` 是风险计算的唯一入口，避免多处重复计算导致不一致
2. **响应式更新**：使用 `useMemo` 自动响应依赖变化，依赖未变化时复用缓存结果
3. **职责分离**：天气统计与风险计算解耦，各 Hook 职责单一
4. **可扩展性**：新增产品类型无需修改 Hook，通过产品配置动态适配
5. **性能优化**：多层缓存（Hook 层 `useMemo` + 业务逻辑层缓存），避免不必要的重复计算
6. **类型安全**：Types 层提供编译时类型检查，减少运行时错误
7. **解耦和可测试性**：Interfaces 层支持依赖注入和 Mock，便于单元测试
8. **统一的视觉设计**：Styles 层提供一致的主题系统

---

## 三、总结

### 3.1 核心设计原则

1. **Types 层**：定义所有数据结构，提供类型安全，独立层，不依赖其他层
2. **Interfaces 层**：定义业务逻辑接口契约，支持依赖注入和解耦，依赖 Types
3. **Styles 层**：定义全局样式和主题，独立层，通过 CSS 变量被组件使用
4. **Hook 层**：封装数据获取和计算逻辑，管理缓存，作为组件层与业务逻辑层的桥梁
5. **业务逻辑层**：实现核心算法和业务规则，实现 Interfaces，使用 Types
6. **组件层**：UI 渲染和用户交互，使用 Types 和 Styles

### 3.2 最佳实践

1. **类型优先**：优先使用 Types 定义数据结构，确保类型安全
2. **接口契约**：通过 Interfaces 定义服务契约，支持多种实现
3. **样式统一**：使用 Styles 层的 CSS 变量，保持视觉一致性
4. **Hook 封装**：将复杂逻辑封装到 Hook 中，保持组件简洁
5. **单向数据流**：数据从 Dashboard 向下分发，保证一致性

---

**文档维护**：本文档应随项目架构变化及时更新，确保与实际代码保持一致。
