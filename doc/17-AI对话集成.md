# 17-AI对话集成

## 步骤概述

### 步骤编号和名称
**步骤17**：AI对话集成

### 步骤目标
集成Google Contextual View AI kit和Grounding Lite MCP，实现AI对话功能，支持自然语言输入，解析用户需求并自动设置参数（行政区域、数据类型、时间范围、叠加的保险产品），与手动选择面板互斥显示。

### 预期成果
- Contextual View组件可以正常显示和交互
- Grounding Lite MCP可以正确解析用户输入
- AI对话可以正确设置参数（区域、数据类型、时间范围、产品）
- 参数设置后，手动选择界面同步更新
- 与手动选择面板的互斥显示正常工作
- UI布局符合需求（地图右侧，1/4宽度）

---

## 前置条件

### 依赖的步骤
- **步骤03**：Google Maps API配置与初始化（需要API Key和地图上下文）

### 需要完成的前置工作
- Google Maps API已配置
- API Key已配置
- Vertex AI API访问权限已配置（如果需要）

### 需要的数据/接口
- Google Maps API Key
- Contextual View组件：`gmp-place-contextual` Web Component
- Grounding Lite MCP：自然语言理解服务
- 当前参数状态：`selectedRegion`、`rainfallType`、`dateRange`、`selectedProduct`

---

## 实现要点

### 核心功能点

1. **Contextual View组件集成**
   - 使用Web Component方式集成`gmp-place-contextual`
   - 在React组件中使用`useEffect`和`useRef`集成
   - 配置contextToken（从Grounding Lite获取）
   - 设置组件布局（地图右侧，1/4宽度）

2. **Grounding Lite MCP集成**
   - 调用Vertex AI API并配置Google Maps grounding
   - 解析用户输入，提取以下参数：
     - 行政区域：国家、省/州、市/区
     - 数据类型：历史降雨量 / 预测降雨量
     - 时间范围：起止日期和时刻
     - 保险产品：产品ID或名称
   - 生成contextToken传递给Contextual View

3. **参数提取和设置**
   - 从AI对话结果中提取参数
   - 更新全局状态（selectedRegion、rainfallType、dateRange、selectedProduct）
   - 触发数据重新计算和地图重新渲染

4. **状态同步机制**
   - AI对话解析参数 → 更新全局状态
   - 全局状态变更 → 触发地图重新渲染和数据重新计算
   - 手动选择修改参数 → 更新全局状态 → AI对话界面显示当前参数

5. **UI布局和交互**
   - 位置：地图右侧，1/4宽度
   - 高度：`calc(100% - 2rem)`，与地图容器等高
   - 支持最小化/最大化
   - 与手动选择面板互斥（一种激活时，另一种最小化）

### 技术实现方案

#### 1. Contextual View组件集成
```typescript
// 伪代码示例
function ContextualAssistant({
  isMinimized,
  onMaximize,
  onMinimize,
  selectedRegion,
  rainfallType,
  setRainfallType,
  setSelectedRegion,
  setSelectedProduct
}: ContextualAssistantProps) {
  const widgetRef = useRef<HTMLElement | null>(null);
  const [contextToken, setContextToken] = useState<string | null>(null);

  useEffect(() => {
    // 加载Contextual View组件
    const script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places';
    script.async = true;
    document.head.appendChild(script);

    return () => {
      document.head.removeChild(script);
    };
  }, []);

  useEffect(() => {
    const widget = widgetRef.current as any;
    if (widget && contextToken) {
      widget.contextToken = contextToken;
    }
  }, [contextToken]);

  const handleUserInput = async (userInput: string) => {
    // 调用Grounding Lite MCP解析用户输入
    const token = await parseUserInput(userInput);
    setContextToken(token);
  };

  return (
    <div className={cn(
      "contextual-assistant",
      isMinimized ? "minimized" : "expanded"
    )}>
      {!isMinimized && (
        <gmp-place-contextual
          ref={widgetRef}
          id="contextual-widget"
          style={{ width: '100%', height: '100%' }}
        />
      )}
      <button onClick={isMinimized ? onMaximize : onMinimize}>
        {isMinimized ? '展开' : '最小化'}
      </button>
    </div>
  );
}
```

#### 2. Grounding Lite MCP集成
```typescript
// 伪代码示例
async function parseUserInput(
  userInput: string,
  apiKey: string
): Promise<string> {
  const response = await fetch(vertexAIEndpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      contents: [
        {
          role: 'user',
          parts: [{ text: userInput }]
        }
      ],
      systemInstruction: {
        parts: [{
          text: systemInstructions // 系统指令，说明如何提取参数
        }]
      },
      tools: {
        googleMaps: {
          authConfig: {
            apiKeyConfig: {
              name: 'api_key',
              apiKeyString: apiKey
            }
          }
        }
      },
      model: `projects/${projectNumber}/locations/us-central1/publishers/google/models/${modelId}`
    })
  });

  const data = await response.json();
  const { googleMapsWidgetContextToken } = data;
  
  // 从响应中提取参数并更新状态
  extractAndUpdateParameters(data);
  
  return googleMapsWidgetContextToken;
}
```

#### 3. 参数提取和更新
```typescript
// 伪代码示例
function extractAndUpdateParameters(
  response: any,
  setters: {
    setSelectedRegion: (region: Region) => void;
    setRainfallType: (type: RainfallType) => void;
    setDateRange: (range: DateRange) => void;
    setSelectedProduct: (product: Product | null) => void;
  }
) {
  // 从响应中提取参数
  const region = extractRegion(response);
  const rainfallType = extractRainfallType(response);
  const dateRange = extractDateRange(response);
  const product = extractProduct(response);

  // 更新状态
  if (region) setters.setSelectedRegion(region);
  if (rainfallType) setters.setRainfallType(rainfallType);
  if (dateRange) setters.setDateRange(dateRange);
  if (product) setters.setSelectedProduct(product);
}
```

### 关键代码结构

#### AI对话组件
```typescript
// 伪代码示例
export function ContextualAssistant({
  isMinimized,
  onMaximize,
  onMinimize,
  selectedRegion,
  rainfallType,
  setRainfallType,
  setSelectedRegion,
  setSelectedProduct
}: ContextualAssistantProps) {
  // Contextual View组件集成
  // Grounding Lite MCP集成
  // 参数提取和更新
  // 状态同步
}
```

---

## 输入输出

### 输入
- **用户输入**：自然语言文本
- **当前参数状态**：`selectedRegion`、`rainfallType`、`dateRange`、`selectedProduct`
- **API Key**：Google Maps API Key和Vertex AI API Key

### 输出
- **更新的参数状态**：通过setter函数更新
- **Context Token**：传递给Contextual View组件
- **用户操作事件**：参数设置、对话交互

---

## 验收标准

### 功能验收标准
- [ ] Contextual View组件可以正常显示和交互
- [ ] Grounding Lite MCP可以正确解析用户输入
- [ ] AI对话可以正确设置参数（区域、数据类型、时间范围、产品）
- [ ] 参数设置后，手动选择界面同步更新
- [ ] 与手动选择面板的互斥显示正常工作
- [ ] UI布局符合需求（地图右侧，1/4宽度）

### 交互验收标准
- [ ] 用户可以通过自然语言描述需求
- [ ] AI可以正确理解用户意图
- [ ] 参数设置后，地图和数据面板可以实时更新
- [ ] 对话界面生动美观，交互流畅

### 性能验收标准
- [ ] AI对话响应时间在3秒内
- [ ] 参数提取和更新在1秒内完成
- [ ] 组件加载时间在2秒内

---

## 注意事项

### 常见问题
1. **Contextual View组件加载失败**
   - 确保API Key正确配置
   - 确保组件脚本正确加载
   - 检查网络连接

2. **Grounding Lite MCP解析失败**
   - 确保Vertex AI API访问权限正确
   - 确保API调用格式正确
   - 处理API调用失败的情况

3. **参数提取不准确**
   - 优化系统指令，提高解析准确性
   - 处理模糊的用户输入
   - 提供参数确认机制

### 技术难点
- **Web Component集成**：在React中集成Web Component需要特殊处理
- **自然语言理解**：需要正确配置Grounding Lite以提高解析准确性
- **状态同步**：确保AI对话和手动选择的状态同步

### 扩展性考虑
- AI对话功能可以扩展，支持更多参数类型
- 可以添加对话历史记录
- 支持未来添加更多AI功能

---

## 下一步

### 后续步骤的准备工作
- AI对话集成已实现，用户交互功能基本完成
- 参数设置功能已实现，可以触发数据重新计算和渲染

### 数据/接口的传递
- 参数通过setter函数传递给Dashboard组件
- Context Token通过props传递给Contextual View组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
