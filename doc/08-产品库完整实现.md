# 08-产品库完整实现

## 步骤概述

### 步骤编号和名称
**步骤08**：产品库完整实现

### 步骤目标
实现三种保险产品类型（降雨量日内产品 Daily Heavy Rain、降雨量周度产品 Weekly Accumulation Rainfall、降雨量月度产品 Drought Defense）的完整配置，包括产品基本信息、产品级的风险事件触发规则、阈值配置和风险级别定义，完成产品库的完整功能实现。

**重要说明**：
- 本步骤实现**产品级的风险事件触发条件**配置（用于风险计算和可视化）
- 同时实现**保单级的赔付原则**配置（仅用于产品介绍页的教育展示，不参与计算）
- 产品配置包含两层信息：`riskRules`用于计算，`payoutRules`用于展示

### 预期成果
- 降雨量日内产品配置完整（3档阈值：100mm、120mm、140mm，对应tier 1、tier 2、tier 3）
- 降雨量周度产品配置完整（3档阈值：300mm、350mm、400mm，对应tier 1、tier 2、tier 3）
- 降雨量月度产品配置完整（3档阈值：60mm、40mm、20mm，对应tier 1、tier 2、tier 3）
- 所有产品配置符合需求文档 #4.3.2 产品级风险事件触发条件的要求
- 产品库可以正常查询和加载产品

---

## 前置条件

### 依赖的步骤
- **步骤06**：产品库基础结构（需要产品数据模型和查询接口）

### 需要完成的前置工作
- 产品数据模型已定义
- 产品查询接口已定义
- 产品配置文件结构已创建

### 需要的数据/接口
- 产品数据模型：`Product`、`RiskRule`、`PayoutRule`、`Threshold`等接口
- 产品配置文件：JSON格式的产品定义
- **注意**：产品配置包含两层信息：
  - `riskRules`：产品级的风险事件触发条件（用于计算）
  - `payoutRules`：保单级的赔付原则（可选，仅用于教育展示）

---

## 实现要点

### 核心功能点

1. **降雨量日内产品配置**
   - 产品基本信息：ID、名称、描述、图标
   - 天气类型：降雨量
   - 风险触发规则：
     - 触发条件：4小时累计降雨量 > 阈值（时间区间：00:00 to 23:59）
     - 时间窗口：滑动窗口，包含当前小时和此前连续3小时
     - 窗口配置：`type: 'hourly'`, `size: 4`, `step: 1`（每小时滑动一次）
   - 阈值配置：100mm（tier 1）、120mm（tier 2）、140mm（tier 3）
   - 计算逻辑：累计方式为sum，比较运算符为>

2. **降雨量周度产品配置**
   - 产品基本信息：ID、名称、描述、图标
   - 天气类型：降雨量
   - 风险触发规则：
     - 触发条件：7天累计降雨量 > 阈值
     - 时间窗口：滑动窗口，包含当天和此前连续6天
     - 窗口配置：`type: 'daily'`, `size: 7`, `step: 1`（每天滑动一次）
   - 阈值配置：300mm（tier 1）、350mm（tier 2）、400mm（tier 3）
   - 计算逻辑：累计方式为sum，比较运算符为>

3. **降雨量月度产品配置**
   - 产品基本信息：ID、名称、描述、图标
   - 天气类型：降雨量
   - 风险触发规则：
     - 触发条件：自然月累计降雨量 < 阈值
     - 时间窗口：完整自然月（固定窗口）
     - 窗口配置：`type: 'monthly'`, `size: 1`（按完整自然月计算，无需step）
   - 阈值配置：60mm（tier 1）、40mm（tier 2）、20mm（tier 3）
   - 计算逻辑：累计方式为sum，比较运算符为<

4. **产品加载和查询**
   - 从配置文件加载所有产品
   - 实现产品查询功能（按ID、按类型）
   - 实现产品验证功能（确保配置正确）

5. **保单级信息配置**（仅用于教育展示）
   - 赔付频率限制：如"once per day per policy"、"once per month per policy"
   - 理赔额度百分比：tier 1: 20%, tier 2: 50%, tier 3: 100%（前端仅展示百分比数值）
   - **注意**：保单级信息不参与风险计算，仅用于产品介绍页展示

### 技术实现方案

#### 1. 产品配置文件
```json
// 伪代码示例（与实际实现一致）
{
  "products": [
    {
      "id": "daily",
      "name": "Daily Heavy Rain",
      "type": "daily",
      "weatherType": "rainfall",
      "description": "4-hour cumulative rainfall within one day (00:00 to 23:59) > threshold, once per day per policy",
      "icon": "cloud-rain",
      "riskRules": {
        "triggerType": "daily",
        "weatherType": "rainfall",
        "timeWindow": {
          "type": "hourly",
          "size": 4,
          "step": 1
        },
        "thresholds": [
          { "value": 100, "level": "tier1", "label": "100mm" },
          { "value": 120, "level": "tier2", "label": "120mm" },
          { "value": 140, "level": "tier3", "label": "140mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": ">",
          "unit": "mm"
        }
      }
    },
    {
      "id": "weekly",
      "name": "Weekly Accumulation Rainfall",
      "type": "weekly",
      "weatherType": "rainfall",
      "description": "7-day cumulative rainfall within one month > threshold, once per month per policy",
      "icon": "cloud-rain",
      "riskRules": {
        "triggerType": "weekly",
        "weatherType": "rainfall",
        "timeWindow": {
          "type": "daily",
          "size": 7,
          "step": 1
        },
        "thresholds": [
          { "value": 300, "level": "tier1", "label": "300mm" },
          { "value": 350, "level": "tier2", "label": "350mm" },
          { "value": 400, "level": "tier3", "label": "400mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": ">",
          "unit": "mm"
        }
      },
      "payoutRules": {
        "frequencyLimit": "once per month per policy",
        "payoutPercentages": {
          "tier1": 20,
          "tier2": 50,
          "tier3": 100
        }
      }
    },
    {
      "id": "drought",
      "name": "Drought Defense",
      "type": "monthly",
      "weatherType": "rainfall",
      "description": "Cumulative rainfall of one month < threshold",
      "icon": "sun",
      "riskRules": {
        "triggerType": "monthly",
        "weatherType": "rainfall",
        "timeWindow": {
          "type": "monthly",
          "size": 1
        },
        "thresholds": [
          { "value": 60, "level": "tier1", "label": "60mm" },
          { "value": 40, "level": "tier2", "label": "40mm" },
          { "value": 20, "level": "tier3", "label": "20mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": "<",
          "unit": "mm"
        }
      },
      "payoutRules": {
        "payoutPercentages": {
          "tier1": 20,
          "tier2": 50,
          "tier3": 100
        }
      }
    }
  ]
}
```

**说明**：
- `riskRules`：产品级的风险事件触发条件，用于风险计算引擎计算风险事件
- `payoutRules`：保单级的赔付原则，仅用于产品介绍页的教育展示，不参与计算
  - `frequencyLimit`：赔付频率限制（可选，如"once per day per policy"）
  - `payoutPercentages`：理赔额度百分比，对应 tier 1/2/3 分别为 20%、50%、100%（前端仅展示百分比数值）

**时间窗口配置说明**：
- `timeWindow.type`：时间单位类型，可选值：`'hourly'` | `'daily' | 'weekly' | 'monthly'`
- `timeWindow.size`：窗口大小（单位由 `type` 决定）
- `timeWindow.step`：滑动步长（可选，默认值为 1）
  - **滑动窗口**：`step < size`，例如 4 小时窗口每小时滑动一次（`step: 1`）
  - **固定窗口**：`step === size` 或不设置 `step`，例如月度产品按完整自然月计算
- **窗口类型语义**：
  - **滑动窗口（Sliding Window）**：通过 `step` 控制每次滑动的距离，适用于需要连续监控的场景（如日内产品、周度产品）
  - **固定窗口（Fixed Window）**：按固定时间单位计算（如自然月），适用于周期性统计场景（如月度产品）

#### 2. 产品库实现
```typescript
// 伪代码示例
class ProductLibrary {
  private products: Map<string, Product>;
  
  constructor() {
    this.products = new Map();
    this.loadProducts();
  }
  
  private loadProducts() {
    const config = require('./products.json');
    config.products.forEach(product => {
      this.validateProduct(product);
      this.products.set(product.id, product);
    });
  }
  
  getProduct(id: string): Product | null {
    return this.products.get(id) || null;
  }
  
  getProductsByType(type: string): Product[] {
    return Array.from(this.products.values())
      .filter(p => p.type === type);
  }
  
  getAllProducts(): Product[] {
    return Array.from(this.products.values());
  }
  
  private validateProduct(product: Product): void {
    // 验证产品配置的正确性
  }
}
```

### 关键代码结构

#### 产品库模块
```typescript
// 伪代码示例
// lib/productLibrary.ts
export class ProductLibrary {
  // 产品加载
  // 产品查询
  // 产品验证
}

// lib/products.json
// 产品配置文件
```

---

## 输入输出

### 输入
- **产品配置文件**：JSON格式的产品定义
- **产品ID**：用于查询特定产品
- **产品类型**：用于查询特定类型的产品

### 输出
- **产品对象**：`Product`类型，包含完整的产品定义
- **产品列表**：`Product[]`类型，包含所有产品
- **产品查询结果**：通过查询接口返回的产品数据

---

## 验收标准

### 功能验收标准
- [ ] 降雨量日内产品配置完整，包含所有必要信息（`riskRules` 和 `payoutRules`）
- [ ] 降雨量周度产品配置完整，包含所有必要信息（`riskRules` 和 `payoutRules`）
- [ ] 降雨量月度产品配置完整，包含所有必要信息（`riskRules` 和 `payoutRules`）
- [ ] 所有产品的阈值配置正确（符合需求文档）
- [ ] 所有产品的天气类型标识正确（降雨量）
- [ ] 所有产品的理赔额度百分比配置正确（tier 1: 20%, tier 2: 50%, tier 3: 100%）
- [ ] 产品查询功能正常工作（按ID、按类型）
- [ ] 产品验证功能正常工作，可以检测配置错误
- [ ] 风险计算引擎仅使用 `riskRules`，不涉及 `payoutRules`

### 数据质量验收标准
- [ ] 产品数据格式统一，符合接口定义
- [ ] 产品配置包含所有必要字段（`riskRules` 和 `payoutRules`）
- [ ] 阈值配置正确（降雨量日内：100/120/140，降雨量周度：300/350/400，降雨量月度：60/40/20）
- [ ] 阈值级别正确（tier 1, tier 2, tier 3）
- [ ] 触发规则配置正确（时间窗口、计算逻辑）
- [ ] 时间窗口配置正确（`type`、`size`、`step` 字段）
- [ ] 滑动窗口的 `step` 配置合理（`step < size`）
- [ ] 降雨量日内产品时间区间正确（00:00 to 23:59）
- [ ] 产品的 `weatherType` 字段正确配置，确保生成的风险事件的 `weatherType` 字段正确对应
- [ ] 理赔额度百分比配置正确（tier 1: 20%, tier 2: 50%, tier 3: 100%）
- [ ] 赔付频率限制配置正确（降雨量日内：once per day per policy，降雨量周度：once per month per policy）

### 扩展性验收标准
- [ ] 支持未来添加新产品类型
- [ ] 支持未来修改产品配置
- [ ] 产品查询接口易于扩展

---

## 注意事项

### 常见问题
1. **产品配置格式错误**
   - 使用TypeScript类型定义确保格式正确
   - 提供配置文件验证机制

2. **阈值配置不正确**
   - 确保阈值配置与需求文档一致
   - 确保阈值级别（tier 1, tier 2, tier 3）正确对应

3. **触发规则配置错误**
   - 确保时间窗口配置正确
   - 确保计算逻辑配置正确
   - 确保 `step` 字段配置合理（滑动窗口应设置 `step < size`，固定窗口可不设置或 `step === size`）

### 技术难点
- **产品配置验证**：需要验证所有配置字段的正确性
- **产品类型扩展**：需要支持未来添加新的产品类型

### 扩展性考虑
- 产品配置可以存储在静态文件或通过API提供
- 支持产品版本管理（如果需要）
- 支持产品配置的热更新（未来扩展）
- **保单级信息说明**：
  - `payoutRules` 为可选字段，仅用于产品介绍页的教育展示
  - 风险计算引擎完全忽略 `payoutRules`，只使用 `riskRules` 进行风险事件计算
  - 前端产品介绍页可以通过 `payoutRules` 展示保单级的赔付原则信息
  - 理赔额度百分比（20%、50%、100%）前端仅展示百分比数值，不涉及实际金额计算

---

## 下一步

### 后续步骤的准备工作
- 产品库已完整实现，可以在步骤09中实现与计算引擎的协同
- 产品配置已完整，可以在步骤07中使用进行风险计算

### 数据/接口的传递
- 产品数据通过`Product`类型传递给风险计算引擎
- 产品查询接口通过`ProductLibrary`类提供给其他模块

### 风险事件字段映射
当产品库的产品配置用于风险计算时，生成的风险事件（`RiskEvent`）会包含以下字段，这些字段与产品配置相关：

**说明**：风险事件仅基于产品级的风险事件触发条件生成，不涉及保单级的赔付原则。

- **`weatherType`**：对应产品的 `weatherType` 字段（如 `'rainfall'`），标识风险事件对应的天气类型
- **`dataType`**：根据计算时使用的数据类型设置（`'historical'` 或 `'predicted'`），标识风险事件是基于历史数据还是预测数据
- **`level`**：对应触发时超过/低于的阈值档位（`'tier1'`、`'tier2'` 或 `'tier3'`），与产品配置中的阈值级别对应
- **`productId`**：对应产品的 `id` 字段

**注意**：风险事件记录的是产品级的风险事件触发情况，不包含保单级的赔付信息（如赔付金额、赔付次数等）。

### 风险严重程度汇总规则
基于需求文档 4.3.3，风险严重程度汇总规则如下：
- **若没有风险事件**：为无 "-"
- **若最高级别的风险事件为 tier 1**：为低
- **若最高级别的风险事件为 tier 2**：为中
- **若最高级别的风险事件为 tier 3**：为高

**说明**：
- 风险严重程度基于时间窗口内所有风险事件的最高级别确定
- 该规则用于数据面板的分析汇总卡片中显示风险严重程度
- **产品级 vs 保单级**：
  - **产品级的风险事件触发条件**（当前实现）：定义什么情况触发风险事件，触发风险的级别（tier 1, tier 2, tier 3）
  - **保单级的赔付原则**（暂不涉及）：定义赔付多少金额，赔付几次（如"once per day per policy"、"对应不同理赔额度"）
- **当前网站范围**：目前该网站仅计算并可视化产品级的风险事件触发条件，不涉及保单级的赔付计算

---

**文档版本**：v1.1  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27  
**更新说明**：v1.1 - 更新 `timeWindow` 配置格式，补充 `step` 字段说明，明确滑动窗口与固定窗口的语义
