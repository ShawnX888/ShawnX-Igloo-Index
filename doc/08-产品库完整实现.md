# 08-产品库完整实现

## 步骤概述

### 步骤编号和名称
**步骤08**：产品库完整实现

### 步骤目标
实现三种保险产品类型（日内、周度、月度）的完整配置，包括产品基本信息、风险触发规则、阈值配置和风险级别定义，完成产品库的完整功能实现。

### 预期成果
- 日内产品配置完整（3档阈值：100mm、120mm、140mm）
- 周度产品配置完整（3档阈值：300mm、350mm、400mm）
- 月度产品配置完整（3档阈值：60mm、40mm、20mm）
- 所有产品配置符合需求文档要求
- 产品库可以正常查询和加载产品

---

## 前置条件

### 依赖的步骤
- **步骤06**：产品库基础结构（需要产品数据模型和查询接口）

### 需要完成的前置工作
- 产品数据模型已定义
- 产品查询接口已定义
- 产品配置文件结构已创建

### 需要的数据/接口
- 产品数据模型：`Product`、`RiskRule`、`Threshold`等接口
- 产品配置文件：JSON格式的产品定义

---

## 实现要点

### 核心功能点

1. **日内产品配置**
   - 产品基本信息：ID、名称、描述、图标
   - 风险触发规则：
     - 触发条件：4小时累计降雨量 > 阈值
     - 时间窗口：滑动窗口，包含当前小时和此前连续3小时
     - 触发限制：每天最多触发一次
   - 阈值配置：100mm（low）、120mm（medium）、140mm（high）
   - 计算逻辑：累计方式为sum，比较运算符为>

2. **周度产品配置**
   - 产品基本信息：ID、名称、描述、图标
   - 风险触发规则：
     - 触发条件：7天累计降雨量 > 阈值
     - 时间窗口：滑动窗口，包含当天和此前连续6天
     - 触发限制：每月最多触发一次
   - 阈值配置：300mm（low）、350mm（medium）、400mm（high）
   - 计算逻辑：累计方式为sum，比较运算符为>

3. **月度产品配置**
   - 产品基本信息：ID、名称、描述、图标
   - 风险触发规则：
     - 触发条件：当月累计降雨量 < 阈值
     - 时间窗口：完整自然月
     - 触发限制：每月最多触发一次
   - 阈值配置：60mm（low）、40mm（medium）、20mm（high）
   - 计算逻辑：累计方式为sum，比较运算符为<

4. **产品加载和查询**
   - 从配置文件加载所有产品
   - 实现产品查询功能（按ID、按类型）
   - 实现产品验证功能（确保配置正确）

### 技术实现方案

#### 1. 产品配置文件
```json
// 伪代码示例
{
  "products": [
    {
      "id": "daily",
      "name": "日内产品",
      "type": "daily",
      "description": "连续4小时的降雨量超过阈值时触发",
      "icon": "cloud-rain",
      "riskRules": {
        "triggerType": "daily",
        "timeWindow": {
          "type": "sliding",
          "duration": 4,
          "unit": "hour"
        },
        "thresholds": [
          { "value": 100, "level": "low", "label": "100mm" },
          { "value": 120, "level": "medium", "label": "120mm" },
          { "value": 140, "level": "high", "label": "140mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": ">",
          "unit": "mm"
        },
        "triggerLimit": {
          "type": "daily",
          "maxCount": 1
        }
      }
    },
    {
      "id": "weekly",
      "name": "周度产品",
      "type": "weekly",
      "description": "7天累计降雨量超过阈值时触发",
      "icon": "cloud-rain",
      "riskRules": {
        "triggerType": "weekly",
        "timeWindow": {
          "type": "sliding",
          "duration": 7,
          "unit": "day"
        },
        "thresholds": [
          { "value": 300, "level": "low", "label": "300mm" },
          { "value": 350, "level": "medium", "label": "350mm" },
          { "value": 400, "level": "high", "label": "400mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": ">",
          "unit": "mm"
        },
        "triggerLimit": {
          "type": "monthly",
          "maxCount": 1
        }
      }
    },
    {
      "id": "drought",
      "name": "月度产品",
      "type": "monthly",
      "description": "当月累计降雨量低于阈值时触发",
      "icon": "sun",
      "riskRules": {
        "triggerType": "monthly",
        "timeWindow": {
          "type": "fixed",
          "duration": 1,
          "unit": "month"
        },
        "thresholds": [
          { "value": 60, "level": "low", "label": "60mm" },
          { "value": 40, "level": "medium", "label": "40mm" },
          { "value": 20, "level": "high", "label": "20mm" }
        ],
        "calculation": {
          "aggregation": "sum",
          "operator": "<",
          "unit": "mm"
        },
        "triggerLimit": {
          "type": "monthly",
          "maxCount": 1
        }
      }
    }
  ]
}
```

#### 2. 产品库实现
```typescript
// 伪代码示例
class ProductLibrary {
  private products: Map<string, Product>;
  
  constructor() {
    this.products = new Map();
    this.loadProducts();
  }
  
  private loadProducts() {
    const config = require('./products.json');
    config.products.forEach(product => {
      this.validateProduct(product);
      this.products.set(product.id, product);
    });
  }
  
  getProduct(id: string): Product | null {
    return this.products.get(id) || null;
  }
  
  getProductsByType(type: string): Product[] {
    return Array.from(this.products.values())
      .filter(p => p.type === type);
  }
  
  getAllProducts(): Product[] {
    return Array.from(this.products.values());
  }
  
  private validateProduct(product: Product): void {
    // 验证产品配置的正确性
  }
}
```

### 关键代码结构

#### 产品库模块
```typescript
// 伪代码示例
// lib/productLibrary.ts
export class ProductLibrary {
  // 产品加载
  // 产品查询
  // 产品验证
}

// lib/products.json
// 产品配置文件
```

---

## 输入输出

### 输入
- **产品配置文件**：JSON格式的产品定义
- **产品ID**：用于查询特定产品
- **产品类型**：用于查询特定类型的产品

### 输出
- **产品对象**：`Product`类型，包含完整的产品定义
- **产品列表**：`Product[]`类型，包含所有产品
- **产品查询结果**：通过查询接口返回的产品数据

---

## 验收标准

### 功能验收标准
- [ ] 日内产品配置完整，包含所有必要信息
- [ ] 周度产品配置完整，包含所有必要信息
- [ ] 月度产品配置完整，包含所有必要信息
- [ ] 所有产品的阈值配置正确（符合需求文档）
- [ ] 产品查询功能正常工作（按ID、按类型）
- [ ] 产品验证功能正常工作，可以检测配置错误

### 数据质量验收标准
- [ ] 产品数据格式统一，符合接口定义
- [ ] 产品配置包含所有必要字段
- [ ] 阈值配置正确（日内：100/120/140，周度：300/350/400，月度：60/40/20）
- [ ] 触发规则配置正确（时间窗口、计算逻辑、触发限制）

### 扩展性验收标准
- [ ] 支持未来添加新产品类型
- [ ] 支持未来修改产品配置
- [ ] 产品查询接口易于扩展

---

## 注意事项

### 常见问题
1. **产品配置格式错误**
   - 使用TypeScript类型定义确保格式正确
   - 提供配置文件验证机制

2. **阈值配置不正确**
   - 确保阈值配置与需求文档一致
   - 确保阈值级别（low/medium/high）正确对应

3. **触发规则配置错误**
   - 确保时间窗口配置正确
   - 确保计算逻辑配置正确
   - 确保触发限制配置正确

### 技术难点
- **产品配置验证**：需要验证所有配置字段的正确性
- **触发限制实现**：需要正确处理每日/每月的触发限制
- **产品类型扩展**：需要支持未来添加新的产品类型

### 扩展性考虑
- 产品配置可以存储在静态文件或通过API提供
- 支持产品版本管理（如果需要）
- 支持产品配置的热更新（未来扩展）

---

## 下一步

### 后续步骤的准备工作
- 产品库已完整实现，可以在步骤09中实现与计算引擎的协同
- 产品配置已完整，可以在步骤07中使用进行风险计算

### 数据/接口的传递
- 产品数据通过`Product`类型传递给风险计算引擎
- 产品查询接口通过`ProductLibrary`类提供给其他模块

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
