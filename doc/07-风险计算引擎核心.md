# 07-风险计算引擎核心

## 步骤概述

### 步骤编号和名称
**步骤07**：风险计算引擎核心

### 步骤目标
实现风险计算引擎的核心架构，包括产品规则解析器、基础计算逻辑和结果格式化器，为风险事件计算提供可扩展的计算框架。

**重要说明**：本步骤仅实现**产品级的风险事件触发条件**计算，不涉及保单级的赔付计算。计算引擎基于产品级的风险事件触发条件（什么情况触发风险事件，触发风险的级别），生成风险事件列表，不涉及赔付金额、赔付频率等保单级规则。

### 预期成果
- 风险计算引擎核心架构已实现
- 产品规则解析器可以正确解析产品级的风险事件触发条件
- 基础计算逻辑可以执行产品级的风险事件计算
- 结果格式化器可以格式化计算结果
- 为后续步骤提供可用的计算引擎

---

## 前置条件

### 依赖的步骤
- **步骤06**：产品库基础结构（需要产品数据模型和查询接口）

### 需要完成的前置工作
- 产品数据模型已定义
- 产品查询接口已实现

### 需要的数据/接口
- 产品定义：`Product`类型（从产品库获取）
- 天气数据：`WeatherData[]`类型（从Mock数据生成器获取，目前主要为降雨量数据）
  - **扩展数据**：使用 `useExtendedWeatherData` 获取扩展时间范围的天气数据，确保时间窗口起始位置的风险事件计算准确
- 时间范围：`DateRange`类型

---

## 实现要点

### 核心功能点

1. **计算引擎架构**
   - 定义`RiskCalculationEngine`类
   - 实现计算引擎的核心接口
   - 支持依赖注入，便于测试和扩展

2. **产品规则解析器**
   - 从产品库加载产品定义
   - 解析产品级的风险事件触发规则（仅产品级，不涉及保单级）
   - 验证规则配置的有效性
   - 生成可执行的计算配置
   - **注意**：仅解析产品级的风险事件触发条件，不考虑保单级的赔付原则

3. **基础计算逻辑**
   - 实现时间窗口滑动计算
   - 实现数据累计计算（sum/avg等）
   - 实现阈值判断逻辑
   - 支持不同产品类型的计算策略
   - **扩展数据支持**：使用扩展时间范围的天气数据，确保时间窗口起始位置的计算准确

4. **结果格式化器**
   - 格式化风险事件数据
   - 计算风险统计信息（事件数量、级别分布等）
   - 生成可视化所需的数据结构

### 技术实现方案

有关中心化风险计算架构的详细方案，请参阅：[风险计算架构升级方案](./补充-风险计算架构升级方案.md)

#### 1. 计算引擎架构
```typescript
// 伪代码示例
class RiskCalculationEngine {
  private productLibrary: ProductLibrary;
  
  constructor(productLibrary: ProductLibrary) {
    this.productLibrary = productLibrary;
  }
  
  calculateRiskEvents(
    product: Product,
    region: Region,
    dateRange: DateRange,
    weatherData: WeatherData[]
  ): RiskEvent[] {
    // 1. 解析产品规则
    // 2. 执行计算
    // 3. 格式化结果
  }
}
```

#### 2. 产品规则解析器
```typescript
// 伪代码示例
class ProductRuleParser {
  parseRiskRule(product: Product): CalculationConfig {
    // 1. 提取风险规则
    // 2. 解析时间窗口配置
    // 3. 解析阈值配置
    // 4. 生成计算配置
  }
}
```

#### 3. 基础计算逻辑
```typescript
// 伪代码示例
class RiskEventCalculator {
  calculate(
    config: CalculationConfig,
    weatherData: WeatherData[],
    dateRange: DateRange
  ): RiskEvent[] {
    // 1. 根据产品类型选择计算策略
    // 2. 执行时间窗口滑动计算
    // 3. 应用阈值判断
    // 4. 记录触发的事件
  }
}
```

#### 4. 结果格式化器
```typescript
// 伪代码示例
class ResultFormatter {
  format(events: RiskEvent[]): {
    events: RiskEvent[];
    statistics: RiskStatistics;
    visualizationData: VisualizationData;
  } {
    // 1. 格式化风险事件
    // 2. 计算统计信息
    // 3. 生成可视化数据
  }
}
```

### 关键代码结构

#### 风险事件数据模型
```typescript
// 伪代码示例
interface RiskEvent {
  id: string;
  productId: string;
  region: Region;
  timestamp: Date;
  dataType: 'historical' | 'predicted'; // 数据类型：历史或预测
  weatherType: WeatherType; // 天气类型，对应产品的weatherType字段：'rainfall' | 'temperature' | 'wind' | 'humidity' | 'pressure' | 'snowfall'
  level: 'tier1' | 'tier2' | 'tier3'; // 对应阈值档位
  type: string;
  value: number; // 触发时的累计值
}
```

---

## 输入输出

### 输入
- **产品**：`Product`类型（从产品库获取）
- **区域**：`Region`类型
- **时间范围**：`DateRange`类型
- **天气数据**：`WeatherData[]`类型（目前主要为降雨量数据）
  - **扩展数据**：使用 `useExtendedWeatherData` 获取扩展时间范围的天气数据，确保时间窗口起始位置的风险事件计算准确

### 输出
- **风险事件列表**：`RiskEvent[]`类型
- **风险统计信息**：包含事件数量、级别分布等
- **可视化数据**：用于地图标记和数据面板图表

---

## 验收标准

### 功能验收标准
- [ ] 计算引擎可以正确解析产品规则
- [ ] 基础计算逻辑可以执行简单的风险计算
- [ ] 结果格式化器可以正确格式化计算结果
- [ ] 计算引擎架构清晰，便于扩展

### 性能验收标准
- [ ] 风险计算应在1秒内完成（对于默认时间范围）
- [ ] 计算引擎不会阻塞UI线程
- [ ] 内存使用合理，不会导致内存泄漏

### 扩展性验收标准
- [ ] 支持未来添加新的产品类型
- [ ] 支持未来添加新的计算策略
- [ ] 计算引擎接口清晰，便于扩展

---

## 注意事项

### 常见问题
1. **产品规则解析失败**
   - 确保产品定义格式正确
   - 提供规则验证机制

2. **计算逻辑错误**
   - 确保时间窗口计算正确
   - 确保阈值判断逻辑正确

3. **性能问题**
   - 使用增量计算，只计算新增时间窗口
   - 考虑使用Web Worker进行复杂计算

### 技术难点
- **时间窗口滑动计算**：需要正确处理时间边界和累计逻辑
- **多产品类型支持**：需要设计可扩展的计算策略
- **结果格式化**：需要生成多种格式的数据（事件列表、统计信息、可视化数据）

### 扩展性考虑
- 计算策略可以注册到引擎的策略注册表中
- 支持自定义计算函数（通过配置或插件方式）
- **当前范围**：仅实现产品级的风险事件触发条件计算
- **未来扩展**：预留保单级计算接口（用于赔付金额、赔付频率等保单级规则计算）

---

## 下一步

### 后续步骤的准备工作
- 计算引擎核心已实现，可以在步骤08中实现具体产品配置
- 计算逻辑已实现，可以在步骤09中实现协同机制

### 数据/接口的传递
- 风险事件数据通过`RiskEvent[]`类型传递给地图组件
- 统计信息通过`RiskStatistics`类型传递给数据面板

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
