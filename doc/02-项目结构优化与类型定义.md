# 02-项目结构优化与类型定义

## 步骤概述

### 步骤编号和名称
**步骤02**：项目结构优化与类型定义

### 步骤目标
优化项目结构，定义核心类型和接口，为后续开发提供统一的类型系统和代码组织基础，确保代码的可维护性和扩展性。

### 预期成果
- 项目结构清晰，符合最佳实践
- 核心类型定义完整，覆盖主要数据模型
- 接口定义清晰，便于模块间协作
- 类型系统统一，减少类型错误
- 为后续步骤提供类型支持

---

## 前置条件

### 依赖的步骤
- **无**（类型定义是基础工作，不依赖其他步骤）

**说明**：
- 类型定义可以使用TypeScript的类型声明文件（如`@types/google.maps`），不需要实际加载Google Maps API
- 项目结构优化是基础工作，应该在开发初期完成
- 步骤02和步骤03可以并行开发，或者步骤02先于步骤03完成

### 需要完成的前置工作
- 了解现有项目结构
- 了解需求文档中的数据类型需求
- 了解技术方案中的接口设计
- 安装TypeScript类型声明包（如`@types/google.maps`，如果需要）

### 需要的数据/接口
- 现有项目代码：`Next-gen-index/src/`目录
- 需求文档：数据类型和接口需求
- 技术方案：接口设计规范
- TypeScript类型声明包：`@types/google.maps`（用于Google Maps类型定义）

---

## 实现要点

### 核心功能点

1. **项目结构优化**
   - 检查现有目录结构
   - 创建必要的目录（如果需要）
   - 组织代码文件，确保结构清晰
   - 建立代码组织规范

2. **核心类型定义**
   - 区域相关类型：`Region`、`AdministrativeRegion`
   - 数据相关类型：`WeatherData`、`RegionData`、`DateRange`、`WeatherType`、`DataType`
   - 产品相关类型：`Product`、`RiskRule`、`PayoutRule`、`Threshold`
   - 风险相关类型：`RiskEvent`、`RiskStatistics`
   - 地图相关类型：地图配置、图层配置

3. **接口定义**
   - 数据生成器接口：`WeatherDataGenerator`
   - 产品库接口：`ProductLibrary`
   - 计算引擎接口：`RiskCalculationEngine`
   - 地图服务接口：`MapService`

4. **类型扩展**
   - Google Maps类型扩展（如果需要）
   - 工具类型定义：`Nullable`、`Optional`等
   - 通用类型定义：`Result`、`AsyncResult`等

### 技术实现方案

#### 1. 类型定义文件组织
```typescript
// 伪代码示例
// src/types/
//   ├── region.ts          // 区域相关类型
//   ├── data.ts            // 数据相关类型
//   ├── product.ts         // 产品相关类型
//   ├── risk.ts            // 风险相关类型
//   ├── map.ts             // 地图相关类型
//   └── common.ts          // 通用类型
```

#### 2. 核心类型定义
```typescript
// 伪代码示例
// src/types/region.ts
export interface Region {
  country: string;
  province: string;
  district: string;
}

export interface AdministrativeRegion extends Region {
  center: { lat: number; lng: number };
  boundary: google.maps.LatLngLiteral[];
}

// src/types/data.ts
export type WeatherType = 'rainfall' | 'temperature' | 'wind' | 'humidity' | 'pressure' | 'snowfall';
export type DataType = 'historical' | 'predicted';

export interface WeatherData {
  date: string; // ISO格式
  value: number; // 数值（根据天气类型有不同的单位和含义）
  risk?: 'low' | 'medium' | 'high';
  weatherType?: WeatherType;
}

export interface RegionData {
  [districtName: string]: WeatherData[];
}

export interface DateRange {
  from: Date;
  to: Date;
  startHour: number; // 0-23
  endHour: number; // 0-23
}

// src/types/product.ts
export interface Product {
  id: string;
  name: string;
  type: 'daily' | 'weekly' | 'monthly';
  description: string;
  icon: string;
  riskRules: RiskRule; // 产品级的风险事件触发条件（用于计算）
  payoutRules?: PayoutRule; // 保单级的赔付原则（可选，仅用于教育展示，不参与计算）
}

export interface RiskRule {
  triggerType: 'daily' | 'weekly' | 'monthly';
  timeWindow: TimeWindowConfig;
  thresholds: Threshold[];
  calculation: CalculationConfig;
}

export interface PayoutRule {
  // 赔付频率限制（仅用于教育展示）
  frequencyLimit?: string; // 如 "once per day per policy", "once per month per policy"
  
  // 理赔额度百分比（仅用于教育展示，前端展示百分比数值）
  // tier 1: 20%, tier 2: 50%, tier 3: 100%
  payoutPercentages: {
    tier1: number; // 20
    tier2: number; // 50
    tier3: number; // 100
  };
}

// src/types/risk.ts
export interface RiskEvent {
  id: string;
  productId: string;
  region: Region;
  timestamp: Date;
  dataType: 'historical' | 'predicted'; // 数据类型：历史或预测
  weatherType: WeatherType; // 天气类型，对应产品的weatherType字段：'rainfall' | 'temperature' | 'wind' | 'humidity' | 'pressure' | 'snowfall'
  level: 'tier1' | 'tier2' | 'tier3'; // 对应阈值档位
  type: string;
  value: number; // 触发时的累计值
}

export interface RiskStatistics {
  total: number;
  byLevel: {
    tier1: number;
    tier2: number;
    tier3: number;
  };
  severity: 'low' | 'medium' | 'high' | 'none' | '-';
}
```

#### 3. 接口定义
```typescript
// 伪代码示例
// src/interfaces/dataGenerator.ts
export interface WeatherDataGenerator {
  generate(
    region: Region,
    dateRange: DateRange,
    dataType: DataType,
    weatherType: WeatherType
  ): RegionData;
}

// src/interfaces/productLibrary.ts
export interface ProductLibrary {
  getProduct(id: string): Product | null;
  getProductsByType(type: string): Product[];
  getAllProducts(): Product[];
}

// src/interfaces/riskCalculation.ts
export interface RiskCalculationEngine {
  calculateRiskEvents(
    product: Product,
    region: Region,
    dateRange: DateRange,
    weatherData: WeatherData[]
  ): RiskEvent[];
}
```

### 关键代码结构

#### 类型定义模块
```typescript
// 伪代码示例
// src/types/index.ts
export * from './region';
export * from './data';
export * from './product';
export * from './risk';
export * from './map';
export * from './common';
```

---

## 输入输出

### 输入
- **现有代码**：`Next-gen-index/src/`目录下的代码
- **需求文档**：数据类型和接口需求
- **技术方案**：接口设计规范

### 输出
- **类型定义文件**：`src/types/`目录下的类型定义
- **接口定义文件**：`src/interfaces/`目录下的接口定义
- **优化的项目结构**：清晰的文件组织

---

## 验收标准

### 功能验收标准
- [ ] 项目结构清晰，符合最佳实践
- [ ] 核心类型定义完整，覆盖主要数据模型
- [ ] 接口定义清晰，便于模块间协作
- [ ] 类型系统统一，TypeScript编译无错误
- [ ] 类型定义与需求文档一致

### 代码质量验收标准
- [ ] 类型定义遵循TypeScript最佳实践
- [ ] 接口定义遵循SOLID原则
- [ ] 代码组织清晰，易于维护
- [ ] 类型注释完整，便于理解

### 扩展性验收标准
- [ ] 类型定义易于扩展
- [ ] 接口定义支持未来功能扩展
- [ ] 项目结构支持模块化开发

---

## 注意事项

### 常见问题
1. **类型定义不完整**
   - 确保覆盖所有主要数据模型
   - 确保类型定义与需求文档一致
   - 预留扩展字段（如果需要）

2. **类型错误**
   - 确保TypeScript编译无错误
   - 确保类型定义与实际使用一致
   - 使用类型检查工具验证

3. **接口设计不合理**
   - 遵循SOLID原则
   - 确保接口职责单一
   - 考虑未来扩展需求

### 技术难点
- **类型系统设计**：需要平衡完整性和灵活性
- **接口抽象**：需要设计清晰的接口抽象
- **类型扩展**：需要支持Google Maps等第三方库的类型

### 扩展性考虑
- 类型定义可以扩展，支持未来添加新字段
- 接口定义可以扩展，支持未来添加新方法
- 项目结构可以扩展，支持未来添加新模块

---

## 下一步

### 后续步骤的准备工作
- 类型定义已完善，可以在步骤04中使用进行数据生成
- 接口定义已完善，可以在步骤06和步骤07中使用
- 类型定义可以在步骤03中使用，为Google Maps API配置提供类型支持

### 数据/接口的传递
- 类型定义通过TypeScript类型系统传递给所有模块
- 接口定义通过接口文件提供给实现模块

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
