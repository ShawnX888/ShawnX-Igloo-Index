# 阶段五：问题修复 - 风险事件数量不一致

## 问题描述
Weekly Accumulation 产品的风险事件数量显示不一致：
1. 地图上的 marker 显示 6 个 ✅
2. Risk Analysis 的时间表显示 6 个（17 Dec to 22 Dec）✅
3. 统计汇总显示 8 个 ❌
4. 风险叠加显示 8 个 ❌

## 问题分析

### 根本原因

1. **统计汇总显示 8 个**
   - `detailedStatistics` 在 `useRiskAnalysis.ts` 中重新计算了风险事件
   - 使用了 `riskService.calculateRiskStatistics`，该方法会重新调用 `calculateRiskEvents`
   - 传入的是原始数据 `allRegionsWeatherData[selectedRegion.district]`，而不是已过滤的 `riskEvents`
   - 因此会包含扩展时间范围内的事件（14个），但只显示在用户选择的时间窗口内的事件（6个）
   - 实际上，`calculateRiskStatistics` 会重新计算所有事件，包括扩展时间范围内的，所以得到8个事件

2. **风险叠加显示 8 个**
   - `analysisData` 中的 `isTriggered` 计算基于 `triggeredThreshold`，而不是 `matchingEvent`
   - `triggeredThreshold` 是基于扩展数据计算的，可能包含不在用户选择的时间窗口内的事件
   - 而 `matchingEvent` 来自 `riskEvents`，已经过滤到用户选择的时间窗口内

### 数据流分析

```
扩展数据计算（14个事件在扩展时间范围内）
  ↓
useRiskAnalysis 计算所有事件（14个）
  ↓
过滤到用户选择的时间窗口（6个）→ riskEvents ✅
  ↓
mapMarkersData 使用过滤后的事件（6个）✅
  ↓
detailedStatistics 重新计算（使用原始数据）→ 8个 ❌
  ↓
analysisData 使用 triggeredThreshold（基于扩展数据）→ 8个 ❌
```

## 修复方案

### 修复 1：detailedStatistics 使用已过滤的 riskEvents

**文件**: `Next-gen-index/src/hooks/useRiskAnalysis.ts`

**修改前**:
```typescript
return riskService.calculateRiskStatistics(
  selectedProduct.id,
  selectedRegion,
  dateRange,
  allRegionsWeatherData[selectedRegion.district] || []
);
```

**修改后**:
```typescript
// 直接使用已经过滤好的 riskEvents 来计算统计信息
// 这样可以确保统计信息与显示的风险事件列表一致
return riskService.calculationEngine.calculateRiskStatistics(riskEvents);
```

**说明**:
- `calculateRiskStatistics` 方法接收 `RiskEvent[]` 作为参数
- 直接使用已经过滤好的 `riskEvents`，确保统计信息与显示的风险事件列表一致

### 修复 2：analysisData 使用 matchingEvent 判断 isTriggered

**文件**: `Next-gen-index/src/components/home/DataDashboard.tsx`

**修改前** (hourly, daily/weekly, monthly):
```typescript
const triggeredThreshold = thresholds.find(t => checkThreshold(calculatedValue, t.value));
const isTriggered = !!triggeredThreshold;
```

**修改后**:
```typescript
// IMPORTANT: isTriggered should be based on matchingEvent, not just threshold check
// This ensures that only events within the user-selected time window are marked as triggered
// The matchingEvent is already filtered to the user's dateRange in riskEvents
const isTriggered = !!matchingEvent;
```

**说明**:
- `matchingEvent` 来自 `findMatchingRiskEvent`，它查找 `riskEvents` 中匹配的事件
- `riskEvents` 已经过滤到用户选择的时间窗口内
- 因此 `isTriggered` 应该基于 `matchingEvent`，而不是 `triggeredThreshold`

## 修复验证

### 预期结果
修复后，所有显示的风险事件数量应该一致：
- ✅ 地图上的 marker：6 个
- ✅ Risk Analysis 的时间表：6 个
- ✅ 统计汇总：6 个（修复后）
- ✅ 风险叠加：6 个（修复后）

### 验证步骤
1. 选择 Weekly Accumulation 产品
2. 检查地图上的 marker 数量
3. 检查 Risk Analysis 时间表的事件数量
4. 检查统计汇总中的 Risk Events 数量
5. 检查风险叠加图中的触发点数量

## 修复文件清单

1. `Next-gen-index/src/hooks/useRiskAnalysis.ts`
   - 修改 `detailedStatistics` 计算逻辑，使用已过滤的 `riskEvents`

2. `Next-gen-index/src/components/home/DataDashboard.tsx`
   - 修改 `analysisData` 中的 `isTriggered` 计算逻辑（hourly, daily/weekly, monthly）

## 注意事项

1. **数据一致性**
   - 所有显示的风险事件数量应该基于同一个数据源：已过滤的 `riskEvents`
   - 这确保了用户界面的一致性

2. **扩展数据的作用**
   - 扩展数据仍然用于计算（确保时间窗口起始位置的计算准确性）
   - 但显示时只显示用户选择的时间窗口内的事件

3. **性能考虑**
   - 修复后，`detailedStatistics` 不再重新计算事件，而是直接使用已计算的 `riskEvents`
   - 这提高了性能，并确保了一致性

---

**文档版本**：v1.0  
**创建日期**：2025-12-18  
**修复状态**：✅ 已修复

