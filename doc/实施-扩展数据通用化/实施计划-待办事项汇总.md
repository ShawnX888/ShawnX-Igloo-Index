# 实施计划：待办事项汇总

## 📊 总体进度

- ✅ **已完成**：阶段一、阶段二、阶段三、阶段四（核心功能实现）
- 🟡 **进行中**：阶段五（测试与验证）
- ⏳ **未开始**：阶段六（文档更新）

---

## 🟡 阶段五：测试与验证（进行中）

**测试状态**：🟢 主要功能测试通过（浏览器自动化测试已完成）

**已完成**：
- ✅ 日志已开启并验证
- ✅ 浏览器自动化测试已完成（Daily Heavy Rain, Weekly Accumulation, Drought Defense）
- ✅ 三个产品的功能测试通过
- ✅ 所有发现的问题已修复（问题1-4）

**测试报告**：详见 `阶段五-测试报告.md` 和 `阶段五-浏览器测试报告.md`

---

### 步骤 5.1：功能测试 - 风险叠加示意图
**状态**：✅ 部分完成（浏览器测试已通过，详细测试用例待完成）

**已完成测试**：
- ✅ 基础功能：图表正常显示（三个产品都通过）
- ✅ 扩展时间范围验证：天级/周级/月级窗口扩展起始时刻为 00:00:00 UTC
- ✅ 小时级窗口：保持原有时刻

**待完成测试用例**：
- [ ] **起始位置验证**（详细测试）：
  - [ ] 图表第一个数据点的纵轴值计算正确（使用扩展数据回溯）
  - [ ] 不同产品类型（hourly/daily/weekly/monthly）都正确

**预期输出**：
- 测试报告 ✅（已有浏览器测试报告）
- 问题清单 ✅（已记录并修复）

---

### 步骤 5.2：功能测试 - 风险事件计算
**状态**：✅ 部分完成（浏览器测试已通过，详细测试用例待完成）

**已完成测试**：
- ✅ 基础功能：风险事件可以正常计算（三个产品都通过）
- ✅ 风险事件列表正确显示（Daily Heavy Rain: 24个，Weekly Accumulation: 6个，Drought Defense: 0个）
- ✅ 统计信息计算正确（已修复风险事件数量不一致问题）
- ✅ 结果过滤验证：风险事件列表只包含用户选择时间范围内的事件
- ✅ 地图标记数据正确（基于过滤后的风险事件）
- ✅ 时间窗口起始位置验证：使用扩展数据计算（日志验证通过）

**待完成测试用例**：
- [ ] **时间窗口起始位置验证**（详细测试）：
  - [ ] 不同产品类型都正确（需要更多测试场景）

**预期输出**：
- 测试报告 ✅（已有浏览器测试报告）
- 问题清单 ✅（已记录并修复）

**已修复的问题**：
- ✅ **过滤逻辑问题**：已修复 - 对于 daily/weekly/monthly 产品，使用日期范围比较；对于 hourly 产品，使用精确时间比较
  - 详见：`阶段五-问题修复-过滤逻辑优化.md`
- ✅ **事件时间戳问题**：已修复 - weekly 产品的事件时间戳使用窗口最后一个数据点的时间
  - 详见：`阶段五-问题修复-风险事件数量不一致.md`
- ✅ **风险事件数量不一致**：已修复 - `detailedStatistics` 和 `analysisData` 现在都使用已过滤的 `riskEvents`
  - 详见：`阶段五-问题修复-风险事件数量不一致.md`

---

### 步骤 5.3：边界测试
**状态**：🟡 进行中（部分验证通过，详细测试用例待完成）

**已完成验证**：
- ✅ **不同产品类型**（通过浏览器测试）：
  - ✅ hourly 产品：使用扩展的小时级数据（Daily Heavy Rain: 173条数据）
  - ✅ daily/weekly 产品：使用扩展的日级数据，起始时刻 00:00:00 UTC（Weekly Accumulation: 15条数据）
  - ✅ monthly 产品：使用扩展的日级数据，起始时刻 00:00:00 UTC（Drought Defense: 53条数据）

**待完成测试用例**：
- [ ] **无产品选择**：
  - [ ] 不获取扩展数据
  - [ ] 使用原始数据
  - [ ] 功能正常

- [ ] **扩展范围超出可用数据**：
  - [ ] 使用实际可用数据范围
  - [ ] 不报错
  - [ ] 功能正常

- [ ] **跨月/跨年**：
  - [ ] 时间计算正确
  - [ ] 不出现日期错误

**预期输出**：
- 测试报告 ⏳（部分完成）
- 问题清单 ✅（已记录并修复）

---

### 步骤 5.4：性能测试
**状态**：🟡 进行中（日志已开启，测试用例已定义）

**待完成测试用例**：
- [ ] **数据获取性能**：
  - [ ] 扩展数据获取时间在可接受范围内
  - [ ] 不影响页面加载性能

- [ ] **缓存机制**：
  - [ ] 缓存机制正常工作
  - [ ] 避免重复计算

- [ ] **内存使用**：
  - [ ] 内存使用合理
  - [ ] 不会导致内存泄漏

**预期输出**：
- 性能测试报告

---

### 步骤 5.5：集成测试
**状态**：✅ 部分完成（浏览器测试已验证，详细测试用例待完成）

**已完成验证**（通过浏览器测试）：
- ✅ **同时使用场景**：
  - ✅ 风险叠加示意图和风险事件计算同时使用扩展数据（三个产品都通过）
  - ✅ 两者使用相同的扩展数据源（日志验证通过）
  - ✅ 功能都正常（图表和事件列表都正常显示）

- ✅ **数据一致性**：
  - ✅ 两个场景使用的扩展数据一致（日志验证通过）
  - ✅ 计算结果一致（风险事件数量与图表显示一致）

**待完成测试用例**：
- [ ] **详细集成测试**：
  - [ ] 更多产品类型的集成测试
  - [ ] 不同时间范围的集成测试

**预期输出**：
- 集成测试报告 ✅（已有浏览器测试报告）

---

## ⏳ 阶段六：文档更新（未开始）

### 步骤 6.1：代码注释更新
**状态**：⏳ 未开始

**待完成操作**：
1. 更新 Hook 文件的注释，反映通用化用途
   - 文件：`src/hooks/useExtendedWeatherData.ts`
   - 确保注释说明该 Hook 用于风险叠加示意图和风险事件计算

2. 更新 `useRiskAnalysis` 的注释，说明使用扩展数据
   - 文件：`src/hooks/useRiskAnalysis.ts`
   - 说明扩展数据的使用场景和过滤逻辑

3. 更新相关组件的注释
   - 文件：`src/components/home/DataDashboard.tsx`
   - 确保注释反映使用通用 Hook 的变化

**预期输出**：
- 代码注释已更新

---

### 步骤 6.2：验证文档一致性
**状态**：⏳ 未开始

**待完成操作**：
1. 对照文档检查代码实现：
   - 扩展时间范围计算逻辑
   - 数据过滤逻辑
   - 使用场景说明

2. 检查以下文档是否需要更新：
   - `doc/补充-扩展数据获取方案.md`（已更新）
   - `doc/00-项目总览.md`（已更新）
   - `doc/07-风险计算引擎核心.md`（已更新）
   - `doc/20-图表可视化.md`（已更新）
   - `doc/补充-风险计算架构升级方案.md`（已更新）
   - `doc/说明-项目文件-功能&协作.md`（已更新）

3. 验证实施计划文档与实际实现的一致性

**预期输出**：
- 文档一致性报告

---

## 📋 验收标准

### 功能验收
- [x] 风险叠加示意图功能正常，纵轴值计算准确 ✅（浏览器测试通过）
- [x] 风险事件计算功能正常，时间窗口起始位置计算准确 ✅（浏览器测试通过）
- [x] 扩展时间范围计算正确（天级、周级、月级起始时刻为 00:00:00） ✅（浏览器测试验证）
- [x] 结果过滤正确（只包含用户选择时间范围内的事件） ✅（已修复并验证）

### 代码质量验收
- [x] 所有引用已更新为新的 Hook 名称 ✅（已完成）
- [x] 代码可以编译通过 ✅（已完成）
- [x] 没有 TypeScript 类型错误 ✅（已完成）
- [ ] 代码注释已更新 ⏳（待完成）

### 测试验收
- [x] 所有功能测试通过 ✅（浏览器自动化测试通过，详细测试用例部分完成）
- [ ] 所有边界测试通过 🟡（部分完成，待详细测试）
- [ ] 性能测试通过 🟡（进行中）
- [x] 集成测试通过 ✅（浏览器测试验证通过）

---

## 🎯 优先级建议

### 高优先级（必须完成）
1. ✅ **步骤 5.2：功能测试 - 风险事件计算** - **已完成**
   - ✅ 过滤逻辑已修复（日期范围比较 vs 精确时间比较）
   - ✅ 事件时间戳已修复
   - ✅ 风险事件数量不一致问题已修复
   - ⏳ 详细测试用例待完成

2. ✅ **步骤 5.1：功能测试 - 风险叠加示意图** - **部分完成**
   - ✅ 图表显示和计算正确（浏览器测试验证）
   - ⏳ 详细测试用例待完成

### 中优先级（建议完成）
3. **步骤 5.3：边界测试** - **部分完成**
   - ✅ 不同产品类型已验证
   - ⏳ 其他边界情况待测试
   - 确保边界情况处理正确
   - 避免生产环境出现问题

4. **步骤 6.1：代码注释更新** - **未开始**
   - 提高代码可维护性
   - 帮助其他开发者理解代码

### 低优先级（可选）
5. **步骤 5.4：性能测试** - **进行中**
   - 浏览器测试显示性能正常
   - 可以延后进行详细性能分析

6. ✅ **步骤 5.5：集成测试** - **已完成**
   - ✅ 浏览器测试验证通过
   - ✅ 两个场景协同工作正常

7. **步骤 6.2：验证文档一致性** - **未开始**
   - 文档已基本更新，主要是验证工作

---

## 📝 注意事项

1. **测试环境**：
   - ✅ 日志已开启并验证
   - ✅ 浏览器自动化测试已完成
   - ⏳ 详细测试用例待完成

2. **已修复的问题**：
   - ✅ **过滤逻辑**：已修复 - daily/weekly/monthly 产品使用日期范围比较，hourly 产品使用精确时间比较
   - ✅ **事件时间戳**：已修复 - weekly 产品使用窗口最后一个数据点的时间
   - ✅ **风险事件数量不一致**：已修复 - 所有显示都基于已过滤的 `riskEvents`
   - ✅ **viewMode 初始化**：已修复 - 根据产品类型自动初始化
   - ✅ **扩展数据回退逻辑**：已修复 - 增强错误处理和警告信息

3. **测试报告**：
   - ✅ 浏览器测试报告已完成：`阶段五-浏览器测试报告.md`
   - ✅ 测试报告已更新：`阶段五-测试报告.md`
   - ✅ 问题修复报告已完成：`阶段五-问题修复完成报告.md`
   - ✅ 问题记录已更新：`阶段五-问题记录.md`

4. **测试结果总结**：
   - ✅ **Daily Heavy Rain**：24个风险事件，扩展数据正确（173条小时级数据）
   - ✅ **Weekly Accumulation**：6个风险事件（过滤后），扩展数据正确（15条日级数据）
   - ✅ **Drought Defense**：0个风险事件，扩展数据正确（53条日级数据）

---

---

## 📊 最新更新（2025-12-18）

### 已完成的工作
1. ✅ **浏览器自动化测试**：三个产品（Daily Heavy Rain, Weekly Accumulation, Drought Defense）全部测试通过
2. ✅ **问题修复**：所有发现的问题（问题1-4）已修复
   - 问题1：风险计算引擎的 dateRange 参数使用
   - 问题2：缓存键设计（验证为正确，添加注释）
   - 问题3：viewMode 状态初始化
   - 问题4：扩展数据回退逻辑
3. ✅ **过滤逻辑优化**：根据产品类型使用不同的过滤方式
4. ✅ **风险事件数量一致性**：修复了统计汇总和风险叠加显示不一致的问题

### 待完成的工作
1. ⏳ **详细测试用例**：部分测试用例需要更详细的验证
2. ⏳ **边界测试**：无产品选择、扩展范围超出、跨月/跨年等场景
3. ⏳ **性能测试**：详细性能分析
4. ⏳ **代码注释更新**：更新 Hook 和组件的注释

---

**文档版本**：v1.1  
**创建日期**：2025-12-18  
**最后更新**：2025-12-18（根据阶段五测试报告和问题修复报告更新）

