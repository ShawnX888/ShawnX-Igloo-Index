# 实施计划：扩展数据获取通用化

## 目标
将扩展数据获取从仅用于风险叠加示意图，扩展为通用方案，既用于风险叠加示意图，又用于风险事件计算。

## 变更范围
- **Hook 重命名**：`useExtendedWeatherDataForOverlayChart` → `useExtendedWeatherData`
- **应用场景扩展**：风险叠加示意图 + 风险事件计算
- **扩展规则更新**：天级、周级窗口的扩展起始时刻统一为 00:00:00

---

## 阶段一：准备与清单（Preparation）

### 步骤 1.1：全面搜索和清单
**目标**：找出所有需要修改的文件和引用

**操作**：
1. 搜索代码库中所有 `useExtendedWeatherDataForOverlayChart` 的引用
2. 列出所有需要修改的文件清单：
   - Hook 文件本身
   - 使用该 Hook 的组件
   - 类型定义文件（如果有）
   - 测试文件（如果有）
   - 注释和文档字符串

**预期输出**：
- 文件清单（包含文件路径和行号）
- 引用统计（总数、按文件分类）

**验证点**：
- [ ] 所有引用都已找到
- [ ] 没有遗漏的文件

---

## 阶段二：Hook 重命名与通用化（Refactoring）✅ 已完成

**完成时间**：2025-12-18  
**完成报告**：详见 `阶段二-完成报告.md`

### 步骤 2.1：Hook 文件重命名 ✅
**目标**：重命名 Hook 文件，更新函数名和导出

**操作**：
1. 重命名文件：`src/hooks/useExtendedWeatherDataForOverlayChart.ts` → `src/hooks/useExtendedWeatherData.ts`
2. 更新文件内的函数名：`useExtendedWeatherDataForOverlayChart` → `useExtendedWeatherData`
3. 更新文件注释和文档字符串：
   - 从"为风险叠加示意图获取扩展的天气数据"
   - 改为"通用扩展数据获取 Hook，用于风险叠加示意图和风险事件计算"

**预期输出**：
- 文件已重命名
- 函数名已更新
- 注释已更新

**验证点**：
- [x] 文件重命名成功
- [x] 函数名更新正确
- [x] 注释反映通用化用途

**注意事项**：
- 这一步完成后，代码会暂时无法编译（因为引用还未更新）
- 需要快速完成后续步骤

---

### 步骤 2.2：更新扩展时间范围计算逻辑 ✅
**目标**：确保天级、周级窗口的扩展起始时刻为 00:00:00

**完成说明**：已验证当前实现已符合要求，天级、周级、月级窗口已对齐到 00:00:00 UTC

**操作**：
1. 检查当前扩展时间范围计算逻辑
2. 更新天级窗口计算：
   - 从 `subDays(dateRange.from, timeWindow.size)` 
   - 改为 `startOfDay(subDays(dateRange.from, timeWindow.size))`（确保 00:00:00）
3. 更新周级窗口计算：
   - 从 `subWeeks(dateRange.from, timeWindow.size)`
   - 改为 `startOfDay(subWeeks(dateRange.from, timeWindow.size))`（确保 00:00:00）
4. 验证月级窗口计算：
   - 确认已经是 `startOfMonth(dateRange.from)`（应该已经是 00:00:00）

**预期输出**：
- 扩展时间范围计算逻辑已更新
- 天级、周级、月级窗口的扩展起始时刻统一为 00:00:00

**验证点**：
- [x] 天级窗口扩展起始时刻为 00:00:00 UTC
- [x] 周级窗口扩展起始时刻为 00:00:00 UTC
- [x] 月级窗口扩展起始时刻为 00:00:00 UTC
- [x] 小时级窗口保持原有时刻（不强制 00:00:00）

**注意事项**：
- 需要导入 `startOfDay` 函数（如果尚未导入）
- 确保时间计算逻辑正确，避免时区问题

---

### 步骤 2.3：验证 Hook 接口通用性 ✅
**目标**：确保 Hook 的输入参数和输出接口适合两个使用场景

**完成说明**：已验证输入参数和输出接口适合两个使用场景，Hook 职责单一

**操作**：
1. 检查 Hook 的输入参数：
   - `selectedRegion`, `dateRange`, `dataType`, `weatherType`, `selectedProduct`
   - 确认这些参数适合两个使用场景
2. 检查 Hook 的输出：
   - `extendedHourlyData`, `extendedDailyData`, `extendedDateRange`
   - 确认输出格式适合两个使用场景
3. 验证 Hook 的职责：
   - 只负责获取扩展数据
   - 不涉及具体业务逻辑（风险计算、图表渲染等）

**预期输出**：
- Hook 接口已验证，适合通用化使用

**验证点**：
- [x] 输入参数适合两个使用场景
- [x] 输出格式适合两个使用场景
- [x] Hook 职责单一，不涉及业务逻辑

---

## 阶段三：集成到风险事件计算（Integration）✅ 已完成

**完成时间**：2025-12-18  
**完成报告**：详见 `阶段三-完成报告.md`

### 步骤 3.1：在 useRiskAnalysis 中导入 Hook ✅
**目标**：导入新的 Hook

**操作**：
1. 在 `src/hooks/useRiskAnalysis.ts` 中导入 `useExtendedWeatherData`
2. 移除或注释掉旧的天气数据获取逻辑（如果有）

**预期输出**：
- Hook 已导入

**验证点**：
- [x] 导入语句正确
- [x] 没有编译错误

---

### 步骤 3.2：在 useRiskAnalysis 中调用扩展数据获取 ✅
**目标**：使用扩展数据替代原始数据

**操作**：
1. 在 `useRiskAnalysis` 函数内部调用 `useExtendedWeatherData`
2. 传入正确的参数：
   - `selectedRegion`, `dateRange`, `dataType`, `weatherType`, `selectedProduct`
3. 获取扩展数据：
   - `extendedHourlyData`, `extendedDailyData`
4. 根据产品类型选择合适的扩展数据：
   - 小时级产品使用 `extendedHourlyData`
   - 日级/周级/月级产品使用 `extendedDailyData`

**预期输出**：
- `useRiskAnalysis` 内部已调用 `useExtendedWeatherData`
- 已获取扩展数据

**验证点**：
- [x] Hook 调用正确
- [x] 参数传递正确
- [x] 扩展数据已获取
- [x] 根据产品类型正确选择数据粒度

**注意事项**：
- 需要根据产品类型选择合适的数据粒度
- 确保只在有产品选择时获取扩展数据

---

### 步骤 3.3：使用扩展数据进行风险事件计算 ✅
**目标**：使用扩展数据计算风险事件

**操作**：
1. 找到风险事件计算的位置（调用 `RiskCalculationService` 的地方）
2. 将传入的天气数据从原始数据改为扩展数据
3. 确保计算逻辑使用扩展数据

**预期输出**：
- 风险事件计算使用扩展数据

**验证点**：
- [x] 计算使用扩展数据（选中区域）
- [x] 计算逻辑正确
- [x] 其他区域仍使用原始数据

**注意事项**：
- 确保扩展数据正确传递到计算服务
- 保持计算逻辑不变，只改变数据源

---

### 步骤 3.4：实现结果过滤逻辑 ✅
**目标**：过滤风险事件结果到用户选择的时间窗口

**操作**：
1. 在风险事件计算完成后，添加过滤逻辑
2. 过滤条件：只保留时间戳在 `dateRange.from` 到 `dateRange.to` 范围内的风险事件
3. 确保过滤后的结果用于：
   - `riskEvents` 输出
   - `mapMarkersData` 计算（如果需要）
   - `statistics` 计算

**预期输出**：
- 风险事件结果已过滤到用户选择的时间窗口

**验证点**：
- [x] 过滤逻辑正确
- [x] 只包含用户选择时间范围内的风险事件
- [x] 不影响其他输出（mapMarkersData, statistics）
- [x] 缓存机制正常工作

**注意事项**：
- 确保时间比较逻辑正确（考虑时区）
- 确保过滤不影响统计计算的准确性

---

## 阶段四：更新组件引用（Component Updates）✅ 已完成

**完成时间**：2025-12-18（在阶段二中完成）  
**完成说明**：DataDashboard 组件的更新已在阶段二步骤 2.1 中完成

### 步骤 4.1：更新 DataDashboard 组件 ✅
**目标**：更新风险叠加示意图组件中的 Hook 引用

**完成说明**：已在阶段二步骤 2.1 中完成

**操作**：
1. 在 `src/components/home/DataDashboard.tsx` 中：
   - 更新导入语句：`useExtendedWeatherDataForOverlayChart` → `useExtendedWeatherData`
   - 更新函数调用：`useExtendedWeatherDataForOverlayChart(...)` → `useExtendedWeatherData(...)`
2. 验证参数传递是否正确

**预期输出**：
- DataDashboard 组件已更新为使用新的 Hook 名称

**验证点**：
- [x] 导入语句已更新
- [x] 函数调用已更新
- [x] 参数传递正确

**注意事项**：
- 这一步完成后，代码应该可以编译通过
- 功能应该保持不变（风险叠加示意图）

---

### 步骤 4.2：检查其他可能的引用 ✅
**目标**：确保所有引用都已更新

**完成说明**：已在阶段一完成全面搜索，确认没有其他引用。在阶段四中修复了 TypeScript 类型错误。

**操作**：
1. 再次搜索代码库，确认没有遗漏的引用
2. 检查以下位置：
   - 其他组件文件
   - 类型定义文件
   - 测试文件
   - 工具函数文件

**预期输出**：
- 所有引用都已更新

**验证点**：
- [x] 没有遗漏的引用
- [x] 代码可以编译通过

---

## 阶段五：测试与验证（Testing）🟡 进行中

**开始时间**：2025-12-18  
**测试报告**：详见 `阶段五-测试报告.md`  
**状态**：日志已开启，测试用例已定义，待实际运行测试

### 步骤 5.1：功能测试 - 风险叠加示意图 🟡 进行中
**目标**：验证风险叠加示意图功能正常

**测试用例**：
1. **基础功能**：
   - [ ] 选择产品后，图表可以正常显示
   - [ ] 纵轴值计算正确
   - [ ] 图表只显示用户选择的时间窗口

2. **起始位置验证**：
   - [ ] 图表第一个数据点的纵轴值计算正确（使用扩展数据回溯）
   - [ ] 不同产品类型（hourly/daily/weekly/monthly）都正确

3. **扩展时间范围验证**：
   - [ ] 天级窗口：扩展起始时刻为 00:00:00
   - [ ] 周级窗口：扩展起始时刻为 00:00:00
   - [ ] 月级窗口：扩展起始时刻为 00:00:00
   - [ ] 小时级窗口：保持原有时刻

**预期输出**：
- 测试报告
- 问题清单（如果有）

---

### 步骤 5.2：功能测试 - 风险事件计算 🟡 进行中
**目标**：验证风险事件计算功能正常

**完成说明**：日志已开启，测试用例已定义。实际测试需要运行应用进行验证。

**测试用例**：
1. **基础功能**：
   - [ ] 选择产品后，风险事件可以正常计算
   - [ ] 风险事件列表正确显示
   - [ ] 统计信息计算正确

2. **时间窗口起始位置验证**：
   - [ ] 时间窗口起始位置的风险事件计算完整（使用扩展数据）
   - [ ] 不同产品类型都正确

3. **结果过滤验证**：
   - [ ] 风险事件列表只包含用户选择时间范围内的事件
   - [ ] 地图标记数据正确（基于过滤后的风险事件）
   - [ ] 统计信息正确（基于过滤后的风险事件）

**预期输出**：
- 测试报告
- 问题清单（如果有）

---

### 步骤 5.3：边界测试 🟡 进行中
**目标**：验证边界情况处理正确

**完成说明**：日志已开启，测试用例已定义。实际测试需要运行应用进行验证。

**测试用例**：
1. **无产品选择**：
   - [ ] 不获取扩展数据
   - [ ] 使用原始数据
   - [ ] 功能正常

2. **不同产品类型**：
   - [ ] hourly 产品：使用扩展的小时级数据
   - [ ] daily 产品：使用扩展的日级数据，起始时刻 00:00:00
   - [ ] weekly 产品：使用扩展的日级数据，起始时刻 00:00:00
   - [ ] monthly 产品：使用扩展的日级数据，起始时刻 00:00:00

3. **扩展范围超出可用数据**：
   - [ ] 使用实际可用数据范围
   - [ ] 不报错
   - [ ] 功能正常

4. **跨月/跨年**：
   - [ ] 时间计算正确
   - [ ] 不出现日期错误

**预期输出**：
- 测试报告
- 问题清单（如果有）

---

### 步骤 5.4：性能测试 🟡 进行中
**目标**：验证扩展数据获取不影响性能

**完成说明**：日志已开启，测试用例已定义。实际测试需要运行应用进行验证。

**测试用例**：
1. **数据获取性能**：
   - [ ] 扩展数据获取时间在可接受范围内
   - [ ] 不影响页面加载性能

2. **缓存机制**：
   - [ ] 缓存机制正常工作
   - [ ] 避免重复计算

3. **内存使用**：
   - [ ] 内存使用合理
   - [ ] 不会导致内存泄漏

**预期输出**：
- 性能测试报告

---

### 步骤 5.5：集成测试 🟡 进行中
**目标**：验证两个使用场景协同工作

**完成说明**：日志已开启，测试用例已定义。实际测试需要运行应用进行验证。

**测试用例**：
1. **同时使用场景**：
   - [ ] 风险叠加示意图和风险事件计算同时使用扩展数据
   - [ ] 两者使用相同的扩展数据源
   - [ ] 功能都正常

2. **数据一致性**：
   - [ ] 两个场景使用的扩展数据一致
   - [ ] 计算结果一致

**预期输出**：
- 集成测试报告

---

## 阶段六：文档更新（Documentation）

### 步骤 6.1：代码注释更新
**目标**：更新代码中的注释和文档字符串

**操作**：
1. 更新 Hook 文件的注释，反映通用化用途
2. 更新 `useRiskAnalysis` 的注释，说明使用扩展数据
3. 更新相关组件的注释

**预期输出**：
- 代码注释已更新

---

### 步骤 6.2：验证文档一致性
**目标**：确保代码实现与文档一致

**操作**：
1. 对照文档检查代码实现：
   - 扩展时间范围计算逻辑
   - 数据过滤逻辑
   - 使用场景说明

**预期输出**：
- 文档一致性报告

---

## 实施顺序总结

```
阶段一：准备与清单
  └─ 步骤 1.1：全面搜索和清单

阶段二：Hook 重命名与通用化
  ├─ 步骤 2.1：Hook 文件重命名
  ├─ 步骤 2.2：更新扩展时间范围计算逻辑
  └─ 步骤 2.3：验证 Hook 接口通用性

阶段三：集成到风险事件计算
  ├─ 步骤 3.1：在 useRiskAnalysis 中导入 Hook
  ├─ 步骤 3.2：在 useRiskAnalysis 中调用扩展数据获取
  ├─ 步骤 3.3：使用扩展数据进行风险事件计算
  └─ 步骤 3.4：实现结果过滤逻辑

阶段四：更新组件引用
  ├─ 步骤 4.1：更新 DataDashboard 组件
  └─ 步骤 4.2：检查其他可能的引用

阶段五：测试与验证
  ├─ 步骤 5.1：功能测试 - 风险叠加示意图
  ├─ 步骤 5.2：功能测试 - 风险事件计算
  ├─ 步骤 5.3：边界测试
  ├─ 步骤 5.4：性能测试
  └─ 步骤 5.5：集成测试

阶段六：文档更新
  ├─ 步骤 6.1：代码注释更新
  └─ 步骤 6.2：验证文档一致性
```

---

## 风险评估与应对

### 风险 1：重命名导致编译错误
**风险等级**：中
**应对措施**：
- 步骤 2.1 和 4.1 需要快速连续完成
- 准备回滚方案（Git 分支）

### 风险 2：扩展数据计算逻辑错误
**风险等级**：高
**应对措施**：
- 仔细验证步骤 2.2 的计算逻辑
- 添加单元测试验证扩展时间范围计算

### 风险 3：结果过滤逻辑错误
**风险等级**：高
**应对措施**：
- 仔细验证步骤 3.4 的过滤逻辑
- 添加测试用例验证过滤结果

### 风险 4：性能影响
**风险等级**：低
**应对措施**：
- 步骤 5.4 进行性能测试
- 如有问题，优化缓存机制

---

## 验收标准

### 功能验收
- [ ] 风险叠加示意图功能正常，纵轴值计算准确
- [ ] 风险事件计算功能正常，时间窗口起始位置计算准确
- [ ] 扩展时间范围计算正确（天级、周级、月级起始时刻为 00:00:00）
- [ ] 结果过滤正确（只包含用户选择时间范围内的事件）

### 代码质量验收
- [ ] 所有引用已更新为新的 Hook 名称
- [ ] 代码可以编译通过
- [ ] 没有 TypeScript 类型错误
- [ ] 代码注释已更新

### 测试验收
- [ ] 所有功能测试通过
- [ ] 所有边界测试通过
- [ ] 性能测试通过
- [ ] 集成测试通过

---

**文档版本**：v1.0  
**创建日期**：2025-12-18  
**最后更新**：2025-12-18

