# 13-风险事件标记图层

## 步骤概述

### 步骤编号和名称
**步骤13**：风险事件标记图层

### 步骤目标
实现历史风险事件和预测风险事件的标记图层，使用Advanced Markers创建圆形标记，根据风险事件数量动态调整大小和颜色，实现动画效果，支持选中区域显示事件数量。

### 预期成果
- 历史风险事件标记图层可以正常显示
- 预测风险事件标记图层可以正常显示
- 标记大小和颜色根据事件数量动态调整
- 动画效果正确实现（风险从无到有的态势）
- 选中区域在标记中心显示事件数量

---

## 前置条件

### 依赖的步骤
- **步骤10**：地图容器替换（需要地图实例）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- 地图实例已创建
- 风险计算引擎可以正确计算风险事件
- 风险事件数据格式已定义

### 需要的数据/接口
- 地图实例：`google.maps.Map`类型
- 风险事件数据：`RiskEvent[]`类型（从计算引擎获取）
- 区域信息：`AdministrativeRegion[]`类型
- 选中区域：`Region`类型

---

## 实现要点

### 核心功能点

1. **图层3：历史风险事件标记**
   - 使用Advanced Markers创建圆形标记
   - 根据历史风险事件数量设置标记大小和颜色
   - 使用红色系（#ef4444）表示历史风险
   - 仅在选中产品时显示

2. **图层4：预测风险事件标记**
   - 使用相同的技术实现
   - 使用橙色系（#f97316）表示预测风险
   - 仅在选中产品时显示

3. **标记大小和颜色计算**
   - 标记大小：根据事件数量计算，范围15-40px
   - 标记颜色：根据事件数量计算透明度，范围0.3-0.8
   - 计算公式：`size = 15 + (count / maxCount) * 25`
   - 计算公式：`opacity = 0.3 + (count / maxCount) * 0.5`

4. **动画效果实现**
   - 使用Framer Motion或CSS动画
   - 动画效果：风险从无到有的态势反复播放
   - 动画参数：scale从0到1.1再到1，opacity从0到目标值
   - 动画时长：2.5秒，无限循环

5. **事件数量显示**
   - 仅在选中区域显示事件数量
   - 显示在标记中心
   - 文本样式：白色、加粗、带阴影

### 技术实现方案

有关地图标记使用中心化聚合数据的详细方案，请参阅：[风险计算架构升级方案](./补充-风险计算架构升级方案.md)

#### 1. 使用 mapMarkersData
地图图层不再从原始事件列表 `riskEvents` 中进行过滤和计数，而是直接使用由 `useRiskAnalysis` Hook 预先聚合好的 `mapMarkersData`。

- **不分级统计**：`mapMarkersData` 仅包含每个行政区域的风险事件总数。
- **动态样式**：标记的大小和透明度依然根据 `count / maxCount` 计算，但数据来源更纯净。

```typescript
// 伪代码示例
function RiskEventMarkersLayer({
  map,
  mapMarkersData, // 直接接收聚合后的数据
  selectedRegion,
  dataType,
  selectedProduct
}: MarkersLayerProps) {
  useEffect(() => {
    if (!map || !selectedProduct || mapMarkersData.length === 0) {
      // 清除标记逻辑...
      return;
    }
    
    // 直接遍历聚合数据进行渲染
    const markers = mapMarkersData.map(risk => {
      const count = risk.events;
      if (count === 0) return null;
      // ... 渲染逻辑
    });
  }, [map, mapMarkersData, selectedRegion, dataType, selectedProduct]);
}
```

### 关键代码结构

#### 风险事件标记图层组件
```typescript
// 伪代码示例
function RiskEventMarkersLayer({
  map,
  regions,
  riskEvents,
  selectedRegion,
  dataType,
  selectedProduct
}: MarkersLayerProps) {
  // 标记创建和管理逻辑
  // 动画效果实现
  // 事件数量显示
}
```

---

## 输入输出

### 输入
- **地图实例**：`google.maps.Map` 类型
- **聚合风险数据 (来自中心化 Hook)**：`mapMarkersData`: `RiskData[]` (包含各行政区事件总数)
- **展示参数**：`dataType` (历史/预测)、`selectedProduct` (仅在有产品时显示)
- **交互参数**：`selectedRegion` (用于标记选中态)

### 输出
- **交互式图层**：在地图上渲染的带动画的 Advanced Markers
- **视觉反馈**：通过标记大小和透明度展示风险密集度

---

## 验收标准

### 功能验收标准
- [ ] 历史风险事件标记可以正常显示
- [ ] 预测风险事件标记可以正常显示
- [ ] 标记仅在选中产品时显示
- [ ] 标记大小和颜色根据事件数量动态调整
- [ ] 动画效果正确实现（风险从无到有的态势）
- [ ] 选中区域在标记中心显示事件数量

### 视觉验收标准
- [ ] 历史数据使用红色系（#ef4444）
- [ ] 预测数据使用橙色系（#f97316）
- [ ] 标记大小合理，易于识别
- [ ] 动画效果流畅自然
- [ ] 事件数量文本清晰可读

### 性能验收标准
- [ ] 标记创建时间在1秒内
- [ ] 标记更新流畅，无明显卡顿
- [ ] 动画性能良好，不影响地图交互

---

## 注意事项

### 常见问题
1. **标记不显示**
   - 确保仅在选中产品时创建标记
   - 确保风险事件数据正确
   - 确保区域中心点坐标正确

2. **动画效果不流畅**
   - 使用CSS动画或Framer Motion
   - 确保使用GPU加速（transform、opacity）
   - 限制同时播放的动画数量

3. **标记大小计算不准确**
   - 确保计算公式正确
   - 确保最大事件数量参考值合理

### 技术难点
- **Advanced Markers使用**：需要正确使用新的Advanced Markers API
- **动画效果实现**：需要实现流畅的动画效果
- **标记管理**：需要正确管理标记的生命周期

### 扩展性考虑
- 标记图层实现可以提取为独立组件，便于复用
- 动画效果可以配置化，便于调整
- 支持未来添加更多标记类型

---

## 下一步

### 后续步骤的准备工作
- 风险事件标记图层已实现，可以在步骤14中使用图层控制功能
- 标记实例已创建，可以在步骤20中使用进行图表可视化

### 数据/接口的传递
- 风险事件数据通过`RiskEvent[]`类型传递给标记图层
- 标记可见性通过props控制

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
