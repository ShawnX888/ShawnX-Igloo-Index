# 13-风险事件标记图层

## 步骤概述

### 步骤编号和名称
**步骤13**：风险事件标记图层

### 步骤目标
实现历史风险事件和预测风险事件的标记图层，使用Advanced Markers创建圆形标记，根据风险事件数量动态调整大小和颜色，实现动画效果，支持选中区域显示事件数量。

### 预期成果
- 历史风险事件标记图层可以正常显示
- 预测风险事件标记图层可以正常显示
- 标记大小和颜色根据事件数量动态调整
- 动画效果正确实现（风险从无到有的态势）
- 选中区域在标记中心显示事件数量

---

## 前置条件

### 依赖的步骤
- **步骤10**：地图容器替换（需要地图实例）
- **步骤09**：产品库与计算引擎协同（需要风险事件数据）

### 需要完成的前置工作
- 地图实例已创建
- 风险计算引擎可以正确计算风险事件
- 风险事件数据格式已定义

### 需要的数据/接口
- 地图实例：`google.maps.Map`类型
- 风险事件数据：`RiskEvent[]`类型（从计算引擎获取）
- 区域信息：`AdministrativeRegion[]`类型
- 选中区域：`Region`类型

---

## 实现要点

### 核心功能点

1. **图层3：历史风险事件标记**
   - 使用Advanced Markers创建圆形标记
   - 根据历史风险事件数量设置标记大小和颜色
   - 使用红色系（#ef4444）表示历史风险
   - 仅在选中产品时显示

2. **图层4：预测风险事件标记**
   - 使用相同的技术实现
   - 使用橙色系（#f97316）表示预测风险
   - 仅在选中产品时显示

3. **标记大小和颜色计算**
   - 标记大小：根据事件数量计算，范围15-40px
   - 标记颜色：根据事件数量计算透明度，范围0.3-0.8
   - 计算公式：`size = 15 + (count / maxCount) * 25`
   - 计算公式：`opacity = 0.3 + (count / maxCount) * 0.5`

4. **动画效果实现**
   - 使用Framer Motion或CSS动画
   - 动画效果：风险从无到有的态势反复播放
   - 动画参数：scale从0到1.1再到1，opacity从0到目标值
   - 动画时长：2.5秒，无限循环

5. **事件数量显示**
   - 仅在选中区域显示事件数量
   - 显示在标记中心
   - 文本样式：白色、加粗、带阴影

### 技术实现方案

#### 1. Advanced Markers创建
```typescript
// 伪代码示例
const marker = new google.maps.marker.AdvancedMarkerElement({
  map: map,
  position: { lat: region.center.lat, lng: region.center.lng },
  content: createMarkerContent(count, isSelected),
});

function createMarkerContent(count: number, isSelected: boolean): HTMLElement {
  const div = document.createElement('div');
  div.className = 'risk-marker';
  
  // 计算大小和颜色
  const size = 15 + (count / 20) * 25;
  const opacity = 0.3 + (count / 20) * 0.5;
  
  div.style.width = `${size}px`;
  div.style.height = `${size}px`;
  div.style.borderRadius = '50%';
  div.style.backgroundColor = baseColor;
  div.style.opacity = opacity.toString();
  div.style.animation = 'risk-emerge 2.5s ease-out infinite';
  
  // 如果选中，显示事件数量
  if (isSelected) {
    const text = document.createElement('span');
    text.textContent = `${count} Events`;
    text.className = 'risk-marker-text';
    div.appendChild(text);
  }
  
  return div;
}
```

#### 2. 动画CSS
```css
/* 伪代码示例 */
@keyframes risk-emerge {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  50% {
    transform: scale(1.1);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 0.8;
  }
}

.risk-marker {
  animation: risk-emerge 2.5s ease-out infinite;
}
```

#### 3. 标记管理
```typescript
// 伪代码示例
function RiskEventMarkersLayer({
  map,
  regions,
  riskEvents,
  selectedRegion,
  rainfallType,
  selectedProduct
}: MarkersLayerProps) {
  const markersRef = useRef<google.maps.marker.AdvancedMarkerElement[]>([]);

  useEffect(() => {
    if (!map || !selectedProduct) {
      // 清除所有标记
      markersRef.current.forEach(marker => marker.map = null);
      markersRef.current = [];
      return;
    }

    // 计算每个区域的风险事件数量
    const regionCounts = calculateRegionCounts(regions, riskEvents);
    
    // 创建标记
    const markers = regions.map(region => {
      const count = regionCounts[region.district] || 0;
      if (count === 0) return null;
      
      const isSelected = selectedRegion.district === region.district;
      const baseColor = rainfallType === 'historical' ? '#ef4444' : '#f97316';
      
      return createRiskMarker(
        map,
        region,
        count,
        isSelected,
        baseColor
      );
    }).filter(Boolean);

    markersRef.current = markers;

    return () => {
      markers.forEach(marker => marker.map = null);
    };
  }, [map, regions, riskEvents, selectedRegion, rainfallType, selectedProduct]);

  return null;
}
```

### 关键代码结构

#### 风险事件标记图层组件
```typescript
// 伪代码示例
function RiskEventMarkersLayer({
  map,
  regions,
  riskEvents,
  selectedRegion,
  rainfallType,
  selectedProduct
}: MarkersLayerProps) {
  // 标记创建和管理逻辑
  // 动画效果实现
  // 事件数量显示
}
```

---

## 输入输出

### 输入
- **地图实例**：`google.maps.Map`类型
- **区域数据**：`AdministrativeRegion[]`类型
- **风险事件数据**：`RiskEvent[]`类型
- **选中区域**：`Region`类型
- **数据类型**：`RainfallType`（"historical" | "predicted"）
- **选中产品**：`Product | null`类型

### 输出
- **风险事件标记图层**：显示在地图上的Advanced Markers
- **标记实例列表**：`AdvancedMarkerElement[]`类型（用于后续控制）

---

## 验收标准

### 功能验收标准
- [ ] 历史风险事件标记可以正常显示
- [ ] 预测风险事件标记可以正常显示
- [ ] 标记仅在选中产品时显示
- [ ] 标记大小和颜色根据事件数量动态调整
- [ ] 动画效果正确实现（风险从无到有的态势）
- [ ] 选中区域在标记中心显示事件数量

### 视觉验收标准
- [ ] 历史数据使用红色系（#ef4444）
- [ ] 预测数据使用橙色系（#f97316）
- [ ] 标记大小合理，易于识别
- [ ] 动画效果流畅自然
- [ ] 事件数量文本清晰可读

### 性能验收标准
- [ ] 标记创建时间在1秒内
- [ ] 标记更新流畅，无明显卡顿
- [ ] 动画性能良好，不影响地图交互

---

## 注意事项

### 常见问题
1. **标记不显示**
   - 确保仅在选中产品时创建标记
   - 确保风险事件数据正确
   - 确保区域中心点坐标正确

2. **动画效果不流畅**
   - 使用CSS动画或Framer Motion
   - 确保使用GPU加速（transform、opacity）
   - 限制同时播放的动画数量

3. **标记大小计算不准确**
   - 确保计算公式正确
   - 确保最大事件数量参考值合理

### 技术难点
- **Advanced Markers使用**：需要正确使用新的Advanced Markers API
- **动画效果实现**：需要实现流畅的动画效果
- **标记管理**：需要正确管理标记的生命周期

### 扩展性考虑
- 标记图层实现可以提取为独立组件，便于复用
- 动画效果可以配置化，便于调整
- 支持未来添加更多标记类型

---

## 下一步

### 后续步骤的准备工作
- 风险事件标记图层已实现，可以在步骤14中使用图层控制功能
- 标记实例已创建，可以在步骤20中使用进行图表可视化

### 数据/接口的传递
- 风险事件数据通过`RiskEvent[]`类型传递给标记图层
- 标记可见性通过props控制

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
