# 14-图层控制功能

## 步骤概述

### 步骤编号和名称
**步骤14**：图层控制功能

### 步骤目标
实现图层控制UI，支持开启/关闭各个数据图层（历史/预测降雨量热力图、风险事件标记），根据数据类型和产品选择动态显示可操作的图层，UI设计参考Google Maps。

### 预期成果
- 图层控制UI可以正常显示和交互
- 历史/预测降雨量图层可以开启/关闭
- 风险事件图层可以开启/关闭
- 根据数据类型动态显示可操作的图层
- 根据产品选择动态显示风险事件图层
- UI设计符合Google Maps风格

---

## 前置条件

### 依赖的步骤
- **步骤12**：降雨量热力图图层（需要图层实例）
- **步骤13**：风险事件标记图层（需要图层实例）

### 需要完成的前置工作
- 热力图图层已实现
- 风险事件标记图层已实现
- 图层实例可以控制可见性

### 需要的数据/接口
- 图层实例：热力图图层和标记图层的实例
- 数据类型：`RainfallType`（"historical" | "predicted"）
- 选中产品：`Product | null`类型
- 图层可见性状态：`boolean`类型

---

## 实现要点

### 核心功能点

1. **图层控制UI**
   - 使用Popover组件创建图层控制菜单
   - 圆形按钮触发，位于地图右下角（或根据输入模式调整位置）
   - UI设计参考Google Maps的图层控制样式

2. **图层开关功能**
   - 历史降雨量图层：可以开启/关闭
   - 预测降雨量图层：可以开启/关闭
   - 风险事件图层：可以开启/关闭
   - 开关状态有清晰的视觉反馈

3. **动态显示逻辑**
   - 历史数据模式：仅"Historical Rainfall"可操作
   - 预测数据模式：仅"Predicted Rainfall"可操作
   - 风险事件图层：仅在选中产品时可用
   - 不可操作的图层显示为禁用状态

4. **图层状态管理**
   - 使用useState管理图层可见性状态
   - 状态变更时更新图层实例的可见性
   - 状态与图层实例同步

### 技术实现方案

#### 1. 图层控制UI组件
```typescript
// 伪代码示例
function LayerControls({
  layers,
  setLayers,
  rainfallType,
  selectedProduct
}: LayerControlsProps) {
  return (
    <Popover>
      <PopoverTrigger asChild>
        <button className="layer-control-button">
          <Layers className="w-5 h-5" />
        </button>
      </PopoverTrigger>
      <PopoverContent>
        <h4>Map Layers</h4>
        
        {/* Historical Rainfall */}
        <LayerToggle
          label="Historical Rainfall"
          enabled={rainfallType === 'historical'}
          checked={layers.heatmap && rainfallType === 'historical'}
          onChange={(checked) => {
            if (rainfallType === 'historical') {
              setLayers(prev => ({ ...prev, heatmap: checked }));
            }
          }}
        />
        
        {/* Predicted Rainfall */}
        <LayerToggle
          label="Predicted Rainfall"
          enabled={rainfallType === 'predicted'}
          checked={layers.heatmap && rainfallType === 'predicted'}
          onChange={(checked) => {
            if (rainfallType === 'predicted') {
              setLayers(prev => ({ ...prev, heatmap: checked }));
            }
          }}
        />
        
        {/* Risk Events */}
        <LayerToggle
          label="Risk Events"
          enabled={!!selectedProduct}
          checked={layers.events && !!selectedProduct}
          onChange={(checked) => {
            if (selectedProduct) {
              setLayers(prev => ({ ...prev, events: checked }));
            }
          }}
        />
      </PopoverContent>
    </Popover>
  );
}
```

#### 2. 图层状态管理
```typescript
// 伪代码示例
const [layers, setLayers] = useState({
  heatmap: true,
  events: true,
});

useEffect(() => {
  // 更新热力图图层可见性
  if (heatmapLayerRef.current) {
    heatmapLayerRef.current.setVisible(layers.heatmap);
  }
  
  // 更新风险事件图层可见性
  if (riskMarkersRef.current) {
    riskMarkersRef.current.forEach(marker => {
      marker.map = layers.events ? map : null;
    });
  }
}, [layers]);
```

#### 3. 图层切换组件
```typescript
// 伪代码示例
function LayerToggle({
  label,
  enabled,
  checked,
  onChange
}: LayerToggleProps) {
  return (
    <div
      onClick={() => enabled && onChange(!checked)}
      className={cn(
        "layer-toggle",
        enabled ? "enabled" : "disabled",
        checked && enabled ? "checked" : ""
      )}
    >
      <div className="layer-icon">...</div>
      <div className="layer-info">
        <div className="layer-label">{label}</div>
        <div className="layer-description">...</div>
      </div>
      {checked && enabled && <div className="layer-indicator" />}
    </div>
  );
}
```

### 关键代码结构

#### 图层控制组件
```typescript
// 伪代码示例
export function LayerControls({
  layers,
  setLayers,
  rainfallType,
  selectedProduct,
  heatmapLayer,
  riskMarkersLayer
}: LayerControlsProps) {
  // 图层控制UI
  // 图层状态管理
  // 图层可见性更新
}
```

---

## 输入输出

### 输入
- **图层实例**：热力图图层和标记图层的实例
- **数据类型**：`RainfallType`（"historical" | "predicted"）
- **选中产品**：`Product | null`类型
- **当前图层状态**：`{ heatmap: boolean; events: boolean }`

### 输出
- **更新的图层状态**：通过setter函数更新
- **图层可见性变更**：通过图层实例更新可见性

---

## 验收标准

### 功能验收标准
- [ ] 图层控制UI可以正常显示和交互
- [ ] 历史降雨量图层可以开启/关闭
- [ ] 预测降雨量图层可以开启/关闭
- [ ] 风险事件图层可以开启/关闭
- [ ] 根据数据类型动态显示可操作的图层
- [ ] 根据产品选择动态显示风险事件图层
- [ ] 图层状态与图层实例同步

### 交互验收标准
- [ ] 图层开关响应及时，无明显延迟
- [ ] 不可操作的图层显示为禁用状态
- [ ] 图层状态有清晰的视觉反馈
- [ ] Popover可以正常打开和关闭

### 视觉验收标准
- [ ] UI设计符合Google Maps风格
- [ ] 图层图标清晰可识别
- [ ] 选中状态明显，易于识别
- [ ] 禁用状态清晰，不会误导用户

---

## 注意事项

### 常见问题
1. **图层状态不同步**
   - 确保图层状态与图层实例同步
   - 确保状态更新时正确更新图层可见性

2. **图层控制UI位置错误**
   - 根据输入模式（manual/chat）调整位置
   - 确保不遮挡地图重要区域

3. **图层切换不响应**
   - 确保图层实例正确传递
   - 确保状态更新逻辑正确

### 技术难点
- **图层状态管理**：需要正确管理多个图层的状态
- **动态显示逻辑**：需要根据数据类型和产品选择动态显示
- **UI设计**：需要符合Google Maps的设计风格

### 扩展性考虑
- 图层控制组件可以扩展，支持更多图层类型
- 图层状态可以持久化（如果需要）
- 支持未来添加更多图层控制选项

---

## 下一步

### 后续步骤的准备工作
- 图层控制功能已实现，地图可视化功能基本完成
- 图层状态管理已实现，可以在后续步骤中使用

### 数据/接口的传递
- 图层状态通过props传递给图层组件
- 图层可见性通过图层实例控制

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
