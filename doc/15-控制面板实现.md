# 15-控制面板实现

## 步骤概述

### 步骤编号和名称
**步骤15**：控制面板实现

### 步骤目标
实现手动选择控制面板，包含区域选择（模糊搜索、层级选择）、天气数据类型切换、时间范围选择、产品选择等功能，支持与AI对话面板的互斥显示。

### 预期成果
- 控制面板可以正常显示和交互
- 区域选择功能正常工作（模糊搜索、层级选择）
- 天气数据类型切换功能正常工作
- 时间范围选择功能正常工作
- 产品选择功能正常工作
- 与AI对话面板的互斥显示正常工作

---

## 前置条件

### 依赖的步骤
- **步骤05**：行政区域数据管理（需要区域搜索和选择功能）
- **步骤06**：产品库基础结构（需要产品查询接口）

### 需要完成的前置工作
- 区域搜索功能已实现
- 产品查询接口已实现

### 需要的数据/接口
- 区域数据：`AdministrativeRegion[]`类型
- 产品数据：`Product[]`类型
- 当前选择状态：`selectedRegion`、`weatherDataType`、`dateRange`、`selectedProduct`

---

## 实现要点

### 核心功能点

1. **区域选择功能**
   - 模糊搜索：支持按区域名称搜索
   - 层级选择：三级下拉选择器（国家→省/州→市/区）
   - GPS一键定位：点击定位按钮后自动设置区域（参考 [16-GPS定位功能.md](./16-GPS定位功能.md)）
   - 搜索结果显示和选择
   - 区域切换后通过动画系统自动更新地图视图（参考 [25-矢量地图动画切换.md](./25-矢量地图动画切换.md)）
     - 使用 `FlyToStrategy` 实现抛物线动画
     - 自动计算所选区域全景 zoom 级别
     - 最终视图以所选区域的GADM中心位置为核心，显示区域全景

2. **天气数据类型切换**
   - 单选按钮：历史天气数据 / 预测天气数据
   - 切换时自动更新时间范围（根据需求文档逻辑）
   - 视觉反馈：选中状态明显

3. **天气类型切换**（预留扩展，暂不开发）
   - 支持切换不同天气指标：降雨量、温度、湿度、风速等
   - 切换后更新地图图层和数据展示
   - 预留接口，后续迭代实现

4. **时间范围选择**
   - 日期选择器：选择起止日期
   - 小时选择器：选择起止时刻（0-23）
   - 默认时间窗口逻辑：
     - 历史数据：当前日期1小时前至过去7天的相同时刻
     - 预测数据：当前日期和时刻至未来10天的相同时刻
   - 限制：历史数据最多选择40天内

5. **产品选择**
   - 产品卡片显示：图标 + 文字描述
   - 单选：只能选择一个产品
   - 点击"more"跳转到产品介绍页
   - 选中状态明显

6. **面板交互**
   - 支持最小化/最大化
   - 与AI对话面板互斥（一种激活时，另一种最小化）
   - UI设计参考Google Maps

### 技术实现方案

#### 1. 区域选择组件
```typescript
// 伪代码示例
function RegionSelector({
  selectedRegion,
  setSelectedRegion,
  onGPSClick
}: RegionSelectorProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  
  // 模糊搜索
  const handleSearch = (query: string) => {
    const results = searchRegions(query);
    setSearchResults(results);
  };
  
  // 层级选择
  const handleLevelSelect = (level: string, value: string) => {
    // 更新对应层级的选择
  };
  
  return (
    <div>
      {/* 模糊搜索输入框 */}
      {/* 层级选择下拉 */}
      {/* GPS定位按钮 */}
    </div>
  );
}
```

#### 2. 天气数据类型切换组件
```typescript
// 伪代码示例
function WeatherDataTypeSelector({
  weatherDataType,
  setWeatherDataType,
  onTypeChange
}: TypeSelectorProps) {
  return (
    <div className="flex gap-2">
      <button
        onClick={() => handleTypeChange('historical')}
        className={weatherDataType === 'historical' ? 'selected' : ''}
      >
        历史天气数据
      </button>
      <button
        onClick={() => handleTypeChange('forecast')}
        className={weatherDataType === 'forecast' ? 'selected' : ''}
      >
        预测天气数据
      </button>
    </div>
  );
}
```

#### 3. 时间范围选择组件
```typescript
// 伪代码示例
function DateRangeSelector({
  dateRange,
  setDateRange,
  weatherDataType
}: DateRangeSelectorProps) {
  return (
    <div>
      {/* 日期选择器 */}
      <DatePicker
        from={dateRange.from}
        to={dateRange.to}
        maxDays={weatherDataType === 'historical' ? 40 : 10}
        onChange={handleDateChange}
      />
      
      {/* 小时选择器 */}
      <HourPicker
        startHour={dateRange.startHour}
        endHour={dateRange.endHour}
        onChange={handleHourChange}
      />
    </div>
  );
}
```

### 关键代码结构

#### ControlPanel组件结构
```typescript
// 伪代码示例
export function ControlPanel({
  isMinimized,
  onMaximize,
  onMinimize,
  selectedRegion,
  setSelectedRegion,
  weatherDataType,
  setWeatherDataType,
  dateRange,
  setDateRange,
  selectedProduct,
  setSelectedProduct,
  onNavigateToProduct
}: ControlPanelProps) {
  return (
    <div className={isMinimized ? 'minimized' : 'expanded'}>
      {!isMinimized && (
        <>
          <RegionSelector ... />
          <WeatherDataTypeSelector ... />
          <DateRangeSelector ... />
          <ProductSelector ... />
        </>
      )}
      <button onClick={isMinimized ? onMaximize : onMinimize}>
        {isMinimized ? '展开' : '最小化'}
      </button>
    </div>
  );
}
```

---

## 输入输出

### 输入
- **当前选择状态**：`selectedRegion`、`weatherDataType`、`dateRange`、`selectedProduct`
- **区域数据**：`AdministrativeRegion[]`类型
- **产品数据**：`Product[]`类型

### 输出
- **更新的选择状态**：通过setter函数更新
- **用户操作事件**：区域选择、类型切换、时间范围修改、产品选择

---

## 验收标准

### 功能验收标准
- [ ] 区域选择功能正常工作（模糊搜索、层级选择）
- [ ] 天气数据类型切换功能正常工作，自动更新时间范围
- [ ] 时间范围选择功能正常工作，限制正确
- [ ] 产品选择功能正常工作，可以切换产品
- [ ] 控制面板可以最小化/最大化
- [ ] 与AI对话面板的互斥显示正常工作

### 交互验收标准
- [ ] 参数修改后，地图和数据面板可以实时更新
- [ ] 搜索结果显示正确，可以选择
- [ ] 层级选择逻辑正确，选择上级后动态加载下级
- [ ] 时间范围限制正确（历史数据最多40天）

### 视觉验收标准
- [ ] UI设计符合Google Maps风格
- [ ] 选中状态明显，易于识别
- [ ] 面板布局清晰，信息层次分明

---

## 注意事项

### 常见问题
1. **区域搜索性能问题**
   - 使用防抖（debounce）避免频繁搜索
   - 考虑使用索引优化搜索性能

2. **时间范围逻辑错误**
   - 确保默认时间窗口逻辑正确
   - 确保限制逻辑正确（历史数据最多40天）

3. **产品选择状态不同步**
   - 确保产品选择状态与全局状态同步
   - 确保AI对话修改参数后，控制面板同步更新

### 技术难点
- **区域搜索算法**：需要支持模糊匹配和部分匹配
- **时间范围计算**：需要正确处理时区和日期边界
- **状态同步**：确保控制面板和AI对话面板的状态同步

### 扩展性考虑
- 区域选择组件可以扩展，支持更多搜索方式
- 时间范围选择可以扩展，支持更多时间单位
- 产品选择可以扩展，支持产品筛选和排序

---

## 下一步

### 后续步骤的准备工作
- 控制面板已实现，可以在步骤16中集成GPS定位功能
- 参数设置功能已实现，可以在步骤21中实现页面间联动

### 数据/接口的传递
- 参数通过props传递给Dashboard组件
- 参数更新通过setter函数触发数据重新计算和渲染

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
