# 05-行政区域数据管理

## 步骤概述

### 步骤编号和名称
**步骤05**：行政区域数据管理

### 步骤目标
准备行政区域边界数据（GeoJSON格式），实现区域搜索和选择逻辑，支持模糊搜索、层级选择和GPS定位转换，为地图可视化提供区域数据支持。

### 预期成果
- 行政区域边界数据已准备（GeoJSON格式）
- 区域搜索功能正常工作（模糊搜索）
- 层级选择功能正常工作（国家→省/州→市/区）
- GPS定位可以转换为行政区域
- 区域数据结构统一，便于后续使用

---

## 前置条件

### 依赖的步骤
- 无（区域数据管理相对独立）

### 需要完成的前置工作
- 了解区域数据结构需求
- 准备或获取行政区域边界数据（GeoJSON格式）

### 需要的数据/接口
- 行政区域边界数据：GeoJSON格式
- 区域层级数据：国家、省/州、市/区的层级关系
- GPS坐标（用于反向地理编码）

---

## 实现要点

### 核心功能点

1. **区域数据结构定义**
   - 定义`AdministrativeRegion`接口
   - 包含：国家、省/州、市/区、中心点坐标、边界坐标（GeoJSON格式）

2. **区域边界数据准备**
   - 从OpenStreetMap或其他地理数据源获取行政区域边界
   - 转换为GeoJSON格式
   - 按"省/州"级别组织数据，包含所有"市/区"的边界
   - 如果无法获取真实边界，使用简化方案（矩形/圆形）

3. **区域搜索功能**
   - 实现模糊搜索算法
   - 支持按国家、省/州、市/区名称搜索
   - 支持部分匹配和拼音匹配（如果需要）

4. **层级选择功能**
   - 实现三级下拉选择器（国家→省/州→市/区）
   - 支持全球范围的国家和地区
   - 选择上级后，动态加载下级选项

5. **GPS定位转换**
   - 使用Google Geocoding API进行反向地理编码
   - 从地址信息中提取行政区域层级
   - 自动设置定位到的区域，不限制特定地区

### 技术实现方案

#### 1. 区域数据结构
```typescript
// 伪代码示例
interface AdministrativeRegion {
  country: string;
  province: string;
  district: string;
  center: { lat: number; lng: number };
  boundary: google.maps.LatLngLiteral[]; // GeoJSON格式的边界坐标
}
```

#### 2. 区域数据存储
- **方案A（推荐）**：预处理边界数据，存储为静态JSON文件
- **方案B（备选）**：使用Places API获取边界信息（成本较高）
- **方案C（临时）**：使用简化边界（矩形/圆形）用于演示

#### 3. 区域搜索算法
```typescript
// 伪代码示例
function searchRegions(query: string): AdministrativeRegion[] {
  // 1. 模糊匹配区域名称
  // 2. 支持部分匹配
  // 3. 返回匹配结果列表
}
```

#### 4. GPS定位转换
```typescript
// 伪代码示例
async function convertGPSToRegion(
  lat: number,
  lng: number
): Promise<AdministrativeRegion | null> {
  // 1. 调用Geocoding API
  // 2. 解析地址组件
  // 3. 提取行政区域信息
  // 4. 返回区域信息（不限制特定地区）
}
```

### 关键代码结构

#### 区域数据管理Hook
```typescript
// 伪代码示例
function useRegionData() {
  // 1. 加载区域数据
  // 2. 提供搜索功能
  // 3. 提供层级选择功能
  // 4. 提供GPS转换功能
}
```

---

## 输入输出

### 输入
- **搜索查询**：字符串（区域名称）
- **GPS坐标**：`{ lat: number; lng: number }`
- **层级选择**：国家、省/州、市/区的选择

### 输出
- **区域信息**：`AdministrativeRegion`类型
- **区域列表**：匹配的区域列表（用于搜索）
- **边界数据**：GeoJSON格式的边界坐标（用于地图绘制）

---

## 验收标准

### 功能验收标准
- [ ] 区域边界数据可以正常加载
- [ ] 模糊搜索功能正常工作，可以找到匹配的区域
- [ ] 层级选择功能正常工作，可以按国家→省/州→市/区选择
- [ ] GPS定位可以正确转换为行政区域
- [ ] 区域数据结构统一，符合接口定义

### 数据质量验收标准
- [ ] 区域边界数据格式正确（GeoJSON格式）
- [ ] 区域中心点坐标准确
- [ ] 区域层级关系正确
- [ ] 数据覆盖所需的国家和地区

### 性能验收标准
- [ ] 区域搜索响应时间在500ms内
- [ ] 区域数据加载时间在2秒内
- [ ] GPS定位转换时间在3秒内

---

## 注意事项

### 常见问题
1. **区域边界数据获取困难**
   - 准备简化方案（矩形/圆形边界）作为备选
   - 考虑使用OpenStreetMap或其他开源数据源

2. **GPS定位转换失败**
   - 处理用户拒绝位置权限的情况
   - 处理定位超时的情况
   - 处理定位位置无法转换为行政区域的情况

3. **区域搜索性能问题**
   - 使用索引优化搜索性能
   - 考虑使用防抖（debounce）避免频繁搜索

### 技术难点
- **区域边界数据获取**：Google Maps不直接提供行政区域边界，需要外部数据源
- **GPS定位转换**：需要正确解析Geocoding API返回的地址组件
- **区域匹配**：需要处理不同数据源的区域名称差异

### 扩展性考虑
- 区域数据可以存储在静态文件或通过API提供
- 支持未来添加更多区域数据
- 支持未来接入真实的区域数据API

---

## 下一步

### 后续步骤的准备工作
- 区域数据已准备，可以在步骤11中使用数据绘制行政区域边界
- 区域搜索功能已实现，可以在步骤15中使用

### 数据/接口的传递
- 区域信息通过`Region`类型传递给其他组件
- 边界数据通过GeoJSON格式传递给地图组件

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**最后更新**：2025-01-27
