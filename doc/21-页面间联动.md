# 21-页面间联动

## 步骤概述

### 步骤编号和名称
**步骤21**：页面间联动

### 步骤目标
实现首页与产品介绍页之间的跳转和参数传递，支持从产品介绍页的"Simulate risk"按钮跳转到首页并自动设置选中产品，确保页面间数据传递和状态同步。

### 预期成果
- 首页与产品介绍页的跳转功能正常工作
- 从产品介绍页跳转到首页时，可以自动设置选中产品（区域、数据类型、时间范围使用默认值）
- 从首页跳转到产品介绍页时，可以跳转到指定的位置（"core-products"章节）
- 页面状态同步正常
- "Simulate risk"功能正常工作

---

## 前置条件

### 依赖的步骤
- **步骤15**：控制面板实现（需要产品选择功能）
- **步骤20**：图表可视化（需要完整的数据展示功能）

### 需要完成的前置工作
- 首页功能基本完成
- 产品介绍页已存在
- 产品选择功能已实现

### 需要的数据/接口
- 产品信息：`Product`类型
- 页面路由：`currentPage`状态
- 导航函数：`onNavigateToProduct`、`onNavigateToHome`

---

## 实现要点

### 核心功能点

1. **首页到产品介绍页的跳转**
   - 从产品选择器点击"More"按钮跳转（不带参数，跳转到产品页顶部）
   - 从数据面板点击链接跳转到特定章节 "core-products"（scrollToSection）
   - 支持自动滚动到指定章节（通过 `scrollToSection` prop）

2. **产品介绍页到首页的跳转**
   - 从"Simulate risk"按钮跳转（多个按钮，每个对应不同产品）
   - 传递产品信息，自动设置选中产品（通过 `initialProduct` prop）
   - **注意**：区域、数据类型、时间范围使用默认值，不会根据产品自动设置
   - 自动触发相关的数据加载、计算、展示（因为产品选择会触发数据重新计算）

3. **参数传递机制**
   - 使用状态管理传递产品信息
   - 使用URL参数或状态传递其他参数（如果需要）
   - 确保参数正确解析和设置

4. **页面状态同步**
   - 跳转时保持必要的状态
   - 跳转后正确初始化新页面的状态
   - 确保数据正确加载

### 技术实现方案

#### 1. 首页到产品介绍页的跳转
```typescript
// 实际实现
// 在App.tsx中
const handleNavigateToProduct = (section?: string) => {
  if (section) setScrollToSection(section);
  else setScrollToSection(null);
  setCurrentPage('product');
};

// 在ProductSelector组件中
<button 
  onClick={onNavigateToProduct}
  className="flex items-center gap-1 px-3 py-2 text-xs font-semibold text-blue-600 bg-white/80 hover:bg-white rounded-full transition-colors whitespace-nowrap backdrop-blur-sm"
>
  More <ChevronRight className="w-3 h-3" />
</button>

// 在DataDashboard组件中（跳转到特定章节）
<button 
  onClick={() => onNavigateToProduct('core-products')}
  className="text-blue-600 hover:text-blue-700 font-semibold hover:underline transition-colors outline-none"
>
  Click here
</button>
```

#### 2. 产品介绍页到首页的跳转
```typescript
// 实际实现
// 在ProductIntro组件中（直接调用，无需中间函数）
<Button 
  onClick={() => onNavigateToHome(PRODUCTS.find(p => p.id === 'daily'))}
  className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-6 text-lg rounded-full"
>
  Simulate risk
</Button>

// 在App.tsx中
const handleNavigateToHome = (product?: InsuranceProduct) => {
  setDashboardInitialProduct(product || null);
  setCurrentPage('home');
};

// 在Dashboard组件中（通过useState初始化，无需useEffect）
const [selectedProduct, setSelectedProduct] = useState<InsuranceProduct | null>(
  initialProduct || null
);
// 注意：区域、数据类型、时间范围使用默认值，不会根据产品自动设置
```

#### 3. 参数传递和状态同步
```typescript
// 实际实现
// App.tsx
export default function App() {
  const [currentPage, setCurrentPage] = useState<'home' | 'product'>('home');
  const [dashboardInitialProduct, setDashboardInitialProduct] = useState<InsuranceProduct | null>(null);
  const [scrollToSection, setScrollToSection] = useState<string | null>(null);

  // 清除缓存（开发模式）
  useEffect(() => {
    weatherDataGenerator.clearCache();
    clearRiskCache();
  }, []);

  // 页面切换时滚动到顶部（除非指定了特定章节）
  useEffect(() => {
    if (!scrollToSection) {
      window.scrollTo(0, 0);
    }
  }, [currentPage, scrollToSection]);

  const handleNavigateToProduct = (section?: string) => {
    if (section) setScrollToSection(section);
    else setScrollToSection(null);
    setCurrentPage('product');
  };

  const handleNavigateToHome = (product?: InsuranceProduct) => {
    setDashboardInitialProduct(product || null);
    setCurrentPage('home');
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900 flex flex-col">
      <Header currentPage={currentPage} setCurrentPage={setCurrentPage} />
      <main className="flex-1 pt-16">
        {currentPage === 'home' ? (
          <Dashboard
            onNavigateToProduct={handleNavigateToProduct}
            initialProduct={dashboardInitialProduct}
          />
        ) : (
          <ProductIntro
            onNavigateToHome={handleNavigateToHome}
            scrollToSection={scrollToSection}
          />
        )}
      </main>
    </div>
  );
}
```

### 关键代码结构

#### 页面导航组件
```typescript
// 实际实现
// App.tsx - 页面状态管理和导航逻辑
export default function App() {
  // 页面状态：currentPage, dashboardInitialProduct, scrollToSection
  // 导航函数：handleNavigateToProduct, handleNavigateToHome
  // 缓存清理：应用启动时清除天气数据和风险事件缓存
  // 滚动控制：页面切换时自动滚动到顶部（除非指定了特定章节）
}

// Dashboard.tsx - 接收初始产品参数
export function Dashboard({ 
  onNavigateToProduct, 
  initialProduct 
}: { 
  onNavigateToProduct: (section?: string) => void;
  initialProduct?: InsuranceProduct | null;
}) {
  // 使用 initialProduct 初始化 selectedProduct 状态
  const [selectedProduct, setSelectedProduct] = useState<InsuranceProduct | null>(
    initialProduct || null
  );
  // 注意：区域、数据类型、时间范围使用默认值，不会根据产品自动设置
}

// ProductIntro.tsx - 处理滚动定位和跳转回首页
export function ProductIntro({ 
  onNavigateToHome, 
  scrollToSection 
}: ProductIntroProps) {
  // 处理 scrollToSection：自动滚动到指定章节
  useEffect(() => {
    if (scrollToSection) {
      setTimeout(() => {
        const element = document.getElementById(scrollToSection);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });
        }
      }, 100);
    }
  }, [scrollToSection]);
  
  // 多个"Simulate risk"按钮，传递不同的产品
  // 例如：onClick={() => onNavigateToHome(PRODUCTS.find(p => p.id === 'daily'))}
}
```

---

## 输入输出

### 输入
- **产品信息**：`Product`类型（从产品介绍页获取）
- **导航操作**：用户点击跳转按钮
- **目标章节**：`string | null`类型（用于产品介绍页滚动）

### 输出
- **页面跳转**：切换到目标页面
- **参数设置**：自动设置选中产品（区域、数据类型、时间范围使用默认值）
- **状态更新**：更新页面状态和数据显示（产品选择会触发数据重新计算）

---

## 验收标准

### 功能验收标准
- [x] 首页与产品介绍页的跳转功能正常工作
- [x] 从产品介绍页跳转到首页时，可以自动设置选中产品，并触发相关的数据加载、计算、展示
- [x] 从首页跳转到产品介绍页时，可以自动定位到指定章节（"core-products"）
- [x] 页面状态同步正常
- [x] "Simulate risk"功能正常工作（多个按钮，每个对应不同产品）

### 交互验收标准
- [x] 页面跳转流畅，无明显延迟
- [x] 参数设置后，地图和数据面板可以正确更新
- [x] 页面状态保持正确，不会丢失数据

### 数据质量验收标准
- [x] 产品信息传递正确
- [x] 产品设置正确（区域、数据类型、时间范围使用默认值，不会根据产品自动设置）
- [x] 数据加载正确，与设置的产品一致

---

## 注意事项

### 常见问题
1. **参数传递失败**
   - 确保产品信息正确传递（通过 `initialProduct` prop）
   - 确保状态管理正确（App.tsx 中的状态管理）

2. **页面状态不同步**
   - 确保跳转时正确更新状态（`setCurrentPage` 和 `setDashboardInitialProduct`）
   - 确保新页面正确初始化（Dashboard 通过 `useState` 初始化 `selectedProduct`）
   - **注意**：区域、数据类型、时间范围不会自动设置，使用默认值

3. **数据加载失败**
   - 确保产品设置后触发数据重新加载（产品选择会触发数据重新计算）
   - 处理数据加载错误

### 技术难点
- **状态管理**：需要正确管理页面间状态传递
- **参数解析**：需要正确解析和设置参数
- **数据同步**：需要确保页面间数据同步

### 扩展性考虑
- 页面导航可以扩展，支持更多页面类型
- 参数传递可以扩展，支持更多参数类型
- 支持未来添加更多页面间交互功能

---

## 下一步

### 后续步骤的准备工作
- 页面间联动已实现，用户流程基本完整
- 参数传递机制已实现，可以在后续步骤中使用

### 数据/接口的传递
- 产品信息通过状态管理传递
- 导航事件通过回调函数传递

---

**文档版本**：v1.1  
**创建日期**：2025-01-27  
**最后更新**：2025-12-18
