# 风险计算架构升级方案

## 1. 背景与目标
为了解决目前风险计算逻辑分散在 UI 组件（如 DataDashboard）和模拟数据（如 initialRiskData）中的问题，实现“唯一事实来源”（Single Source of Truth）原则，提升系统的一致性和可维护性。

## 2. 核心架构：useRiskAnalysis Hook
建立统一的风险分析 Hook，作为系统唯一的风险计算入口，协调产品库、天气数据和计算引擎。

### 2.1 输入参数 (Inputs)
- `selectedRegion`: `Region` (包含国家、省、市)
- `dateRange`: `DateRange` (时间窗口)
- `selectedProduct`: `InsuranceProduct | null` (选中的保险产品)
- `weatherType`: `WeatherType` (天气类型，如 'rainfall')
- `dataType`: `DataType` (数据类型: 'historical' | 'predicted')
- `weatherData`: `WeatherData[]` (天气原始数据流)

### 2.2 内部逻辑
1. **监听触发**：监听上述所有参数的变更，自动触发计算。
2. **服务协同**：内部调用 `RiskCalculationService` 进行逻辑计算。
3. **数据聚合**：
   - **全域统计**：对当前省份内所有城市的风险事件进行**不分级**的数量统计（用于地图标记）。
   - **选中城市统计**：对当前选中城市的风险情况进行**分级**（Tier 1/2/3）的数量统计和详细描述。

### 2.3 输出结果 (Outputs)
- `riskEvents`: `RiskEvent[]` (原始风险事件列表)
- `mapMarkersData`: `RiskData[]` (用于地图展示的聚合数据：城市 -> 风险事件总数)
- `detailedStatistics`: `RiskStatistics` (用于数据面板的风险分级统计)
- `isCalculated`: `boolean` (计算状态标识)

## 3. 天气数据统计解耦 (Weather Statistics Decoupling)
为了保持风险计算引擎的职责单一，天气相关的基础统计指标已从风险计算逻辑中剥离。

### 3.1 useWeatherStatistics Hook
独立的 Hook 用于处理与风险事件无关的气象统计：
- **Time Window**: 基于 `dateRange` 计算的总时长（天、小时）。
- **Metrics**: 统计周期内的总降雨量、日均降雨量、小时均降雨量、极大/极小值。

### 3.2 协同工作流
- `useRiskAnalysis`: 负责识别风险事件并生成分级统计（Tier 1/2/3）。
- `useWeatherStatistics`: 负责基础气象趋势的量化分析。
- `DataDashboard`: 组合上述两个数据源，呈现完整的分析视图。

## 4. 页面协同机制
- **单向数据流**：`Dashboard.tsx` 统一持有 `useRiskAnalysis` 的状态，并分发给子组件。
- **地图层 (Map Layer)**：加载 `mapMarkersData`，Marker 的视觉反馈（大小/颜色）仅反映风险事件总量，不涉及具体分级。
- **分析层 (Analysis Layer)**：`DataDashboard` 加载 `detailedStatistics` 和 `riskEvents`，展示具体的 Tier 分级、触发过程图表及严重程度。

## 4. 缓存与持久化策略
- **历史数据持久化**：针对 `dataType === 'historical'` 产生的风险事件列表进行长期的记忆或数据记录。由于历史天气数据是静态的，其计算结果具有确定性。
- **预测数据/统计动态化**：
  - 预测天气产生的风险事件不进行长期缓存，因气象预测会随模型更新而变化。
  - 所有基于事件产生的统计数据（Statistics）仅在内存中通过 `useMemo` 保持响应式更新。

## 5. 对话集成 (AI Integration)
- `useRiskAnalysis` 需支持原子化更新。当 AI 助理一次性更改多个参数（如城市、产品、时间范围）时，应确保在同一个渲染周期内完成计算，保证 UI 展现的一致性。

